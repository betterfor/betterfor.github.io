[{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"åœ¨æ—¥å¸¸Golangä½¿ç”¨ä¸­ï¼Œä½ æœ‰æ²¡æœ‰è¿™æ ·çš„ç–‘æƒ‘ï¼Ÿ nilæ˜¯ä»€ä¹ˆï¼Ÿå“ªäº›å¯ä»¥ç”¨nilï¼Ÿå“ªäº›ä¸èƒ½ç”¨nilï¼Ÿ æ¥ä¸‹æ¥ï¼Œæˆ‘å°†å¯¹è¿™äº›å†…å®¹è¿›è¡Œæ€»ç»“ã€‚ ","date":"2022-03-07","objectID":"/2022/03/nil/:0:0","tags":["nil"],"title":"Nilçš„ä½¿ç”¨åœºæ™¯","uri":"/2022/03/nil/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"ä¸€ã€ä»€ä¹ˆæ˜¯nil é¦–å…ˆnilæ˜¯ä¸€ä¸ªå˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æºç åŒ…ä¸­æ‰¾åˆ°è¿™æ ·çš„æè¿°ï¼š // nil is a predeclared identifier representing the zero value for a // pointer, channel, func, interface, map, or slice type. var nil Type // Type must be a pointer, channel, func, interface, map, or slice type // Type is here for the purposes of documentation only. It is a stand-in // for any Go type, but represents the same type for any given function // invocation. type Type int ä»ç±»å‹å®šä¹‰ä¸Šå¯ä»¥å¾—åˆ°ä»¥ä¸‹å…³é”®ç‚¹ï¼š nilæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªTypeç±»å‹çš„å˜é‡ Typeç±»å‹ä»…ä»…æ˜¯åŸºäºintå®šä¹‰å‡ºæ¥çš„æ–°ç±»å‹ nilé€‚ç”¨äºæŒ‡é’ˆã€channelã€å‡½æ•°ã€interfaceã€mapã€sliceå…­ç§ç±»å‹ ","date":"2022-03-07","objectID":"/2022/03/nil/:1:0","tags":["nil"],"title":"Nilçš„ä½¿ç”¨åœºæ™¯","uri":"/2022/03/nil/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"äºŒã€å…­å¤§ç±»å‹ ","date":"2022-03-07","objectID":"/2022/03/nil/:2:0","tags":["nil"],"title":"Nilçš„ä½¿ç”¨åœºæ™¯","uri":"/2022/03/nil/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"1ã€æŒ‡é’ˆ 1.1ã€å˜é‡å®šä¹‰ var ptr *int 1.2ã€å˜é‡æœ¬èº« å˜é‡æœ¬èº«æ˜¯8å­—èŠ‚çš„å†…å­˜å— 1.3ã€nilèµ‹å€¼ è¿™8ä¸ªå­—èŠ‚æŒ‡é’ˆç½®0 1.4ã€nilåˆ¤æ–­ åˆ¤æ–­è¿™8ä¸ªå­—èŠ‚æ˜¯å¦ä¸º0 ","date":"2022-03-07","objectID":"/2022/03/nil/:2:1","tags":["nil"],"title":"Nilçš„ä½¿ç”¨åœºæ™¯","uri":"/2022/03/nil/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"2ã€channel 2.1ã€å˜é‡å®šä¹‰ // å˜é‡æœ¬èº«å®šä¹‰ var c1 chan struct{} // å˜é‡å®šä¹‰å’Œåˆå§‹åŒ– var c2 = make(chan struct{}) ç¬¬ä¸€ç§æ–¹å¼ä»…ä»…å®šä¹‰äº†c1å˜é‡æœ¬èº« ç¬¬äºŒç§æ–¹å¼åˆ™åˆ†é…äº†c2çš„å†…å­˜ï¼Œè°ƒç”¨äº†runtimeä¸‹çš„makechanå‡½æ•°æ¥åˆ›å»ºç»“æ„ 2.2ã€å˜é‡æœ¬èº« ä¸€ä¸ª 8 å­—èŠ‚çš„æŒ‡é’ˆè€Œå·²ï¼ŒæŒ‡å‘ä¸€ä¸ª channel ç®¡ç†ç»“æ„ï¼Œä¹Ÿå°±æ˜¯ struct hchan çš„æŒ‡é’ˆã€‚ 2.3ã€nilèµ‹å€¼ èµ‹å€¼ nil ä¹‹åï¼Œä»…ä»…æ˜¯æŠŠè¿™ 8 å­—èŠ‚çš„æŒ‡é’ˆç½® 0 ã€‚ 2.4ã€nilåˆ¤æ–­ åˆ¤æ–­è¿™æŒ‡é’ˆæ˜¯å¦ä¸º0 ","date":"2022-03-07","objectID":"/2022/03/nil/:2:2","tags":["nil"],"title":"Nilçš„ä½¿ç”¨åœºæ™¯","uri":"/2022/03/nil/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"3ã€map 3.1ã€å˜é‡å®šä¹‰ // å˜é‡å®šä¹‰ var m1 map[int]int // å˜é‡å®šä¹‰å’Œåˆå§‹åŒ– var m2 = make(map[int]int) ç¬¬ä¸€ç§æ–¹å¼ä»…ä»…å®šä¹‰äº†m1å˜é‡æœ¬èº« ç¬¬äºŒç§æ–¹å¼åˆ™åˆ†é…äº†m2çš„å†…å­˜ï¼Œè°ƒç”¨äº†runtimeä¸‹çš„makemapå‡½æ•°æ¥åˆ›å»ºç»“æ„ 3.2ã€å˜é‡æœ¬èº« å˜é‡æœ¬èº«æ˜¯ä¸ªæŒ‡é’ˆ // A header for a Go map. type hmap struct { // Note: the format of the hmap is also encoded in cmd/compile/internal/gc/reflect.go. // Make sure this stays in sync with the compiler's definition. // é”®å€¼å¯¹çš„æ•°é‡ count int // # live cells == size of map. Must be first (used by len() builtin) // æ ‡è¯†çŠ¶æ€ flags uint8 // 2^B = len(buckets) B uint8 // log_2 of # of buckets (can hold up to loadFactor * 2^B items) // æº¢å‡ºæ¡¶é‡Œbmapå¤§è‡´æ•°é‡ noverflow uint16 // approximate number of overflow buckets; see incrnoverflow for details // hashå› å­ hash0 uint32 // hash seed // æŒ‡å‘ä¸€ä¸ªæ•°ç»„ï¼ˆè¿ç»­å†…å­˜ç©ºé—´ï¼‰ï¼Œæ•°ç»„ç±»å‹ä¸º[]bmapï¼Œbmapç±»å‹å°±æ˜¯å­˜åœ¨é”®å€¼å¯¹çš„ç»“æ„ buckets unsafe.Pointer // array of 2^B Buckets. may be nil if count==0. // æ‰©å®¹æ—¶ï¼Œå­˜æ”¾ä¹‹å‰çš„buckets oldbuckets unsafe.Pointer // previous bucket array of half the size, non-nil only when growing // åˆ†æµæ¬¡æ•°ï¼Œæˆå€æ‰©å®¹åˆ†æµæ“ä½œè®¡æ•°çš„å­—æ®µ nevacuate uintptr // progress counter for evacuation (buckets less than this have been evacuated) // æº¢å‡ºæ¡¶ç»“æ„ï¼Œæ­£å¸¸æ¡¶é‡Œé¢æŸä¸ªbmapå­˜æ»¡äº†ï¼Œä¼šä½¿ç”¨è¿™é‡Œé¢çš„å†…å­˜ç©ºé—´å­˜æ”¾é”®å€¼å¯¹ extra *mapextra // optional fields } åˆå§‹åŒ–äº†mapç»“æ„åï¼Œæ‰èƒ½åˆ†é…mapæ‰€ä½¿ç”¨çš„å†…å­˜ã€‚ 3.3ã€nilèµ‹å€¼ èµ‹å€¼ nil ä¹‹åï¼Œä»…ä»…æ˜¯æŠŠè¿™ 8 å­—èŠ‚çš„æŒ‡é’ˆç½® 0 ã€‚ 3.4ã€nilåˆ¤æ–­ åˆ¤æ–­è¿™æŒ‡é’ˆæ˜¯å¦ä¸º0 ","date":"2022-03-07","objectID":"/2022/03/nil/:2:3","tags":["nil"],"title":"Nilçš„ä½¿ç”¨åœºæ™¯","uri":"/2022/03/nil/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"4ã€interface 4.1ã€å˜é‡å®šä¹‰ // å®šä¹‰ä¸€ä¸ªæ¥å£ type Reader interface { Read(p []byte) (n int, err error) } // å®šä¹‰ä¸€ä¸ªæ¥å£å˜é‡ var reader Reader // ç©ºæ¥å£ var empty interface{} 4.2ã€å˜é‡æœ¬èº« type iface struct { tab *itab data unsafe.Pointer } type eface struct { _type *_type data unsafe.Pointer } å…¶ä¸­ifaceæ˜¯é€šå¸¸å®šä¹‰çš„interfaceç±»å‹ï¼Œefaceæ˜¯ç©ºæ¥å£å¯¹åº”çš„æ•°æ®ç»“æ„ï¼Œè¿™ä¸¤ä¸ªç»“æ„ä½“å ç”¨å†…å­˜éƒ½æ˜¯16å­—èŠ‚ã€‚ 4.3ã€nilèµ‹å€¼ èµ‹å€¼ nil ä¹‹åï¼ŒæŠŠè¿™ 16 å­—èŠ‚çš„å†…å­˜å—ç½® 0 ã€‚ 4.4ã€nilåˆ¤æ–­ éœ€è¦åˆ¤æ–­ç±»å‹å’Œå€¼ ","date":"2022-03-07","objectID":"/2022/03/nil/:2:4","tags":["nil"],"title":"Nilçš„ä½¿ç”¨åœºæ™¯","uri":"/2022/03/nil/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"5ã€å‡½æ•° 5.1ã€å˜é‡å®šä¹‰ var f func(int) error 5.2ã€å˜é‡æœ¬èº« å˜é‡æœ¬èº«æ˜¯8å­—èŠ‚çš„æŒ‡é’ˆ 5.3ã€nilèµ‹å€¼ æœ¬èº«å°±æ˜¯æŒ‡é’ˆï¼Œåªä¸è¿‡æŒ‡å‘çš„æ˜¯å‡½æ•°è€Œå·²ï¼Œæ‰€ä»¥èµ‹å€¼ä¹Ÿæ˜¯å°†è¿™ 8 å­—èŠ‚ç½® 0 ã€‚ 5.4ã€nilåˆ¤æ–­ åˆ¤æ–­è¿™8ä¸ªå­—èŠ‚æ˜¯å¦ä¸º0 ","date":"2022-03-07","objectID":"/2022/03/nil/:2:5","tags":["nil"],"title":"Nilçš„ä½¿ç”¨åœºæ™¯","uri":"/2022/03/nil/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"6ã€slice 6.1ã€å˜é‡å®šä¹‰ // å®šä¹‰ var slice1 []int var slice2 []int = []byte{1,2,3} // å®šä¹‰åŠåˆå§‹åŒ– var slice3 = make([]int, 3) varå’Œmakeè¿™ä¸¤ç§æ–¹å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ ç¬¬ä¸€ç§varçš„æ–¹å¼å®šä¹‰å˜é‡ï¼Œå¦‚æœé€ƒé€¸åˆ†æä¹‹åï¼Œå¯ä»¥ç¡®è®¤åˆ†é…åœ¨æ ˆä¸Šï¼Œé‚£ä¹ˆå°±åœ¨æ ˆä¸Šåˆ†é…24ä¸ªå­—èŠ‚ï¼Œå¦‚æœé€ƒé€¸åˆ°å †ä¸Šï¼Œé‚£ä¹ˆè°ƒç”¨newobjectå‡½æ•°è¿›è¡Œç±»å‹åˆ†æã€‚ ç¬¬äºŒç§makeæ–¹å¼ç•¥æœ‰ä¸åŒï¼Œå¦‚æœé€ƒé€¸åˆ†æä¹‹åï¼Œç¡®è®¤åˆ†é…åœ¨æ ˆä¸Šï¼Œé‚£ä¹ˆç›´æ¥åœ¨æ ˆä¸Šåˆ†é…24å­—èŠ‚ï¼Œå¦‚æœé€ƒé€¸åˆ°å †ä¸Šï¼Œä¼šè°ƒç”¨makesliceæ¥åˆ†é…å˜é‡ã€‚ 6.2ã€å˜é‡æœ¬èº« type slice struct { array unsafe.Pointer // ç®¡ç†çš„å†…å­˜å—é¦–åœ°å€ len int // åŠ¨æ€æ•°ç»„å®é™…ä½¿ç”¨å¤§å° cap int // åŠ¨æ€æ•°æ®å†…å­˜å¤§å° } å˜é‡æœ¬èº«å ç”¨24å­—èŠ‚ã€‚ æˆ‘ä»¬çœ‹åˆ°æ— è®ºæ˜¯varå£°æ˜å®šä¹‰çš„sliceå˜é‡ï¼Œè¿˜æ˜¯makeåˆ›å»ºçš„sliceå˜é‡ï¼Œsliceç®¡ç†ç»“æ„æ˜¯å·²ç»åˆ†é…å‡ºæ¥çš„ï¼Œä¹Ÿå°±æ˜¯struct sliceç»“æ„ 6.3ã€nilèµ‹å€¼ æœ¬èº«çš„ 24 å­—èŠ‚çš„å†…å­˜å—è¢«ç½® 0ã€‚ 6.4ã€nilåˆ¤æ–­ é‚£ä¹ˆä»€ä¹ˆæ ·çš„sliceè¢«è®¤ä¸ºæ˜¯nilï¼Ÿ æŒ‡é’ˆä¸º0ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªåŠ¨æ€æ•°ç»„æ²¡æœ‰å®é™…æ•°æ®çš„æ—¶å€™ã€‚ é—®é¢˜ï¼šä»…åˆ¤æ–­æŒ‡é’ˆï¼Ÿå¯¹lenå’Œcapä¸¤ä¸ªå­—æ®µä¸åšåˆ¤æ–­å—ï¼Ÿ package main import \"unsafe\" type sliceType struct { pdata unsafe.Pointer len int cap int } func main() { var slice []byte ((*sliceType)(unsafe.Pointer(\u0026slice))).len = 0x3 ((*sliceType)(unsafe.Pointer(\u0026slice))).cap = 0x4 if slice != nil { println(\"not nil\") } else { println(\"nil\") } } // Output: nil ","date":"2022-03-07","objectID":"/2022/03/nil/:2:6","tags":["nil"],"title":"Nilçš„ä½¿ç”¨åœºæ™¯","uri":"/2022/03/nil/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"ä¸‰ã€æ€»ç»“ 1ã€å˜é‡å°±æ˜¯ç»‘å®šåˆ°æŸä¸ªå†…å­˜å—ä¸Šçš„åç§° 2ã€å˜é‡å®šä¹‰åˆ†é…çš„å†…å­˜æ˜¯ç½®é›¶åˆ†é…çš„ 3ã€ä¸æ˜¯æ‰€æœ‰çš„ç±»å‹èƒ½å¤Ÿèµ‹å€¼ nilï¼Œå¹¶ä¸”å’Œ nil è¿›è¡Œå¯¹æ¯”åˆ¤æ–­ã€‚åªæœ‰ æŒ‡é’ˆã€channelã€å‡½æ•°ã€interfaceã€mapã€slice è¿™ 6 ç§ç±»å‹ 4ã€channelã€mapç±»å‹çš„å˜é‡éœ€è¦makeæ‰èƒ½ä½¿ç”¨ 5ã€sliceåœ¨å£°æ˜åå¯ä»¥ä½¿ç”¨ï¼Œæ˜¯å› ä¸ºstruct sliceæ ¸å¿ƒç»“æ„åœ¨å®šä¹‰çš„æ—¶å€™å°±å·²ç»åˆ†é…å‡ºæ¥äº†ã€‚ 6ã€sliceæ˜¯24å­—èŠ‚ï¼Œinterfaceæ˜¯16å­—èŠ‚ï¼Œå…¶ä»–çš„éƒ½æ˜¯8å­—èŠ‚ 7ã€è¿™ 6 ç§ç±»å‹å’Œ nil è¿›è¡Œæ¯”è¾ƒåˆ¤æ–­æœ¬è´¨ä¸Šéƒ½æ˜¯å’Œå˜é‡æœ¬èº«åšåˆ¤æ–­ï¼Œslice æ˜¯åˆ¤æ–­ç®¡ç†ç»“æ„çš„ç¬¬ä¸€ä¸ªæŒ‡é’ˆå­—æ®µï¼Œmapï¼Œchannel æœ¬èº«å°±æ˜¯æŒ‡é’ˆ ","date":"2022-03-07","objectID":"/2022/03/nil/:3:0","tags":["nil"],"title":"Nilçš„ä½¿ç”¨åœºæ™¯","uri":"/2022/03/nil/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"ä¸€ã€goroutine è¿›ç¨‹ï¼šå¯å¹¶å‘æ‰§è¡Œçš„ç¨‹åºåœ¨æŸä¸ªæ•°æ®é›†åˆä¸Šçš„ä¸€æ¬¡è®¡ç®—æ´»åŠ¨ï¼Œä¹Ÿæ˜¯æ“ä½œç³»ç»Ÿè¿›è¡Œèµ„æºåˆ†é…å’Œè°ƒåº¦çš„åŸºæœ¬å•ä½ã€‚æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„ç‹¬ç«‹ç©ºé—´ï¼Œä¸åŒè¿›ç¨‹é€šè¿‡è¿›ç¨‹é—´é€šä¿¡æ¥é€šä¿¡ã€‚ çº¿ç¨‹ï¼šä»å±äºè¿›ç¨‹ï¼Œæ˜¯ç¨‹åºçš„å®é™…æ‰§è¡Œè€…ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹ä¼šå…±äº«çˆ¶è¿›ç¨‹çš„èµ„æºã€‚ åç¨‹ï¼šç”¨æˆ·æ€çš„è½»é‡çº§çº¿ç¨‹ï¼Œåç¨‹çš„è°ƒåº¦å®Œå…¨ç”±ç”¨æˆ·æ§åˆ¶ã€‚ å¾ˆæ˜æ˜¾ï¼Œåœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œä¸ºæ¯ä¸ªä»»åŠ¡åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ä¼šæ¶ˆè€—å¤§é‡çš„èµ„æºï¼Œå¦‚é«˜å†…å­˜å ç”¨ï¼Œé«˜cpuè°ƒåº¦ã€‚ åœ¨Goä¸­ï¼Œä½¿ç”¨goroutineè®©ä¸€ç»„å¯å¤ç”¨çš„å‡½æ•°è¿è¡Œåœ¨ä¸€ç»„çº¿ç¨‹ä¸Šï¼Œå³ä½¿åç¨‹é˜»å¡ï¼Œè¯¥çº¿ç¨‹çš„å…¶ä»–åç¨‹ä¹Ÿä¼šè¢«runtimeè°ƒåº¦ã€‚goroutineéå¸¸è½»é‡ï¼Œä¸€ä¸ªgoroutineåªå ç”¨å‡ KBï¼Œè¿™å°±èƒ½è¿è¡Œå¤§é‡çš„goroutineï¼Œæ”¯æŒé«˜å¹¶å‘ã€‚ ","date":"2022-03-07","objectID":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/:1:0","tags":["golang","cspå¹¶å‘æ¨¡å‹"],"title":"CSPå¹¶å‘æ¨¡å‹","uri":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"äºŒã€GPMæ¨¡å‹ åœ¨Goä¸­ï¼Œè®¾è®¡äº†GPMæ¨¡å‹ Gï¼šgoroutineåç¨‹ Pï¼šprocessorå¤„ç†å™¨ Mï¼šthreadçº¿ç¨‹ 1ã€å…¨å±€é˜Ÿåˆ—ï¼ˆGlobal queueï¼‰ï¼šå…¨å±€å­˜æ”¾ç­‰å¾…è¿è¡Œçš„G 2ã€Pçš„æœ¬åœ°é˜Ÿåˆ—ï¼šå­˜æ”¾ç­‰å¾…è¿è¡Œçš„Gï¼Œä¸è¶…è¿‡256ã€‚æ–°å»ºGæ—¶ï¼ŒGä¼˜å…ˆåŠ å…¥æœ¬åœ°é˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼ŒæŠŠæœ¬åœ°é˜Ÿåˆ—ä¸­çš„ä¸€åŠç§»åŠ¨åˆ°å…¨å±€é˜Ÿåˆ—ä¸­ 3ã€Påˆ—è¡¨ï¼šæ‰€æœ‰çš„Péƒ½åœ¨ç¨‹åºå¯åŠ¨æ—¶åˆ›å»ºï¼Œå¹¶ä¿å­˜åœ¨æ•°ç»„ä¸­ï¼Œæœ€å¤šæœ‰GOMAXPROCSä¸ª 4ã€Mï¼šçº¿ç¨‹è¿è¡Œä»»åŠ¡éœ€è¦è·å–Pï¼Œä»Pçš„æœ¬åœ°é˜Ÿåˆ—ä¸­è·å–Gï¼ŒPé˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œä¼šå°è¯•ä»å…¨å±€é˜Ÿåˆ—ä¸­æ‹¿ä¸€æ‰¹Gæ”¾åˆ°Pçš„æœ¬åœ°é˜Ÿåˆ—ï¼Œæˆ–ä»å…¶ä»–Pçš„æœ¬åœ°é˜Ÿåˆ—å·ä¸€åŠæ”¾åˆ°è‡ªå·±çš„æœ¬åœ°é˜Ÿåˆ—ã€‚ goroutineè°ƒåº¦å™¨å’ŒOSè°ƒåº¦å™¨é€šè¿‡Mç»“åˆèµ·æ¥ï¼Œæ¯ä¸€ä¸ªMä»£è¡¨ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ï¼ŒOSè°ƒåº¦å™¨è´Ÿè´£æŠŠå†…æ ¸çº¿ç¨‹æ”¾åˆ°CPUä¸Šæ‰§è¡Œã€‚ ","date":"2022-03-07","objectID":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/:2:0","tags":["golang","cspå¹¶å‘æ¨¡å‹"],"title":"CSPå¹¶å‘æ¨¡å‹","uri":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"2.1ã€På’ŒMçš„æ•°é‡ 1ã€Pçš„æ•°é‡ å¯åŠ¨æ—¶ç”±ç¯å¢ƒå˜é‡GOMAXPROCSæˆ–è€…é€šè¿‡runtime.GOMAXPROCS()ç¡®å®šã€‚è¿™å°±ä»£è¡¨ç¨‹åºæ‰§è¡Œæ—¶æœ€å¤šæœ‰GOMAXPROCSä¸ªgoroutineåœ¨åŒæ—¶è¿è¡Œã€‚ 2ã€Mçš„æ•°é‡ goæœ¬èº«é™åˆ¶ï¼šç¨‹åºå¯åŠ¨æ—¶ï¼Œä¼šè®¾ç½®Mçš„æœ€å¤§æ•°é‡ï¼Œé»˜è®¤æ˜¯10000ã€‚sched.maxmcount = 10000 runtime/debugåŒ…ä¸­SetMaxThreadså‡½æ•°å¯ä»¥è®¾ç½®Mçš„æœ€å¤§æ•°é‡ ä¸€ä¸ªMé˜»å¡äº†ï¼Œä¼šåˆ›å»ºæ–°çš„M 3ã€Pæ•°é‡å’ŒMæ•°é‡çš„å…³ç³» Pä¸Mçš„æ²¡æœ‰æ•°é‡å…³ç³»ï¼Œä¸€ä¸ªMé˜»å¡äº†ï¼ŒPå°±ä¼šå»åˆ›å»ºæˆ–åˆ‡æ¢å¦ä¸€ä¸ªMï¼Œæ‰€ä»¥å³ä½¿P=1ï¼Œä¹Ÿæœ‰å¯èƒ½åˆ›å»ºå¤šä¸ªM ","date":"2022-03-07","objectID":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/:2:1","tags":["golang","cspå¹¶å‘æ¨¡å‹"],"title":"CSPå¹¶å‘æ¨¡å‹","uri":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"2.2ã€ä½•æ—¶åˆ›å»ºPå’ŒM 1ã€Pä½•æ—¶åˆ›å»º åœ¨ç¡®å®šPçš„æœ€å¤§æ•°é‡åï¼Œè¿è¡Œæ—¶ç¨‹åºä¼šæ ¹æ®æ•°é‡åˆ›å»ºP 2ã€Mä½•æ—¶åˆ›å»º æ²¡æœ‰è¶³å¤Ÿçš„Mæ¥å…³è”På¹¶è¿è¡ŒGã€‚æ¯”å¦‚æ‰€æœ‰çš„Méƒ½è¢«é˜»å¡äº†ï¼Œè€ŒPä¸­æœ‰å¾ˆå¤šå°±ç»ªä»»åŠ¡ï¼Œå°±ä¼šå»å¯»æ‰¾ç©ºé—²çš„Mï¼Œå¦‚æœæ²¡æœ‰ç©ºé—²çš„ï¼Œå°±ä¼šå»æ–°å»ºM ","date":"2022-03-07","objectID":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/:2:2","tags":["golang","cspå¹¶å‘æ¨¡å‹"],"title":"CSPå¹¶å‘æ¨¡å‹","uri":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"2.3ã€è°ƒåº¦å™¨è®¾è®¡ç­–ç•¥ 1ã€å¤ç”¨çº¿ç¨‹ é¿å…é¢‘ç¹çš„åˆ›å»ºã€é”€æ¯çº¿ç¨‹ work stealingæœºåˆ¶ å½“çº¿ç¨‹Mæ²¡æœ‰å¯ä»¥æ‰§è¡Œçš„Gæ—¶ï¼Œå°è¯•ä»å…¶ä»–çº¿ç¨‹ç»‘å®šçš„Pä¸­å·å–Gï¼Œè€Œä¸æ˜¯é”€æ¯çº¿ç¨‹ hand offæœºåˆ¶ å½“çº¿ç¨‹Må› ä¸ºGè¿›è¡Œç³»ç»Ÿè°ƒç”¨é˜»å¡æ—¶ï¼Œçº¿ç¨‹Mé‡Šæ”¾ç»‘å®šçš„Pï¼ŒæŠŠPç§»äº¤ç»™å…¶ä»–ç©ºé—²çš„çº¿ç¨‹æ‰§è¡Œ 2ã€æŠ¢å  ä¸€ä¸ªgoroutineæœ€å¤šå ç”¨cpu 10msï¼Œé˜²æ­¢å…¶ä»–goroutineè¢«é¥¿æ­» ","date":"2022-03-07","objectID":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/:2:3","tags":["golang","cspå¹¶å‘æ¨¡å‹"],"title":"CSPå¹¶å‘æ¨¡å‹","uri":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"2.4ã€go func() è°ƒåº¦è¿‡ç¨‹ 1ã€é€šè¿‡go func()åˆ›å»ºä¸€ä¸ªgoroutine 2ã€æ–°åˆ›å»ºçš„Gä¼šå…ˆä¿å­˜åœ¨Pçš„æœ¬åœ°é˜Ÿåˆ—ï¼Œå¦‚æœPçš„æœ¬åœ°é˜Ÿåˆ—æ»¡äº†ï¼Œå°±ä¼šå­˜æ”¾åœ¨å…¨å±€é˜Ÿåˆ—ä¸­ 3ã€Gåªèƒ½åœ¨Mä¸­è¿è¡Œï¼Œä¸€ä¸ªMåªèƒ½æœ‰ä¸€ä¸ªPã€‚Mä¼šä»Pçš„æœ¬åœ°é˜Ÿåˆ—è¯»å–ä¸€ä¸ªå¯æ‰§è¡Œçš„Gæ¥æ‰§è¡Œï¼Œå¦‚æœæœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºï¼Œå°±ä¼šæƒ³å…¶ä»–çš„MPä¸­å·å–ä¸€ä¸ªå¯æ‰§è¡Œçš„Gæ¥æ‰§è¡Œã€‚ 4ã€ä¸€ä¸ªMè°ƒåº¦Gçš„è¿‡ç¨‹æ˜¯å¾ªç¯è¿‡ç¨‹ 5ã€å½“Mæ‰§è¡ŒæŸä¸ªGå‘ç”Ÿsyscallæˆ–å…¶ä»–é˜»å¡æ“ä½œï¼ŒMä¼šé˜»å¡ï¼Œå¦‚æœå½“å‰æœ‰ä¸€äº›Gåœ¨æ‰§è¡Œï¼Œruntimeä¼šæŠŠè¿™ä¸ªçº¿ç¨‹Mä»Pä¸­æ‘˜é™¤(detach)ï¼Œç„¶åå†åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ 6ã€å½“Mç³»ç»Ÿè°ƒç”¨ç»“æŸï¼Œè¿™ä¸ªGä¼šå°è¯•è·å–ä¸€ä¸ªç©ºé—²çš„Pæ‰§è¡Œï¼Œå¹¶æ”¾å…¥åˆ°è¿™ä¸ªPçš„æœ¬åœ°é˜Ÿåˆ—ã€‚å¦‚æœè·å–ä¸åˆ°Pï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹Må°±ä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼ŒåŠ å…¥åˆ°ç©ºé—²çº¿ç¨‹ä¸­ï¼Œè¿™ä¸ªGä¼šè¢«æ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­ã€‚ M0ï¼šç¨‹åºå¯åŠ¨åçš„ç¼–å·ä¸º0çš„ä¸»çº¿ç¨‹ï¼Œè¿™ä¸ªMå¯¹åº”çš„å®ä¾‹ä¼šåœ¨å…¨å±€å˜é‡runtime.m0ä¸­ï¼Œä¸éœ€è¦åœ¨å †ä¸­åˆ†é…ï¼ŒM0è´Ÿè´£æ‰§è¡Œåˆå§‹åŒ–æ“ä½œå’Œå¯åŠ¨ç¬¬ä¸€ä¸ªGï¼Œåœ¨ä¹‹åå°±å’Œå…¶ä»–Mä¸€æ · G0ï¼šå¯åŠ¨æ¯ä¸ªMéƒ½ä¼šåˆ›å»ºçš„ç¬¬ä¸€ä¸ªgoroutineï¼ŒG0ä»…ç”¨äºè´Ÿè´£è°ƒåº¦çš„Gï¼ŒG0ä¸æŒ‡å‘ä»»ä½•å¯æ‰§è¡Œçš„å‡½æ•°ã€‚æ¯ä¸ªMéƒ½æœ‰è‡ªå·±çš„G0ã€‚åœ¨è°ƒåº¦æˆ–ç³»ç»Ÿè°ƒç”¨æ—¶ä¼šä½¿ç”¨G0çš„æ ˆç©ºé—´, å…¨å±€å˜é‡çš„G0æ˜¯M0çš„G0ã€‚ ","date":"2022-03-07","objectID":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/:2:4","tags":["golang","cspå¹¶å‘æ¨¡å‹"],"title":"CSPå¹¶å‘æ¨¡å‹","uri":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"ä¸‰ã€è°ƒåº¦æœºåˆ¶ Go0.xï¼šåŸºäºå•çº¿ç¨‹çš„è°ƒåº¦ Go1.0ï¼šåŸºäºå¤šçº¿ç¨‹çš„è°ƒåº¦ Go1.1ï¼šåŸºäºä»»åŠ¡çªƒå–çš„è°ƒåº¦ Go1.2-Go1.13ï¼šåŸºäºåä½œçš„æŠ¢å å¼è°ƒåº¦ Go1.14ï¼šåŸºäºä¿¡å·çš„æŠ¢å å¼è°ƒåº¦ ","date":"2022-03-07","objectID":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/:3:0","tags":["golang","cspå¹¶å‘æ¨¡å‹"],"title":"CSPå¹¶å‘æ¨¡å‹","uri":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"3.1ã€åŸºäºåä½œçš„æŠ¢å å¼è°ƒåº¦ goroutineæœ‰ä¸ªå­—æ®µstackguard0ï¼Œå½“è¯¥å­—æ®µè¢«è®¾ç½®æˆStackPreemptï¼Œæ„å‘³ç€å½“å‰goroutineå‘å‡ºäº†æŠ¢å è¯·æ±‚ï¼ŒåŒæ—¶è§¦å‘è°ƒåº¦å™¨æŠ¢å è®©å‡ºçº¿ç¨‹ã€‚ ç¼–è¯‘å™¨ä¼šåœ¨è°ƒç”¨å‡½æ•°å‰æ’å…¥runtime.morestackï¼Œå¯èƒ½ä¼šè°ƒç”¨runtime.newstackè¿›è¡ŒæŠ¢å  Goè¯­è¨€è¿è¡Œæ—¶ä¼šåœ¨åƒåœ¾å›æ”¶æš‚åœã€ç³»ç»Ÿç›‘æ§å‘ç°goroutineè¿è¡Œè¶…è¿‡10mså‘å‡ºæŠ¢å è¯·æ±‚ å½“å‘ç”Ÿå‡½æ•°è°ƒç”¨æ—¶ï¼Œè°ƒç”¨runtime.newstackæ£€æŸ¥goroutineçš„stackguard0å­—æ®µ å¦‚æœstackguard0æ˜¯StackPreemptï¼Œè§¦å‘æŠ¢å è®©å‡ºçº¿ç¨‹ ","date":"2022-03-07","objectID":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/:3:1","tags":["golang","cspå¹¶å‘æ¨¡å‹"],"title":"CSPå¹¶å‘æ¨¡å‹","uri":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"3.2ã€åŸºäºä¿¡å·çš„æŠ¢å å¼è°ƒåº¦ Goç¨‹åºå¯åŠ¨æ—¶ï¼Œä¼šåœ¨runtime.sighandleræ–¹æ³•æ³¨å†Œå¹¶ç»‘å®šSIGURGä¿¡å· func mstartm0() { initsig(false) } func initsig(preinit bool) { for i := uint32(0); i \u003c _NSIG; i++ { ... setsig(i, funcPC(sighandler)) } } ç»‘å®šç›¸åº”çš„runtime.doSigPreemptæŠ¢å æ–¹æ³• func sighandler(sig uint32, info *siginfo, ctxt unsafe.Pointer, gp *g) { ... if sig == sigPreempt { doSigPreempt(gp, c) } } åŒæ—¶åœ¨è°ƒåº¦çš„ç³»ç»Ÿç›‘æ§runtime.sysmonè°ƒç”¨retakeæ–¹æ³•å¤„ç†ï¼š æŠ¢å é˜»å¡åœ¨ç³»ç»Ÿè°ƒç”¨çš„P æŠ¢å è¿è¡Œæ—¶é—´è¿‡é•¿çš„G å½“ç¬¦åˆæ¡ä»¶æ—¶ï¼Œä¼šå‘é€ä¿¡å·ç»™Mã€‚Mæ”¶åˆ°ä¿¡å·å°†ä¼šç¡çœ æ­£åœ¨é˜»å¡çš„Gï¼Œè°ƒç”¨ç»‘å®šä¿¡å·æ–¹æ³•ï¼Œå¹¶é‡æ–°è°ƒåº¦ã€‚ ","date":"2022-03-07","objectID":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/:3:2","tags":["golang","cspå¹¶å‘æ¨¡å‹"],"title":"CSPå¹¶å‘æ¨¡å‹","uri":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"3.3ã€ä¸ºä»€ä¹ˆè¦æŠ¢å P package main import ( \"fmt\" \"runtime\" ) func main() { runtime.GOMAXPROCS(1) // åç¨‹1 go func() { for {} }() // åç¨‹2 go func() { fmt.Println(\"hello world\") }() select { } } åœ¨Go1.13ç‰ˆæœ¬ï¼Œæ˜¯æ²¡æœ‰è¾“å‡ºçš„ã€‚ åœ¨Go1.14ç‰ˆæœ¬ï¼Œæ˜¯èƒ½æ‰“å°\"hello world\"çš„ã€‚ å› ä¸ºä¸æŠ¢å ä¼šè¢«ä¸€ç›´æŒ‚èµ·(hang)ã€‚ ","date":"2022-03-07","objectID":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/:3:3","tags":["golang","cspå¹¶å‘æ¨¡å‹"],"title":"CSPå¹¶å‘æ¨¡å‹","uri":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"3.4ã€å¦‚ä½•æŠ¢å  åœ¨runtime.retakeæ–¹æ³•ï¼Œå¤„ç†ä¸€ä¸‹ä¸¤ç§åœºæ™¯ï¼š æŠ¢å é˜»å¡åœ¨ç³»ç»Ÿè°ƒç”¨ä¸Šçš„P æŠ¢å è¿è¡Œæ—¶é—´è¿‡é•¿çš„G func retake(now int64) uint32 { n := 0 lock(\u0026allpLock) for i := 0; i \u003c len(allp); i++ { _p_ := allp[i] if _p_ == nil { continue } pd := \u0026_p_.sysmontick s := _p_.status sysretake := false } unlock(\u0026allpLock) return uint32(n) } é¦–å…ˆä¼šå¯¹allpLockåŠ é”ï¼Œå¯ä»¥é˜²æ­¢å‘ç”Ÿå˜æ›´ã€‚ ç„¶åå¯¹æ‰€æœ‰çš„På¼€å§‹å¾ªç¯å¤„ç†ã€‚ åœºæ™¯1 t := int64(_p_.syscalltick) if !sysretake \u0026\u0026 int64(pd.syscalltick) != t { pd.syscalltick = uint32(t) pd.syscallwhen = now continue } å¦‚æœåœ¨ç³»ç»Ÿè°ƒç”¨ä¸­è¶…è¿‡sysmon ticjå‘¨æœŸï¼ˆè‡³å°‘20usï¼‰ï¼Œåˆ™ä¼šä»ç³»ç»Ÿè°ƒç”¨ä¸­æŠ¢å P åœºæ™¯2 if runqempty(_p_) \u0026\u0026 atomic.Load(\u0026sched.nmspinning)+atomic.Load(\u0026sched.npidle) \u003e 0 \u0026\u0026 pd.syscallwhen+10*1000*1000 \u003e now { continue } runqempty(_p_)åˆ¤æ–­pçš„ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œä»¥æ­¤æ¥æ£€æµ‹æœ‰æ²¡æœ‰å…¶ä»–ä»»åŠ¡éœ€è¦æ‰§è¡Œã€‚ atomic.Load(\u0026sched.nmspinning)+atomic.Load(\u0026sched.npidle) \u003e 0åˆ¤æ–­æ˜¯å¦å­˜åœ¨ç©ºé—²çš„På’Œæ­£åœ¨è¿›è¡Œè°ƒåº¦çªƒå–çš„P pd.syscallwhen+10*1000*1000 \u003e nowä¼šåˆ¤æ–­ç³»ç»Ÿè°ƒç”¨æ˜¯å¦è¶…è¿‡äº†10ms å®Œæˆæ¡ä»¶åˆ¤æ–­åï¼Œå°±è¿›å…¥äº†æŠ¢å æ­¥éª¤ unlock(\u0026allpLock) incidlelocked(-1) if atomic.Cas(\u0026_p_.status, s, _Pidle) { n++ _p_.syscalltick++ handoffp(_p_) } incidlelocked(1) lock(\u0026allpLock) è§£é” å‡å°‘é—²ç½® Mï¼šéœ€è¦åœ¨åŸå­æ“ä½œï¼ˆCASï¼‰ä¹‹å‰å‡å°‘é—²ç½® M çš„æ•°é‡ï¼ˆå‡è®¾æœ‰ä¸€ä¸ªæ­£åœ¨è¿è¡Œï¼‰ã€‚å¦åˆ™åœ¨å‘ç”ŸæŠ¢å¤º M æ—¶å¯èƒ½ä¼šé€€å‡ºç³»ç»Ÿè°ƒç”¨ï¼Œé€’å¢ nmidle å¹¶æŠ¥å‘Šæ­»é”äº‹ä»¶ã€‚ ä¿®æ”¹Pçš„çŠ¶æ€ä¸ºidleï¼Œä»¥ä¾¿äº¤ç»™å…¶ä»–Mä½¿ç”¨ æŠ¢å På’Œè°ƒåº¦Mï¼šè°ƒç”¨handoffpæ–¹æ³•ä»ç³»ç»Ÿè°ƒç”¨æˆ–é”å®šçš„Mä¸­å¼ºå Pï¼Œä¼šç”±æ–°çš„Mæ¥ç®¡è¿™ä¸ªP ","date":"2022-03-07","objectID":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/:3:4","tags":["golang","cspå¹¶å‘æ¨¡å‹"],"title":"CSPå¹¶å‘æ¨¡å‹","uri":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"å››ã€å®ä¾‹ 1ã€Pä¸Šå­˜åœ¨G1ï¼ŒM1è·å–Påæ‰§è¡ŒG1ï¼ŒG1ä½¿ç”¨go func()åˆ›å»ºäº†G2ï¼ŒG2ä¼šä¼˜å…ˆåŠ å…¥åˆ°Pçš„æœ¬åœ°é˜Ÿåˆ— 2ã€G1è¿è¡Œå®Œåï¼ŒMä¸Šè¿è¡Œçš„goroutineåˆ‡æ¢ä¸ºG0ï¼ŒG0èµ‹å€¼è°ƒåº¦åç¨‹çš„åˆ‡æ¢ã€‚ä»Pçš„æœ¬åœ°é˜Ÿåˆ—å–G2ï¼Œä»G0åˆ‡æ¢åˆ°G2ï¼Œå¼€å§‹è¿è¡ŒG2ã€‚ 3ã€å‡è®¾Pçš„æœ¬åœ°é˜Ÿåˆ—èƒ½å­˜å‚¨4ä¸ªGï¼ŒG2è¦åˆ›å»º6ä¸ªGï¼Œå‰4ä¸ªGï¼ˆG3ï¼ŒG4ï¼ŒG5ï¼ŒG6ï¼‰å·²ç»åŠ å…¥åˆ°Pçš„æœ¬åœ°é˜Ÿåˆ—ä¸­ï¼ŒPçš„æœ¬åœ°é˜Ÿåˆ—æ»¡äº† 4ã€G2åœ¨åˆ›å»ºG7æ—¶ï¼Œå‘ç°æœ¬åœ°é˜Ÿåˆ—æ»¡äº†ï¼Œä¼šæŠŠæœ¬åœ°é˜Ÿåˆ—çš„å‰ä¸€åŠçš„Gï¼ˆG3ï¼ŒG4ï¼‰ï¼Œè¿˜æœ‰æ–°åˆ›å»ºçš„Gè½¬ç§»åˆ°å…¨å±€é˜Ÿåˆ— 5ã€G2åœ¨åˆ›å»ºG8æ—¶ï¼ŒPçš„æœ¬åœ°é˜Ÿåˆ—æ²¡æœ‰æ»¡ï¼Œä¼šåŠ å…¥åˆ°æœ¬åœ°é˜Ÿåˆ—ä¸­ 6ã€M2ç»‘å®šçš„P2çš„æœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºï¼Œä¼šå»ä»å…¨å±€é˜Ÿåˆ—ä¸­æ‹¿ä¸€æ‰¹Gæ”¾åˆ°P2çš„æœ¬åœ°é˜Ÿåˆ—ã€‚å–çš„ä¸ªæ•°ä¸º n=min(len(global queue))/GOMAXPROCS+1,cap(local queue)/2 7ã€åŠ å…¥G2ä¸€ç›´åœ¨M1ä¸Šè¿è¡Œï¼Œè€ŒM2è¿è¡Œå®Œæœ¬åœ°é˜Ÿåˆ—å’Œå…¨å±€é˜Ÿåˆ—çš„Gï¼Œå°±ä¼šä»M1çš„Pä¸­å·å–ä¸€åŠçš„Gæ”¾åˆ°è‡ªå·±çš„æœ¬åœ°é˜Ÿåˆ—ä¸­æ‰§è¡Œ 8ã€æ­¤æ—¶M1æ­£åœ¨è¿è¡ŒG2ï¼ŒM2æ­£åœ¨è¿è¡ŒG8ã€‚G8åˆ›å»ºäº†G9åï¼Œå‘ç”Ÿäº†é˜»å¡çš„ç³»ç»Ÿè°ƒç”¨ï¼ŒM2å’ŒP2ä¼šå‘ç”Ÿè§£ç»‘ï¼ŒP2ä¼šæ‰§è¡Œå¦‚ä¸‹åˆ¤æ–­ï¼šå¦‚æœP2æœ¬åœ°é˜Ÿåˆ—æœ‰Gï¼Œå…¨å±€é˜Ÿåˆ—æœ‰Gæˆ–æœ‰ç©ºé—²çš„Mï¼ŒP2éƒ½ä¼šå”¤é†’ä¸€ä¸ªMå’Œå®ƒç»‘å®šï¼Œå¦åˆ™P2ä¼šåŠ å…¥åˆ°ç©ºé—²Påˆ—è¡¨ï¼Œç­‰å¾…Mæ¥è·å–å¯ç”¨çš„G 9ã€å‡å¦‚G8åˆ›å»ºäº†G9ï¼Œå‘ç”Ÿäº†éé˜»å¡ç³»ç»Ÿè°ƒç”¨ï¼ŒM2å’ŒP2ä¼šè§£ç»‘ï¼Œä½†M2ä¼šè®°ä½P2ï¼Œç„¶åG8å’ŒM2è¿›å…¥ç³»ç»Ÿè°ƒç”¨çŠ¶æ€ï¼Œå½“G8å’ŒM2é€€å‡ºç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œä¼šå°è¯•è·å–P2ï¼Œå¦‚æœæ— æ³•è·å–ï¼Œåˆ™è·å–ç©ºé—²çš„Pï¼Œå¦‚æœæ²¡æœ‰ï¼ŒG8è¢«æ ‡è®°ä¸ºå¯è¿è¡ŒçŠ¶æ€ï¼ŒåŠ å…¥åˆ°å…¨å±€é˜Ÿåˆ—ï¼ŒM2å› æ²¡æœ‰Pçš„ç»‘å®šè¿›å…¥ä¼‘çœ çŠ¶æ€ã€‚ ","date":"2022-03-07","objectID":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/:4:0","tags":["golang","cspå¹¶å‘æ¨¡å‹"],"title":"CSPå¹¶å‘æ¨¡å‹","uri":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"äº”ã€æ€»ç»“ Goè°ƒåº¦æœ¬è´¨æ˜¯æŠŠå¤§é‡çš„goroutineåˆ†é…åˆ°å°‘é‡çº¿ç¨‹ä¸Šå»æ‰§è¡Œï¼Œå¹¶åˆ©ç”¨å¤šæ ¸å¹¶è¡Œï¼Œå®ç°æ›´å¼ºå¤§çš„å¹¶å‘ã€‚ ","date":"2022-03-07","objectID":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/:5:0","tags":["golang","cspå¹¶å‘æ¨¡å‹"],"title":"CSPå¹¶å‘æ¨¡å‹","uri":"/2022/03/csp%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"åœ¨å¹¶å‘ç¨‹åºä¸­ï¼Œç”±äºè¶…æ—¶ã€å–æ¶ˆæ“ä½œæˆ–å…¶ä»–ä¸€äº›å¼‚å¸¸æƒ…å†µï¼Œå¾€å¾€éœ€è¦é€šçŸ¥å…¶ä»–goroutineï¼Œè™½ç„¶å¯ä»¥ä½¿ç”¨channelæ¥å¤„ç†è¿™äº›é—®é¢˜ï¼Œä½†æ˜¯ä¼šå˜å¾—éå¸¸ç¹çï¼Œè€Œä¸”ä¸åˆ©äºå¤šçº§ç®¡ç†ã€‚ goä½¿ç”¨Contextæ¥åšè§£å†³æ–¹æ¡ˆã€‚ ","date":"2022-03-07","objectID":"/2022/03/context/:0:0","tags":["context"],"title":"Contextæ§åˆ¶goroutineå¹¶å‘è¿è¡Œ","uri":"/2022/03/context/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"1ã€Contextæ¥å£ type Context interface { Deadline() (deadline time.Time, ok bool) Done() \u003c-chan struct{} Err() error Value(key interface{}) interface{} } Contextæ¥å£åŒ…å«4ä¸ªæ–¹æ³• Deadlineï¼šè¿”å›ç»‘å®šå½“å‰Contextçš„ä»»åŠ¡è¢«å–æ¶ˆçš„æˆªæ­¢æ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®æ—¶é—´ï¼Œok=false Doneï¼šcontextä»»åŠ¡è¢«å–æ¶ˆï¼Œè¿”å›ä¸€ä¸ªä¿¡å·struct{}ï¼Œå¦‚æœä¸è¢«å–æ¶ˆï¼Œè¿”å›nil Errï¼šå¦‚æœDoneå·²ç»å…³é—­ï¼Œå°†è¿”å›éç©ºçš„å€¼è¡¨æ˜ä»»åŠ¡ç»“æŸçš„åŸå›  Valueï¼šå­˜å‚¨çš„é”®å€¼å¯¹ä¸­å½“å‰keyå¯¹åº”çš„å€¼ ","date":"2022-03-07","objectID":"/2022/03/context/:1:0","tags":["context"],"title":"Contextæ§åˆ¶goroutineå¹¶å‘è¿è¡Œ","uri":"/2022/03/context/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"2ã€emptyCtx emptyCtxå…¶å®å°±æ˜¯ä¸€ä¸ªintç±»å‹çš„å˜é‡ï¼Œå®ç°äº†Contextæ¥å£ã€‚ å¦‚å…¶åï¼Œå°±æ˜¯ä¸€ä¸ªæ²¡æœ‰è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œä¸èƒ½å–æ¶ˆï¼Œä¹Ÿä¸èƒ½å­˜å‚¨é”®å€¼å¯¹çš„Contextã€‚ emptyCtxç”¨æ¥ä½œä¸ºcontextçš„æ ¹ç»“ç‚¹ã€‚ type emptyCtx int func (*emptyCtx) Deadline() (deadline time.Time, ok bool) { return } func (*emptyCtx) Done() \u003c-chan struct{} { return nil } func (*emptyCtx) Err() error { return nil } func (*emptyCtx) Value(key interface{}) interface{} { return nil } è€Œæˆ‘ä»¬é€šå¸¸ä¸ä¼šç›´æ¥ä½¿ç”¨emptyCtxï¼Œè€Œæ˜¯ä½¿ç”¨emptyCtxå®ä¾‹åŒ–çš„ä¸¤ä¸ªå˜é‡ var ( background = new(emptyCtx) todo = new(emptyCtx) ) func Background() Context { return background } func TODO() Context { return todo } Backgroundï¼šé€šå¸¸è¢«ç”¨ä½œä¸»å‡½æ•°ï¼Œåˆå§‹åŒ–ä»¥åŠæµ‹è¯•ä¸­ï¼Œä½œä¸ºé¡¶çº§çš„context TODOï¼šä¸ç¡®å®šä½¿ç”¨ä»€ä¹ˆcontextæ—¶ ","date":"2022-03-07","objectID":"/2022/03/context/:2:0","tags":["context"],"title":"Contextæ§åˆ¶goroutineå¹¶å‘è¿è¡Œ","uri":"/2022/03/context/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"3ã€valueCtx ","date":"2022-03-07","objectID":"/2022/03/context/:3:0","tags":["context"],"title":"Contextæ§åˆ¶goroutineå¹¶å‘è¿è¡Œ","uri":"/2022/03/context/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"3.1ã€åŸºç¡€ç±»å‹ type valueCtx struct { Context key, val interface{} } func (c *valueCtx) Value(key interface{}) interface{} { if c.key == key { return c.val } return c.Context.Value(key) } valueCtxåˆ©ç”¨äº†contextç±»å‹çš„å˜é‡æ¥è¡¨ç¤ºçˆ¶èŠ‚ç‚¹contextï¼Œç»§æ‰¿äº†çˆ¶contextçš„æ‰€æœ‰ä¿¡æ¯ã€‚ valueCtxæºå¸¦äº†ä¸€ä¸ªé”®å€¼å¯¹ï¼Œå®ç°äº†Valueæ–¹æ³•ï¼Œæ‰€ä»¥å¯ä»¥åœ¨contextä¸Šè·å–keyå¯¹åº”çš„å€¼ï¼Œå¦‚æœcontextä¸å­˜åœ¨ï¼Œä¼šæ²¿ç€çˆ¶contextå‘ä¸ŠæŸ¥æ‰¾ ","date":"2022-03-07","objectID":"/2022/03/context/:3:1","tags":["context"],"title":"Contextæ§åˆ¶goroutineå¹¶å‘è¿è¡Œ","uri":"/2022/03/context/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"3.2ã€å®ç°æ–¹æ³• func WithValue(parent Context, key, val interface{}) Context { if key == nil { panic(\"nil key\") } if !reflectlite.TypeOf(key).Comparable() { panic(\"key is not comparable\") } return \u0026valueCtx{parent, key, val} } å‘contextä¸­æ·»åŠ é”®å€¼å¯¹ï¼Œå¹¶ä¸æ˜¯ç›´æ¥åœ¨åŸcontextä¸Šç›´æ¥æ·»åŠ ï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„valueCtxï¼Œå°†é”®å€¼å¯¹æ·»åŠ åœ¨å­èŠ‚ç‚¹ä¸Šã€‚ ","date":"2022-03-07","objectID":"/2022/03/context/:3:2","tags":["context"],"title":"Contextæ§åˆ¶goroutineå¹¶å‘è¿è¡Œ","uri":"/2022/03/context/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"4ã€cancelCtx ","date":"2022-03-07","objectID":"/2022/03/context/:4:0","tags":["context"],"title":"Contextæ§åˆ¶goroutineå¹¶å‘è¿è¡Œ","uri":"/2022/03/context/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"4.1ã€åŸºç¡€ç±»å‹ type canceler interface { cancel(removeFromParent bool, err error) Done() \u003c-chan struct{} } type cancelCtx struct { Context mu sync.Mutex done chan struct{} children map[canceler]struct{} err error } å’ŒvalueCtxç±»ä¼¼ï¼Œä¹Ÿæœ‰çˆ¶contextï¼Œ é€šé“doneç”¨æ¥ä¼ é€’å…³é—­ä¿¡å·ã€‚ childrenå­˜å‚¨äº†contextèŠ‚ç‚¹ä¸‹çš„å­èŠ‚ç‚¹ï¼Œ errç”¨äºå­˜å‚¨å–æ¶ˆåŸå›  func (c *cancelCtx) Value(key interface{}) interface{} { if key == \u0026cancelCtxKey { return c } return c.Context.Value(key) } func (c *cancelCtx) Done() \u003c-chan struct{} { c.mu.Lock() if c.done == nil { c.done = make(chan struct{}) } d := c.done c.mu.Unlock() return d } func (c *cancelCtx) Err() error { c.mu.Lock() err := c.err c.mu.Unlock() return err } ","date":"2022-03-07","objectID":"/2022/03/context/:4:1","tags":["context"],"title":"Contextæ§åˆ¶goroutineå¹¶å‘è¿è¡Œ","uri":"/2022/03/context/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"4.2ã€å®ç°æ–¹æ³• func WithCancel(parent Context) (ctx Context, cancel CancelFunc) { c := newCancelCtx(parent) propagateCancel(parent, \u0026c) return \u0026c, func() { c.cancel(true, Canceled) } } newCancelCtxåªæ˜¯åˆå§‹åŒ–äº†cancelCtx func newCancelCtx(parent Context) cancelCtx { return cancelCtx{Context: parent} } propagateCancelå»ºç«‹å½“å‰èŠ‚ç‚¹ä¸çˆ¶èŠ‚ç‚¹çš„å–æ¶ˆé€»è¾‘ func propagateCancel(parent Context, child canceler) { done := parent.Done() if done == nil { return } select { case \u003c-done: child.cancel(false, parent.Err()) return default: } if p, ok := parentCancelCtx(parent); ok { p.mu.Lock() if p.err != nil { child.cancel(false, p.err) } else { if p.children == nil { p.children = make(map[canceler]struct{}) } p.children[child] = struct{}{} } p.mu.Unlock() } else { atomic.AddInt32(\u0026goroutines, +1) go func() { select { case \u003c-parent.Done(): child.cancel(false, parent.Err()) case \u003c-child.Done(): } }() } } 1ã€å¦‚æœçˆ¶contextå·²ç»å–æ¶ˆäº†ï¼Œå°±ç›´æ¥è¿”å›ï¼Œå› ä¸ºçˆ¶èŠ‚ç‚¹ä¸å¯èƒ½å†è¢«å–æ¶ˆäº† 2ã€ç›‘å¬ä¿¡å·doneï¼Œå¦‚æœæ¥æ”¶åˆ°äº†å°±é€šçŸ¥å­contextå–æ¶ˆ 3ã€å¦‚æœæ‰¾åˆ°çˆ¶contextï¼Œå°±æŒ‚åœ¨çˆ¶contextä¸Š 4ã€å¦‚æœæ²¡æœ‰æ‰¾åˆ°çˆ¶contextï¼Œä¹Ÿå°±æ˜¯è‡ªèº«æ˜¯æ ¹contextï¼Œå°±å¯åŠ¨ä¸€ä¸ªgoroutineç›‘å¬ä¿¡å· è€Œè°ƒç”¨çš„cancelæ–¹æ³•ï¼Œå…¶å®å°±æ˜¯å…³é—­é€šé“åŠè®¾ç½®åŸå›  func (c *cancelCtx) cancel(removeFromParent bool, err error) { if err == nil { panic(\"context: internal error: missing cancel error\") } c.mu.Lock() if c.err != nil { c.mu.Unlock() return // already canceled } c.err = err if c.done == nil { c.done = closedchan } else { close(c.done) } for child := range c.children { child.cancel(false, err) } c.children = nil c.mu.Unlock() if removeFromParent { removeChild(c.Context, c) } } ","date":"2022-03-07","objectID":"/2022/03/context/:4:2","tags":["context"],"title":"Contextæ§åˆ¶goroutineå¹¶å‘è¿è¡Œ","uri":"/2022/03/context/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"5ã€timerCtx ","date":"2022-03-07","objectID":"/2022/03/context/:5:0","tags":["context"],"title":"Contextæ§åˆ¶goroutineå¹¶å‘è¿è¡Œ","uri":"/2022/03/context/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"5.1ã€åŸºç¡€ç±»å‹ type timerCtx struct { cancelCtx timer *time.Timer deadline time.Time } func (c *timerCtx) Deadline() (deadline time.Time, ok bool) { return c.deadline, true } timerå£°æ˜äº†ä¸€ä¸ªå®šæ—¶å™¨ï¼Œç”¨äºå‘é€æˆªæ­¢æ—¶é—´ ","date":"2022-03-07","objectID":"/2022/03/context/:5:1","tags":["context"],"title":"Contextæ§åˆ¶goroutineå¹¶å‘è¿è¡Œ","uri":"/2022/03/context/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"5.2ã€å®ç°æ–¹æ³• func WithDeadline(parent Context, d time.Time) (Context, CancelFunc) { if cur, ok := parent.Deadline(); ok \u0026\u0026 cur.Before(d) { return WithCancel(parent) } c := \u0026timerCtx{ cancelCtx: newCancelCtx(parent), deadline: d, } propagateCancel(parent, c) dur := time.Until(d) if dur \u003c= 0 { c.cancel(true, DeadlineExceeded) return c, func() { c.cancel(false, Canceled) } } c.mu.Lock() defer c.mu.Unlock() if c.err == nil { c.timer = time.AfterFunc(dur, func() { c.cancel(true, DeadlineExceeded) }) } return c, func() { c.cancel(true, Canceled) } } å¤§è‡´å’ŒcancelCtxå·®ä¸å¤šï¼Œå¤šäº†å£°æ˜çš„å®šæ—¶å™¨ï¼Œç”¨äºå‘é€æˆªæ­¢æ—¶é—´ã€‚ è€ŒtimerCtx.cancelæœ‰äº›ä¸ä¸€æ ·ï¼Œæ˜¯å…³é—­å®šæ—¶å™¨çš„ã€‚ func (c *timerCtx) cancel(removeFromParent bool, err error) { c.cancelCtx.cancel(false, err) if removeFromParent { removeChild(c.cancelCtx.Context, c) } c.mu.Lock() if c.timer != nil { c.timer.Stop() c.timer = nil } c.mu.Unlock() } å…³äºtimerCtxè¿˜æœ‰ä¸€ä¸ªæ–¹æ³• func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc) { return WithDeadline(parent, time.Now().Add(timeout)) } ä¸WithDeadlineç±»ä¼¼ï¼Œåªä¸è¿‡æ˜¯åˆ›å»ºäº†ä¸€ä¸ªè¿‡æœŸæ—¶é—´çš„context ","date":"2022-03-07","objectID":"/2022/03/context/:5:2","tags":["context"],"title":"Contextæ§åˆ¶goroutineå¹¶å‘è¿è¡Œ","uri":"/2022/03/context/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"6ã€æ€»ç»“ contextä¸»è¦ç”¨äºçˆ¶å­ä¹‹é—´åŒæ­¥ä¿¡å·ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ç§åç¨‹è°ƒåº¦æ–¹å¼ contextæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºcontextæœ¬èº«ä¸å˜ çˆ¶contexté€šçŸ¥å­contextå–æ¶ˆï¼Œä½†æ˜¯ä¸ä¼šå¹²æ¶‰å­ä»»åŠ¡çš„æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´contextçš„å–æ¶ˆæœºåˆ¶æ˜¯æ— ä¾µå…¥çš„ å­contextçš„å–æ¶ˆæ˜¯ä¸ä¼šå½±å“çˆ¶contextçš„ ","date":"2022-03-07","objectID":"/2022/03/context/:6:0","tags":["context"],"title":"Contextæ§åˆ¶goroutineå¹¶å‘è¿è¡Œ","uri":"/2022/03/context/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"beego æ˜¯ä¸€ä¸ªå¿«é€Ÿå¼€å‘ Go åº”ç”¨çš„ HTTP æ¡†æ¶ï¼Œå¯ä»¥ç”¨æ¥å¿«é€Ÿå¼€å‘ APIã€Web åŠåç«¯æœåŠ¡ç­‰å„ç§åº”ç”¨ï¼Œæ˜¯ä¸€ä¸ª RESTful çš„æ¡†æ¶ã€‚ é‚£ä¹ˆè¿™ç§RESTfuleè·¯ç”±åˆ°åº•æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿå¸¦ç€è¿™ä¸ªç–‘é—®ï¼Œæˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹å®ç°è¿‡ç¨‹ã€‚ ","date":"2022-03-07","objectID":"/2022/03/beego_router/:0:0","tags":["beego"],"title":"Beegoè·¯ç”±---å‰ç¼€æ ‘","uri":"/2022/03/beego_router/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"ä¸€ã€ä½¿ç”¨æ–¹æ³• package main import ( beego \"github.com/beego/beego/v2/server/web\" ) type MainController struct { beego.Controller } func (this *MainController) Get() { this.Ctx.WriteString(\"Hello world\") } func main() { beego.Router(\"/\", \u0026MainController{}) beego.Run() } è¿™ä¸ªå°±æ˜¯beegoæ¡†æ¶çš„ç®€å•ä½¿ç”¨ã€‚å½“ç„¶è¿˜æœ‰ä¸€äº›RESTfulçš„ä½¿ç”¨ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€èµ˜è¿°äº†ã€‚ ","date":"2022-03-07","objectID":"/2022/03/beego_router/:1:0","tags":["beego"],"title":"Beegoè·¯ç”±---å‰ç¼€æ ‘","uri":"/2022/03/beego_router/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"äºŒã€å‰ç¼€æ ‘ Tireæ ‘ï¼Œå³å­—å…¸æ ‘ï¼Œåˆç§°å•è¯æŸ¥æ‰¾æ ‘æˆ–é”®æ ‘ï¼Œæ˜¯ä¸€ç§æ ‘å½¢ç»“æ„ï¼Œæ˜¯ä¸€ç§å“ˆå¸Œæ ‘çš„å˜ç§ã€‚å…¸å‹åº”ç”¨æ˜¯ç”¨äºç»Ÿè®¡å’Œæ’åºå¤§é‡çš„å­—ç¬¦ä¸²ï¼ˆä½†ä¸ä»…é™äºå­—ç¬¦ä¸²ï¼‰ï¼Œæ‰€ä»¥ç»å¸¸è¢«æœç´¢å¼•æ“ç³»ç»Ÿç”¨äºæ–‡æœ¬è¯é¢‘ç»Ÿè®¡ã€‚ å®ƒçš„ä¼˜ç‚¹æ˜¯ï¼šæœ€å¤§é™åº¦åœ°å‡å°‘æ— è°“çš„å­—ç¬¦ä¸²æ¯”è¾ƒï¼ŒæŸ¥è¯¢æ•ˆç‡æ¯”å“ˆå¸Œè¡¨é«˜ã€‚ Trieçš„æ ¸å¿ƒæ€æƒ³æ˜¯ç©ºé—´æ¢æ—¶é—´ã€‚åˆ©ç”¨å­—ç¬¦ä¸²çš„å…¬å…±å‰ç¼€æ¥é™ä½æŸ¥è¯¢æ—¶é—´çš„å¼€é”€ä»¥è¾¾åˆ°æé«˜æ•ˆç‡çš„ç›®çš„ã€‚ é‚£ä¹ˆåœ¨å­—å…¸æ ‘ä¸­æœç´¢æ·»åŠ è¿‡çš„å•è¯çš„æ­¥éª¤å¦‚ä¸‹ï¼š 1ã€ä»æ ¹èŠ‚ç‚¹å¼€å§‹æœç´¢ 2ã€å–å¾—è¦æŸ¥æ‰¾å•è¯çš„ç¬¬ä¸€ä¸ªå­—æ¯ï¼Œå¹¶æ ¹æ®è¯¥å­—æ¯å¯¹åº”çš„å­—ç¬¦è·¯å¾„å‘ä¸‹æœç´¢ 3ã€å­—ç¬¦è·¯å¾„æŒ‡å‘çš„ç¬¬äºŒå±‚èŠ‚ç‚¹ä¸Šï¼Œæ ¹æ®ç¬¬äºŒä¸ªå­—æ¯é€‰æ‹©å¯¹åº”çš„å­—ç¬¦è·¯å¾„å‘ä¸‹ç»§ç»­æœç´¢ 4ã€ä¸€ç›´å‘ä¸‹æœç´¢ï¼Œå¦‚æœå•è¯æœç´¢å®Œæˆï¼Œæ‰¾åˆ°çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¶å­èŠ‚ç‚¹ï¼Œè¯´æ˜å­—å…¸æ ‘ä¸­å­˜åœ¨è¿™ä¸ªå•è¯ï¼Œå¦‚æœæ‰¾åˆ°çš„ä¸æ˜¯å¶å­èŠ‚ç‚¹ï¼Œè¯´æ˜å•è¯ä¸æ˜¯å­—å…¸æ ‘ä¸­æ·»åŠ è¿‡çš„å•è¯ã€‚ ","date":"2022-03-07","objectID":"/2022/03/beego_router/:2:0","tags":["beego"],"title":"Beegoè·¯ç”±---å‰ç¼€æ ‘","uri":"/2022/03/beego_router/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"ä¸‰ã€beegoçš„å‰ç¼€æ ‘ ","date":"2022-03-07","objectID":"/2022/03/beego_router/:3:0","tags":["beego"],"title":"Beegoè·¯ç”±---å‰ç¼€æ ‘","uri":"/2022/03/beego_router/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"1ã€æ•°æ®ç»“æ„ // è·¯ç”±æ ‘ type ControllerRegister struct { routers map[string]*Tree } // æ ‘èŠ‚ç‚¹ç»“æ„ type Tree struct { // è·¯ç”±å‰ç¼€ prefix string // å®Œå…¨è·¯ç”±ä¿¡æ¯ fixrouters []*Tree // if set, failure to match fixrouters search then search wildcard wildcard *Tree // if set, failure to match wildcard search leaves []*leafInfo } // å¶å­èŠ‚ç‚¹ç»“æ„ type leafInfo struct { // names of wildcards that lead to this leaf. eg, [\"id\" \"name\"] for the wildcard \":id\" and \":name\" wildcards []string // if the leaf is regexp regexps *regexp.Regexp runObject interface{} } ControllerRegisteræ˜¯æ‰€æœ‰è·¯ç”±çš„é›†åˆï¼Œé‡Œé¢çš„routersæ˜¯æ–¹æ³•çš„é›†åˆï¼Œkeyæ˜¯httpçš„æ–¹æ³•ï¼šGET,POST,PUTç­‰ï¼ŒTreeå°±æ˜¯è·¯ç”±çš„å‰ç¼€æ ‘äº†ã€‚ åªä¸è¿‡è¿™ä¸ªè·¯ç”±å‰ç¼€æ ‘å’Œå‰ç¼€æ ‘å¹¶ä¸å®Œå…¨ç›¸åŒï¼Œè¿˜å­˜åœ¨é€šé…ç¬¦/user/:idå’Œ/user/*è¿™ç§æƒ…å†µï¼Œæ‰€ä»¥æ·»åŠ äº†wildcardç”¨äºåŒ¹é…è¿™ä¸¤ç§æƒ…å†µã€‚ ","date":"2022-03-07","objectID":"/2022/03/beego_router/:3:1","tags":["beego"],"title":"Beegoè·¯ç”±---å‰ç¼€æ ‘","uri":"/2022/03/beego_router/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"2ã€è·¯ç”±æ³¨å†Œ æˆ‘ä»¬çš„è·¯ç”±ç”±ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š 1ã€å…¨åŒ¹é…è·¯ç”± /user/list 2ã€æ­£åˆ™è·¯ç”± /user/:id /user/:id()[0-9]+) /user/* æ·»åŠ è·¯ç”±çš„æ—¶å€™ï¼Œå®é™…æ˜¯è°ƒç”¨äº† func (p *ControllerRegister) addToRouter(method, pattern string, r *ControllerInfo) { if !p.cfg.RouterCaseSensitive { pattern = strings.ToLower(pattern) } if t, ok := p.routers[method]; ok { t.AddRouter(pattern, r) } else { t := NewTree() t.AddRouter(pattern, r) p.routers[method] = t } } è¿™ä¸ªä»£ç ä¹Ÿç®€å•æ˜äº†ï¼ŒæŸ¥æ‰¾è¿™ä¸ªè·¯ç”±çš„æ–¹æ³•æ ‘ï¼Œå¦‚æœå­˜åœ¨å°±æ·»åŠ è¿™ä¸ªæ–¹æ³•ï¼Œå¦‚æœä¸å­˜åœ¨å°±æ–°å»ºæ–¹æ³•æ ‘ï¼Œç„¶åå†æ·»åŠ ã€‚ è€Œè°ƒç”¨çš„æ˜¯AddRouterè¿™ä¸ªå‡½æ•°ã€‚ // åœ¨è·¯ç”±æ ‘ä¸Šæ·»åŠ è·¯ç”±ï¼Œpatternæ˜¯è·¯ç”±ä¿¡æ¯ï¼ŒrunObjectæ˜¯æ‰§è¡Œæ–¹æ³• func (t *Tree) AddRouter(pattern string, runObject interface{}) { t.addseg(splitPath(pattern), runObject, nil, \"\") } è¿™ä¸ªsplitPathå‡½æ•°å°±æ˜¯å°†è·¯ç”±ä»¥/åˆ†å‰²ã€‚ è€Œæ·»åŠ çš„è¿‡ç¨‹å½“ç„¶æ˜¯å…¨åŒ¹é…è·¯ç”±åœ¨fixroutersï¼Œæ­£åˆ™è·¯ç”±åœ¨wildcardã€‚ func (t *Tree) addseg(segments []string, route interface{}, wildcards []string, reg string) { if len(segments) == 0 { // åœ¨å¶å­èŠ‚ç‚¹ä¸Šæ·»åŠ æ–¹æ³• if reg != \"\" { t.leaves = append(t.leaves, \u0026leafInfo{runObject: route, wildcards: wildcards, regexps: regexp.MustCompile(\"^\" + reg + \"$\")}) } else { t.leaves = append(t.leaves, \u0026leafInfo{runObject: route, wildcards: wildcards}) } } else { seg := segments[0] // splitSegmentèµ·åˆ°çš„ä½œç”¨æ˜¯åˆ†æseg // \"admin\" -\u003e false, nil, \"\" // \":id\" -\u003e true, [:id], \"\" // \"?:id\" -\u003e true, [: :id], \"\" : meaning can empty // \"ğŸ†”int\" -\u003e true, [:id], ([0-9]+) // \":name:string\" -\u003e true, [:name], ([\\w]+) // \":id([0-9]+)\" -\u003e true, [:id], ([0-9]+) // \":id([0-9]+)_:name\" -\u003e true, [:id :name], ([0-9]+)_(.+) // \"cms_:id_:page.html\" -\u003e true, [:id_ :page], cms_(.+)(.+).html // \"cms_:id(.+)_:page.html\" -\u003e true, [:id :page], cms_(.+)_(.+).html // \"*\" -\u003e true, [:splat], \"\" // \"*.*\" -\u003e true,[. :path :ext], \"\" . meaning separator iswild, params, regexpStr := splitSegment(seg) // if it's ? meaning can igone this, so add one more rule for it if len(params) \u003e 0 \u0026\u0026 params[0] == \":\" { t.addseg(segments[1:], route, wildcards, reg) params = params[1:] } // Rule: /login/*/access match /login/2009/11/access // if already has *, and when loop the access, should as a regexpStr if !iswild \u0026\u0026 utils.InSlice(\":splat\", wildcards) { iswild = true regexpStr = seg } // Rule: /user/:id/* if seg == \"*\" \u0026\u0026 len(wildcards) \u003e 0 \u0026\u0026 reg == \"\" { regexpStr = \"(.+)\" } if iswild { // ... çœç•¥ä»£ç  // ä¸»è¦æ˜¯é€šé…ç¬¦åˆ¤æ–­é€»è¾‘ t.wildcard.addseg(segments[1:], route, append(wildcards, params...), reg+regexpStr) } else { var subTree *Tree // è¿™é‡Œæ·»åŠ çš„æ˜¯å…¨åŒ¹é…è·¯ç”± for _, sub := range t.fixrouters { if sub.prefix == seg { subTree = sub break } } if subTree == nil { subTree = NewTree() subTree.prefix = seg t.fixrouters = append(t.fixrouters, subTree) } subTree.addseg(segments[1:], route, wildcards, reg) } } } ä¸»è¦å°±æ˜¯åˆ¤æ–­ç»™çš„è·¯ç”±æ•°æ®æ˜¯å¦å­˜åœ¨é€šé…ç¬¦ï¼Œç„¶ååˆ†æƒ…å†µè®¨è®ºã€‚ æœ€ç®€å•çš„å°±æ˜¯æ™®é€šè·¯ç”±äº†ï¼Œç›´æ¥æ·»åŠ åˆ°fixroutersé‡Œã€‚ è€Œæ­£åˆ™è·¯ç”±æ ¹æ®å„ç§æƒ…å†µï¼Œæ·»åŠ åˆ°wildcardsé‡Œã€‚ ","date":"2022-03-07","objectID":"/2022/03/beego_router/:3:2","tags":["beego"],"title":"Beegoè·¯ç”±---å‰ç¼€æ ‘","uri":"/2022/03/beego_router/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"3ã€è·¯ç”±æŸ¥æ‰¾ å¾ˆæ˜¾ç„¶ï¼Œæ˜¯è¦å…ˆåŒ¹é…fixroutersï¼Œå¦‚æœæ²¡æœ‰å¯¹åº”çš„è·¯ç”±ï¼Œå†åˆ°wildcardsä¸­æŸ¥æ‰¾è·¯ç”±ï¼Œè¿”å›å¯¹åº”çš„leavesé‡Œçš„æ–¹æ³•ã€‚ æŸ¥æ‰¾è·¯ç”±çš„æ–¹æ³•å’Œæ’å…¥çš„å·®ä¸å¤šï¼Œè¿™é‡Œå°±ä¸è´´ä»£ç äº†ã€‚ ","date":"2022-03-07","objectID":"/2022/03/beego_router/:3:3","tags":["beego"],"title":"Beegoè·¯ç”±---å‰ç¼€æ ‘","uri":"/2022/03/beego_router/"},{"categories":["æœˆéœœå¤©çš„å°éšç¬”"],"content":"å››ã€æ€»ç»“ beegoçš„è·¯ç”±å¯¹å‰ç¼€æ ‘åšäº†ä¸€ç‚¹ä¼˜åŒ–ï¼ŒæŒ‰ç…§/åˆ†å‰²è·¯ç”±ï¼ŒæŠŠè¿™éƒ¨åˆ†æ”¾åˆ°å‰ç¼€æ ‘çš„å€¼ä¸­ï¼Œå‡å°‘äº†å‰ç¼€æ ‘çš„æ·±åº¦ï¼Œæ¯•ç«Ÿå¦‚æœæŒ‰ç…§å­—ç¬¦åˆ‡åˆ†çš„è¯ï¼Œå‰ç¼€æ ‘ä¼šå¾ˆæ·±ï¼Œè€Œä¸”å¯¹æ­£åˆ™è¡¨ç°ä¹Ÿä¸ä¼šå‹å¥½ã€‚ ","date":"2022-03-07","objectID":"/2022/03/beego_router/:4:0","tags":["beego"],"title":"Beegoè·¯ç”±---å‰ç¼€æ ‘","uri":"/2022/03/beego_router/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"åœ¨æ—¥å¸¸å·¥ä½œä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šç”¨å…³é”®å­—goèµ·ä¸€ä¸ªgoroutineã€‚ ä½†æ˜¯åœ¨è·‘ä¸€æ®µæ—¶é—´åï¼Œå¯èƒ½ä¼šé‡åˆ°ä¸€äº›é—®é¢˜ï¼šå½“goroutineå†…çš„ä»»åŠ¡è¿è¡Œçš„å¤ªä¹…ï¼Œå†…å­˜æ³„éœ²ï¼Œæˆ–ä¸€ç›´é˜»å¡ï¼Œå˜æˆgoroutineæ³„éœ²ç­‰ä¸€äº›é—®é¢˜ã€‚ é‚£ä¹ˆå¦‚ä½•åœæ­¢goroutineï¼Œå°±éœ€è¦æˆ‘ä»¬æ¥äº†è§£äº†ã€‚ é€šå¸¸ä¼šæœ‰ä¸‰ç§æ–¹æ³•ï¼š ä¿¡å·é‡ context ä¿¡å·é‡+context ","date":"2021-07-27","objectID":"/2021/07/%E5%81%9C%E6%AD%A2goroutine%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/:0:0","tags":["goroutine","golang"],"title":"åœæ­¢goroutineçš„å‡ ç§æ–¹æ³•","uri":"/2021/07/%E5%81%9C%E6%AD%A2goroutine%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"ä¿¡å·é‡ 1ã€å€ŸåŠ©äºchannelçš„closeæ–¹æ³•å…³é—­é€šé“æ¥å…³é—­åç¨‹ func main() { ch := make(chan int, 1) go func() { for { v,ok := \u003c- ch if !ok { fmt.Println(\"ç»“æŸgoroutine\") return } fmt.Println(v) } }() ch \u003c- 1 ch \u003c- 2 close(ch) time.Sleep(time.Second) } å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨for rangeçš„ç‰¹æ€§ go func() { for v := range ch { fmt.Println(v) } }() 2ã€ä½¿ç”¨ä¿¡å·é‡è¿›è¡Œé€šçŸ¥ func main() { ch := make(chan int, 1) done := make(chan struct{}) go func() { for { select { case \u003c-ch: case \u003c-done: close(ch) fmt.Println(\"å…³é—­channel\") return } } }() ch \u003c- 1 ch \u003c- 2 done \u003c- struct{}{} time.Sleep(time.Second) } åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œå£°æ˜å˜é‡doneï¼Œç±»å‹æ˜¯channelï¼Œä½œä¸ºä¿¡å·é‡å¤„ç†goroutineçš„å…³é—­ã€‚ åˆ©ç”¨for-loopç»“åˆselectå…³é”®å­—æ¥ç›‘å¬ï¼Œå¤„ç†ç›¸å…³çš„é€»è¾‘åï¼Œå†è°ƒç”¨closeæ¥çœŸæ­£å…³é—­channelã€‚ ","date":"2021-07-27","objectID":"/2021/07/%E5%81%9C%E6%AD%A2goroutine%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/:1:0","tags":["goroutine","golang"],"title":"åœæ­¢goroutineçš„å‡ ç§æ–¹æ³•","uri":"/2021/07/%E5%81%9C%E6%AD%A2goroutine%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"context å¯ä»¥å€ŸåŠ©ä¸Šä¸‹æ–‡Contextæ¥åšgoroutineçš„æ§åˆ¶å’Œå…³é—­ã€‚ func main() { ch := make(chan int, 1) ctx,cancel := context.WithTimeout(context.Background(), time.Second) defer cancel() go func() { for { select { case \u003c-ch: case \u003c-ctx.Done(): close(ch) fmt.Println(\"å…³é—­channel\") return } } }() ch \u003c- 1 ch \u003c- 2 time.Sleep(time.Second * 2) } åœ¨contextä¸­ï¼Œä½¿ç”¨ctx.Doneè·å–ä¸€ä¸ªåªè¯»çš„channelï¼Œæ ‡è¯†å½“å‰çš„channelæ˜¯å¦å…³é—­ï¼Œå¯èƒ½æ˜¯åˆ°æœŸï¼Œä¹Ÿå¯èƒ½æ˜¯è¢«å–æ¶ˆã€‚ ","date":"2021-07-27","objectID":"/2021/07/%E5%81%9C%E6%AD%A2goroutine%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/:2:0","tags":["goroutine","golang"],"title":"åœæ­¢goroutineçš„å‡ ç§æ–¹æ³•","uri":"/2021/07/%E5%81%9C%E6%AD%A2goroutine%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"å…³é—­å…¶ä»–goroutine æˆ‘æƒ³åœ¨ goroutineA é‡Œå»åœæ­¢ goroutineBï¼Œæœ‰åŠæ³•å—ï¼Ÿ ç­”æ¡ˆæ˜¯ä¸èƒ½ï¼Œå› ä¸ºåœ¨ Go è¯­è¨€ä¸­ï¼Œgoroutine åªèƒ½è‡ªå·±ä¸»åŠ¨é€€å‡ºï¼Œä¸€èˆ¬é€šè¿‡ channel æ¥æ§åˆ¶ï¼Œä¸èƒ½è¢«å¤–ç•Œçš„å…¶ä»– goroutine å…³é—­æˆ–å¹²æ‰ï¼Œä¹Ÿæ²¡æœ‰ goroutine å¥æŸ„çš„æ˜¾å¼æ¦‚å¿µã€‚ question: is it possible to a goroutine immediately stop another goroutine? åœ¨ Go issues ä¸­ä¹Ÿæœ‰äººæè¿‡ç±»ä¼¼é—®é¢˜ï¼ŒDave Cheney ç»™å‡ºäº†ä¸€äº›æ€è€ƒï¼š å¦‚æœä¸€ä¸ª goroutine è¢«å¼ºè¡Œåœæ­¢äº†ï¼Œå®ƒæ‰€æ‹¥æœ‰çš„èµ„æºä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿå †æ ˆè¢«è§£å¼€äº†å—ï¼Ÿdefer æ˜¯å¦è¢«æ‰§è¡Œï¼Ÿ å¦‚æœæ‰§è¡Œ deferï¼Œè¯¥ goroutine å¯èƒ½å¯ä»¥ç»§ç»­æ— é™æœŸåœ°ç”Ÿå­˜ä¸‹å»ã€‚ å¦‚æœä¸æ‰§è¡Œ deferï¼Œè¯¥ goroutine åŸæœ¬çš„åº”ç”¨ç¨‹åºç³»ç»Ÿè®¾è®¡é€»è¾‘å°†ä¼šè¢«ç ´åï¼Œè¿™è‚¯å®šä¸åˆç†ã€‚ å¦‚æœå…è®¸å¼ºåˆ¶åœæ­¢ goroutineï¼Œæ˜¯è¦é‡Šæ”¾æ‰€æœ‰ä¸œè¥¿ï¼Œè¿˜æ˜¯ç›´æ¥æŠŠå®ƒä»è°ƒåº¦å™¨ä¸­è¸¢å‡ºå»ï¼Œä½ æƒ³é€šè¿‡æ­¤è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ è¿™éƒ½æ˜¯å€¼å¾—æ·±æ€çš„ï¼Œå¦å¤–ä¸€æ—¦æ”¾å¼€è¿™ç§é™åˆ¶ã€‚ä½œä¸ºç¨‹åºå‘˜ï¼Œä½ ç»´æŠ¤ä»£ç ã€‚å¾ˆæœ‰å¯èƒ½å°±ä¸çŸ¥é“ goroutine çš„å¥æŸ„è¢«ä¼ åˆ°äº†å“ªé‡Œï¼Œåˆæ˜¯åœ¨ä½•æ—¶ä½•åœ°è¢«äººè«åå…¶å¦™å…³é—­ï¼Œéå¸¸ç³Ÿç³•â€¦ ","date":"2021-07-27","objectID":"/2021/07/%E5%81%9C%E6%AD%A2goroutine%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/:3:0","tags":["goroutine","golang"],"title":"åœæ­¢goroutineçš„å‡ ç§æ–¹æ³•","uri":"/2021/07/%E5%81%9C%E6%AD%A2goroutine%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"å…¶ä»–æ–¹æ³• mainå‡½æ•°é€€å‡ºï¼Œgoroutineä¹Ÿä¼šé€€å‡º runtime.Goexit()æ–¹æ³•å¯ä»¥ä½¿goroutineé€€å‡º ","date":"2021-07-27","objectID":"/2021/07/%E5%81%9C%E6%AD%A2goroutine%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/:4:0","tags":["goroutine","golang"],"title":"åœæ­¢goroutineçš„å‡ ç§æ–¹æ³•","uri":"/2021/07/%E5%81%9C%E6%AD%A2goroutine%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"æ€»ç»“ goroutine çš„è®¾è®¡å°±æ˜¯è¿™æ ·çš„ï¼ŒåŒ…æ‹¬åƒ goroutine+panic+recover çš„è®¾è®¡ä¹Ÿæ˜¯éµå¾ªè¿™ä¸ªåŸç†ï¼Œå› æ­¤ä¹Ÿæœ‰çš„ Go å¼€å‘è€…æ€»æ˜¯ä¼šè¯¯ä»¥ä¸ºè·¨ goroutine èƒ½æœ‰ recover æ¥ä½â€¦ è®°ä½ï¼Œåœ¨ Go è¯­è¨€ä¸­æ¯ä¸€ä¸ª goroutine éƒ½éœ€è¦è‡ªå·±æ‰¿æ‹…è‡ªå·±çš„ä»»ä½•è´£ä»»ï¼Œè¿™æ˜¯åŸºæœ¬åŸåˆ™ã€‚ ","date":"2021-07-27","objectID":"/2021/07/%E5%81%9C%E6%AD%A2goroutine%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/:5:0","tags":["goroutine","golang"],"title":"åœæ­¢goroutineçš„å‡ ç§æ–¹æ³•","uri":"/2021/07/%E5%81%9C%E6%AD%A2goroutine%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"åœ¨syncåŒ…ä¸‹é¢ç»å¸¸å‡ºç°\"XXX must not be copied after first use.\"ï¼Œç„¶åä¸‹é¢å°±æœ‰ä¸€ä¸ªnoCopyã€‚ ","date":"2021-07-19","objectID":"/2021/07/nocopy%E6%9C%BA%E5%88%B6/:0:0","tags":["æºç è§£æ","golang"],"title":"no copyæœºåˆ¶","uri":"/2021/07/nocopy%E6%9C%BA%E5%88%B6/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"ä»€ä¹ˆæ˜¯noCopy ? å¦‚æœç»“æ„ä½“å¯¹è±¡åŒ…å«æŒ‡é’ˆå­—æ®µï¼Œå½“è¯¥å¯¹è±¡è¢«æ‹·è´æ—¶ï¼Œä¼šä½¿å¾—ä¸¤ä¸ªå¯¹è±¡ä¸­çš„æŒ‡é’ˆå­—æ®µå˜å¾—ä¸å†å®‰å…¨ã€‚ type S struct { f1 int f2 *s } type s struct { name string } func main() { mOld := S{ f1: 0, f2: \u0026s{name: \"mike\"}, } mNew := mOld //æ‹·è´ mNew.f1 = 1 mNew.f2.name = \"jane\" fmt.Println(mOld.f1, mOld.f2) //è¾“å‡ºï¼š0 \u0026{jane} } ä¿®æ”¹nNewå­—æ®µçš„å€¼ä¼šæŠŠmOldå­—æ®µçš„å€¼ä¿®æ”¹æ‰ï¼Œè¿™å°±ä¼šå¼•å‘å®‰å…¨é—®é¢˜ã€‚ ","date":"2021-07-19","objectID":"/2021/07/nocopy%E6%9C%BA%E5%88%B6/:1:0","tags":["æºç è§£æ","golang"],"title":"no copyæœºåˆ¶","uri":"/2021/07/nocopy%E6%9C%BA%E5%88%B6/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"å¦‚æœä¿è¯noCopy ","date":"2021-07-19","objectID":"/2021/07/nocopy%E6%9C%BA%E5%88%B6/:2:0","tags":["æºç è§£æ","golang"],"title":"no copyæœºåˆ¶","uri":"/2021/07/nocopy%E6%9C%BA%E5%88%B6/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"runtime checking copyæ£€æŸ¥ func main() { var a strings.Builder a.Write([]byte(\"a\")) b := a b.Write([]byte(\"b\")) } // è¿è¡ŒæŠ¥é”™ï¼š panic: strings: illegal use of non-zero Builder copied by value æŠ¥é”™ä¿¡æ¯æ¥è‡ªäºstrings.Builderçš„copyCheck // Do not copy a non-zero Builder. type Builder struct { addr *Builder // of receiver, to detect copies by value buf []byte } func (b *Builder) Write(p []byte) (int, error) { b.copyCheck() b.buf = append(b.buf, p...) return len(p), nil } func (b *Builder) copyCheck() { if b.addr == nil { // This hack works around a failing of Go's escape analysis // that was causing b to escape and be heap allocated. // See issue 23382. // TODO: once issue 7921 is fixed, this should be reverted to // just \"b.addr = b\". b.addr = (*Builder)(noescape(unsafe.Pointer(b))) } else if b.addr != b { panic(\"strings: illegal use of non-zero Builder copied by value\") } } åœ¨Builderä¸­ï¼Œaddræ˜¯ä¸€ä¸ªæŒ‡å‘è‡ªèº«çš„æŒ‡é’ˆã€‚å¦‚æœaå¤åˆ¶ç»™bï¼Œé‚£ä¹ˆaå’Œbæœ¬èº«æ˜¯ä¸åŒçš„å¯¹è±¡ã€‚å› æ­¤b.addrå®é™…ä¸Šæ˜¯æŒ‡å‘aï¼Œå°±ä¼šå¯¼è‡´panic. sync.Condä¸­çš„copyæ£€æŸ¥ type copyChecker uintptr func (c *copyChecker) check() { if uintptr(*c) != uintptr(unsafe.Pointer(c)) \u0026\u0026 !atomic.CompareAndSwapUintptr((*uintptr)(c), 0, uintptr(unsafe.Pointer(c))) \u0026\u0026 uintptr(*c) != uintptr(unsafe.Pointer(c)) { panic(\"sync.Cond is copied\") } } å½“è¢«æ‹·è´åï¼Œuintptr(*c)å’Œuintptr(unsafe.Pointer(c))çš„å€¼æ˜¯ä¸åŒçš„ï¼Œé€šè¿‡uintå¯¹è±¡çš„åŸå­æ¯”è¾ƒæ–¹æ³•CompareAndSwapUintptrå°†è¿”å›falseï¼Œå®ƒè¯æ˜äº†å¯¹è±¡aè¢«copyè¿‡ï¼Œä»è€Œè°ƒç”¨panicä¿æŠ¤sync.Condä¸è¢«å¤åˆ¶ã€‚ ","date":"2021-07-19","objectID":"/2021/07/nocopy%E6%9C%BA%E5%88%B6/:2:1","tags":["æºç è§£æ","golang"],"title":"no copyæœºåˆ¶","uri":"/2021/07/nocopy%E6%9C%BA%E5%88%B6/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"go vet checking ä¸Šé¢çš„ä¸¤ä¸ªéƒ½æ˜¯åœ¨ç¨‹åºç¼–è¯‘æ—¶ï¼Œruntimeè¿›è¡Œæ£€æŸ¥çš„ã€‚ // noCopy may be embedded into structs which must not be copied // after the first use. // // See https://golang.org/issues/8005#issuecomment-190753527 // for details. type noCopy struct{} // Lock is a no-op used by -copylocks checker from `go vet`. func (*noCopy) Lock() {} func (*noCopy) Unlock() {} syncåŒ…ä¸‹çš„å…¶ä»–çš„å¯¹è±¡å¦‚Poolã€WaitGroupã€Mutexã€Mapç­‰ï¼Œå®ƒä»¬éƒ½å­˜åœ¨copyæ£€æŸ¥æœºåˆ¶ã€‚ é€šè¿‡go vetè¿›è¡Œcopyæ£€æŸ¥ã€‚ é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å‚è€ƒGoæºç çš„noCopyï¼Œå®ç°è°ƒç”¨ä¸èƒ½æ‹·è´ type noCopy struct{} func (*noCopy) Lock() {} func (*noCopy) Unlock() {} type MyType struct { noCopy noCopy ... } ","date":"2021-07-19","objectID":"/2021/07/nocopy%E6%9C%BA%E5%88%B6/:2:2","tags":["æºç è§£æ","golang"],"title":"no copyæœºåˆ¶","uri":"/2021/07/nocopy%E6%9C%BA%E5%88%B6/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"æˆ‘ä»¬é€šå¸¸ç”¨golangæ¥æ„å»ºé«˜å¹¶å‘åœºæ™¯ä¸‹çš„åº”ç”¨ï¼Œä½†æ˜¯ç”±äºgolangå†…å»ºçš„GCæœºåˆ¶ä¼šå½±å“åº”ç”¨çš„æ€§èƒ½ï¼Œä¸ºäº†å‡å°‘GCï¼Œgolangæä¾›äº†å¯¹è±¡é‡ç”¨çš„æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯sync.Poolå¯¹è±¡æ± ã€‚sync.Poolæ˜¯å¯ä¼¸ç¼©çš„ï¼Œå¹¶å‘å®‰å…¨çš„ã€‚å…¶å¤§å°ä»…å—é™äºå†…å­˜çš„å¤§å°ï¼Œå¯ä»¥è¢«çœ‹ä½œæ˜¯ä¸€ä¸ªå­˜æ”¾å¯é‡ç”¨å¯¹è±¡çš„å€¼çš„å®¹å™¨ã€‚ è®¾è®¡çš„ç›®çš„æ˜¯å­˜æ”¾å·²ç»åˆ†é…çš„ä½†æ˜¯æš‚æ—¶ä¸ç”¨çš„å¯¹è±¡ï¼Œåœ¨éœ€è¦ç”¨åˆ°çš„æ—¶å€™ç›´æ¥ä»poolä¸­å–ã€‚ ä»»ä½•å­˜æ”¾åŒºå…¶ä¸­çš„å€¼å¯ä»¥åœ¨ä»»ä½•æ—¶å€™è¢«åˆ é™¤è€Œä¸é€šçŸ¥ï¼Œåœ¨é«˜è´Ÿè½½ä¸‹å¯ä»¥åŠ¨æ€çš„æ‰©å®¹ï¼Œåœ¨ä¸æ´»è·ƒæ—¶å¯¹è±¡æ± ä¼šæ”¶ç¼©ã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.pool/:0:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹sync.Pool","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.pool/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"ä½¿ç”¨æ–¹æ³• func main() { // åˆå§‹åŒ–Poolå®ä¾‹New // Newæ–¹æ³•å£°æ˜Poolå…ƒç´ åˆ›å»ºçš„æ–¹æ³• bufferpool := \u0026sync.Pool{ New: func() interface{} { println(\"Create new instance\") return struct{}{} }, } // ç”³è¯·å¯¹è±¡ // Getæ–¹æ³•ä¼šè¿”å›Poolå·²ç»å­˜åœ¨çš„å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±èµ°æ…¢è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨åˆå§‹åŒ–çš„æ—¶å€™å®šä¹‰çš„Newæ–¹æ³•æ¥åˆå§‹åŒ–ä¸€ä¸ªå¯¹è±¡ buffer := bufferpool.Get() // é‡Šæ”¾å¯¹è±¡ // ä½¿ç”¨å¯¹è±¡åï¼Œè°ƒç”¨Putæ–¹æ³•å£°æ˜æŠŠå¯¹è±¡æ”¾å›æ± å­ã€‚ // è¿™ä¸ªè°ƒç”¨ä¹‹åä»…ä»…æ˜¯æŠŠè¿™ä¸ªå¯¹è±¡æ”¾å›æ± å­ï¼Œæ± å­é‡Œçš„å¯¹è±¡ä»€ä¹ˆæ—¶å€™çœŸæ­£é‡Šæ”¾å¤–ç•Œä¸æ¸…æ¥šï¼Œä¸å—å¤–ç•Œæ§åˆ¶ã€‚ bufferpool.Put(buffer) } ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.pool/:1:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹sync.Pool","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.pool/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"Poolç»“æ„ä½“ // A Pool must not be copied after first use. type Pool struct { noCopy noCopy // æ•°ç»„ï¼Œå¯¹åº”æ¯ä¸ªPï¼Œæ•°é‡å’ŒPçš„æ•°é‡ä¿æŒä¸€è‡´ local unsafe.Pointer // local fixed-size per-P pool, actual type is [P]poolLocal localSize uintptr // size of the local array // GCåˆ°æ—¶ï¼Œvictimå’ŒvictimSizeåˆ†åˆ«æ¥ç®¡localå’ŒlocalSize // victim çš„ç›®çš„æ˜¯ä¸ºäº†å‡å°‘GCåå†·å¯åŠ¨å¯¼è‡´çš„æ€§èƒ½æŠ–åŠ¨ï¼Œè®©åˆ†é…å¯¹è±¡æ›´åŠ å¹³æ»‘ victim unsafe.Pointer // local from previous cycle victimSize uintptr // size of victims array // New optionally specifies a function to generate // a value when Get would otherwise return nil. // It may not be changed concurrently with calls to Get. New func() interface{} } // poolLocalç®¡ç†Poolæ± é‡Œcacheå…ƒç´ çš„å…³é”®ç»“æ„ï¼ŒPool.localæŒ‡å‘è¿™ä¸ªç±»å‹çš„æ•°ç»„ï¼Œ type poolLocal struct { poolLocalInternal // Prevents false sharing on widespread platforms with // 128 mod (cache line size) = 0 . // æŠŠpoolLocalå¡«å……è‡³128å­—èŠ‚å¯¹é½ï¼Œé¿å…false sharingå¼•èµ·çš„æ€§èƒ½é—®é¢˜ pad [128 - unsafe.Sizeof(poolLocalInternal{})%128]byte } // ç®¡ç†cacheçš„å†…éƒ¨ç»“æ„ï¼Œè·Ÿæ¯ä¸ªPå¯¹åº”ï¼Œæ“ä½œæ— é¡»åŠ é” type poolLocalInternal struct { // æ¯ä¸ªPçš„ç§æœ‰ï¼Œä½¿ç”¨æ—¶æ— éœ€åŠ é” private interface{} // Can be used only by the respective P. // åŒé“¾è¡¨ç»“æ„ï¼Œç”¨äºæŒ‚æ¥cacheå…ƒç´  shared poolChain // Local P can pushHead/popHead; any P can popTail. } è¿™é‡Œçš„poolChainæ˜¯ä¸€ä¸ªåŒé“¾è¡¨ç»“æ„ï¼Œé‡Œé¢åŒ…å«äº†å¤´æ’ã€å¤´å‡ºã€å°¾å‡ºçš„æ–¹æ³•ã€‚ æˆ‘ä»¬æ³¨æ„åˆ°Poolé‡Œæ˜¯æ²¡æœ‰é”çš„ï¼Œä½†æ˜¯å´å®ç°äº†å¹¶å‘å®‰å…¨ï¼Œè¿™é‡Œæˆ‘ä»¬è¯¦ç»†çœ‹ä¸€ä¸‹å®ç° ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.pool/:2:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹sync.Pool","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.pool/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"pin func (p *Pool) pin() (*poolLocal, int) { // æŠŠGé”ä½åœ¨å½“å‰Mï¼ˆå£°æ˜å½“å‰Mä¸èƒ½è¢«æŠ¢å ï¼‰ï¼Œè¿”å›Mç»‘å®šçš„Pçš„ID pid := runtime_procPin() // In pinSlow we store to local and then to localSize, here we load in opposite order. // Since we've disabled preemption, GC cannot happen in between. // Thus here we must observe local at least as large localSize. // We can observe a newer/larger local, it is fine (we must observe its zero-initialized-ness). s := atomic.LoadUintptr(\u0026p.localSize) // load-acquire l := p.local // load-consume if uintptr(pid) \u003c s { return indexLocal(l, pid), pid } return p.pinSlow() } // ä¸€èˆ¬æ˜¯Poolç¬¬ä¸€æ¬¡è°ƒç”¨Getçš„æ—¶å€™æ‰ä¼šèµ°è¿›æ¥ï¼ˆæ¯ä¸ª P çš„ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼‰ // æŠŠPoolæ³¨å†Œè¿›allPoolsæ•°ç»„ï¼› // Pool.local æ•°ç»„æŒ‰ç…§Pçš„ä¸ªæ•°(cpuçš„ä¸ªæ•°)è¿›è¡Œåˆ†é… func (p *Pool) pinSlow() (*poolLocal, int) { // Retry under the mutex. // Can not lock the mutex while pinned. // G-Må…ˆè§£é” runtime_procUnpin() // ä»¥ä¸‹é€»è¾‘åœ¨å…¨å±€é”allPoolsMuå†… allPoolsMu.Lock() defer allPoolsMu.Unlock() // è·å–å½“å‰G-M-Pï¼ŒPçš„id pid := runtime_procPin() // poolCleanup won't be called while we are pinned. s := p.localSize l := p.local if uintptr(pid) \u003c s { return indexLocal(l, pid), pid } if p.local == nil { // æŠŠè‡ªå·±æ³¨å†Œè¿›allPoolsæ•°ç»„ allPools = append(allPools, p) } // If GOMAXPROCS changes between GCs, we re-allocate the array and lose the old one. // Pçš„ä¸ªæ•° size := runtime.GOMAXPROCS(0) // localæ•°ç»„çš„å¤§å°ç­‰äºPçš„ä¸ªæ•° local := make([]poolLocal, size) atomic.StorePointer(\u0026p.local, unsafe.Pointer(\u0026local[0])) // store-release atomic.StoreUintptr(\u0026p.localSize, uintptr(size)) // store-release return \u0026local[pid], pid } func indexLocal(l unsafe.Pointer, i int) *poolLocal { lp := unsafe.Pointer(uintptr(l) + uintptr(i)*unsafe.Sizeof(poolLocal{})) return (*poolLocal)(lp) } runtime_procPinæ˜¯procPinçš„ä¸€å±‚å°è£… func procPin() int { _g_ := getg() mp := _g_.m mp.locks++ return int(mp.p.ptr().id) } procPinå‡½æ•°ç›®çš„æ˜¯ä¸ºäº†å½“å‰Gè¢«æŠ¢å äº†æ‰§è¡Œæƒé™ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å‰Gå°±åœ¨å½“å‰Mä¸Šä¸èµ°äº†ï¼‰ï¼Œ è¿™é‡Œçš„æ ¸å¿ƒå®ç°æ˜¯mp.locks++æ“ä½œï¼Œåœ¨newstacké‡Œä¼šå¯¹æ­¤æ¡ä»¶è¿›è¡Œåˆ¤æ–­ if preempt { // å·²ç»æ‰“äº†æŠ¢å æ ‡è¯†ï¼Œä½†è¿˜éœ€è¦åˆ¤æ–­æ¡ä»¶æ»¡è¶³æ‰èƒ½å‡ºè®©æ‰§è¡Œæƒ if !canPreemptM(thisg.m) { // Let the goroutine keep running for now. // gp-\u003epreempt is set, so it will be preempted next time. gp.stackguard0 = gp.stack.lo + _StackGuard gogo(\u0026gp.sched) // never return } } func canPreemptM(mp *m) bool { return mp.locks == 0 \u0026\u0026 mp.mallocing == 0 \u0026\u0026 mp.preemptoff == \"\" \u0026\u0026 mp.p.ptr().status == _Prunning } è¿™é‡Œçš„æµç¨‹ï¼šç¦æ­¢æŠ¢å GC-\u003eå¯»æ‰¾åç§»é‡-\u003eè¶Šç•Œæ£€æŸ¥-\u003eè¿”å›poolLocalæˆ–åŠ é”é‡å»ºpoolï¼Œå¹¶æ·»åŠ åˆ°allPoolä¸­ã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.pool/:3:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹sync.Pool","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.pool/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"æ”¾å›Put // Put adds x to the pool. func (p *Pool) Put(x interface{}) { if x == nil { return } // G-Mé”å®š l, _ := p.pin() if l.private == nil { // Fast pathï¼šæ”¾å›xåˆ°private l.private = x x = nil } if x != nil { // æ”¾åˆ°åŒå‘é“¾è¡¨ l.shared.pushHead(x) } runtime_procUnpin() } æ”¾å…¥æµç¨‹ 1ã€å¦‚æœxä¸ºç©ºï¼Œç›´æ¥è¿”å› 2ã€è·å–localPool 3ã€å¦‚æœprivateä¸ºç©ºï¼ŒæŠŠxæ”¾å›privateï¼Œå¹¶ä¸”æŠŠxç½®nil 4ã€å¦‚æœxä¸ä¸ºnilï¼Œå°†xæ”¾åˆ°poolçš„sharedåŒå‘é“¾è¡¨ä¸­ æ€»ç»“æ¥è¯´ï¼Œä¼˜å…ˆæ”¾å…¥privateï¼Œåé¢å†æ”¾å…¥sharedç©ºé—´ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.pool/:4:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹sync.Pool","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.pool/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"å–å‡ºGet func (p *Pool) Get() interface{} { l, pid := p.pin() // fast pathï¼šä»privateå»é™¤ç¼“å­˜å…ƒç´  x := l.private l.private = nil if x == nil { // Try to pop the head of the local shard. We prefer // the head over the tail for temporal locality of // reuse. // ä»sharedé˜Ÿåˆ—ä¸­è·å–ï¼Œshareçš„åº¦é‡åœ¨Getè·å–ï¼Œåœ¨PutæŠ•é€’ x, _ = l.shared.popHead() if x == nil { // å°è¯•ä»å…¶ä»–Pçš„é˜Ÿåˆ—ä¸­è·å–å…ƒç´ ï¼Œæˆ–å°è¯•ä»victim cacheå–å…ƒç´  x = p.getSlow(pid) } } // è§£é™¤é”å®š runtime_procUnpin() // slow pathï¼šåˆå§‹åŒ–å¯¹è±¡ if x == nil \u0026\u0026 p.New != nil { x = p.New() } return x } func (p *Pool) getSlow(pid int) interface{} { // See the comment in pin regarding ordering of the loads. size := atomic.LoadUintptr(\u0026p.localSize) // load-acquire locals := p.local // load-consume // Try to steal one element from other procs. // ä»å…¶ä»–Pä¸­è·å–local for i := 0; i \u003c int(size); i++ { l := indexLocal(locals, (pid+i+1)%int(size)) if x, _ := l.shared.popTail(); x != nil { return x } } // ä»victimä¸­å–å‡ºå¯¹è±¡ // Try the victim cache. We do this after attempting to steal // from all primary caches because we want objects in the // victim cache to age out if at all possible. size = atomic.LoadUintptr(\u0026p.victimSize) if uintptr(pid) \u003e= size { return nil } locals = p.victim l := indexLocal(locals, pid) if x := l.private; x != nil { l.private = nil return x } for i := 0; i \u003c int(size); i++ { l := indexLocal(locals, (pid+i)%int(size)) if x, _ := l.shared.popTail(); x != nil { return x } } // Mark the victim cache as empty for future gets don't bother // with it. atomic.StoreUintptr(\u0026p.victimSize, 0) return nil } å–å‡ºæµç¨‹ 1ã€è·å–poolLocal 2ã€ä»privateä¸­å–å‡ºç¼“å­˜å…ƒç´  3ã€å¦‚æœå–å‡ºçš„å…ƒç´ ä¸ºnilï¼Œåˆ™ä»sharedä¸­è·å–ç¼“å­˜å…ƒç´  4ã€å¦‚æœè¿˜ä¸ºç©ºï¼Œåˆ™ä»å…¶ä»–Pçš„é˜Ÿåˆ—ä¸­å–å‡ºå…ƒç´  5ã€å¦‚æœéƒ½å–ä¸åˆ°ï¼Œåˆ™è°ƒç”¨Newæ–¹æ³•åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„å…ƒç´ ã€‚ æ€»ç»“æ¥è¯´ï¼Œä¼˜å…ˆä»privateç©ºé—´æ‹¿ï¼Œå†ä»sharedç©ºé—´æ‹¿ï¼Œè¿˜æ²¡æœ‰å°±ä»å…¶ä»–çš„poolLocalçš„sharedç©ºé—´æ‹¿ï¼Œå¦‚æœè¿˜æ²¡æœ‰å°±Newä¸€ä¸ªè¿”å›ã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.pool/:5:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹sync.Pool","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.pool/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"å®šæ—¶æ¸…ç† func init() { // åœ¨GCå¼€å§‹æ—¶ï¼ŒgcStartè°ƒç”¨clearpoolså‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸€è½®GCéƒ½ä¼šå¯¹æ‰€æœ‰çš„Poolåšæ¸…ç†å·¥ä½œ runtime_registerPoolCleanup(poolCleanup) } func poolCleanup() { // æ¸…ç†oldPoolsä¸Šçš„victimçš„å…ƒç´  for _, p := range oldPools { p.victim = nil p.victimSize = 0 } // Move primary cache to victim cache. // æŠŠlocal cacheè¿ç§»åˆ°victimä¸Š // è¿™æ ·å°±ä¸è‡³äºè®©GCæŠŠæ‰€æœ‰çš„Pooléƒ½æ¸…ç©ºäº†ï¼Œå¯ä»¥é˜²æ­¢æŠ–åŠ¨ for _, p := range allPools { p.victim = p.local p.victimSize = p.localSize p.local = nil p.localSize = 0 } // The pools with non-empty primary caches now have non-empty // victim caches and no pools have primary caches. oldPools, allPools = allPools, nil } åœ¨æ¯æ¬¡GCæ—¶ï¼ŒæŠŠlocalç§»åˆ°victimä¸­ã€‚ è€Œruntime_registerPoolCleanupå‡½æ•°çš„å…·ä½“å®ç°åœ¨runtime/mgc.goä¸­ func sync_runtime_registerPoolCleanup(f func()) { poolcleanup = f } func clearpools() { // clear sync.Pools if poolcleanup != nil { poolcleanup() } ... } ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.pool/:6:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹sync.Pool","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.pool/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"é—®é¢˜ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.pool/:7:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹sync.Pool","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.pool/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"1ã€ä¸ºä»€ä¹ˆç”¨Poolï¼Œè€Œä¸æ˜¯åœ¨è¿è¡Œæ—¶ç›´æ¥å®ä¾‹åŒ–å¯¹è±¡ï¼Ÿ åŸå› ï¼šGoçš„å†…å­˜é‡Šæ”¾æ˜¯ç”±runtimeæ¥è‡ªåŠ¨å¤„ç†ï¼Œæœ‰GCè¿‡ç¨‹ ä¸¾ä¸ªæ —å­ package main import ( \"fmt\" \"sync\" \"sync/atomic\" ) // ç”¨æ¥ç»Ÿè®¡å®ä¾‹çœŸæ­£åˆ›å»ºçš„æ¬¡æ•° var numCalcsCreated int32 // åˆ›å»ºå®ä¾‹çš„å‡½æ•° func createBuffer() interface{} { // è¿™é‡Œè¦æ³¨æ„ä¸‹ï¼Œéå¸¸é‡è¦çš„ä¸€ç‚¹ã€‚è¿™é‡Œå¿…é¡»ä½¿ç”¨åŸå­åŠ ï¼Œä¸ç„¶æœ‰å¹¶å‘é—®é¢˜ï¼› atomic.AddInt32(\u0026numCalcsCreated, 1) buffer := make([]byte, 1024) return \u0026buffer } func main() { // åˆ›å»ºå®ä¾‹ bufferPool := \u0026sync.Pool{ New: createBuffer, } // å¤š goroutine å¹¶å‘æµ‹è¯• numWorkers := 1024 * 1024 var wg sync.WaitGroup wg.Add(numWorkers) for i := 0; i \u003c numWorkers; i++ { go func() { defer wg.Done() // ç”³è¯·ä¸€ä¸ª buffer å®ä¾‹ buffer := bufferPool.Get() // buffer := createBuffer() _ = buffer.(*[]byte) // é‡Šæ”¾ä¸€ä¸ª buffer å®ä¾‹ defer bufferPool.Put(buffer) }() } wg.Wait() fmt.Printf(\"%d buffer objects were created.\\n\", numCalcsCreated) } // Output: 7 buffer objects were created. 8 buffer objects were created. å¤šæ¬¡è¿è¡Œä¼šå‡ºç°ä¸åŒçš„ç»“æœã€‚ åˆ›å»ºPoolå®ä¾‹çš„æ—¶å€™ï¼Œåªè¦æ±‚å¡«å……äº†Newå‡½æ•°ï¼Œè€Œæ²¡æœ‰å£°æ˜æˆ–é™åˆ¶Poolçš„å¤§å°ã€‚ å¦‚æœä¸ç”¨poolæ¥ç”³è¯·ï¼Œè€Œæ˜¯ç›´æ¥å˜é‡å£°æ˜çš„æ–¹å¼,ä¼šæœ‰1024*1024ä¸ªå¯¹è±¡ç”Ÿæˆã€‚ è¿™å°±æ˜¯å¤ç”¨å¯¹è±¡ã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.pool/:7:1","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹sync.Pool","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.pool/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"2ã€sync.Poolæ˜¯å¹¶å‘å®‰å…¨å—ï¼Ÿ A Pool is safe for use by multiple goroutines simultaneously. å½“ç„¶å¹¶å‘å®‰å…¨ã€‚ å› ä¸ºsync.Poolåªæ˜¯æœ¬èº«çš„Poolæ•°æ®ç»“æ„å¹¶å‘å®‰å…¨ï¼Œå¹¶ä¸æ˜¯è¯´Pool.Newå‡½æ•°ä¸€å®šçº¿ç¨‹å®‰å…¨ã€‚ Pool.Newå‡½æ•°å¯èƒ½ä¼šè¢«å¹¶å‘è°ƒç”¨ã€‚ å¦‚æœæŠŠatomic.AddInt32(\u0026numCalcsCreated, 1)æ”¹æˆnumCalcsCreated++ï¼Œç„¶åç”¨go run -race main.goå‘½ä»¤æ£€æŸ¥ä¸€ä¸‹ï¼Œä¼šæŠ¥å‡ºå‘Šè­¦ã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.pool/:7:2","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹sync.Pool","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.pool/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"3ã€ä¸ºä»€ä¹ˆsync.Poolä¸é€‚åˆç”¨äºåƒsocketé•¿è¿æ¥æˆ–æ•°æ®åº“è¿æ¥æ± ï¼Ÿ Poolæ± é‡Œçš„å…ƒç´ éšæ—¶å¯èƒ½é‡Šæ”¾æ‰ï¼Œé‡Šæ”¾ç­–ç•¥å®Œå…¨ç”±runtimeå†…éƒ¨ç®¡ç† Getè·å–åˆ°çš„å¯¹è±¡å…ƒç´ å¯èƒ½æ˜¯åˆšåˆ›å»ºçš„ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¹‹å‰åˆ›å»ºå¥½cacheä½çš„ï¼Œä½¿ç”¨è€…æ— æ³•åŒºåˆ† Poolæ± é‡Œé¢çš„å…ƒç´ ä¸ªæ•°æ— æ³•çŸ¥é“ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.pool/:7:3","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹sync.Pool","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.pool/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"æ€»ç»“ sync.Poolæœ¬è´¨ç”¨é€”æ˜¯å¢åŠ ä¸´æ—¶å¯¹è±¡çš„é‡ç”¨ç‡ï¼Œå‡å°‘GCè´Ÿæ‹…ã€‚ 1ã€å¦‚æœä¸æ˜¯Pool.Getç”³è¯·çš„å¯¹è±¡ï¼Œè°ƒç”¨äº†Putï¼Œä¼šå¦‚ä½•ï¼Ÿ Poolæ± ä¸­é‡Œçš„å°±ä¸æ˜¯å•ä¸€çš„å¯¹è±¡å…ƒç´ ï¼Œå–å‡ºçš„å¯¹è±¡ç±»å‹éœ€è¦ä¸šåŠ¡è‡ªå·±åˆ¤æ–­ 2ã€ä¸ºä»€ä¹ˆGetå‡ºçš„å¯¹è±¡è¿˜è¦Putæ”¾å›å»ï¼Ÿ é€šå¸¸æ˜¯defer Putè¿™ç§å½¢å¼ä¿è¯é‡Šæ”¾å…ƒç´ æ”¾å›æ± å­ã€‚ Getå‡ºçš„å¯¹è±¡å¦‚æœä¸Putæ”¾å›å»ï¼Œä¼šè¢«GCé‡Šæ”¾ï¼Œå°±ä¸èƒ½å¤ç”¨ä¸´æ—¶å¯¹è±¡äº† 3ã€Poolæœ¬èº«å…è®¸å¤åˆ¶åä½¿ç”¨å—ï¼Ÿ ä¸å…è®¸ï¼Œå› ä¸ºæœ‰noCopyï¼Œä½†æ˜¯å¯ä»¥ç¼–è¯‘é€šè¿‡ã€‚ å› ä¸ºcopyä¹‹åï¼Œå¯¹äºåŒä¸€ä¸ªPoolé‡Œé¢çš„cacheå¯¹è±¡ï¼Œå°±æœ‰äº†2ä¸ªå¯¹è±¡æ¥æºã€‚ Poolé‡Œé¢çš„æ— é”è®¾è®¡çš„åŸºç¡€æ˜¯å¤šä¸ªgoroutineä¸ä¼šæ“ä½œåˆ°åŒä¸€ä¸ªæ•°æ®ç»“æ„ï¼ŒPoolæ‹·è´åå°±ä¸èƒ½ä¿è¯è¿™ä¸€ç‚¹äº†ã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.pool/:8:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹sync.Pool","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.pool/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"golangåŸç”Ÿçš„mapæ˜¯ä¸æ”¯æŒå¹¶å‘ï¼Œè€Œåœ¨sync/mapæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥å¹¶å‘è¯»å†™ï¼Œé€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ã€‚ sync.Mapæ˜¯Go map[interface{}]interface{}ï¼Œå®ƒå¯¹ä¸¤ç§å¸¸ç”¨çš„åœºæ™¯è¿›è¡Œäº†ä¼˜åŒ–ï¼š 1ã€entryåªå†™ä¸€æ¬¡ï¼Œä½†è¯»å¾ˆå¤šæ¬¡ï¼Œæ¯”å¦‚åœ¨åªå¢é•¿çš„ç¼“å­˜ä¸­ 2ã€å¤šä¸ªgoroutineè¯»å†™ã€æ›´æ–°entryäº’ä¸å¹²æ‰° åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œä½¿ç”¨sync.Mapæ¯”mapåŠ äº’æ–¥é”æ€§èƒ½è¦æ›´å¥½ã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.map/:0:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹Map","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"åŸºæœ¬çš„æ•°æ®ç»“æ„ type Map struct { // å½“æ¶‰åŠåˆ°è„æ•°æ®ï¼ˆdirtyï¼‰æ“ä½œæ—¶ï¼Œéœ€è¦ç”¨é” mu Mutex read atomic.Value // readOnly // dirty åŒ…å«éƒ¨åˆ†mapé”®å€¼å¯¹ï¼Œå¦‚æœéœ€è¦æ“ä½œéœ€è¦mutexè·å–é” // æœ€å dirty ä¸­çš„å…ƒç´ ä¼šè¢«å…¨éƒ¨æå‡åˆ°readé‡Œçš„mapå» dirty map[interface{}]*entry // è®¡æ•°å™¨ï¼Œç”¨äºè®°å½•readä¸­æ²¡æœ‰çš„è€Œåœ¨dirtyä¸­æœ‰çš„æ•°æ®çš„æ•°é‡ã€‚ // ä¹Ÿå°±æ˜¯è¯´å¦‚æœreadä¸åŒ…å«è¿™ä¸ªæ•°æ®ï¼Œä¼šä»dirtyä¸­è¯»å–ï¼Œmisses+1 // å½“missesçš„æ•°é‡ç­‰äºdirtyçš„é•¿åº¦ï¼Œå°±ä¼šå°†dirtyä¸­çš„æ•°æ®è¿ç§»åˆ°readä¸­ misses int } readåŒ…å«äº†mapå†…å®¹ä¸­å¯¹å¹¶å‘è®¿é—®æ˜¯å®‰å…¨çš„éƒ¨åˆ†ï¼ˆä¸ç®¡æœ‰æ²¡æœ‰muï¼‰ã€‚è¯»å–å­—æ®µæœ¬èº«æ€»æ˜¯å®‰å…¨çš„ï¼Œä½†å¿…é¡»å’Œmuä¸€èµ·å­˜å‚¨ã€‚å­˜å‚¨åœ¨readä¸­çš„Entrieså¯ä»¥åœ¨æ²¡æœ‰é”çš„æƒ…å†µä¸‹å¹¶å‘æ›´æ–°ï¼Œä½†æ˜¯æ›´æ–°ä¹‹å‰åˆ é™¤çš„entryéœ€è¦å°†entryå¤åˆ¶åˆ°dirtyï¼Œå¹¶ä¸”ä¿è¯ä¸è¢«åˆ é™¤ dirty åŒ…å«éƒ¨åˆ†mapé”®å€¼å¯¹ï¼Œå¦‚æœéœ€è¦æ“ä½œéœ€è¦mutexè·å–é”ï¼Œæœ€å dirty ä¸­çš„å…ƒç´ ä¼šè¢«å…¨éƒ¨æå‡åˆ°readé‡Œçš„mapå» missesè®¡æ•°å™¨ï¼Œç”¨äºè®°å½•readä¸­æ²¡æœ‰çš„è€Œåœ¨dirtyä¸­æœ‰çš„æ•°æ®çš„æ•°é‡ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœreadä¸åŒ…å«è¿™ä¸ªæ•°æ®ï¼Œä¼šä»dirtyä¸­è¯»å–ï¼Œmisses+1ï¼Œå½“missesçš„æ•°é‡ç­‰äºdirtyçš„é•¿åº¦ï¼Œå°±ä¼šå°†dirtyä¸­çš„æ•°æ®è¿ç§»åˆ°readä¸­ æ¥çœ‹çœ‹dirtyï¼Œæ˜¯ä¸€ä¸ªmapç±»å‹çš„æ•°æ®ï¼Œé”®ç±»å‹æ˜¯interface{}ï¼Œè€Œå€¼çš„ç±»å‹æ˜¯entryï¼Œå…¶ç»“æ„å¦‚ä¸‹ï¼š type entry struct { p unsafe.Pointer // *interface{} } pæŒ‡é’ˆæŒ‡å‘entryçš„interface{}å€¼ nil:entryå·²ç»è¢«åˆ é™¤ï¼Œå¹¶ä¸”m.dirtyä¸ºç©º expunged:entryå·²ç»è¢«åˆ é™¤ï¼Œä½†m.dirtyä¸ä¸ºç©ºï¼Œä¹Ÿä¸åœ¨m.dirty å…¶ä»–:entryæ˜¯æœ‰æ•ˆçš„ï¼Œæ˜¯ä¸ªæ­£å¸¸å€¼ï¼Œå¹¶è®°å½•åœ¨m.read.m[key],å¹¶ä¸”m.dirty != nil, åœ¨ m.dirty[key]. è€Œreadå®é™…ä¸ŠæŒ‡å‘readonlyç»“æ„ï¼Œç›¸æ¯”äºdirtyå¤šäº†ä¸ªamendedå±æ€§ï¼Œç”¨æ¥è¡¨ç¤ºæ˜¯å¦å­˜åœ¨keyä¸å­˜åœ¨äºreadonlyï¼Œè€Œå­˜åœ¨äºdirtyã€‚ type readOnly struct { m map[interface{}]*entry amended bool // true if the dirty map contains some key not in m. } è€Œæ“ä½œè¿™ä¸ªsync.Mapçš„æ–¹æ³•æœ‰Loadï¼ŒStoreï¼ŒLoadOrStoreï¼ŒDeleteï¼ŒRangeè¿™å‡ ä¸ªæ–¹æ³•ã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.map/:1:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹Map","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"æŸ¥æ‰¾Load func (m *Map) Load(key interface{}) (value interface{}, ok bool) { // ä»readçš„mapä¸­æŸ¥æ‰¾ read, _ := m.read.Load().(readOnly) e, ok := read.m[key] // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå¹¶ä¸”read.amended=trueï¼Œè¯´æ˜dirtyä¸­æœ‰æ–°æ•°æ®ï¼Œä»dirtyä¸­æŸ¥æ‰¾ï¼Œéœ€è¦åŠ é” if !ok \u0026\u0026 read.amended { m.mu.Lock() // åœ¨readä¸­å†æ£€æŸ¥ä¸€éï¼Œé˜²æ­¢åŠ é”çš„æ—¶å€™dirtyå·²ç»è¿ç§»åˆ°readä¸­ï¼ˆäºŒæ¬¡æ£€æŸ¥ï¼‰ read, _ = m.read.Load().(readOnly) e, ok = read.m[key] if !ok \u0026\u0026 read.amended { e, ok = m.dirty[key] // ä¸ç®¡æ˜¯å¦å­˜åœ¨ï¼Œè®°å½•misses+1ï¼Œæ»¡è¶³æ¡ä»¶åå°†dirtyä¸­æ•°æ®è¿ç§»åˆ°readä¸­ m.missLocked() } m.mu.Unlock() } if !ok { return nil, false } return e.load() } func (e *entry) load() (value interface{}, ok bool) { p := atomic.LoadPointer(\u0026e.p) if p == nil || p == expunged { return nil, false } return *(*interface{})(p), true } func (m *Map) missLocked() { m.misses++ if m.misses \u003c len(m.dirty) { // misseså°äºdirtyçš„é•¿åº¦ï¼Œå°±ä¸è¿ç§»æ•°æ® return } m.read.Store(readOnly{m: m.dirty}) m.dirty = nil m.misses = 0 } è¯»å–çš„æ—¶å€™å…ˆä»readä¸­è¯»å–ï¼Œå¦‚æœreadä¸­ä¸å­˜åœ¨ï¼Œåˆ™åŠ é”ä»dirtyä¸­è¯»å–ï¼Œå¹¶ä¸”ä½¿ç”¨missLockedä½¿å¾—misses+1ã€‚ å¦‚æœè®¡æ•°å™¨missesçš„æ•°é‡å¤§äºdirtyçš„é•¿åº¦ï¼Œåˆ™æŠŠdirtyçš„æ•°æ®æ›´æ–°åˆ°readä¸­ã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.map/:2:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹Map","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"æ–°å¢å’Œæ›´æ–°Store func (m *Map) Store(key, value interface{}) { // ä»read mapä¸­å¦‚æœèƒ½æ‰¾åˆ°keyï¼Œupdate read, _ := m.read.Load().(readOnly) if e, ok := read.m[key]; ok \u0026\u0026 e.tryStore(\u0026value) { return } // ä¸Šé”ä¹‹åé‡æ–°checkä¸€ä¸‹read mapçš„å†…å®¹(äºŒæ¬¡è¯»å†™) m.mu.Lock() read, _ = m.read.Load().(readOnly) // åœºæ™¯ä¸€ï¼šå¦‚æœåœ¨readä¸­ï¼Œè€Œkeyå¯¹åº”çš„valueæ ‡è¯†æ˜¯å·²åˆ é™¤ï¼ˆéœ€è¦å…ˆåœ¨dirtyä¸­æ·»åŠ ï¼‰ï¼Œæ›´æ–°è¿™ä¸ªå€¼ if e, ok := read.m[key]; ok { if e.unexpungeLocked() { // The entry was previously expunged, which implies that there is a // non-nil dirty map and this entry is not in it. m.dirty[key] = e } e.storeLocked(\u0026value) // åœºæ™¯äºŒï¼šå¦‚æœä¸åœ¨readä¸­ï¼Œåœ¨dirtyä¸­ï¼Œç›´æ¥æ›´æ–°å€¼ } else if e, ok := m.dirty[key]; ok { e.storeLocked(\u0026value) // åœºæ™¯ä¸‰ï¼šéƒ½ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆæŠŠæ•°æ®å­˜åœ¨dirtyä¸­ï¼Œå¹¶ä¸”ä¿®æ”¹readä¸­çš„æ ‡è¯† } else { if !read.amended { // dirtyæ²¡æœ‰æ–°æ•°æ® // We're adding the first new key to the dirty map. // Make sure it is allocated and mark the read-only map as incomplete. // ä»readä¸­å¤åˆ¶æœªåˆ é™¤çš„æ•°æ® m.dirtyLocked() // æ›´æ”¹çŠ¶æ€ m.read.Store(readOnly{m: read.m, amended: true}) } m.dirty[key] = newEntry(value) // åŠ å…¥dirtyä¸­ } m.mu.Unlock() } mapçš„å¹¶å‘è¯»å†™å®¹æ˜“å‡ºé—®é¢˜ï¼Œæ˜¯å› ä¸ºå­˜å€¼ã€åˆ é™¤ã€å–å€¼çš„è¿‡ç¨‹ä¸­å­˜åœ¨æ‰©å®¹çš„è¿‡ç¨‹ã€‚å¦‚æœä¸å¯¹mapè¿›è¡Œä¿®æ”¹å°±èƒ½æé«˜æ‰§è¡Œæ•ˆç‡ã€‚ æ‰€ä»¥readå’Œdirtyä½¿ç”¨çš„mapç±»å‹å°±æ˜¯map[interface{}]*entryï¼Œå€¼æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œé€šè¿‡å¯¹æŒ‡é’ˆçš„æ“ä½œæ¥æ”¹å˜å€¼çš„çŠ¶æ€ï¼Œè€Œä¸æ˜¯ç›´æ¥åˆ é™¤æˆ–èµ‹å€¼ã€‚ è€ŒStroeç¬¬ä¸€æ­¥ï¼Œå¦‚æœkeyåœ¨readä¸­å­˜åœ¨ï¼Œé‚£ä¹ˆé€šè¿‡tryStoreæ–¹æ³•æ¥ä¿®æ”¹å€¼ func (e *entry) tryStore(i *interface{}) bool { for { p := atomic.LoadPointer(\u0026e.p) if p == expunged { return false } if atomic.CompareAndSwapPointer(\u0026e.p, p, unsafe.Pointer(i)) { return true } } } è¿™é‡Œä½¿ç”¨äº†CASï¼Œä¹è§‚é”ã€‚ç›¸å½“äºå¯¹mapä¸­æ¯ä¸ªå·²ç»å­˜åœ¨çš„å€¼çš„ä¿®æ”¹ä½¿ç”¨ä¹è§‚é”ï¼Œç›¸æ¯”äºå¯¹æ•´ä¸ªmapä½¿ç”¨é”æ¥è¯´ï¼Œæé«˜äº†æ•ˆç‡ã€‚ Storeç¬¬äºŒæ­¥ï¼Œå¦‚æœæ²¡æœ‰æ›´æ–°æˆåŠŸæˆ–ä¸åœ¨readä¸­ï¼Œåˆ™æŒ‰ç…§é€»è¾‘ç»§ç»­å¾€ä¸‹èµ°ã€‚ åœ¨readä¸­ï¼Œæ²¡æœ‰æ›´æ–°æˆåŠŸï¼Œæ˜¯å› ä¸ºå€¼ç±»å‹è¢«æ ‡è®°ä¸ºå·²åˆ é™¤ï¼Œé‚£ä¹ˆå°±åœ¨dirtyä¸­æ·»åŠ è¿™ä¸ªé”®å€¼å¯¹ å¦‚æœä¸åœ¨dirtyï¼Œé‚£ä¹ˆåœ¨dirtyä¸­æ›´æ–°å€¼ å¦‚æœä¸åœ¨dirtyä¸­ï¼Œé‚£ä¹ˆåœ¨dirtyä¸­å­˜å‚¨é”®å€¼å¯¹ï¼Œå¦‚æœdirtyç›¸æ¯”äºreadæ²¡æœ‰æ–°çš„æ•°æ®ï¼Œé‚£ä¹ˆdirtyLockedæ–¹æ³•å°†readä¸­çš„æ•°æ®ä¿å­˜è¿›dirtyä¸­ï¼Œå¹¶ä¸”ä¿®æ”¹readä¸­çš„çŠ¶æ€amended ç”±äºmap[interface{}]*entryæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå¯¹readé‡Œçš„å€¼ä¿®æ”¹æ—¶ï¼Œdirtyä¸­çš„å€¼ä¹Ÿä¼šè¢«ä¿®æ”¹ï¼Œå› ä¸ºä¸¤ä¸ªæŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.map/:3:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹Map","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"åˆ é™¤Delete func (m *Map) Delete(key interface{}) { read, _ := m.read.Load().(readOnly) e, ok := read.m[key] if !ok \u0026\u0026 read.amended { // ä¸å­˜åœ¨readä¸­ï¼Œå¹¶ä¸”dirtyæœ‰æ–°æ•°æ® m.mu.Lock() read, _ = m.read.Load().(readOnly) e, ok = read.m[key] if !ok \u0026\u0026 read.amended { delete(m.dirty, key) // åŠ é”åˆ é™¤dirtyçš„æ•°æ® } m.mu.Unlock() } if ok { // åœ¨readä¸­å­˜åœ¨key e.delete() } } åˆ é™¤æ“ä½œæ¯”è¾ƒç®€å• å¦‚æœåœ¨readä¸­ï¼Œç›´æ¥åˆ é™¤ å¦‚æœä¸åœ¨readä¸­ï¼Œå¹¶ä¸”dirtyæ²¡æœ‰æ–°æ•°æ®ï¼Œç›´æ¥è¿”å› å¦‚æœä¸åœ¨readä¸­ï¼Œå¹¶ä¸”dirtyæœ‰æ–°æ•°æ®ï¼Œé‚£ä¹ˆå°±å»dirtyä¸­åˆ é™¤ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.map/:4:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹Map","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"å…¶ä»– LoadOrStoreå’ŒRangeè¿™ä¸¤ä¸ªæ–¹æ³•çš„é€»è¾‘å¤§ä½“å’ŒLoadå’ŒStroeç±»ä¼¼ã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.map/:5:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹Map","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"æ€»ç»“ 1ã€ç©ºé—´æ¢æ—¶é—´ï¼šé€šè¿‡ä¸¤ä¸ªå†—ä½™çš„æ•°æ®ç»“æ„ï¼ˆreadã€writeï¼‰ï¼Œå‡å°é”å¯¹æ€§èƒ½çš„å½±å“ã€‚ 2ã€è¯»æ“ä½œä½¿ç”¨readï¼Œå†™æ“ä½œä½¿ç”¨dirtyï¼Œé¿å…è¯»å†™å†²çªã€‚ 3ã€åŠ¨æ€è°ƒæ•´ï¼šé€šè¿‡misseså€¼ï¼Œé¿å…dirtyæ•°æ®è¿‡å¤šã€‚ 4ã€åŒæ£€æŸ¥æœºåˆ¶ï¼šé¿å…åœ¨éåŸå­æ“ä½œæ—¶äº§ç”Ÿæ•°æ®é”™è¯¯ã€‚ 5ã€å»¶è¿Ÿåˆ é™¤æœºåˆ¶ï¼šåˆ é™¤ä¸€ä¸ªé”®å€¼åªæ˜¯å…ˆæ‰“æ ‡è®°ï¼Œåªæœ‰ç­‰æå‡dirtyï¼ˆå¤åˆ¶åˆ°readä¸­ï¼Œå¹¶æ¸…ç©ºè‡ªèº«ï¼‰æ—¶æ‰æ¸…ç†åˆ é™¤çš„æ•°æ®ã€‚ 6ã€ä¼˜å…ˆä»readä¸­è¯»ã€æ”¹å’Œåˆ é™¤ï¼Œå› ä¸ºå¯¹readçš„æ“ä½œä¸ç”¨åŠ é”ï¼Œå¤§å¤§æå‡æ€§èƒ½ã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.map/:6:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹Map","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"è¯»å†™é”æ˜¯åŸºäºäº’æ–¥é”Mutexå®ç°çš„è¯»å†™äº’æ–¥é”ï¼Œä¸€ä¸ªgoroutineå¯ä»¥æŒæœ‰å¤šä¸ªè¯»é”æˆ–ä¸€ä¸ªå†™é”ï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½åŒæ—¶æŒæœ‰è¯»é”æˆ–å†™é”ã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E8%AF%BB%E5%86%99%E9%94%81/:0:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹è¯»å†™é”","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E8%AF%BB%E5%86%99%E9%94%81/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"RWMutexç»“æ„ä½“ type RWMutex struct { w Mutex // held if there are pending writers // äº’æ–¥é” // å†™å’Œè¯»é”ä¿¡å· writerSem uint32 // semaphore for writers to wait for completing readers readerSem uint32 // semaphore for readers to wait for completing writers // è¯»é”è®¡æ•°å™¨ readerCount int32 // number of pending readers // è·å–å†™é”æ˜¯éœ€è¦ç­‰å¾…çš„è¯»é”é‡Šæ”¾æ•°é‡ readerWait int32 // number of departing readers } const rwmutexMaxReaders = 1 \u003c\u003c 30 // æœ€å¤šæ”¯æŒ2^30ä¸ªé” ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E8%AF%BB%E5%86%99%E9%94%81/:1:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹è¯»å†™é”","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E8%AF%BB%E5%86%99%E9%94%81/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"è¯»åŠ é”RLock // è¯»åŠ é”ï¼Œä¸åº”è¯¥ç”¨äºé€’å½’è¯»é”å®š func (rw *RWMutex) RLock() { // æ¯æ¬¡goroutineè·å–è¯»é”æ—¶ï¼ŒreaderCount+1 // å¦‚æœå†™é”å·²ç»è¢«è·å–ï¼Œé‚£ä¹ˆreaderCountåœ¨[-rwmutexMaxReaders,0)ï¼Œè¿™æ—¶æŒ‚èµ·è¯»é”çš„goroutine // å¦‚æœå†™é”æ²¡æœ‰è¢«è·å–ï¼Œé‚£ä¹ˆreaderCount\u003e=0,è·å–è¯»é”ï¼Œä¸é˜»å¡ if atomic.AddInt32(\u0026rw.readerCount, 1) \u003c 0 { // å°†goroutineæ’åˆ°é˜Ÿåˆ—å°¾éƒ¨ï¼ŒæŒ‚èµ·goroutineï¼Œç›‘å¬readerSemä¿¡å·é‡ runtime_SemacquireMutex(\u0026rw.readerSem, false, 0) } } è¯»åŠ é”æ—¶å¹¶æ²¡æœ‰ç”¨åˆ°äº’æ–¥é”ï¼Œè€Œæ˜¯readerCount+1ï¼Œè€Œå°äº0çš„æƒ…å†µæ˜¯å› ä¸ºå†™åŠ é”äº† ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E8%AF%BB%E5%86%99%E9%94%81/:2:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹è¯»å†™é”","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E8%AF%BB%E5%86%99%E9%94%81/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"è¯»è§£é”RUnlock // è¯»è§£é”ï¼Œåªä¼šæ’¤é”€å¯¹åº”çš„RLockè°ƒç”¨ï¼Œä¸ä¼šå½±å“å…¶ä»–è¯»é” func (rw *RWMutex) RUnlock() { // è¯»è®¡æ•°å™¨readerCount-1 // åœºæ™¯ä¸€ï¼šæœ‰è¯»é”ï¼Œæ²¡æœ‰å†™é”è¢«æŒ‚èµ· r=readerCount-1\u003e=0 // åœºæ™¯äºŒï¼šæœ‰è¯»é”ï¼Œæœ‰å†™é”è¢«æŒ‚èµ· r\u003c0 // åœºæ™¯ä¸‰ï¼šæ²¡æœ‰è¯»é”ï¼Œæ²¡æœ‰å†™é”è¢«æŒ‚èµ· r=-1 // åœºæ™¯å››ï¼šæ²¡æœ‰è¯»é”ï¼Œæœ‰å†™é”è¢«æŒ‚èµ· r=-(1\u003c\u003c30)-1\u003c0 if r := atomic.AddInt32(\u0026rw.readerCount, -1); r \u003c 0 { // Outlined slow-path to allow the fast-path to be inlined rw.rUnlockSlow(r) } } func (rw *RWMutex) rUnlockSlow(r int32) { // åœºæ™¯ä¸‰å’Œåœºæ™¯å››æ˜¯å¼‚å¸¸æƒ…å†µ if r+1 == 0 || r+1 == -rwmutexMaxReaders { race.Enable() throw(\"sync: RUnlock of unlocked RWMutex\") } // å¦‚æœå†™é”çš„goroutineè¢«é˜»å¡ï¼Œéœ€è¦å°†è¯»é”çš„goroutineå…¨éƒ¨é‡Šæ”¾ï¼Œæ‰ä¼šå”¤é†’å†™é” if atomic.AddInt32(\u0026rw.readerWait, -1) == 0 { // The last reader unblocks the writer. runtime_Semrelease(\u0026rw.writerSem, false, 1) } } å› ä¸ºå†™åŠ é”æ—¶æ˜¯æŠŠreaderCount+-rwmutexMaxReadersï¼Œæ‰€ä»¥åœ¨å·²ç»æœ‰å†™åŠ é”æ—¶ï¼ŒreaderCountä¸€å®šæ˜¯è´Ÿæ•°ã€‚ è€Œå¯¹æ²¡æœ‰è¯»é”æ²¡æœ‰å†™é”è¿™ç§å¼‚å¸¸æƒ…å†µï¼ŒreaderCount-1åä¸º-1 è€Œå¯¹æ²¡æœ‰è¯»é”ï¼Œæœ‰å†™é”æ—¶ï¼Œæ­¤æ—¶readerCount+1=-rwmutexMaxReaders è¿™ä¸¤ç§æƒ…å†µéƒ½ä¼šæŠ¥é”™ã€‚ å¯¹äºæœ‰è¯»é”ï¼Œæœ‰å†™é”æ—¶ï¼Œå¦‚æœæ˜¯æœ€åä¸€ä¸ªè¯»è§£é”ï¼Œé‚£ä¹ˆå”¤é†’å†™é”ã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E8%AF%BB%E5%86%99%E9%94%81/:3:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹è¯»å†™é”","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E8%AF%BB%E5%86%99%E9%94%81/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"å†™åŠ é”Lock func (rw *RWMutex) Lock() { // é¦–å…ˆï¼Œè·å–äº’æ–¥é”ï¼Œä¸å…¶ä»–æ¥è·å–å†™é”çš„goroutineäº’æ–¥ rw.w.Lock() // å‘Šè¯‰å…¶ä»–æ¥è·å–è¯»é”çš„goroutineï¼Œç°åœ¨å·²ç»æœ‰äººè·å–äº†å†™é” // å‡å»æœ€å¤§è¯»é”çš„æ•°é‡ï¼Œç”¨è´Ÿæ•°æ¥è¡¨ç¤ºï¼Œå†™é”å·²ç»è¢«è·å– r := atomic.AddInt32(\u0026rw.readerCount, -rwmutexMaxReaders) + rwmutexMaxReaders // è®¾ç½®éœ€è¦ç­‰å¾…é‡Šæ”¾çš„è¯»é”æ•°é‡ï¼Œå¦‚æœæœ‰æŒ‚èµ·å†™é” if r != 0 \u0026\u0026 atomic.AddInt32(\u0026rw.readerWait, r) != 0 { runtime_SemacquireMutex(\u0026rw.writerSem, false, 0) } } è¿™é‡Œå…ˆç”¨äº’æ–¥é”ä¿æŠ¤ä¸‹é¢çš„æ“ä½œï¼š è®¾ç½®è¯»ç­‰å¾…çš„æ•°é‡readerWaitï¼Œå¦‚æœä¸ä¸º0ï¼Œå°±æŒ‚èµ·å†™é” ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E8%AF%BB%E5%86%99%E9%94%81/:4:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹è¯»å†™é”","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E8%AF%BB%E5%86%99%E9%94%81/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"å†™è§£é”Unlock func (rw *RWMutex) Unlock() { // å‘è¯»é”çš„goroutineå‘å‡ºé€šçŸ¥ï¼Œæ²¡æœ‰å†™é”äº† // è¿˜åŸåŠ é”æ—¶çš„readerCount r := atomic.AddInt32(\u0026rw.readerCount, rwmutexMaxReaders) if r \u003e= rwmutexMaxReaders { race.Enable() throw(\"sync: Unlock of unlocked RWMutex\") } for i := 0; i \u003c int(r); i++ { runtime_Semrelease(\u0026rw.readerSem, false, 0) } // Allow other writers to proceed. rw.w.Unlock() } å†™è§£é”æ—¶ï¼Œé¦–å…ˆå°†readerCountæ•°é‡è¿˜åŸï¼Œç„¶åå»å”¤é†’è¯»é” ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E8%AF%BB%E5%86%99%E9%94%81/:5:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹è¯»å†™é”","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E8%AF%BB%E5%86%99%E9%94%81/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"æ€»ç»“ æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œè¯»å†™é”é¦–å…ˆå†…ç½®äº†ä¸€ä¸ªäº’æ–¥é”ï¼Œå†åŠ ä¸Šå„ç§è®¡æ•°å™¨æ¥å®ç°è¯»å†™é”ã€‚ è¯»é”ä¸èƒ½é˜»å¡è¯»é”ï¼Œæ‰€ä»¥æ·»åŠ readerCount è¯»é”éœ€è¦é˜»å¡å†™é”ï¼Œç›´åˆ°æ‰€æœ‰çš„è¯»é”é‡Šæ”¾ï¼Œå¼•å…¥writerSem å†™é”éœ€è¦é˜»å¡è¯»é”ï¼Œç›´åˆ°æ‰€æœ‰å†™é”é‡Šæ”¾ï¼Œå¼•å…¥readerSem å†™é”éœ€è¦é˜»å¡å†™é”ï¼Œå¼•å…¥mutexå®ç° ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E8%AF%BB%E5%86%99%E9%94%81/:6:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹è¯»å†™é”","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E8%AF%BB%E5%86%99%E9%94%81/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"å¹¶å‘å¿…ç„¶ä¼šå¸¦æ¥å¯¹äºèµ„æºçš„ç«äº‰ï¼Œè¿™æ—¶éœ€è¦ä½¿ç”¨goæä¾›çš„sync.Mutexè¿™æŠŠäº’æ–¥é”æ¥ä¿è¯ä¸´ç•Œèµ„æºçš„è®¿é—®äº’æ–¥äº†ã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.mutex/:0:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹äº’æ–¥é”","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.mutex/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"é”çš„æ€§è´¨ åœ¨ä»£ç æ³¨é‡Šå¼€ç¯‡å°±æœ‰ä¸€å¤§æ®µæ³¨é‡Šï¼Œé‡Œé¢è®²äº†é”çš„è®¾è®¡ç†å¿µã€‚å¤§è‡´æ„æ€å¦‚ä¸‹ï¼š é”æœ‰ä¸¤ç§æ¨¡å¼ï¼šæ­£å¸¸æ¨¡å¼å’Œé¥¥é¥¿æ¨¡å¼ã€‚ åœ¨æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰çš„ç­‰å¾…é”çš„goroutineéƒ½ä¼šå­˜åœ¨ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ä¸­ï¼ˆè½®æµè¢«å”¤é†’ï¼‰ ä½†æ˜¯ä¸€ä¸ªè¢«å”¤é†’çš„goroutineå¹¶ä¸æ˜¯ç›´æ¥è·å¾—é”ï¼Œè€Œæ˜¯ä»ç„¶éœ€è¦å’Œé‚£äº›æ–°è¯·æ±‚é”çš„ï¼ˆnew arrivialï¼‰çš„goroutineç«äº‰ï¼Œè€Œè¿™å…¶å®æ˜¯ä¸å…¬å¹³çš„ï¼Œå› ä¸ºæ–°è¯·æ±‚é”çš„goroutineæœ‰ä¸€ä¸ªä¼˜åŠ¿â€”â€”å®ƒä»¬æ­£åœ¨CPUä¸Š è¿è¡Œï¼Œå¹¶ä¸”æ•°é‡å¯èƒ½ä¼šå¾ˆå¤šã€‚æ‰€ä»¥ä¸€ä¸ªè¢«å”¤é†’çš„goroutineæ‹¿åˆ°é”çš„æ¦‚ç‡æ˜¯å¾ˆå°çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ è¿™ä¸ªè¢«å”¤é†’çš„goroutineä¼šåŠ å…¥åˆ°é˜Ÿåˆ—çš„å¤´éƒ¨ã€‚å¦‚æœä¸€ä¸ªç­‰å¾…çš„goroutineæœ‰è¶…è¿‡1msï¼ˆå†™æ­»åœ¨ä»£ç ä¸­ï¼‰ éƒ½æ²¡è·å–åˆ°é”ï¼Œé‚£ä¹ˆå°±ä¼šæŠŠé”è½¬å˜ä¸ºé¥¥é¥¿æ¨¡å¼ã€‚ åœ¨é¥¥é¥¿æ¨¡å¼ä¸­ï¼Œé”çš„æ‰€æœ‰æƒä¼šç›´æ¥ä»é‡Šæ”¾é”(unlock)çš„goroutineè½¬äº¤ç»™é˜Ÿåˆ—å¤´çš„goroutineï¼Œ æ–°è¯·æ±‚é”çš„goroutineå°±ç®—é”æ˜¯ç©ºé—²çŠ¶æ€ä¹Ÿä¸ä¼šå»è·å–é”ï¼Œå¹¶ä¸”ä¹Ÿä¸ä¼šå°è¯•è‡ªæ—‹ã€‚å®ƒä»¬åªæ˜¯æ’åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨ã€‚ å¦‚æœä¸€ä¸ªgoroutineè·å–åˆ°äº†é”ä¹‹åï¼Œå®ƒä¼šåˆ¤æ–­ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š å®ƒæ˜¯é˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªgoroutineï¼› å®ƒæ‹¿åˆ°é”æ‰€èŠ±çš„æ—¶é—´å°äº1msï¼› ä»¥ä¸Šåªè¦æœ‰ä¸€ä¸ªæˆç«‹ï¼Œå®ƒå°±ä¼šæŠŠé”è½¬å˜å›æ­£å¸¸æ¨¡å¼ã€‚ æ­£å¸¸æ¨¡å¼ä¼šæœ‰æ¯”è¾ƒå¥½çš„æ€§èƒ½ï¼Œå› ä¸ºå³ä½¿æœ‰å¾ˆå¤šé˜»å¡çš„ç­‰å¾…é”çš„goroutineï¼Œ ä¸€ä¸ªgoroutineä¹Ÿå¯ä»¥å°è¯•è¯·æ±‚å¤šæ¬¡é”ã€‚ é¥¥é¥¿æ¨¡å¼å¯¹äºé˜²æ­¢å°¾éƒ¨å»¶è¿Ÿæ¥è¯´éå¸¸çš„é‡è¦ã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.mutex/:1:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹äº’æ–¥é”","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.mutex/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"å­—æ®µå®šä¹‰ // A Mutex must not be copied after first use. type Mutex struct { state int32 // é”çš„å½“å‰çŠ¶æ€ sema uint32 // ä¿¡å·é‡ï¼Œç”¨æˆ·å”¤é†’goroutine } const ( // æ˜¯å¦åŠ é”çš„æ ‡è¯† mutexLocked = 1 \u003c\u003c iota // mutex is locked mutexWoken mutexStarving mutexWaiterShift = iota // Mutex fairness. starvationThresholdNs = 1e6 ) stateçš„çŠ¶æ€ï¼š mutexLockedï¼šå¯¹åº”ä½1ä½bitä»£è¡¨é”è¢«å ç”¨ï¼Œ0æ ‡è¯†é”ç©ºé—² mutexWokenï¼šå¯¹åº”ä½2ä½bitä»£è¡¨å·²å”¤é†’ï¼Œ0æ ‡è¯†æœªå”¤é†’ mutexStarvingï¼šå¯¹åº”ä½3ä½bitä»£è¡¨å¤„äºé¥¥é¥¿æ¨¡å¼ï¼Œ0æ ‡è¯†æ­£å¸¸æ¨¡å¼ mutexWaiterShiftï¼š3(011)ï¼Œm.state\u003e\u003emutexWaiterShiftå¾—åˆ°å½“å‰é˜»å¡çš„goroutineæ•°ç›®ï¼Œæœ€å¤šå¯ä»¥é˜»å¡2^29^ä¸ªgoroutineã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.mutex/:2:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹äº’æ–¥é”","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.mutex/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"Lock func (m *Mutex) Lock() { // Fast path: grab unlocked mutex. // åˆ¤æ–­æ˜¯å¦å¯ä»¥åŠ é”ã€‚ // ç¬¬ä¸€ä¸ªå¯ä»¥ç›´æ¥åŠ é”è¿”å› if atomic.CompareAndSwapInt32(\u0026m.state, 0, mutexLocked) { return } // Slow path (outlined so that the fast path can be inlined) m.lockSlow() } func (m *Mutex) lockSlow() { var waitStartTime int64 // é¥¥é¥¿æ¨¡å¼ starving := false // åç¨‹å”¤é†’ awoke := false // å¾ªç¯æ¬¡æ•° iter := 0 // å½“å‰é”çŠ¶æ€ old := m.state for { // Don't spin in starvation mode, ownership is handed off to waiters // so we won't be able to acquire the mutex anyway. // æ¡ä»¶ä¸€ï¼šoldè¢«è·å–åˆ°é”ï¼Œä½†ä¸å¤„äºé¥¥é¥¿çŠ¶æ€ã€‚å¦‚æœå¤„äºé¥¥é¥¿çŠ¶æ€ï¼Œé”çš„æ‰€æœ‰æƒç›´æ¥äº¤ç»™ç­‰å¾…é˜Ÿåˆ—ç¬¬ä¸€ä¸ª // æ¡ä»¶äºŒï¼šå¯ä»¥è‡ªæ—‹ï¼Œå¤šæ ¸ã€å‹åŠ›ä¸å¤§å¹¶ä¸”åœ¨ä¸€å®šæ¬¡æ•°å†…å¯ä»¥è‡ªæ—‹ã€‚sync_runtime_canSpinçš„å®ç° if old\u0026(mutexLocked|mutexStarving) == mutexLocked \u0026\u0026 runtime_canSpin(iter) { // Active spinning makes sense. // Try to set mutexWoken flag to inform Unlock // to not wake other blocked goroutines. // è‡ªæ—‹è¿‡ç¨‹ä¸­å¦‚æœå‘ç°stateæ²¡æœ‰è®¾ç½®å”¤é†’æ ‡è¯†ï¼Œæ·»åŠ awokeæ ‡è¯†ï¼Œå¹¶æ ‡è®°è‡ªå·±å·²å”¤é†’ if !awoke \u0026\u0026 old\u0026mutexWoken == 0 \u0026\u0026 old\u003e\u003emutexWaiterShift != 0 \u0026\u0026 atomic.CompareAndSwapInt32(\u0026m.state, old, old|mutexWoken) { awoke = true } // ä¸»åŠ¨è‡ªæ—‹ runtime_doSpin() iter++ old = m.state continue } // åˆ°äº†è¿™ä¸€æ­¥ï¼šstateçš„çŠ¶æ€å¯èƒ½æ˜¯ // 1ã€é”æ²¡æœ‰é‡Šæ”¾ï¼Œé”å¤„äºæ­£å¸¸çŠ¶æ€ï¼ˆ011ï¼‰ // 2ã€é”æ²¡æœ‰é‡Šæ”¾ï¼Œé”å¤„äºé¥¥é¥¿çŠ¶æ€ï¼ˆ111ï¼‰ // 3ã€é”å·²ç»é‡Šæ”¾ï¼Œé”å¤„äºæ­£å¸¸çŠ¶æ€ï¼ˆ010ï¼‰ // 4ã€é”å·²ç»é‡Šæ”¾ï¼Œé”å¤„äºé¥¥é¥¿çŠ¶æ€ï¼ˆ110ï¼‰ // å¤åˆ¶ä¸€ä¸ªæ–°çš„çŠ¶æ€ new := old // Don't try to acquire starving mutex, new arriving goroutines must queue. // å¦‚æœä¸æ˜¯é¥¥é¥¿çŠ¶æ€ï¼Œnewè®¾ç½®é”ï¼Œå°è¯•è·å–é” // å¦‚æœå¤„äºé¥¥é¥¿çŠ¶æ€ï¼Œä¸è®¾ç½®çŠ¶æ€ if old\u0026mutexStarving == 0 { new |= mutexLocked // æ ‡è®°ä¸ºè·å–é”ï¼ˆå®é™…ä¸Šè¿˜æ²¡æœ‰è·å–åˆ°ï¼‰ } // å¦‚æœoldé”å¤„äºè¢«è·å–æˆ–é¥¥é¥¿çŠ¶æ€ï¼Œå°±æŠŠæœŸæœ›çŠ¶æ€çš„ç­‰å¾…é˜Ÿåˆ—çš„ç­‰å¾…è€…æ•°é‡+1 if old\u0026(mutexLocked|mutexStarving) != 0 { new += 1 \u003c\u003c mutexWaiterShift } // The current goroutine switches mutex to starvation mode. // But if the mutex is currently unlocked, don't do the switch. // Unlock expects that starving mutex has waiters, which will not // be true in this case. // å¦‚æœå¤„äºé¥¥é¥¿çŠ¶æ€ï¼Œå¹¶ä¸”stateå·²ç»è¢«åŠ é”ï¼Œå°†new stateæ ‡è®°ä¸ºé¥¥é¥¿çŠ¶æ€ if starving \u0026\u0026 old\u0026mutexLocked != 0 { new |= mutexStarving } if awoke { // The goroutine has been woken from sleep, // so we need to reset the flag in either case. // goroutineå·²ç»è¢«å”¤é†’ï¼Œå› æ­¤éœ€è¦reset if new\u0026mutexWoken == 0 { throw(\"sync: inconsistent mutex state\") } // è®¾ä¸ºæœªå”¤é†’çŠ¶æ€ new \u0026^= mutexWoken } // åŸå­æ›´æ–°state if atomic.CompareAndSwapInt32(\u0026m.state, old, new) { // å¦‚æœoldçŠ¶æ€ä¸æ˜¯é¥¥é¥¿çŠ¶æ€ä¹Ÿä¸æ˜¯è¢«è·å–çŠ¶æ€ï¼Œä»£è¡¨å½“å‰goroutineå·²ç»è·å–äº†é” if old\u0026(mutexLocked|mutexStarving) == 0 { break // locked the mutex with CAS } // If we were already waiting before, queue at the front of the queue. // å¦‚æœä¹‹å‰åœ¨ç­‰å¾…äº†ï¼Œå°±æ’åœ¨é˜Ÿåˆ—å‰é¢ queueLifo := waitStartTime != 0 // å¦‚æœæ²¡æœ‰ç­‰å¾…è¿‡ï¼Œåˆå§‹åŒ–ç­‰å¾…æ—¶é—´ if waitStartTime == 0 { waitStartTime = runtime_nanotime() } // å¦‚æœqueueLifoä¸ºtrueï¼Œå°†ç­‰å¾…æœåŠ¡æ–¹é’ˆç­‰å¾…é˜Ÿåˆ—é˜Ÿå¤´ï¼Œè¢«é˜»å¡ runtime_SemacquireMutex(\u0026m.sema, queueLifo, 1) // é˜»å¡è¢«å”¤é†’ // å¦‚æœæ˜¯é¥¥é¥¿çŠ¶æ€æˆ–ç­‰å¾…è¶…è¿‡1msï¼Œå°†å½“å‰goroutineçŠ¶æ€è®¾ç½®ä¸ºé¥¥é¥¿ starving = starving || runtime_nanotime()-waitStartTime \u003e starvationThresholdNs old = m.state // å¦‚æœæ˜¯é¥¥é¥¿çŠ¶æ€ if old\u0026mutexStarving != 0 { // If this goroutine was woken and mutex is in starvation mode, // ownership was handed off to us but mutex is in somewhat // inconsistent state: mutexLocked is not set and we are still // accounted as waiter. Fix that. if old\u0026(mutexLocked|mutexWoken) != 0 || old\u003e\u003emutexWaiterShift == 0 { throw(\"sync: inconsistent mutex state\") } // å½“å‰çš„goroutineè·å–é”ï¼Œwaiter-1 delta := int32(mutexLocked - 1\u003c\u003cmutexWaiterShift) // å¦‚æœå½“å‰goroutineä¸æ˜¯é¥¥é¥¿çŠ¶æ€æˆ–å½“å‰goroutineæ˜¯é˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªï¼Œé€€å‡ºé¥¥é¥¿æ¨¡å¼ï¼ŒçŠ¶æ€è®¾ä¸ºæ­£å¸¸ if !starving || old\u003e\u003emutexWaiterShift == 1 { // Exit starvation mode. // Critical to do it here and consider wait time. // Starvation mode is so inefficient, that two goroutines // can go lock-step infinitely once they switch mutex // to starvation mode. delta -= mutexStarving } atomic.AddInt32(\u0026m.state, delta) break } awoke = true iter = 0 } else { // casä¸æˆåŠŸï¼Œè¯´æ˜æ²¡æœ‰æˆåŠŸè·å–åˆ°é”ï¼Œæ›´æ–°old old = m.state } } } åŠ é”æµç¨‹ 1ã€åŸå­åˆ¤æ–­æ˜¯å¦å¯ä»¥åŠ é”ï¼Œå¦‚æœå½“å‰é”æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œå½“å‰goroutineè·å–é”ï¼Œç»“æŸæœ¬æ¬¡Lockæ“ä½œ 2ã€å¦‚æœå·²ç»è¢«åˆ«çš„goroutineæŒæœ‰äº†ï¼Œå¯åŠ¨ä¸€ä¸ªforå¾ªç¯å»æŠ¢å é”ï¼š ä¼šå­˜åœ¨ä¸¤ç§çŠ¶æ€çš„åˆ‡æ¢ï¼šé¥¥é¥¿çŠ¶æ€å’Œæ­£å¸¸çŠ¶æ€ å¦‚æœä¸€ä¸ªç­‰å¾…çš„goroutineæœ‰è¶…è¿‡1msæ²¡æœ‰è·å–åˆ°é”ï¼Œé‚£ä¹ˆæŠŠé”è½¬æ¢ä¸ºé¥¥é¥¿æ¨¡å¼ï¼› å¦‚æœä¸€ä¸ªgoroutineè·å–åˆ°é”å 1ã€å®ƒæ˜¯é˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªgoroutine 2ã€å®ƒæ‹¿åˆ°é”èŠ±è´¹çš„æ—¶é—´å°äº1ms ä¸Šé¢çš„ä¸¤ä¸ªåªè¦æœ‰ä¸€ä¸ªæ¡ä»¶æˆç«‹ï¼Œå°±ä¼šæŠŠé”è½¬ä¸ºæ­£å¸¸çŠ¶æ€ã€‚ 3ã€å¦‚æœé”å·²ç»è¢«å…¶ä»–goroutineæŒæœ‰äº†ï¼Œä½†ä¸æ˜¯é¥¥é¥¿çŠ¶æ€ï¼Œå¹¶ä¸”æ»¡è¶³è‡ªæ—‹çŠ¶æ€ï¼Œå½“å‰goroutineä¼šä¸æ–­è‡ªæ—‹ï¼Œç­‰å¾…é”è¢«é‡Šæ”¾ 4ã€ä¸æ»¡è¶³è‡ªæ—‹æ¡ä»¶çš„goroutineï¼Œç»“æŸè‡ªæ—‹çŠ¶æ€ 5ã€å¦‚æœold.stateä¸æ˜¯é¥¥é¥¿çŠ¶æ€ï¼Œæ–°çš„goroutineä¼šå»å°è¯•è·å–é”ï¼Œå¦‚æœæ˜¯é¥¥é¥¿çŠ¶æ€ï¼Œå°±ç›´æ¥æŠŠé”äº¤ç»™ç­‰å¾…é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ª 6ã€å¦‚æœé”æ—¶è¢«è·å–æˆ–é¥¥é¥¿çŠ¶æ€ï¼Œç­‰å¾…è€…æ•°é‡+1 7ã€å½“æœ¬goroutineè¢«å”¤é†’","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.mutex/:3:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹äº’æ–¥é”","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.mutex/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"UnLock func (m *Mutex) Unlock() { if race.Enabled { _ = m.state race.Release(unsafe.Pointer(m)) } // Fast path: drop lock bit. // ä¿®æ”¹é”çš„çŠ¶æ€ new := atomic.AddInt32(\u0026m.state, -mutexLocked) if new != 0 { // å¦‚æœnew=0ï¼Œè¯´æ˜åªæœ‰ä¸€ä¸ªLockå¹¶ä¸”è¢«è§£å¼€äº† // Outlined slow path to allow inlining the fast path. // To hide unlockSlow during tracing we skip one extra frame when tracing GoUnblock. m.unlockSlow(new) } } func (m *Mutex) unlockSlow(new int32) { // ï¼ˆnew+1ï¼‰\u00261==0ï¼Œnew=-1ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢å·²ç»Unlockååˆè°ƒç”¨ä¸€æ¬¡Unlockä¼šå‡ºç°è¿™ç§æƒ…å†µ if (new+mutexLocked)\u0026mutexLocked == 0 { throw(\"sync: unlock of unlocked mutex\") } if new\u0026mutexStarving == 0 { // ä¸æ˜¯é¥¥é¥¿çŠ¶æ€ old := new for { // å¦‚æœé”æ²¡æœ‰ç­‰å¾…æ‹¿é”çš„goroutine // æˆ–é”è¢«è·å–äº†ï¼ˆåœ¨å¾ªç¯è¿‡ç¨‹ä¸­è¢«å…¶ä»–goroutineè·å–äº†ï¼‰ // æˆ–é”æ˜¯è¢«å”¤é†’çŠ¶æ€ï¼ˆè¡¨ç¤ºæœ‰goroutineè¢«å”¤é†’ï¼Œä¸éœ€è¦å†å»å°è¯•å”¤é†’å…¶ä»–goroutineï¼‰ // æˆ–è€…é”æ˜¯é¥¥é¥¿çŠ¶æ€ï¼ˆä¼šç›´æ¥äº¤ç»™é˜Ÿåˆ—å¤´çš„goroutineï¼‰ // é‚£ä¹ˆç›´æ¥è¿”å› if old\u003e\u003emutexWaiterShift == 0 || old\u0026(mutexLocked|mutexWoken|mutexStarving) != 0 { return } // Grab the right to wake someone. // å°†ç­‰å¾…é˜Ÿåˆ—-1ï¼Œè®¾ç½®wokenæ ‡è¯† new = (old - 1\u003c\u003cmutexWaiterShift) | mutexWoken // è®¾ç½®æ–°çš„stateï¼Œé€šè¿‡ä¿¡å·é‡ä¼šå”¤é†’ä¸€ä¸ªé˜»å¡çš„goroutineå»è·å–é” if atomic.CompareAndSwapInt32(\u0026m.state, old, new) { runtime_Semrelease(\u0026m.sema, false, 1) return } old = m.state } } else { // é¥¥é¥¿æ¨¡å¼ä¸‹ï¼Œç›´æ¥å°†é”çš„æ‰€æœ‰æƒè½¬ç»™ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªã€‚ // æ³¨æ„æ­¤æ—¶stateçš„mutexLockedè¿˜æ²¡æœ‰è®¾ç½®ï¼Œå”¤é†’çš„goroutineä¼šè®¾ç½®å®ƒã€‚ // åœ¨æ­¤æœŸé—´ï¼Œå¦‚æœæœ‰æ–°çš„goroutineæ¥è¯·æ±‚é”ï¼Œå› ä¸ºmutexå¤„äºé¥¥é¥¿çŠ¶æ€ï¼Œmutexè¿˜ä¼šè¢«è®¤ä¸ºå¤„äºé”çš„çŠ¶æ€ï¼Œæ–°æ¥çš„goroutineä¸ä¼šæŠ¢å é” runtime_Semrelease(\u0026m.sema, true, 1) } } è§£é”æµç¨‹ 1ã€åˆ¤æ–­é”çš„çŠ¶æ€ï¼Œä¸èƒ½é‡å¤è§£é” 2ã€å¦‚æœé”æ˜¯æ­£å¸¸æ¨¡å¼ï¼Œä¼šä¸æ–­å°è¯•è§£é” 3ã€å¦‚æœé”æ—¶é¥¥é¥¿æ¨¡å¼ï¼Œé€šè¿‡ä¿¡å·é‡ï¼Œå”¤é†’é¥¥é¥¿æ¨¡å¼ä¸‹Lockæ“ä½œé˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªgoroutine ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.mutex/:4:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹äº’æ–¥é”","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.mutex/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"æ€»ç»“ åŠ é”è¿‡ç¨‹ä¼šå­˜åœ¨æ­£å¸¸æ¨¡å¼å’Œé¥¥é¥¿æ¨¡å¼çš„è½¬æ¢ é¥¥é¥¿æ¨¡å¼æ˜¯ä¿è¯é”çš„å…¬å¹³æ€§ï¼Œæ­£å¸¸æ¨¡å¼ä¸‹çš„äº’æ–¥é”èƒ½æä¾›æ›´å¥½çš„æ€§èƒ½ï¼Œé¥¥é¥¿æ¨¡å¼èƒ½é¿å…goroutineç”±äºé™·å…¥ç­‰å¾…æ— æ³•è·å–é”é€ æˆçš„é«˜å°¾å»¶è¿Ÿ é”çš„çŠ¶æ€åˆ‡æ¢ï¼Œç”¨çš„æ˜¯ä½è¿ç®— ä¸€ä¸ªå·²ç»é”å®šçš„äº’æ–¥é”ï¼Œåªèƒ½è¢«è§£é”ä¸€æ¬¡ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.mutex/:5:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹äº’æ–¥é”","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.mutex/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"å¦‚æœatomicå¯ä»¥ä¿è¯åŸå­æ€§ï¼Œé‚£ä¹ˆå’Œmutexæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ Mutexes are slow, due to the setup and teardown, and due to the fact that they block other goroutines for the duration of the lock. Atomic operations are fast because they use an atomic CPU instruction, rather than relying on external locks to. äº’æ–¥é”å…¶å®æ˜¯é€šè¿‡é˜»å¡å…¶ä»–åç¨‹èµ·åˆ°äº†åŸå­æ“ä½œçš„åŠŸèƒ½ï¼Œè€Œatomicæ˜¯é€šè¿‡æ§åˆ¶æ›´åº•å±‚çš„CPUæŒ‡ä»¤ï¼Œæ¥è¾¾åˆ°å€¼æ“ä½œçš„åŸå­æ€§ã€‚ mutexç±»ä¼¼äºæ‚²è§‚é”ï¼Œæ€»æ˜¯å‡è®¾ä¼šæœ‰å¹¶å‘çš„æ“ä½œè¦ä¿®æ”¹è¢«æ“ä½œçš„å€¼ï¼Œæ‰€ä»¥ä½¿ç”¨é”å°†ç›¸å…³æ“ä½œæ”¾å…¥ä¸´ç•ŒåŒºåŠ ä»¥ä¿æŠ¤ è€ŒåŸå­é”CASè¶‹å‘äºä¹è§‚é”ï¼Œæ€»æ˜¯å‡è®¾è¢«æ“ä½œå€¼æœªæ›¾ä¿®æ”¹ï¼ˆä¸æ—§å€¼ç›¸ç­‰ï¼‰ï¼Œä¸€æ—¦ç¡®è®¤å°±ç«‹å³è¿›è¡Œå€¼æ›¿æ¢ã€‚åœ¨å€¼è¢«é¢‘ç¹å˜æ›´çš„æƒ…å†µä¸‹ï¼ŒCASæ“ä½œå¹¶ä¸æ˜¯å®¹æ˜“æˆåŠŸéœ€è¦ä¸æ–­å°è¯•ã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.mutex/:5:1","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹äº’æ–¥é”","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.mutex/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"sync.Condå­—é¢æ„æ€å°±æ˜¯åŒæ­¥æ¡ä»¶å˜é‡ï¼Œå®ƒå®ç°çš„æ˜¯ä¸€ç§ç›‘è§†å™¨(Monitor)æ¨¡å¼ã€‚ å¯¹äºCondè€Œè¨€ï¼Œå®ƒå®ç°ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼Œæ˜¯goroutineé—´ç­‰å¾…å’Œé€šçŸ¥çš„ç‚¹ã€‚æ¡ä»¶å˜é‡å’Œå…±äº«çš„æ•°æ®éš”ç¦»ï¼Œå®ƒå¯ä»¥åŒæ—¶é˜»å¡å¤šä¸ªgoroutineï¼ŒçŸ¥é“å¦å¤–çš„goroutineæ›´æ”¹äº†æ¡ä»¶å˜é‡ï¼Œå¹¶é€šçŸ¥å”¤é†’é˜»å¡ç€çš„ä¸€ä¸ªæˆ–å¤šä¸ªgoroutineã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.cond/:0:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹æ¡ä»¶å˜é‡Cond","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.cond/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"æ¼”ç¤ºä¾‹å­ ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹ GopherCon 2018 ä¸Šã€ŠRethinking Classical Concurrency Patternsã€‹ ä¸­çš„æ¼”ç¤ºä»£ç ä¾‹å­ã€‚ type Item = int type Queue struct { items []Item itemAdded sync.Cond } func NewQueue() *Queue { q := new(Queue) q.itemAdded.L = \u0026sync.Mutex{} // ä¸º Cond ç»‘å®šé” return q } func (q *Queue) Put(item Item) { q.itemAdded.L.Lock() defer q.itemAdded.L.Unlock() q.items = append(q.items, item) q.itemAdded.Signal() // å½“ Queue ä¸­åŠ å…¥æ•°æ®æˆåŠŸï¼Œè°ƒç”¨ Singal å‘é€é€šçŸ¥ } func (q *Queue) GetMany(n int) []Item { q.itemAdded.L.Lock() defer q.itemAdded.L.Unlock() for len(q.items) \u003c n { // ç­‰å¾… Queue ä¸­æœ‰ n ä¸ªæ•°æ® q.itemAdded.Wait() // é˜»å¡ç­‰å¾… Singal å‘é€é€šçŸ¥ } items := q.items[:n:n] q.items = q.items[n:] return items } func main() { q := NewQueue() var wg sync.WaitGroup for n := 10; n \u003e 0; n-- { wg.Add(1) go func(n int) { items := q.GetMany(n) fmt.Printf(\"%2d: %2d\\n\", n, items) wg.Done() }(n) } for i := 0; i \u003c 100; i++ { q.Put(i) } wg.Wait() } åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒQueueæ˜¯å­˜å‚¨Itemçš„ç»“æ„ä½“ï¼Œé€šè¿‡Condç±»å‹çš„itemAddedæ¥æ§åˆ¶æ•°æ®çš„è¾“å…¥ä¸è¾“å‡ºã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œé€šè¿‡10ä¸ªgoroutineæ¥æ¶ˆè´¹æ•°æ®ï¼Œä½†æ˜¯é€æ­¥æ·»åŠ 100ä¸ªæ•°æ®è‡³Queueä¸­ã€‚æœ€åï¼Œæˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°10ä¸ªgoroutineéƒ½èƒ½è¢«å”¤é†’ï¼Œå¾—åˆ°æ•°æ®ã€‚ ç¨‹åºçš„è¿è¡Œç»“æœå¦‚ä¸‹ï¼š 3: [11 12 13] 2: [ 0 1] 9: [ 2 3 4 5 6 7 8 9 10] 1: [14] 6: [41 42 43 44 45 46] 4: [32 33 34 35] 5: [36 37 38 39 40] 7: [25 26 27 28 29 30 31] 8: [47 48 49 50 51 52 53 54] 10: [15 16 17 18 19 20 21 22 23 24] å½“ç„¶ï¼Œæ¯æ¬¡çš„è¿è¡Œç»“æœéƒ½ä¸ä¼šç›¸åŒã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.cond/:1:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹æ¡ä»¶å˜é‡Cond","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.cond/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"æºç å®ç° Condçš„å®ç°è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä»£ç é‡æ¯”è¾ƒå°‘ï¼Œå¤æ‚çš„é€»è¾‘å·²ç»è¢«Lockerå’Œruntimeçš„ç­‰å¾…é˜Ÿåˆ—å®ç°äº†ã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.cond/:2:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹æ¡ä»¶å˜é‡Cond","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.cond/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"ç»“æ„ä½“ é¦–å…ˆæ¥çœ‹å®ƒçš„ç»“æ„ä½“ï¼š // A Cond must not be copied after first use. type Cond struct { noCopy noCopy // ä¸å…è®¸æ‹·è´ // L is held while observing or changing the condition // L æ˜¯è§‚å¯Ÿå’Œæ”¹å˜æ¡ä»¶çš„ L Locker notify notifyList // é€šçŸ¥åˆ—è¡¨ï¼Œè°ƒç”¨Wait()æ–¹æ³•çš„goroutineä¼šæ”¾å…¥listä¸­ï¼Œæ¯æ¬¡è¢«å”¤é†’ä»è¿™é‡Œå–å‡º checker copyChecker // æ‹·è´æ£€æŸ¥ï¼Œæ£€æŸ¥condæ˜¯å¦è¢«æ‹·è´ } è¿™é‡Œçš„notifyListé€šçŸ¥åˆ—è¡¨ï¼š type notifyList struct { wait uint32 // å†™ä¸€ä¸ªç­‰å¾…goroutineçš„ticketï¼Œæ˜¯åŸå­æ€§çš„ï¼Œåœ¨é”å¤–é€’å¢ notify uint32 // ä¸‹ä¸€ä¸ªé€šçŸ¥çš„goroutineçš„ticketï¼Œåœ¨é”å¤–è¯»å–ï¼Œä½†åªèƒ½åœ¨æŒæœ‰é”çš„æƒ…å†µä¸‹å†™å…¥ lock uintptr // éœ€è¦ä¼ å…¥çš„é”çš„æ ‡è®° head unsafe.Pointer // åŸºäº*sudogçš„åŒå‘é“¾è¡¨çš„å‰é©±æŒ‡é’ˆ tail unsafe.Pointer // åŸºäº*sudogçš„åŒå‘é“¾è¡¨çš„åé©±æŒ‡é’ˆ } åŸºæœ¬ç»“æ„å¤§è‡´å°±æ˜¯è¿™æ ·ï¼Œä¸‹é¢æ¥çœ‹çœ‹å®ç°æ–¹æ³•ã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.cond/:2:1","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹æ¡ä»¶å˜é‡Cond","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.cond/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"Waitæ–¹æ³•çš„å®ç° func (c *Cond) Wait() { c.checker.check() t := runtime_notifyListAdd(\u0026c.notify) // åŠ å…¥åˆ°é€šçŸ¥åˆ—è¡¨ c.L.Unlock() runtime_notifyListWait(\u0026c.notify, t) // ç­‰å¾…é€šçŸ¥ c.L.Lock() } æ‰§è¡Œè¿è¡ŒæœŸé—´æ‹·è´æ£€æŸ¥ï¼Œå¦‚æœå‘ç”Ÿäº†æ‹·è´ï¼Œåˆ™ç›´æ¥panic è°ƒç”¨runtime_notifyListAddå°†ç­‰å¾…è®¡æ•°å™¨åŠ 1å¹¶è§£é” è°ƒç”¨runtime_notifyListWaitç­‰å¾…å…¶ä»–goroutineçš„å”¤é†’å¹¶åŠ é” è€Œåœ¨runtime/sema.goä¸­runtime_notifyListAddçš„å®ç°ï¼š func notifyListAdd(l *notifyList) uint32 { // This may be called concurrently, for example, when called from // sync.Cond.Wait while holding a RWMutex in read mode. return atomic.Xadd(\u0026l.wait, 1) - 1 } å®ç°æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯åŸå­æ“ä½œå°†ç­‰å¾…è®¡æ•°å™¨+1ï¼Œè€Œè¿”å›çš„å€¼æ˜¯ä»£è¡¨ä¸‹ä¸€ä¸ªç­‰å¾…å”¤é†’çš„goroutineçš„ç´¢å¼• ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.cond/:2:2","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹æ¡ä»¶å˜é‡Cond","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.cond/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"runtime_notifyListWaitçš„å®ç° func notifyListWait(l *notifyList, t uint32) { lock(\u0026l.lock) // Return right away if this ticket has already been notified. if less(t, l.notify) { unlock(\u0026l.lock) return } // Enqueue itself. s := acquireSudog() s.g = getg() s.ticket = t s.releasetime = 0 t0 := int64(0) if blockprofilerate \u003e 0 { t0 = cputicks() s.releasetime = -1 } if l.tail == nil { l.head = s } else { l.tail.next = s } l.tail = s goparkunlock(\u0026l.lock, waitReasonSyncCondWait, traceEvGoBlockCond, 3) if t0 != 0 { blockevent(s.releasetime-t0, 2) } releaseSudog(s) } æ£€æŸ¥å½“å‰waitä¸notifyç´¢å¼•ä½ç½®æ˜¯å¦åŒ¹é…ï¼Œå¦‚æœå·²ç»é€šçŸ¥è¿‡äº†ï¼Œåˆ™ç«‹å³è¿”å› è·å–å½“å‰goroutineï¼Œå¹¶ä¸”å°†å½“å‰çš„goroutineåŠ å…¥åˆ°é“¾è¡¨æœ«ç«¯ è°ƒç”¨goparkunlockæ–¹æ³•æŒ‚èµ·å½“å‰goroutine è¢«å”¤é†’åï¼Œè°ƒç”¨releaseSudogé‡Šæ”¾å½“å‰goroutine Signalå’ŒBoardcastéƒ½ä¼šå”¤é†’ç­‰å¾…é˜Ÿåˆ—ï¼Œä¸è¿‡Signalæ˜¯å”¤é†’é“¾è¡¨æœ€å‰é¢çš„goroutineï¼ŒBoardcastä¼šå”¤é†’é˜Ÿåˆ—ä¸­å…¨éƒ¨çš„goroutineã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.cond/:2:3","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹æ¡ä»¶å˜é‡Cond","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.cond/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"Signal // é€šçŸ¥ç­‰å¾…åˆ—è¡¨ä¸­çš„ä¸€ä¸ª func (c *Cond) Signal() { c.checker.check() runtime_notifyListNotifyOne(\u0026c.notify) } func notifyListNotifyOne(l *notifyList) { // Fast-path: if there are no new waiters since the last notification // we don't need to acquire the lock at all. if atomic.Load(\u0026l.wait) == atomic.Load(\u0026l.notify) { return } lock(\u0026l.lock) // Re-check under the lock if we need to do anything. t := l.notify if t == atomic.Load(\u0026l.wait) { unlock(\u0026l.lock) return } // Update the next notify ticket number. atomic.Store(\u0026l.notify, t+1) for p, s := (*sudog)(nil), l.head; s != nil; p, s = s, s.next { if s.ticket == t { n := s.next if p != nil { p.next = n } else { l.head = n } if n == nil { l.tail = p } unlock(\u0026l.lock) s.next = nil readyWithTime(s, 4) return } } unlock(\u0026l.lock) } æˆ‘ä»¬è®°å¾—åœ¨waitä»£ç ä¸­ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½ä¼šåŸå­ç´¯åŠ waitï¼Œé‚£ä¹ˆè¿™ä¸ªwaitå°±ä»£è¡¨æœ€å¤§çš„waitå€¼ï¼Œå¯¹åº”å”¤é†’æ—¶ï¼Œä¹Ÿä¼šå¯¹åº”ä¸€ä¸ªnotifyå±æ€§ã€‚æˆ‘ä»¬åœ¨notifyListé“¾è¡¨ä¸­é€ä¸ªæ£€æŸ¥ï¼Œæ‰¾åˆ°ticketå¯¹åº”ç›¸ç­‰çš„notifyå±æ€§ã€‚ notifyListå¹¶ä¸æ˜¯ä¸€ç›´æœ‰åºçš„ï¼Œwaitæ–¹æ³•ä¸­è°ƒç”¨runtime_notifyListAddå’Œruntime_notifyListWaitå®Œå…¨æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„è¡Œä¸ºã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.cond/:2:4","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹æ¡ä»¶å˜é‡Cond","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.cond/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"Broadcast // Broadcastå”¤é†’æ‰€æœ‰ç­‰å¾…çš„åç¨‹ func (c *Cond) Broadcast() { c.checker.check() runtime_notifyListNotifyAll(\u0026c.notify) } func notifyListNotifyAll(l *notifyList) { // Fast-path: if there are no new waiters since the last notification // we don't need to acquire the lock. if atomic.Load(\u0026l.wait) == atomic.Load(\u0026l.notify) { return } // Pull the list out into a local variable, waiters will be readied // outside the lock. lock(\u0026l.lock) s := l.head l.head = nil l.tail = nil // Update the next ticket to be notified. We can set it to the current // value of wait because any previous waiters are already in the list // or will notice that they have already been notified when trying to // add themselves to the list. atomic.Store(\u0026l.notify, atomic.Load(\u0026l.wait)) unlock(\u0026l.lock) // Go through the local list and ready all waiters. for s != nil { next := s.next s.next = nil readyWithTime(s, 4) s = next } } å…¨éƒ¨å”¤é†’çš„å®ç°ç®€å•ä¸€ç‚¹ï¼Œä¸»è¦æ˜¯é€šè¿‡è°ƒç”¨readyWithTimeæ–¹æ³•å”¤é†’é“¾è¡¨ä¸­çš„goroutineï¼Œå”¤é†’çš„é¡ºåºä¹Ÿæ˜¯æŒ‰ç…§åŠ å…¥é˜Ÿåˆ—çš„å…ˆåé¡ºåºå”¤é†’ï¼Œè€ŒååŠ å…¥çš„goroutineå¯èƒ½éœ€è¦ç­‰å¾…è°ƒåº¦å™¨çš„è°ƒåº¦ã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.cond/:2:5","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹æ¡ä»¶å˜é‡Cond","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.cond/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"ä½¿ç”¨åœºæ™¯ æ¯æ¬¡å‘é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ åå°±éœ€è¦è°ƒç”¨Broadcasté€šçŸ¥æ‰€æœ‰çš„ç­‰å¾…è€…ï¼Œä½¿ç”¨Condå¾ˆåˆé€‚ï¼Œç›¸æ¯”channelå‡å°‘äº†ä»£ç çš„å¤æ‚åº¦ã€‚ å½“ç„¶ä½¿ç”¨çš„å§¿åŠ¿ä¸€å®šè¦æ­£ç¡®ï¼š c.L.Lock() for !condition() { c.Wait() } // ... make use of condition ... c.L.Unlock() ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.cond/:3:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹æ¡ä»¶å˜é‡Cond","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.cond/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"waitgroupçš„ä½¿ç”¨åœºæ™¯ï¼š ä¸€ä¸ªwaitgroupå¯¹è±¡å¯ä»¥ç­‰åˆ°ä¸€ç»„åç¨‹ç»“æŸï¼Œä¹Ÿå°±æ˜¯ç­‰å¾…ä¸€ç»„goroutineè¿”å›ã€‚ é¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹sync.WaitGroupçš„ç»“æ„ï¼š // A WaitGroup must not be copied after first use. type WaitGroup struct { noCopy noCopy // 64-bit value: high 32 bits are counter, low 32 bits are waiter count. // 64-bit atomic operations require 64-bit alignment, but 32-bit // compilers do not ensure it. So we allocate 12 bytes and then use // the aligned 8 bytes in them as state, and the other 4 as storage // for the sema. // 64bit(8bytes)çš„å€¼åˆ†æˆä¸¤æ®µï¼Œé«˜32ä½æ˜¯è®¡æ•°å€¼ï¼Œä½32ä½æ˜¯waiterçš„è®¡æ•° // 64ä½å€¼çš„åŸå­æ“ä½œéœ€è¦åœ¨64ä½ç¼–è¯‘å™¨ä¸Šï¼Œä½†32ä½ä¸æ”¯æŒï¼Œæ‰€ä»¥ä½¿ç”¨12bytesï¼Œ8bytesè¡¨ç¤ºçŠ¶æ€ï¼Œ4bytesè¡¨ç¤ºä¿¡å·é‡ state1 [3]uint32 } è¿™é‡Œæ€»å…±å°±2ä¸ªå­—æ®µï¼Œä¸€ä¸ªæ˜¯nocopyæ˜¯ä¸ºäº†ä¿è¯è¯¥ç»“æ„ä¸ä¼šè¢«æ‹·è´ï¼Œæ˜¯ä¸€ç§ä¿æŠ¤æœºåˆ¶ã€‚ä¸€ä¸ªæ˜¯state1ä¸»è¦æ˜¯å­˜å‚¨çŠ¶æ€å’Œä¿¡å·é‡ï¼Œè¿™é‡Œä½¿ç”¨çš„8å­—èŠ‚å¯¹é½ã€‚ è¿™é‡Œçš„state1ä¸€å…±è¢«åˆ†é…äº†12ä¸ªå­—èŠ‚ï¼Œè¢«è®¾å®šæˆ3ç§çŠ¶æ€ï¼š å…¶ä¸­å¯¹é½çš„8ä¸ªå­—èŠ‚ä½œä¸ºçŠ¶æ€ï¼Œé«˜32ä½ä¸ºè®¡æ•°çš„æ•°é‡ï¼Œä½32ä½ä¸ºç­‰å¾…çš„goroutineæ•°é‡ å…¶ä¸­çš„4ä¸ªå­—èŠ‚ä½œä¸ºä¿¡å·é‡å­˜å‚¨ // state returns pointers to the state and sema fields stored within wg.state1. func (wg *WaitGroup) state() (statep *uint64, semap *uint32) { if uintptr(unsafe.Pointer(\u0026wg.state1))%8 == 0 { // å¦‚æœæ˜¯64ä½ï¼Œæ•°ç»„å‰ä¸¤ä¸ªå…ƒç´ åšstateï¼Œåä¸€ä¸ªå…ƒç´ åšä¿¡å·é‡ return (*uint64)(unsafe.Pointer(\u0026wg.state1)), \u0026wg.state1[2] } else { // å¦‚æœæ˜¯32ä½ï¼Œæ•°ç»„åä¸¤ä¸ªå…ƒç´ åšstateï¼Œç¬¬ä¸€ä¸ªå…ƒç´ åšä¿¡å·é‡ return (*uint64)(unsafe.Pointer(\u0026wg.state1[1])), \u0026wg.state1[0] } } ä¸ºäº†ä¿è¯waitgroupåœ¨32ä½å¹³å°ä¸Šä½¿ç”¨ï¼Œå°±ä¸èƒ½åˆ†æˆ2ä¸ªå­—æ®µæ¥å†™ï¼Œè€ƒè™‘åˆ°å­—æ®µçš„é¡ºåºå¹³å°çš„ä¸åŒï¼Œå†…å­˜å¯¹é½çš„æ–¹å¼ä¸åŒï¼Œå› æ­¤è¿™é‡Œåˆ¤æ–­æ•°ç»„çš„é¦–åœ°å€æ˜¯å¦å¤„äº8å­—èŠ‚å¯¹é½çš„ä½ç½®ä¸Šã€‚ å½“æ•°ç»„çš„é¦–åœ°å€æ˜¯å¤„äºä¸€ä¸ª8å­—èŠ‚å¯¹é½çš„ä½ç½®ä¸Šæ—¶ï¼Œé‚£ä¹ˆå°±å°†è¿™ä¸ªæ•°ç»„çš„å‰8ä¸ªå­—èŠ‚ä½œä¸º64ä½å€¼ä½¿ç”¨è¡¨ç¤ºçŠ¶æ€ï¼Œå4ä¸ªå­—èŠ‚ä½œä¸º32ä½å€¼è¡¨ç¤ºä¿¡å·é‡(semaphore)ã€‚åŒç†å¦‚æœé¦–åœ°å€æ²¡æœ‰å¤„äº8å­—èŠ‚å¯¹é½çš„ä½ç½®ä¸Šæ—¶ï¼Œé‚£ä¹ˆå°±å°†å‰4ä¸ªå­—èŠ‚ä½œä¸ºsemaphoreï¼Œå8ä¸ªå­—èŠ‚ä½œä¸º64ä½æ•°å€¼ã€‚ç”»ä¸ªå›¾è¡¨ç¤ºä¸€ä¸‹ï¼š waitgroupæä¾›äº†Addæ–¹æ³•å¢åŠ ä¸€ä¸ªè®¡æ•°å™¨ï¼ŒDoneæ–¹æ³•å‡æ‰ä¸€ä¸ªè®¡æ•°å™¨ï¼Œè€ŒDoneæ–¹æ³•å®é™…ä¸Šå°±æ˜¯Add(-1)ã€‚ æ‰€ä»¥æˆ‘ä»¬æ¥çœ‹çœ‹Add()æ–¹æ³•ï¼š // Addä¸»è¦æ“ä½œstateçš„è®¡æ•°å€¼éƒ¨åˆ†ï¼ˆé«˜32ä½ï¼‰ func (wg *WaitGroup) Add(delta int) { statep, semap := wg.state() // å°†deltaæ·»åŠ åˆ°è®¡æ•°å€¼ä¸Š state := atomic.AddUint64(statep, uint64(delta)\u003c\u003c32) // å½“å‰çš„è®¡æ•°å€¼ v := int32(state \u003e\u003e 32) // å½“å‰çš„waiter w := uint32(state) if v \u003c 0 { panic(\"sync: negative WaitGroup counter\") } // Add(1)å¿…é¡»åœ¨Waitä¹‹å‰ if w != 0 \u0026\u0026 delta \u003e 0 \u0026\u0026 v == int32(delta) { panic(\"sync: WaitGroup misuse: Add called concurrently with Wait\") } if v \u003e 0 || w == 0 { return } // This goroutine has set counter to 0 when waiters \u003e 0. // Now there can't be concurrent mutations of state: // - Adds must not happen concurrently with Wait, // - Wait does not increment waiters if it sees counter == 0. // Still do a cheap sanity check to detect WaitGroup misuse. // å¦‚æœè®¡æ•°å€¼v=0ä¸”waiter\u003e0ï¼Œé‚£ä¹ˆstateçš„å€¼å°±æ˜¯waiterçš„æ•°é‡ // å°†waiterè®¾ç½®ä¸º0ï¼Œå”¤é†’æ‰€æœ‰çš„waiter if *statep != state { panic(\"sync: WaitGroup misuse: Add called concurrently with Wait\") } // Reset waiters count to 0. *statep = 0 for ; w != 0; w-- { runtime_Semrelease(semap, false, 0) } } è€ŒWaitæ–¹æ³•ä¼šé˜»å¡goroutineçŸ¥é“waitgroupçš„è®¡æ•°å™¨å˜ä¸º0ã€‚ // ä¸æ–­æ£€æŸ¥stateçš„å€¼ï¼Œå¦‚æœå…¶ä¸­è®¡æ•°å€¼ä¸º0ï¼Œè¯´æ˜æ‰€æœ‰çš„å­goroutineå·²å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ï¼Œè°ƒç”¨è€…ä¸å¿…ç­‰å¾…ï¼Œå…¨éƒ¨è¿”å›ã€‚ // å¦‚æœè®¡æ•°å€¼\u003e0,è¯´æ˜æ­¤æ—¶è¿˜æœ‰ä»»åŠ¡æ²¡æœ‰å®Œæˆï¼Œé‚£ä¹ˆè°ƒç”¨è€…å˜æˆç­‰å¾…è€…ï¼Œéœ€è¦åŠ å…¥waité˜Ÿåˆ—ï¼Œå¹¶ä¸”é˜»å¡è‡ªå·± func (wg *WaitGroup) Wait() { statep, semap := wg.state() for { state := atomic.LoadUint64(statep) v := int32(state \u003e\u003e 32) // è®¡æ•°å€¼ï¼ˆAddï¼‰ w := uint32(state) // waiter if v == 0 { // Counter is 0, no need to wait. return } // Increment waiters count. if atomic.CompareAndSwapUint64(statep, state, state+1) { runtime_Semacquire(semap) // é˜»å¡å®Œæˆï¼Œæ‰€æœ‰çš„Addå·²ç»å®Œæˆ if *statep != 0 { panic(\"sync: WaitGroup is reused before previous Wait has returned\") } return } } } å°ç»“ Addæ–¹æ³•ä¸Waitæ–¹æ³•ä¸å¯ä»¥å¹¶å‘åŒæ—¶è°ƒç”¨ï¼ŒAddæ–¹æ³•å¿…é¡»åœ¨Waitæ–¹æ³•ä¹‹å‰è°ƒç”¨ Addæ–¹æ³•å¿…é¡»ä¸å®é™…ç­‰å¾…çš„goroutineæ•°é‡ä¸€è‡´ï¼Œå¦åˆ™ä¼španic è°ƒç”¨Waitæ–¹æ³•åï¼Œå¿…é¡»ç­‰å¾…Waitæ–¹æ³•è¿”å›åæ‰èƒ½é‡æ–°ä½¿ç”¨waitgroupï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½å†waitæ²¡æœ‰è¿”å›å‰è°ƒç”¨Add waitgroupå¯¹è±¡åªèƒ½æœ‰ä¸€ä»½ï¼Œä¸å¯ä»¥æ‹·è´ç»™å…¶ä»–å˜é‡ã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.waitgroup/:0:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹WaitGroup","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.waitgroup/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"Goè¯­è¨€æ ‡å‡†åº“ä¸­çš„sync.Onceå¯ä»¥ä¿è¯goç¨‹åºåœ¨è¿è¡ŒæœŸé—´çš„æŸæ®µä»£ç åªæ‰§è¡Œä¸€æ¬¡ã€‚ è€Œæˆ‘ä»¬æ¥çœ‹çœ‹sync.Onceçš„æºç ï¼Œå‘ç°æ˜¯æ¯”è¾ƒå°‘çš„ã€‚ å»æ‰æ³¨é‡Šåï¼š type Once struct { done uint32 m Mutex } func (o *Once) Do(f func()) { // todoï¼šä¸ºä»€ä¹ˆä¸ç”¨casï¼Ÿ if atomic.LoadUint32(\u0026o.done) == 0 { o.doSlow(f) } } func (o *Once) doSlow(f func()) { o.m.Lock() defer o.m.Unlock() if o.done == 0 { // todoï¼šä¸ºä»€ä¹ˆç”¨deferæ¥è®¡æ•°ï¼Ÿ defer atomic.StoreUint32(\u0026o.done, 1) f() } } æå‡ºä¸¤ä¸ªé—®é¢˜ï¼š ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.once%E7%9A%84%E5%AE%9E%E7%8E%B0/:0:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹sync.Once","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.once%E7%9A%84%E5%AE%9E%E7%8E%B0/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"ä¸ºä»€ä¹ˆOnce.Doæ²¡æœ‰ç”¨casæ¥åˆ¤æ–­ï¼Ÿ ä»€ä¹ˆæ˜¯casï¼Ÿ åœ¨sync.atomicé‡Œæœ‰CompareAndSwapUint32å‡½æ•°æ¥å®ç°casåŠŸèƒ½ã€‚æ„æ€å°±æ˜¯Compare And Swapçš„ç¼©å†™ï¼ŒæŠŠåˆ¤æ–­å’Œèµ‹å€¼åŒ…è£…æˆä¸€ä¸ªåŸå­æ“ä½œã€‚ é‚£ä¹ˆè¿™é‡Œä¸ºä»€ä¹ˆç”¨ä»¥ä¸‹æ–¹å¼å®ç°ï¼š if atomic.CompareAndSwapUint32(\u0026o.done,0,1) { f() } çœ‹ä¸Šå»ï¼Œä¹Ÿå®ç°äº†åªæ‰§è¡Œä¸€æ¬¡çš„è¯­ä¹‰ã€‚å½“o.done==0çš„æ—¶å€™ï¼Œä¼šèµ‹å€¼o.done==1,ç„¶åæ‰§è¡Œf()ã€‚ å…¶ä»–å¹¶å‘è¯·æ±‚çš„æ—¶å€™ï¼Œo.done==1ï¼Œå°±ä¸ä¼šå†è¿›å…¥è¿™ä¸ªåˆ†æ”¯ï¼Œè²Œä¼¼å¯è¡Œã€‚ æ³¨é‡Šé‡Œæœ‰å†™é“ï¼š å½“o.doneåˆ¤æ–­ä¸º0æ—¶ï¼Œç«‹å³è®¾ç½®æˆ1ï¼Œç„¶åå†æ‰§è¡Œf()ï¼Œè¿™æ ·è¯­ä¹‰å°±ä¸æ­£ç¡®ã€‚ Onceéœ€è¦ä¸ä»…è¦ä¿è¯åªæ‰§è¡Œä¸€æ¬¡ï¼Œè¿˜è¦ä¿è¯å…¶ä»–ç”¨æˆ·çœ‹åˆ°o.done==1çš„æ—¶å€™ï¼Œf()å·²ç»å®Œæˆã€‚ è¿™æ¶‰åŠåˆ°é€»è¾‘çš„æ­£ç¡®æ€§ã€‚ä¾‹å¦‚é€šè¿‡sync.Onceåˆ›å»ºå”¯ä¸€çš„å…¨å±€å˜é‡ï¼Œå¦‚æœè°ƒç”¨sync.Onceé€šçŸ¥ç”¨æˆ·å·²ç»åˆ›å»ºæˆåŠŸï¼Œå®é™…ä¸Šf()è¿˜åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå…¨å±€å˜é‡è¿˜æ²¡æœ‰åˆ›å»ºå®Œæˆï¼Œé‚£ä¹ˆè¿™ä¸ªé€»è¾‘å°±æ˜¯é”™è¯¯çš„ã€‚ é‚£ä¹ˆæ€ä¹ˆè§£å†³ï¼š 1ã€å¿«è·¯å¾„ï¼šç”¨åŸå­è¯»o.doneçš„å€¼ï¼Œä¿è¯ç«æ€æ¡ä»¶æ­£ç¡® 2ã€æ…¢è·¯å¾„ï¼šæ—¢ç„¶ä¸èƒ½ç”¨casåŸå­æ“ä½œï¼Œé‚£ä¹ˆå°±ç”¨é”æœºåˆ¶æ¥ä¿è¯åŸå­æ€§ã€‚å…ˆæ‰§è¡Œf()ï¼Œç„¶åå†å»è®¾ç½®o.doneä¸º1. ç¬¬ä¸€æ¬¡å¯èƒ½åœ¨é”äº’æ–¥çš„æ—¶å€™æ¯”è¾ƒæ…¢ï¼Œä½†åªè¦æ‰§è¡Œè¿‡ä¸€æ¬¡åï¼Œå°±ä¸ä¼šèµ°åˆ°é”æœºåˆ¶ï¼Œéƒ½æ˜¯èµ°åŸå­æ“ä½œã€‚ æ—¢ç„¶å†…éƒ¨æ˜¯ç”¨äº’æ–¥é”æ¥ä¿è¯ä»£ç çš„ä¸´ç•ŒåŒºï¼Œé‚£ä¹ˆå°±ä¸èƒ½åµŒå¥—é” once1.Do(func() { once1.Do(func() { /* do something*/ }) }) ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.once%E7%9A%84%E5%AE%9E%E7%8E%B0/:0:1","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹sync.Once","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.once%E7%9A%84%E5%AE%9E%E7%8E%B0/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"ä¸ºä»€ä¹ˆOnce.doSlowç”¨deferæ¥åŠ è®¡æ•°ï¼Ÿ ä¸ºä»€ä¹ˆä¸å¯ä»¥è¿™æ ·ï¼Ÿ if o.done == 0 { // todoï¼šä¸ºä»€ä¹ˆç”¨deferæ¥è®¡æ•°ï¼Ÿ f() atomic.StoreUint32(\u0026o.done, 1) } å› ä¸ºè¿™æ ·å¤„ç†ä¸äº†panicå¼‚å¸¸ï¼Œä¼šå¯¼è‡´o.doneæ²¡æœ‰åŠ è®¡æ•°ï¼Œä½†f()å·²ç»æ‰§è¡Œäº† ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.once%E7%9A%84%E5%AE%9E%E7%8E%B0/:0:2","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹sync.Once","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.once%E7%9A%84%E5%AE%9E%E7%8E%B0/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"Onceçš„è¯­ä¹‰ 1ã€Once.Doä¿è¯åªè°ƒç”¨ä¸€æ¬¡çš„è¯­ä¹‰ï¼Œæ— è®ºf()å†…éƒ¨æœ‰æ²¡æœ‰æ‰§è¡Œå®Œï¼ˆpanicï¼‰ 2ã€åªæœ‰f()æ‰§è¡Œå®Œæˆï¼ŒOnce.Doæ‰ä¼šè¿”å›ï¼Œå¦åˆ™é˜»å¡ç­‰å¾…f()çš„ç¬¬ä¸€æ¬¡æ‰§è¡Œå®Œæˆã€‚ ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.once%E7%9A%84%E5%AE%9E%E7%8E%B0/:0:3","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹sync.Once","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.once%E7%9A%84%E5%AE%9E%E7%8E%B0/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"æ€»ç»“ 1ã€Once å¯¹å¤–æä¾› f() åªè°ƒç”¨ä¸€æ¬¡çš„è¯­ä¹‰; 2ã€Once.Do è¿”å›ä¹‹åï¼ŒæŒ‰ç…§çº¦å®šï¼Œf() ä¸€å®šè¢«æ‰§è¡Œè¿‡ä¸€æ¬¡ï¼Œå¹¶ä¸”åªæ‰§è¡Œè¿‡ä¸€æ¬¡ã€‚å¦‚æœæ²¡æœ‰æ‰§è¡Œå®Œï¼Œä¼šé˜»å¡ç­‰å¾… f() çš„ç¬¬ä¸€æ¬¡æ‰§è¡Œå®Œæˆï¼› 3ã€Once åªæ‰§è¡Œä¸€æ¬¡çš„è¯­ä¹‰æ˜¯è·Ÿå®ä¾‹ç»‘å®šçš„å…³ç³»ï¼Œå¤šä¸ª Once å®ä¾‹çš„è¯ï¼Œæ¯ä¸ªå®ä¾‹éƒ½æœ‰ä¸€æ¬¡çš„æœºä¼šï¼› 4ã€å†…éƒ¨ç”¨é”æœºåˆ¶æ¥ä¿è¯é€»è¾‘çš„åŸå­æ€§ï¼Œå…ˆæ‰§è¡Œ f() ï¼Œç„¶åè®¾ç½® o.done æ ‡è¯†ä½ï¼› 5ã€Once ç”¨ defer æœºåˆ¶ä¿è¯ panic çš„åœºæ™¯ï¼Œä¹Ÿèƒ½å¤Ÿä¿è¯ o.done æ ‡è¯†ä½è¢«è®¾ç½®ï¼› 6ã€Once å®ä¾‹åƒä¸‡æ³¨æ„ï¼Œä¸è¦åµŒå¥—ï¼Œå†…éƒ¨æœ‰é”ï¼Œä¹±ç”¨çš„è¯å®¹æ˜“æ­»é”ï¼› ","date":"2021-07-16","objectID":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.once%E7%9A%84%E5%AE%9E%E7%8E%B0/:0:4","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹sync.Once","uri":"/2021/07/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsync.once%E7%9A%84%E5%AE%9E%E7%8E%B0/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"channelè®¾è®¡çš„åŸºæœ¬æ€æƒ³æ˜¯ï¼š ä¸è¦é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ï¼Œè€Œæ˜¯è¦é€šè¿‡é€šä¿¡æ¥å®ç°å…±äº«å†…å­˜ã€‚ Do not communicate by sharing memory; instead, share memory by communicating. channelåœ¨è®¾è®¡ä¸Šæœ¬è´¨å°±æ˜¯ä¸€ä¸ªæœ‰é”çš„ç¯å½¢é˜Ÿåˆ—ï¼ŒåŒ…æ‹¬å‘é€æ–¹é˜Ÿåˆ—ã€æ¥æ”¶æ–¹é˜Ÿåˆ—ã€äº’æ–¥é”ç­‰ç»“æ„ã€‚ ä¸‹é¢å°±å¼€å§‹æºç å‰–æè¿™ä¸ªæœ‰é”çš„ç¯å½¢é˜Ÿåˆ—æ˜¯å¦‚ä½•è®¾è®¡çš„ã€‚ ","date":"2021-07-15","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/:0:0","tags":["æºç è§£æ","channel"],"title":"æ·±å…¥ç†è§£channel","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"æ•°æ®ç»“æ„ åœ¨runtime/chan.goä¸­å¯ä»¥çœ‹åˆ°hchançš„ç»“æ„å¦‚ä¸‹ï¼š // 64ä½å ç”¨80,32ä½å ç”¨44 type hchan struct { qcount uint // é˜Ÿåˆ—ä¸­æ•°æ®çš„ä¸ªæ•° dataqsiz uint // é˜Ÿåˆ—å®¹é‡ buf unsafe.Pointer // å­˜æ”¾åœ¨ç¯å½¢æ•°ç»„çš„æ•°æ® elemsize uint16 // channelä¸­æ•°æ®ç±»å‹å¤§å° closed uint32 // channelæ˜¯å¦å…³é—­ï¼Œ0è¡¨ç¤ºæœªå…³é—­ï¼Œé0è¡¨ç¤ºå·²å…³é—­ elemtype *_type // å…ƒç´ ç±»å‹ sendx uint // sendçš„æ•°ç»„ç´¢å¼• recvx uint // receiveçš„æ•°ç»„ç´¢å¼• recvq waitq // \u003c-ch é˜»å¡åœ¨chanä¸Šçš„é˜Ÿåˆ— list of recv waiters sendq waitq // ch\u003c- é˜»å¡åœ¨chanä¸Šçš„é˜Ÿåˆ— list of send waiters // lock protects all fields in hchan, as well as several // fields in sudogs blocked on this channel. // ä¸è¦åœ¨æŒæœ‰é”ï¼ˆç‰¹åˆ«æ˜¯Gæ²¡æœ‰å‡†å¤‡å¥½çš„æ—¶å€™ï¼‰æ”¹å˜å¦ä¸€ä¸ªGçš„çŠ¶æ€ï¼Œå› ä¸ºè¿™å¯èƒ½å¯¼è‡´æ ˆæ”¶ç¼© // Do not change another G's status while holding this lock // (in particular, do not ready a G), as this can deadlock // with stack shrinking. lock mutex } bufæ˜¯æŒ‡å‘åº•å±‚çš„å¾ªç¯æ•°ç»„ï¼Œdataqsizå°±æ˜¯è¿™ä¸ªå¾ªç¯æ•°ç»„çš„é•¿åº¦ï¼Œqcountå°±æ˜¯å½“å‰å¾ªç¯æ•°æ®ä¸­çš„å…ƒç´ æ•°é‡ã€‚ elemsizeå’Œelemtypeå°±æ˜¯åˆ›å»ºchannelæ—¶è®¾ç½®çš„å…ƒç´ ç±»å‹å’Œå¤§å° sendqå’Œrecvqæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œåˆ†åˆ«è¡¨ç¤ºè¢«é˜»å¡çš„goroutineé“¾è¡¨ï¼Œè¿™äº›goroutineç”±äºå°è¯•è¯»å–/å‘é€æ•°æ®è€Œé˜»å¡ã€‚ åŸºäºæ­¤ï¼Œå¦‚ä¸‹å›¾ ","date":"2021-07-15","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/:1:0","tags":["æºç è§£æ","channel"],"title":"æ·±å…¥ç†è§£channel","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"channelçš„åˆ›å»º é€šå¸¸æˆ‘ä»¬ä½¿ç”¨makeè¿›è¡Œåˆ›å»ºï¼Œmakeåœ¨ç»è¿‡ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä¸¤ç§æ–¹æ³•runtime.makechanå’Œruntime.makechan64ã€‚ //go:linkname reflect_makechan reflect.makechan func reflect_makechan(t *chantype, size int) *hchan { return makechan(t, size) } func makechan64(t *chantype, size int64) *hchan { if int64(int(size)) != size { panic(plainError(\"makechan: size out of range\")) } return makechan(t, int(size)) } makechan64å®é™…ä¸Šä¹Ÿæ˜¯è°ƒç”¨makechanæ–¹æ³•ï¼Œåªä¸è¿‡æ˜¯å¤šäº†ä¸€ä¸ªæ•°å€¼æº¢å‡ºçš„æ ¡éªŒã€‚å¤§å¤šæ•°æƒ…å†µè¿˜æ˜¯ä½¿ç”¨makechanã€‚ // åˆå§‹åŒ–chanï¼Œ make(chan int,4) func makechan(t *chantype, size int) *hchan { elem := t.elem // compiler checks this but be safe. // å¯¹å‘é€çš„å…ƒç´ è¿›è¡Œé™åˆ¶ 1\u003c\u003c16 if elem.size \u003e= 1\u003c\u003c16 { throw(\"makechan: invalid channel element type\") } if hchanSize%maxAlign != 0 || elem.align \u003e maxAlign { throw(\"makechan: bad alignment\") } // è®¡ç®— ç±»å‹é•¿åº¦*å®¹é‡ï¼Œ å¦‚æœæº¢å‡ºæˆ–è¶…è¿‡å¯åˆ†é…å†…å­˜ï¼ŒæŠ¥é”™ mem, overflow := math.MulUintptr(elem.size, uintptr(size)) if overflow || mem \u003e maxAlloc-hchanSize || size \u003c 0 { panic(plainError(\"makechan: size out of range\")) } // Hchan does not contain pointers interesting for GC when elements stored in buf do not contain pointers. // buf points into the same allocation, elemtype is persistent. // SudoG's are referenced from their owning thread so they can't be collected. // TODO(dvyukov,rlh): Rethink when collector can move allocated objects. var c *hchan switch { case mem == 0: // ç¼“å†²åŒºå¤§å°ä¸º0ï¼Œåªåˆ†é…sizeof(hchan)å¤§å°çš„å†…å­˜ c = (*hchan)(mallocgc(hchanSize, nil, true)) // Race detector uses this location for synchronization. c.buf = c.raceaddr() case elem.ptrdata == 0: // æ•°æ®ç±»å‹ä¸æ˜¯æŒ‡é’ˆï¼Œåˆ†é…ä¸€å—è¿ç»­å†…å­˜å®¹çº³hchanSizeå’Œç¼“å†²åŒºå¯¹è±¡ c = (*hchan)(mallocgc(hchanSize+mem, nil, true)) c.buf = add(unsafe.Pointer(c), hchanSize) default: // æ•°æ®ç±»å‹åŒ…å«æŒ‡é’ˆï¼Œhchanå’Œbufå•ç‹¬åˆ†é…. c = new(hchan) c.buf = mallocgc(mem, elem, true) } // channelå…ƒç´ å¤§å°ï¼Œå¦‚æœæ˜¯intï¼Œå°±æ˜¯8å­—èŠ‚ c.elemsize = uint16(elem.size) // å…ƒç´ ç±»å‹ c.elemtype = elem // å…ƒç´ bufferæ•°ç»„çš„å¤§å°ï¼Œæ¯”å¦‚make(chan int,2)ï¼Œé‚£ä¹ˆsize=2 c.dataqsiz = uint(size) /* åˆå§‹åŒ–æ ¸å¿ƒå­—æ®µï¼š 1ã€bufï¼šæŒ‡æ˜bufferåœ°å€ 2ã€elemsizeï¼šæŒ‡æ˜å…ƒç´ å¤§å° 3ã€elemtypeï¼šæŒ‡æ˜å…ƒç´ ç±»å‹ 4ã€dataqsizï¼šæŒ‡æ˜æ•°ç»„å¤§å° */ if debugChan { print(\"makechan: chan=\", c, \"; elemsize=\", elem.size, \"; dataqsiz=\", size, \"\\n\") } return c } è¿™é‡Œä¸»è¦æ˜¯ä¸€äº›å†…å­˜åˆ†é…çš„æ“ä½œã€‚ å¦‚æœåˆ›å»ºçš„channelæ˜¯æ— ç¼“å†²çš„ï¼Œæˆ–åˆ›å»ºçš„æœ‰ç¼“å†²çš„channelä¸­å­˜å‚¨çš„æ•°æ®ç±»å‹ä¸æ˜¯æŒ‡é’ˆç±»å‹ï¼Œå°±ä¼šè°ƒç”¨mallocgcåˆ†é…ä¸€æ®µè¿ç»­çš„å†…å­˜ã€‚ å¦‚æœåˆ›å»ºçš„channelä¸­å­˜å‚¨çš„ç±»å‹å­˜åœ¨æŒ‡é’ˆå¼•ç”¨ï¼Œå°±ä¼šè¿åŒhchanå’Œåº•å±‚æ•°ç»„åŒæ—¶åˆ†é…ä¸€æ®µè¿ç»­çš„å†…å­˜ç©ºé—´ã€‚ ","date":"2021-07-15","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/:2:0","tags":["æºç è§£æ","channel"],"title":"æ·±å…¥ç†è§£channel","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"å…¥é˜Ÿ channelå‘é€æ•°æ®éƒ¨åˆ†çš„ä»£ç æ˜¯runtime.chansend1 func chansend1(c *hchan, elem unsafe.Pointer) { chansend(c, elem, true, getcallerpc()) } ","date":"2021-07-15","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/:3:0","tags":["æºç è§£æ","channel"],"title":"æ·±å…¥ç†è§£channel","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"å‰ç½®æ£€æŸ¥ // å¦‚æœchanæ˜¯ç©ºçš„ï¼Œå¯¹äºéé˜»å¡å‘é€ï¼Œç›´æ¥è¿”å›falseã€‚å¯¹äºé˜»å¡çš„é€šé“ï¼Œå°†goroutineæŒ‚èµ·ï¼Œå¹¶ä¸”æ°¸è¿œä¸è¿”å› // ä¹Ÿå°±æ˜¯ä¸è¦å‘ä¸€ä¸ªnilçš„chanå‘é€æ•°æ® if c == nil { if !block { return false } gopark(nil, nil, waitReasonChanSendNilChan, traceEvGoStop, 2) throw(\"unreachable\") } if debugChan { print(\"chansend: chan=\", c, \"\\n\") } if raceenabled { racereadpc(c.raceaddr(), callerpc, funcPC(chansend)) } // éé˜»å¡æƒ…å†µä¸‹ï¼Œå¦‚æœé€šé“æ²¡æœ‰å…³é—­ï¼Œè€Œä¸”æ²¡æœ‰æ¥å—è€…ï¼Œç¼“å†²åŒºå·²ç»æ»¡äº†æˆ–æ²¡æœ‰ç¼“å†²åŒºï¼ˆå³ä¸å¯ä»¥å‘é€æ•°æ®ï¼‰ï¼Œè¿”å›false // å› ä¸ºè¿™é‡Œæ˜¯å…è®¸å¹¶å‘æ‰§è¡Œçš„ï¼Œæ‰€ä»¥è¦ä»”ç»†åˆ†æä¸€ä¸‹ // åˆ¤æ–­å®Œclosedä¹‹åï¼Œé€šé“å¯èƒ½åœ¨è¿™ä¸€ç¬é—´ä»æœªå…³é—­å˜æˆå…³é—­çŠ¶æ€ï¼ˆclosedä¸ä¼šä»é0å˜ä¸º0ï¼Œä½†å¯èƒ½ä»0å˜æˆé0ï¼Œä¹Ÿå°±æ˜¯é€šé“å¯èƒ½è¢«å…³é—­ï¼‰ // é‚£ä¹ˆè¿™é‡Œä¼šæœ‰ä¸¤ç§æƒ…å†µï¼š // 1ã€é€šé“æ²¡æœ‰å…³é—­ï¼Œè€Œä¸”å·²ç»æ»¡äº†ï¼Œé‚£ä¹ˆè¿™æ®µé€»è¾‘è¿è¡Œæ­£ç¡®ï¼Œåº”è¯¥è¿”å›false // 2ã€é€šé“å·²ç»å…³é—­ï¼Œè€Œå…³é—­çš„æ—¶å€™ï¼ˆåŠ é”æ“ä½œï¼‰æ˜¯å°†recvqå’Œsendqå…¨éƒ¨å‡ºé˜Ÿåˆ—ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯è¿”å›false if !block \u0026\u0026 c.closed == 0 \u0026\u0026 ((c.dataqsiz == 0 \u0026\u0026 c.recvq.first == nil) || (c.dataqsiz \u003e 0 \u0026\u0026 c.qcount == c.dataqsiz)) { return false } var t0 int64 if blockprofilerate \u003e 0 { t0 = cputicks() } è¿™é‡Œä¸»è¦çš„æ£€æŸ¥å°±æ˜¯åˆ¤æ–­å½“å‰channelæ˜¯å¦ä¸ºnilï¼Œå¾€ä¸€ä¸ªnilçš„channelä¸­å‘é€æ•°æ®æ—¶ï¼Œä¼šè°ƒç”¨goparkå‡½æ•°å°†å½“å‰æ‰§è¡Œçš„goroutineä»runningçŠ¶æ€è½¬å…¥waitingçŠ¶æ€ï¼Œè¿™ä¼šè¡¨ç°å‡ºpanicäº‹ä»¶ã€‚ ","date":"2021-07-15","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/:3:1","tags":["æºç è§£æ","channel"],"title":"æ·±å…¥ç†è§£channel","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"åŠ é”/å¼‚å¸¸æ£€æŸ¥ // å¯¹chanåŠ é” lock(\u0026c.lock) // å¦‚æœchanå…³é—­ï¼Œpanic if c.closed != 0 { unlock(\u0026c.lock) panic(plainError(\"send on closed channel\")) } å‰ç½®æ ¡éªŒé€šè¿‡åï¼Œå¯¹channelåŠ é”ï¼Œé˜²æ­¢å¤šä¸ªåç¨‹åŒæ—¶æ“ä½œå¹¶å‘ä¿®æ”¹æ•°æ®ã€‚å¦‚æœchannelå·²ç»å…³é—­ï¼Œé‚£ä¹ˆå‘é€æ•°æ®ä¼španicã€‚ ","date":"2021-07-15","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/:3:2","tags":["æºç è§£æ","channel"],"title":"æ·±å…¥ç†è§£channel","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"channelç›´æ¥å‘é€æ•°æ® // åœºæ™¯ä¸€ï¼šä»recvqä¸­å–å‡ºä¸€ä¸ªæ¥å—è€…ï¼Œå¦‚æœæ¥å—è€…å­˜åœ¨ï¼Œåˆ™å‘æ¥å—è€…å‘é€æ•°æ® if sg := c.recvq.dequeue(); sg != nil { // Found a waiting receiver. We pass the value we want to send // directly to the receiver, bypassing the channel buffer (if any). send(c, sg, ep, func() { unlock(\u0026c.lock) }, 3) return true } è¿™é‡Œä¸»è¦è°ƒç”¨äº†sendæ–¹æ³• // sendå‡½æ•°å°†epä½œä¸ºå‚æ•°ä¼ é€ç»™æ¥æ”¶æ–¹sgï¼Œç„¶åä½¿ç”¨goreadyå°†å…¶å”¤é†’ã€‚ func send(c *hchan, sg *sudog, ep unsafe.Pointer, unlockf func(), skip int) { // sg.elemå¦‚æœéç©ºï¼Œåˆ™å°†epçš„å†…å®¹ç›´æ¥æ‹·è´åˆ°elemæŒ‡å‘çš„åœ°å€ // elemæ˜¯æ¥æ”¶åˆ°çš„å€¼å­˜æ”¾çš„ä½ç½® if sg.elem != nil { // è°ƒç”¨sendDirectè¿›è¡Œå†…å­˜æ‹·è´ï¼Œä»å‘é€è€…æ‹·è´åˆ°æ¥å—è€… sendDirect(c.elemtype, sg, ep) sg.elem = nil } gp := sg.g unlockf() gp.param = unsafe.Pointer(sg) if sg.releasetime != 0 { sg.releasetime = cputicks() } // å”¤é†’æ¥å—çš„goroutine goready(gp, skip+1) } ç„¶åï¼Œæˆ‘ä»¬å†çœ‹çœ‹sendDirectæ–¹æ³• func sendDirect(t *_type, sg *sudog, src unsafe.Pointer) { // src is on our stack, dst is a slot on another stack. // Once we read sg.elem out of sg, it will no longer // be updated if the destination's stack gets copied (shrunk). // So make sure that no preemption points can happen between read \u0026 use. dst := sg.elem typeBitsBulkBarrier(t, uintptr(dst), uintptr(src), t.size) // No need for cgo write barrier checks because dst is always // Go memory. memmove(dst, src, t.size) } è¿™é‡Œç›´æ¥è°ƒç”¨memmoveæ–¹æ³•è¿›è¡Œå†…å­˜æ‹·è´ï¼Œè¿™é‡Œæ˜¯ä»ä¸€ä¸ªgoroutineç›´æ¥å†™å…¥å¦ä¸€ä¸ªgoroutineæ ˆçš„æ“ä½œï¼Œå‡å°‘äº†ä¸€æ¬¡å†…å­˜copyï¼Œä¸ç”¨å…ˆæ‹·è´åˆ°channelçš„bufï¼Œç›´æ¥ç”±å‘é€è€…åˆ°æ¥æ”¶è€…ã€‚ ","date":"2021-07-15","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/:3:3","tags":["æºç è§£æ","channel"],"title":"æ·±å…¥ç†è§£channel","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"channelå‘é€åˆ°æ•°æ®ç¼“å†²åŒº // åœºæ™¯äºŒï¼šå¦‚æœç¼“å†²åŒºè¿˜æœ‰å¤šä½™çš„ç©ºé—´ï¼Œé‚£ä¹ˆå°†æ•°æ®å†™å…¥ç¼“å†²åŒºã€‚å†™å…¥ç¼“å†²åŒºåï¼Œå°†å‘é€ä½ç½®åç§»ä¸€ä½ï¼Œå°†qcount+1 if c.qcount \u003c c.dataqsiz { // Space is available in the channel buffer. Enqueue the element to send. qp := chanbuf(c, c.sendx) // typedmemmove å°†epçš„å†…å®¹å¤åˆ¶åˆ°qpä¸Š typedmemmove(c.elemtype, qp, ep) // é€’å¢ç´¢å¼• c.sendx++ // å›ç¯ç©ºé—´ if c.sendx == c.dataqsiz { c.sendx = 0 } // é€’å¢å…ƒç´ ä¸ªæ•° c.qcount++ unlock(\u0026c.lock) return true } è¿™é‡Œçš„å‡ æ­¥è¿˜æ˜¯æ¯”è¾ƒå¥½ç†è§£çš„ï¼š å¦‚æœå½“å‰ç¼“å†²åŒºè¿˜æœ‰å¯ç”¨ç©ºé—´ï¼Œåˆ™è°ƒç”¨chanbufæ–¹æ³•è·å–åº•å±‚ç¼“å†²æ•°ç»„sendxç´¢å¼•å…ƒç´ æŒ‡é’ˆå€¼ è°ƒç”¨typedmemmoveæ–¹æ³•å°†å‘é€çš„å€¼æ‹·è´åˆ°ç¼“å†²åŒºä¸­ æ•°æ®æ‹·è´æˆåŠŸï¼Œsendx++ï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªå¾…å‘é€å…ƒç´ å†å¾ªç¯æ•°ç»„ä¸­çš„ä½ç½®ã€‚å¦‚æœä¸‹ä¸€ä¸ªç´¢å¼•ä½ç½®æ­£å¥½æ˜¯å¾ªç¯é˜Ÿåˆ—çš„é•¿åº¦ï¼Œé‚£ä¹ˆæŠŠç´¢å¼•ç½®0ã€‚ é˜Ÿåˆ—å…ƒç´ é•¿åº¦è‡ªå¢ï¼Œè‡³æ­¤å‘é€æ•°æ®å®Œæˆï¼Œé‡Šæ”¾é” ","date":"2021-07-15","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/:3:4","tags":["æºç è§£æ","channel"],"title":"æ·±å…¥ç†è§£channel","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"channelå‘é€æ•°æ®æ— å¯ç”¨ç¼“å†²åŒº ç¼“å†²åŒºæ»¡äº†ä¹‹åï¼Œæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥é€‰æ‹©ï¼Œä¸€ç§æ˜¯ç›´æ¥è¿”å›ï¼Œä¸€ç§æ˜¯é˜»å¡ç­‰å¾…ã€‚ // å¦‚æœæ˜¯éé˜»å¡çš„ï¼Œé‚£ä¹ˆå°±ç›´æ¥è§£é”è¿”å›äº† if !block { unlock(\u0026c.lock) return false } ä¸‹é¢æ˜¯é˜»å¡ç­‰å¾…çš„ä»£ç  // ä»£ç èµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜éƒ½æ˜¯å› ä¸ºæ¡ä»¶ä¸æ»¡è¶³ï¼Œè¦é˜»å¡å½“å‰ goroutineï¼Œæ‰€ä»¥åšçš„äº‹æƒ…æœ¬è´¨ä¸Šå°±æ˜¯ä¿ç•™å¥½é€šçŸ¥è·¯å¾„ï¼Œç­‰å¾…æ¡ä»¶æ»¡è¶³ï¼Œä¼šåœ¨è¿™ä¸ªåœ°æ–¹å”¤é†’ï¼› // è·å–å½“å‰goroutineçš„sudogï¼Œç„¶åå…¥channelçš„sendé˜Ÿåˆ— // Block on the channel. Some receiver will complete our operation for us. gp := getg() mysg := acquireSudog() mysg.releasetime = 0 if t0 != 0 { mysg.releasetime = -1 } // No stack splits between assigning elem and enqueuing mysg // on gp.waiting where copystack can find it. mysg.elem = ep mysg.waitlink = nil mysg.g = gp mysg.isSelect = false mysg.c = c gp.waiting = mysg gp.param = nil // æŠŠ goroutine ç›¸å…³çš„çº¿ç´¢ç»“æ„å…¥é˜Ÿï¼Œç­‰å¾…æ¡ä»¶æ»¡è¶³çš„å”¤é†’ï¼› c.sendq.enqueue(mysg) // Signal to anyone trying to shrink our stack that we're about // to park on a channel. The window between when this G's status // changes and when we set gp.activeStackChans is not safe for // stack shrinking. atomic.Store8(\u0026gp.parkingOnChan, 1) gopark(chanparkcommit, unsafe.Pointer(\u0026c.lock), waitReasonChanSend, traceEvGoBlockSend, 2) // Ensure the value being sent is kept alive until the // receiver copies it out. The sudog has a pointer to the // stack object, but sudogs aren't considered as roots of the // stack tracer. // é˜²æ­¢å˜é‡è¢«CG KeepAlive(ep) è¿™é‡Œå…ˆé€šè¿‡getgè·å–å½“å‰çš„goroutineï¼Œç„¶åè°ƒç”¨acquireSudogæ–¹æ³•æ„é€ sudogç»“æ„ä½“ï¼Œç„¶åè®¾ç½®å¾…å‘é€æ¶ˆæ¯å’Œgoroutineç­‰ä¿¡æ¯ï¼ˆsudogé€šè¿‡gç»‘å®šgoroutineï¼Œè€Œgoroutineé€šè¿‡waitingç»‘å®šsudogï¼‰ï¼Œæ„é€ å®Œæ¯•åé€šè¿‡c.sendq.enqueueæ”¾å…¥å¾…å‘é€çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œæœ€åè°ƒç”¨goparkæ–¹æ³•æŒ‚èµ·å½“å‰çš„goroutineè¿›å…¥waitçŠ¶æ€ã€‚ æ­¤æ—¶goroutineå¤„äºwaitçŠ¶æ€ï¼Œç­‰å¾…è¢«å”¤é†’ // goroutineè¢«å”¤é†’ï¼Œè¡¨ç¤ºæ•°æ®å·²ç»å‘é€å®Œæˆï¼Œåšæ¸…ç†å·¥ä½œ // someone woke us up. if mysg != gp.waiting { throw(\"G waiting list is corrupted\") } gp.waiting = nil gp.activeStackChans = false if gp.param == nil { if c.closed == 0 { throw(\"chansend: spurious wakeup\") } panic(plainError(\"send on closed channel\")) } gp.param = nil if mysg.releasetime \u003e 0 { blockevent(mysg.releasetime-t0, 2) } mysg.c = nil releaseSudog(mysg) return true å”¤é†’çš„é€»è¾‘å°±æ˜¯åˆ¤æ–­goroutineæ˜¯å¦å­˜åœ¨ï¼Œæ£€æŸ¥å½“å‰channelæ˜¯å¦è¢«å…³é—­äº†ã€‚å–æ¶ˆgoroutineå’Œsudogçš„ç»‘å®šã€‚ ","date":"2021-07-15","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/:3:5","tags":["æºç è§£æ","channel"],"title":"æ·±å…¥ç†è§£channel","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"å‡ºé˜Ÿ channelç»“æ„æ•°æ®æœ‰ä¸¤ç§æ–¹å¼ï¼š val := \u003c- ch val,ok := \u003c- ch å®ƒä»¬åœ¨ç¼–è¯‘å™¨ç¼–è¯‘åçš„åˆ†åˆ«å¯¹åº”çš„æ˜¯runtime.chanrecv1å’Œruntime.chanrecv2ï¼š // entry points for \u003c- c from compiled code //go:nosplit func chanrecv1(c *hchan, elem unsafe.Pointer) { chanrecv(c, elem, true) } //go:nosplit func chanrecv2(c *hchan, elem unsafe.Pointer) (received bool) { _, received = chanrecv(c, elem, true) return } å…¶å®éƒ½æ˜¯è°ƒç”¨chanrecvæ–¹æ³• ","date":"2021-07-15","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/:4:0","tags":["æºç è§£æ","channel"],"title":"æ·±å…¥ç†è§£channel","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"å‰ç½®æ£€æŸ¥ // chanä¸ºnilï¼Œéé˜»å¡ç›´æ¥è¿”å›ï¼Œé˜»å¡å°±ç­‰å¾…å¹¶æŠ›å‡ºå¼‚å¸¸ if c == nil { if !block { return } gopark(nil, nil, waitReasonChanReceiveNilChan, traceEvGoStop, 2) throw(\"unreachable\") } if !block \u0026\u0026 (c.dataqsiz == 0 \u0026\u0026 c.sendq.first == nil || c.dataqsiz \u003e 0 \u0026\u0026 atomic.Loaduint(\u0026c.qcount) == 0) \u0026\u0026 atomic.Load(\u0026c.closed) == 0 { return } var t0 int64 if blockprofilerate \u003e 0 { t0 = cputicks() } åˆ¤æ–­å½“å‰channelæ˜¯å¦ä¸ºnilï¼Œå¦‚æœä¸ºnilåˆ™ä¸ºéé˜»å¡æ¥å—ï¼Œç›´æ¥è¿”å›ã€‚å¦‚æœnil channelä¸ºé˜»å¡æ¥å—ï¼Œä¼šè°ƒç”¨goparkæŒ‚èµ·ã€‚ å½“å¾ªç¯é˜Ÿé˜Ÿåˆ—ä¸º0ä¸”ç­‰å¾…é˜Ÿåˆ—sendqå†…æ²¡æœ‰goroutineæ­£åœ¨ç­‰å¾…æˆ–ç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œç›´æ¥è¿”å›ã€‚ è¿™é‡ŒæŠŠåˆ¤æ–­channelæ˜¯å¦å…³é—­æ”¾åœ¨æœ€ååˆ¤æ–­ï¼Œæ˜¯å› ä¸ºå¦‚æœæ”¾åœ¨å‰é¢åˆ¤æ–­ï¼Œåˆ¤æ–­åˆ°åé¢æ¡ä»¶æ—¶ï¼ŒclosedçŠ¶æ€å¯èƒ½ä¼šè¢«æ”¹å˜ã€‚ ","date":"2021-07-15","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/:4:1","tags":["æºç è§£æ","channel"],"title":"æ·±å…¥ç†è§£channel","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"åŠ é”/å¼‚å¸¸æ£€æŸ¥ lock(\u0026c.lock) // å¦‚æœé€šé“å·²ç»å…³é—­å¹¶ä¸”æ²¡æœ‰æ•°æ®å¯ä»¥è¯»å–ï¼Œè¿”å›(true,false) if c.closed != 0 \u0026\u0026 c.qcount == 0 { unlock(\u0026c.lock) if ep != nil { typedmemclr(c.elemtype, ep) } return true, false } å¦‚æœchannelè¢«å…³é—­äº†ï¼Œå¹¶ä¸”ç¼“å­˜åŒºæ²¡æœ‰æ•°æ®ï¼Œåˆ™ç›´æ¥é‡Šæ”¾é”å’Œæ¸…ç†epä¸­çš„æŒ‡é’ˆæ•°æ®ã€‚ ","date":"2021-07-15","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/:4:2","tags":["æºç è§£æ","channel"],"title":"æ·±å…¥ç†è§£channel","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"channelç›´æ¥æ¥æ”¶æ•°æ® // åœºæ™¯ä¸€ï¼šå¦‚æœæœ‰å‘é€è€…åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œé‚£ä¹ˆç›´æ¥ä»å‘é€è€…æå–æ•°æ®ï¼Œå¹¶å”¤é†’å‘é€è€…ã€‚ if sg := c.sendq.dequeue(); sg != nil { // Found a waiting sender. If buffer is size 0, receive value // directly from sender. Otherwise, receive from head of queue // and add sender's value to the tail of the queue (both map to // the same buffer slot because the queue is full). recv(c, sg, ep, func() { unlock(\u0026c.lock) }, 3) return true, true } è¿™ä¸€æ­¥ä¸channelç›´æ¥å‘é€æ•°æ®æ˜¯å¯¹åº”çš„ï¼Œå½“å‘ç°channelä¸Šæœ‰é˜»å¡çš„ç­‰å¾…å‘é€çš„å‘é€æ–¹æ—¶ï¼Œåˆ™ç›´æ¥è¿›è¡Œæ¥æ”¶ã€‚ ç­‰å¾…å‘é€é˜Ÿåˆ—ä¸­æœ‰goroutineå­˜åœ¨ï¼Œæœ‰ä¸¤ç§å¯èƒ½ï¼š éç¼“å†²çš„channel ç¼“å†²çš„channelï¼Œä½†æ˜¯ç¼“å†²åŒºæ»¡äº† é’ˆå¯¹è¿™ä¸¤ç§æƒ…å†µï¼Œåœ¨recvä¸­æœ‰ä¸åŒçš„è¡Œä¸ºï¼š // å¦‚æœæ— ç¼“å†²ï¼Œç›´æ¥å–å‡ºæ•°æ®ï¼›å¦‚æœæœ‰ç¼“å†²ï¼Œå°†ç¼“å†²åŒºçš„æ•°æ®å–å‡ºæ¥ï¼Œç„¶åå°†ç­‰å¾…ä¸­çš„å‘é€è€…çš„æ•°æ®æ‹·è´åˆ°ç¼“å†²åŒºä¸­ func recv(c *hchan, sg *sudog, ep unsafe.Pointer, unlockf func(), skip int) { if c.dataqsiz == 0 { // å¦‚æœä¸å¸¦ç¼“å†²åŒº if ep != nil { // copy data from sender // ç›´æ¥ä»å‘é€è€…å¤åˆ¶æ•°æ®åˆ°ep recvDirect(c.elemtype, sg, ep) } } else { // Queue is full. Take the item at the // head of the queue. Make the sender enqueue // its item at the tail of the queue. Since the // queue is full, those are both the same slot. // å¦‚æœå¸¦ç¼“å†²åŒºï¼Œç”±äºæœ‰å‘é€è€…ç­‰å¾…ï¼Œæ‰€ä»¥ç¼“å†²åŒºä¸€å®šæ˜¯æ»¡çš„ã€‚å°†ç¼“å†²åŒºçš„ç¬¬ä¸€ä¸ªæ•°æ®å¤åˆ¶åˆ°epï¼Œç„¶åå°†å‘é€è€…çš„æ•°æ®èµ‹å€¼åˆ°ç¼“å†²åŒº qp := chanbuf(c, c.recvx) // copy data from queue to receiver if ep != nil { typedmemmove(c.elemtype, ep, qp) } // copy data from sender to queue typedmemmove(c.elemtype, qp, sg.elem) c.recvx++ if c.recvx == c.dataqsiz { c.recvx = 0 } c.sendx = c.recvx // c.sendx = (c.sendx+1) % c.dataqsiz } sg.elem = nil gp := sg.g unlockf() gp.param = unsafe.Pointer(sg) if sg.releasetime != 0 { sg.releasetime = cputicks() } // å°†å‘é€è€…å”¤é†’ goready(gp, skip+1) } è¿™é‡Œä¸»è¦å°±æ˜¯åˆ†ä¸¤ç§æƒ…å†µï¼š éç¼“å†²channelï¼šæœªå¿½ç•¥æ¥å—å€¼æ—¶ç›´æ¥è°ƒç”¨recvDirectæ–¹æ³•ç›´æ¥ä»å‘é€æ–¹çš„goroutineè°ƒç”¨æ ˆä¸­å°†æ•°æ®æ‹·è´åˆ°æ¥æ”¶æ–¹çš„goroutine å¸¦ç¼“å†²åŒºçš„channelï¼šè°ƒç”¨chanbufæ–¹æ³•æ ¹æ®recvç´¢å¼•çš„ä½ç½®è¯»å–ç¼“å†²åŒºå…ƒç´ ï¼Œå¹¶å°†å…¶æ‹·è´åˆ°æ¥æ”¶æ–¹çš„å†…å­˜åœ°å€ï¼Œæ‹·è´å®Œæˆåè°ƒæ•´sendxå’Œrecvxç´¢å¼•çš„ä½ç½®ã€‚ æœ€ågoreadyå”¤é†’å‘é€æ–¹çš„goroutineç»§ç»­å‘é€æ•°æ®ã€‚ ","date":"2021-07-15","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/:4:3","tags":["æºç è§£æ","channel"],"title":"æ·±å…¥ç†è§£channel","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"channelç¼“å†²åŒºæœ‰æ•°æ® // åœºæ™¯äºŒï¼šå¦‚æœç¼“å†²åŒºæœ‰æ•°æ®ï¼Œä»ç¼“å†²åŒºå¤åˆ¶æ•°æ®åˆ°epï¼Œå¹¶ä¸”ä¿®æ”¹ä¸‹æ¬¡æ¥æ”¶ä½ç½®å’Œqcount if c.qcount \u003e 0 { // Receive directly from queue // å­˜å…ƒç´  qp := chanbuf(c, c.recvx) if raceenabled { raceacquire(qp) racerelease(qp) } if ep != nil { typedmemmove(c.elemtype, ep, qp) } typedmemclr(c.elemtype, qp) c.recvx++ if c.recvx == c.dataqsiz { c.recvx = 0 } c.qcount-- unlock(\u0026c.lock) return true, true } ","date":"2021-07-15","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/:4:4","tags":["æºç è§£æ","channel"],"title":"æ·±å…¥ç†è§£channel","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"channelç¼“å†²åŒºæ— æ•°æ® // æ‰§è¡Œä¸Šé¢çš„æµç¨‹åï¼Œä»ç„¶æ²¡æœ‰è¿”å›ï¼Œè¯´æ˜ç¼“å†²åŒºæ²¡æœ‰æ•°æ®ï¼Œä¸”æ²¡æœ‰å‘é€è€…åœ¨ç­‰å¾…ã€‚ // å¦‚æœæ˜¯éé˜»å¡ï¼Œç›´æ¥è¿”å›(false,false)(èµ°default) if !block { unlock(\u0026c.lock) return false, false } // å¯¹äºé˜»å¡æ¥æ”¶çš„æƒ…å†µï¼Œå°†è°ƒç”¨è€…goroutineæŒ‚èµ·ï¼Œå¹¶ä¸”ç­‰å¾…è¢«å”¤é†’ gp := getg() mysg := acquireSudog() mysg.releasetime = 0 if t0 != 0 { mysg.releasetime = -1 } // No stack splits between assigning elem and enqueuing mysg // on gp.waiting where copystack can find it. mysg.elem = ep mysg.waitlink = nil gp.waiting = mysg mysg.g = gp mysg.isSelect = false mysg.c = c gp.param = nil // goroutine ä½œä¸ºä¸€ä¸ª waiter å…¥é˜Ÿåˆ—ï¼Œç­‰å¾…æ¡ä»¶æ»¡è¶³ä¹‹åï¼Œä»è¿™ä¸ªé˜Ÿåˆ—é‡Œå–å‡ºæ¥å”¤é†’ï¼› c.recvq.enqueue(mysg) // Signal to anyone trying to shrink our stack that we're about // to park on a channel. The window between when this G's status // changes and when we set gp.activeStackChans is not safe for // stack shrinking. atomic.Store8(\u0026gp.parkingOnChan, 1) gopark(chanparkcommit, unsafe.Pointer(\u0026c.lock), waitReasonChanReceive, traceEvGoBlockRecv, 2) å‰©ä¸‹çš„å°±æ˜¯è¢«å”¤é†’åæ¸…ç†ç°åœºã€‚ ","date":"2021-07-15","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/:4:5","tags":["æºç è§£æ","channel"],"title":"æ·±å…¥ç†è§£channel","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"å…³é—­channel // å…³é—­é€šé“ func closechan(c *hchan) { if c == nil { panic(plainError(\"close of nil channel\")) } lock(\u0026c.lock) // ä¸èƒ½å¯¹å·²ç»å…³é—­çš„é€šé“å†æ¬¡æ‰§è¡Œå…³é—­æ“ä½œ if c.closed != 0 { unlock(\u0026c.lock) panic(plainError(\"close of closed channel\")) } if raceenabled { callerpc := getcallerpc() racewritepc(c.raceaddr(), callerpc, funcPC(closechan)) racerelease(c.raceaddr()) } // è®¾ç½®å…³é—­æ ‡è¯† c.closed = 1 var glist gList // gå¯¹è±¡çš„åˆ—è¡¨ // å”¤é†’æ‰€æœ‰çš„æ¥å—è€…ï¼Œå°†æ¥æ”¶æ•°æ®ç½®0 for { sg := c.recvq.dequeue() if sg == nil { break } if sg.elem != nil { typedmemclr(c.elemtype, sg.elem) sg.elem = nil } if sg.releasetime != 0 { sg.releasetime = cputicks() } gp := sg.g gp.param = nil if raceenabled { raceacquireg(gp, c.raceaddr()) } glist.push(gp) } // å”¤é†’æ‰€æœ‰çš„å‘é€è€…ï¼Œä»¤å…¶panic for { sg := c.sendq.dequeue() if sg == nil { break } sg.elem = nil if sg.releasetime != 0 { sg.releasetime = cputicks() } gp := sg.g gp.param = nil if raceenabled { raceacquireg(gp, c.raceaddr()) } glist.push(gp) } unlock(\u0026c.lock) // Ready all Gs now that we've dropped the channel lock. for !glist.empty() { gp := glist.pop() gp.schedlink = 0 goready(gp, 3) } } ä¸å…è®¸å¯¹nilçš„channelè¿›è¡Œå…³é—­ ä¸å…è®¸é‡å¤å…³é—­channel è·å–å½“å‰æ­£åœ¨é˜»å¡çš„å‘é€æˆ–æ¥å—çš„goroutineï¼Œæ­¤æ—¶å®ƒä»¬å¤„äºæŒ‚èµ·çŠ¶æ€ï¼Œç„¶åå°†å®ƒä»¬å”¤é†’ã€‚è¿™æ˜¯å‘é€æ–¹ä¸å…è®¸å‘channelå‘é€æ•°æ®ï¼Œä½†ä¸å½±å“æ¥æ”¶æ–¹ç»§ç»­æ¥å—æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰å…ƒç´ ï¼Œè·å–åˆ°çš„å…ƒç´ ä¸ºé›¶å€¼ã€‚ ","date":"2021-07-15","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/:5:0","tags":["æºç è§£æ","channel"],"title":"æ·±å…¥ç†è§£channel","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"æ€»ç»“ channelçš„è®¾è®¡ä¸æ˜¯ç‰¹åˆ«å¤æ‚ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ç»´æŠ¤äº†ä¸€ä¸ªå¾ªç¯é˜Ÿåˆ—ï¼Œå‘é€æ•°æ®ä¾èµ–äºFIFOï¼Œæ•°æ®ä¼ é€’ä¾èµ–äºå†…å­˜æ‹·è´ã€‚ ","date":"2021-07-15","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/:6:0","tags":["æºç è§£æ","channel"],"title":"æ·±å…¥ç†è§£channel","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3channel/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"å‰è¨€ Mapæ˜¯ä¸€ç§å¸¸ç”¨çš„æ•°æ®ç»“æ„ï¼Œé€šå¸¸ç”¨äºå­˜å‚¨æ— åºçš„é”®å€¼å¯¹ã€‚ä½†æ˜¯ï¼ŒMapåœ¨Golangä¸­æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ å¦‚æœåˆ¤æ–­Mapä¸­æ˜¯å¦åŒ…å«æŸä¸ªkeyï¼Ÿ Mapæ˜¯å¦‚ä½•å®ç°å¢åˆ æ”¹æŸ¥çš„ï¼Ÿ Mapçš„æ‰©å®¹æœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿ Mapæ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿ æ¦‚è¿° æˆ‘ä»¬åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œå‘ç°mapæœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š mapæ˜¯ä¸€ä¸ªæ— åºçš„key/valueé›†åˆ mapä¸­æ‰€æœ‰çš„keyæ˜¯ä¸ç›¸åŒçš„ é€šè¿‡ç»™å®šçš„keyï¼Œå¯ä»¥åœ¨å¸¸æ•°æ—¶é—´å¤æ‚åº¦(O(1))å†…æŸ¥æ‰¾ã€æ›´æ–°æˆ–åˆ é™¤ç›¸åº”çš„value è€Œæƒ³è¦å®ç°ä¸€ä¸ªæ€§èƒ½ä¼˜å¼‚çš„mapï¼Œéœ€è¦è§£å†³ä»¥ä¸‹å…³é”®ç‚¹ï¼š å“ˆå¸Œç®—æ³• å¤„ç†å“ˆå¸Œå†²çª æ‰©å®¹ç­–ç•¥ å“ˆå¸Œç®—æ³• ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:0:0","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"ä»€ä¹ˆæ˜¯å“ˆå¸Œç®—æ³•ï¼Ÿ å“ˆå¸Œç®—æ³•åˆç§°å“ˆå¸Œå‡½æ•°/æ•£åˆ—ç®—æ³•/æ•£åˆ—å‡½æ•°ï¼Œæ˜¯ä¸€ç§ä»ä»»ä½•ä¸€ç§æ•°æ®ä¸­åˆ›å»ºå°çš„æ•°å­—â€œæŒ‡çº¹â€çš„æ–¹æ³•ã€‚å“ˆå¸Œç®—æ³•æŠŠæ¶ˆæ¯æˆ–æ•°æ®å‹ç¼©æˆæ‘˜è¦ï¼Œä½¿å¾—æ•°æ®é‡å˜å°ï¼Œå°†æ•°æ®çš„æ ¼å¼å›ºå®šä¸‹æ¥ã€‚ å“ˆå¸Œç®—æ³•æœ€é‡è¦çš„ç‰¹ç‚¹å°±æ˜¯ï¼š ç›¸åŒçš„è¾“å…¥ä¸€å®šå¾—åˆ°ç›¸åŒçš„è¾“å‡ºï¼› ä¸åŒçš„è¾“å…¥å¤§æ¦‚ç‡å¾—åˆ°ä¸åŒçš„è¾“å‡ºã€‚ ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:1:0","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"Mapä¸­ä¸ºä»€ä¹ˆéœ€è¦å“ˆå¸Œç®—æ³•ï¼Ÿ Mapä¸­ä½¿ç”¨å“ˆå¸Œç®—æ³•æ˜¯ä¸ºäº†å®ç°å¿«é€ŸæŸ¥æ‰¾å’Œå®šä½ã€‚ ä¸€ä¸ªä¼˜ç§€çš„å“ˆå¸Œå‡½æ•°åº”è¯¥åŒ…å«ä»¥ä¸‹ç‰¹æ€§ï¼š å‡åŒ€æ€§ï¼šä¸€ä¸ªå¥½çš„å“ˆå¸Œå‡½æ•°åº”è¯¥åœ¨å…¶è¾“å‡ºèŒƒå›´å†…å°½å¯èƒ½å‡åŒ€åœ°æ˜ å°„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåº”ä»¥å¤§è‡´ç›¸åŒçš„æ¦‚ç‡ç”Ÿæˆè¾“å‡ºèŒƒå›´å†…çš„æ¯ä¸ªå“ˆå¸Œå€¼ã€‚ é«˜æ•ˆç‡ï¼šå“ˆå¸Œæ•ˆç‡è¦é«˜ï¼Œå³ä½¿å¾ˆé•¿çš„è¾“å…¥å‚æ•°ä¹Ÿèƒ½å¿«é€Ÿè®¡ç®—å‡ºå“ˆå¸Œå€¼ã€‚ å¯ç¡®å®šæ€§ï¼šå“ˆå¸Œè¿‡ç¨‹å¿…é¡»æ˜¯ç¡®å®šæ€§çš„ï¼Œè¿™æ„å‘³ç€å¯¹äºç»™å®šçš„è¾“å…¥å€¼ï¼Œå®ƒå¿…é¡»å§‹ç»ˆç”Ÿæˆç›¸åŒçš„å“ˆå¸Œå€¼ã€‚ é›ªå´©æ•ˆåº”ï¼šå¾®å°çš„è¾“å…¥å€¼å˜åŒ–ä¹Ÿä¼šè®©è¾“å‡ºå€¼å‘ç”Ÿå·¨å¤§çš„å˜åŒ–ã€‚ ä¸å¯é€†ï¼šä»å“ˆå¸Œå‡½æ•°çš„è¾“å‡ºå€¼ä¸å¯åå‘æ¨å¯¼å‡ºåŸå§‹çš„æ•°æ®ã€‚ ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:2:0","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"å¸¸è§çš„å“ˆå¸Œç®—æ³• ä¸‹å›¾æ˜¯ä¸åŒå“ˆå¸Œç®—æ³•çš„æ€§èƒ½å¯¹æ¯”ï¼Œæµ‹è¯•ç¯å¢ƒæ˜¯ Open-Source SMHasher program by Austin Appleby ï¼Œåœ¨ Windows 7 ä¸Šé€šè¿‡ Visual C ç¼–è¯‘ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼ŒCPU å†…æ ¸æ˜¯ Core 2 Duo @3.0GHzã€‚ å…¶ä¸­ï¼Œç¬¬ä¸€æ æ˜¯å“ˆå¸Œç®—æ³•åç§°ï¼Œç¬¬äºŒæ æ˜¯é€Ÿåº¦çš„å¯¹æ¯”ï¼Œç¬¬ä¸‰æ æ˜¯å“ˆå¸Œè´¨é‡ã€‚ä»è¡¨ä¸­æ•°æ®çœ‹ï¼Œè´¨é‡æœ€é«˜ã€é€Ÿåº¦æœ€å¿«çš„æ˜¯ xxHashã€‚ ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:3:0","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"Golangä½¿ç”¨çš„å“ˆå¸Œç®—æ³• Golang é€‰æ‹©å“ˆå¸Œç®—æ³•æ—¶ï¼Œæ ¹æ® CPU æ˜¯å¦æ”¯æŒ AES æŒ‡ä»¤é›†è¿›è¡Œåˆ¤æ–­ ï¼Œå¦‚æœ CPU æ”¯æŒ AES æŒ‡ä»¤é›†ï¼Œåˆ™ä½¿ç”¨ Aes Hashï¼Œå¦åˆ™ä½¿ç”¨ memhashã€‚ ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:4:0","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"AES Hash AES æŒ‡ä»¤é›†å…¨ç§°æ˜¯é«˜çº§åŠ å¯†æ ‡å‡†æŒ‡ä»¤é›†ï¼ˆæˆ–ç§°è‹±ç‰¹å°”é«˜çº§åŠ å¯†æ ‡å‡†æ–°æŒ‡ä»¤ï¼Œç®€ç§°AES-NIï¼‰ï¼Œæ˜¯ä¸€ä¸ª x86æŒ‡ä»¤é›†æ¶æ„çš„æ‰©å±•ï¼Œç”¨äº Intel å’Œ AMD å¤„ç†å™¨ã€‚ åˆ©ç”¨ AES æŒ‡ä»¤é›†å®ç°å“ˆå¸Œç®—æ³•æ€§èƒ½å¾ˆä¼˜ç§€ï¼Œå› ä¸ºå®ƒèƒ½æä¾›ç¡¬ä»¶åŠ é€Ÿã€‚ æŸ¥çœ‹ CPU æ˜¯å¦æ”¯æŒ AES æŒ‡ä»¤é›†ï¼š $ cat /proc/cpuinfo | grep aes flags : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts mmx fxsr sse sse2 ss ht syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon pebs bts nopl xtopology tsc_reliable nonstop_tsc aperfmperf eagerfpu pni pclmulqdq ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm 3dnowprefetch epb fsgsbase tsc_adjust bmi1 hle avx2 smep bmi2 invpcid rtm rdseed adx smap xsaveopt dtherm ida arat pln pts ç›¸å…³ä»£ç ï¼š runtime/alg.go asm_amd64.s asm_arm64.s ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:4:1","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"memhash ç½‘ä¸Šæ²¡æœ‰æ‰¾åˆ°è¿™ä¸ªå“ˆå¸Œç®—æ³•çš„ä½œè€…ä¿¡æ¯ï¼Œåªåœ¨ Golang çš„æºç ä¸­æœ‰è¿™å‡ è¡Œæ³¨é‡Šï¼Œè¯´å®ƒçš„çµæ„Ÿæ¥æºäº xxhash å’Œ cityhashã€‚ // Hashing algorithm inspired by // xxhash: https://code.google.com/p/xxhash/ // cityhash: https://code.google.com/p/cityhash/ ç›¸å…³ä»£ç ï¼š runtime/hash64.go runtime/hash32.go å¤„ç†å“ˆå¸Œå†²çª é€šå¸¸æƒ…å†µä¸‹ï¼Œå“ˆå¸Œç®—æ³•çš„è¾“å…¥èŒƒå›´ä¸€å®šä¼šè¿œè¿œå¤§äºè¾“å‡ºèŒƒå›´ï¼Œæ‰€ä»¥å½“è¾“å…¥çš„keyè¶³å¤Ÿå¤šæ—¶ä¸€å®šä¼šé‡åˆ°å†²çªï¼Œè¿™æ—¶éœ€è¦ä¸€äº›æ–¹æ³•æ¥è§£å†³å“ˆå¸Œå†²çªé—®é¢˜ã€‚ æ¯”è¾ƒå¸¸ç”¨çš„å“ˆå¸Œå†²çªè§£å†³æ–¹æ¡ˆæœ‰é“¾åœ°å€æ³•å’Œå¼€æ”¾å¯»å€æ³•ã€‚ Golang åŠå¤šæ•°ç¼–ç¨‹è¯­è¨€éƒ½ä½¿ç”¨é“¾åœ°å€æ³•å¤„ç†å“ˆå¸Œå†²çªã€‚ ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:4:2","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"é“¾åœ°å€æ³• é“¾åœ°å€æ³•ä¸€èˆ¬ä¼šä½¿ç”¨æ•°ç»„åŠ ä¸Šé“¾è¡¨å®ç°ï¼Œæœ‰äº›è¯­è¨€ä¼šå¼•å…¥çº¢é»‘æ ‘ä»¥ä¼˜åŒ–æ€§èƒ½ã€‚ ä¸‹é¢ä»¥ä¸€ä¸ªç®€å•çš„å“ˆå¸Œå‡½æ•°H(key)=key MOD 7ï¼ˆé™¤æ•°å–ä½™æ³•ï¼‰å¯¹ä¸€ç»„å…ƒç´ [50,700,76,85,92,73,101]è¿›è¡Œæ˜ å°„ã€‚ åœ¨éå†å½“å‰æ¡¶ä¸­çš„é“¾è¡¨æ—¶ï¼Œä¼šé‡åˆ°ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š 1ã€æ‰¾åˆ°é”®ç›¸åŒçš„é”®å€¼å¯¹ï¼Œåˆ™æ›´æ–°é”®å¯¹åº”çš„å€¼ 2ã€æ²¡æœ‰æ‰¾åˆ°é”®ç›¸åŒçš„é”®å€¼å¯¹ï¼Œåˆ™åœ¨é“¾è¡¨çš„æœ«å°¾è¿½åŠ æ–°é”®å€¼å¯¹ã€‚ ç‰¹ç‚¹ï¼šå¹³å‡æŸ¥æ‰¾é•¿åº¦çŸ­ï¼Œç”¨äºå­˜å‚¨èŠ‚ç‚¹çš„å†…å­˜æ˜¯åŠ¨æ€ç”³è¯·çš„ï¼Œå¯ä»¥èŠ‚çœè¾ƒå¤šå†…å­˜ã€‚ ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:5:0","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"å¼€æ”¾åœ°å€æ³• å¼€æ”¾åœ°å€æ³•çš„æ ¸å¿ƒæ€è·¯æ˜¯ï¼šå¯¹æ•°ç»„ä¸­çš„å…ƒç´ ä¾æ¬¡æ¢æµ‹å’Œæ¯”è¾ƒï¼Œä»¥åˆ¤æ–­ç›®æ ‡é”®å€¼å¯¹æ˜¯å¦å­˜åœ¨äºmapä¸­ã€‚ å¯¹äºé“¾åœ°å€æ³•è€Œè¨€ï¼Œæ§½ä½æ•°mä¸é”®çš„æ•°ç›®næ˜¯æ²¡æœ‰ç›´æ¥å…³ç³»çš„ã€‚ä½†æ˜¯å¯¹äºå¼€æ”¾å¯»å€æ³•è€Œè¨€ï¼Œæ‰€æœ‰çš„å…ƒç´ éƒ½æ˜¯å­˜å‚¨åœ¨hashè¡¨ä¸­ï¼Œæ‰€ä»¥æ— è®ºå¦‚ä½•éƒ½è¦ä¿è¯å“ˆå¸Œè¡¨çš„æ§½ä½æ•°m\u003e=é”®çš„æ•°ç›®nã€‚ï¼ˆå¿…è¦æ—¶ï¼Œéœ€è¦å¯¹å“ˆå¸Œè¡¨è¿›è¡ŒåŠ¨æ€æ‰©å®¹ï¼‰ å¼€æ”¾å¯»å€æ³•æœ‰å¤šç§æ–¹å¼ï¼šçº¿æ€§æ¢æµ‹æ³•ã€å¹³æ–¹æ¢æµ‹æ³•ã€éšæœºæ¢æµ‹æ³•ã€åŒé‡å“ˆå¸Œæ³•ã€‚ çº¿æ€§æ¢æµ‹æ³• è®¾Hash(key)è¡¨ç¤ºå…³é”®å­—keyçš„å“ˆå¸Œå€¼ï¼Œè¡¨ç¤ºå“ˆå¸Œè¡¨çš„æ§½ä½æ•°ï¼ˆå“ˆå¸Œè¡¨çš„å¤§å°ï¼‰ã€‚ çº¿æ€§æ¢æµ‹æ³•å¯ä»¥è¡¨ç¤ºä¸ºï¼š å¦‚æœHash(x)%Må·²ç»æœ‰æ•°æ®ï¼Œåˆ™å°è¯•(Hash(x)+1)%M å¦‚æœ(Hash(x)+1)%Mæœ‰æ•°æ®ï¼Œåˆ™å°è¯•(Hash(x)+2)%M å¦‚æœ(Hash(x)+2)%Mæœ‰æ•°æ®ï¼Œåˆ™å°è¯•(Hash(x)+3)%M â€¦ åŒæ ·ä»¥å“ˆå¸Œå‡½æ•°H(key)=key MOD 7ï¼ˆé™¤æ•°å–ä½™æ³•ï¼‰å¯¹ä¸€ç»„å…ƒç´ [50,700,76,85,92,73,101]è¿›è¡Œæ˜ å°„ã€‚ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå½“æˆ‘ä»¬å‘å½“å‰mapå†™å…¥æ–°æ•°æ®æ—¶å‘ç”Ÿäº†å†²çªï¼Œå°±å°†é”®å€¼å†™å…¥åˆ°ä¸‹ä¸€ä¸ªä¸ä¸ºç©ºçš„ä½ç½®ã€‚ å¼€æ”¾åœ°å€ä¸­å¯¹æ€§èƒ½å½±å“æœ€å¤§çš„æ˜¯è£…è½½å› å­ï¼Œå®ƒæ˜¯æ•°ç»„ä¸­å…ƒç´ æ•°é‡å’Œæ•°ç»„å¤§å°çš„æ¯”å€¼ã€‚éšç€è£…è½½å› å­çš„å¢åŠ ï¼Œçº¿æ€§æ¢æµ‹çš„å¹³å‡ç”¨æ—¶ä¼šé€æ¸å¢åŠ ï¼Œè¿™ä¼šå½±å“mapçš„è¯»å†™æ€§èƒ½ã€‚ ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:6:0","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"ä¸¤ç§æ–¹æ¡ˆçš„æ¯”è¾ƒ å¯¹äºå¼€æ”¾å¯»å€æ³•è€Œè¨€ï¼Œå®ƒåªæœ‰æ•°ç»„ä¸€ç§æ•°æ®ç»“æ„å°±å¯å®Œæˆå­˜å‚¨ï¼Œç»§æ‰¿äº†æ•°ç»„çš„ä¼˜ç‚¹ï¼Œå¯¹CPUç¼“å­˜å‹å¥½ï¼Œæ˜“äºåºåˆ—åŒ–æ“ä½œã€‚ä½†æ˜¯å®ƒå¯¹å†…å­˜çš„åˆ©ç”¨ç‡ä¸å¦‚é“¾åœ°å€æ³•ï¼Œä¸”å‘ç”Ÿå†²çªæ—¶ä»£ä»·æ›´é«˜ã€‚å½“æ•°æ®é‡æ˜ç¡®ã€è£…è½½å› å­å°ï¼Œé€‚åˆé‡‡ç”¨å¼€æ”¾å¯»å€æ³•ã€‚ é“¾è¡¨èŠ‚ç‚¹å¯ä»¥åœ¨éœ€è¦æ—¶å†åˆ›å»ºï¼Œä¸å¿…åƒå¼€æ”¾å¯»å€æ³•é‚£æ ·äº‹å…ˆç”³è¯·å¥½è¶³å¤Ÿå†…å­˜ï¼Œå› æ­¤é“¾åœ°å€æ³•å¯¹äºå†…å­˜çš„åˆ©ç”¨ç‡ä¼šæ¯”å¼€æ–¹å¯»å€æ³•é«˜ã€‚ é“¾åœ°å€æ³•å¯¹è£…è½½å› å­çš„å®¹å¿åº¦ä¼šæ›´é«˜ï¼Œå¹¶ä¸”é€‚åˆå­˜å‚¨å¤§å¯¹è±¡ã€å¤§æ•°æ®é‡çš„å“ˆå¸Œè¡¨ã€‚è€Œä¸”ç›¸è¾ƒäºå¼€æ”¾å¯»å€æ³•ï¼Œå®ƒæ›´åŠ çµæ´»ï¼Œæ”¯æŒæ›´å¤šçš„ä¼˜åŒ–ç­–ç•¥ï¼Œæ¯”å¦‚å¯é‡‡ç”¨çº¢é»‘æ ‘ä»£æ›¿é“¾è¡¨ã€‚ä½†æ˜¯é“¾åœ°å€æ³•éœ€è¦é¢å¤–çš„ç©ºé—´æ¥å­˜å‚¨æŒ‡é’ˆã€‚ åœ¨Pythonä¸­dictåœ¨å‘ç”Ÿå“ˆå¸Œå†²çªæ—¶é‡‡ç”¨çš„å¼€æ”¾å¯»å€æ³•ï¼Œè€Œjavaçš„HashMapé‡‡ç”¨çš„æ˜¯é“¾åœ°å€æ³•ã€‚ Goè§£å†³å“ˆå¸Œå†²çªçš„æ–¹å¼æ˜¯é“¾åœ°å€æ³•ï¼Œå³é€šè¿‡ä½¿ç”¨æ•°ç»„+é“¾è¡¨çš„æ•°æ®ç»“æ„æ¥è¡¨è¾¾mapã€‚ æ‰©å®¹ç­–ç•¥ éšç€ Map ä¸­å…ƒç´ çš„å¢åŠ ï¼Œå‘ç”Ÿå“ˆå¸Œå†²çªçš„æ¦‚ç‡ä¼šå¢åŠ ï¼ŒMap çš„è¯»å†™æ€§èƒ½ä¹Ÿä¼šä¸‹é™ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ›´å¤šçš„æ¡¶å’Œæ›´å¤§çš„å†…å­˜æ¥ä¿è¯ Map çš„è¯»å†™æ€§èƒ½ã€‚ åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå½“è£…è½½å› å­è¶…è¿‡æŸä¸ªé˜ˆå€¼æ—¶ï¼Œä¼šåŠ¨æ€åœ°å¢åŠ  Map é•¿åº¦ï¼Œå®ç°è‡ªåŠ¨æ‰©å®¹ã€‚ æ¯å½“ Map é•¿åº¦å‘ç”Ÿå˜åŒ–åï¼Œæ‰€æœ‰ key åœ¨ Map ä¸­å¯¹åº”çš„ç´¢å¼•éœ€è¦é‡æ–°è®¡ç®—ã€‚å¦‚æœä¸€ä¸ªä¸€ä¸ªè®¡ç®—åŸ Map ä¸­çš„ key çš„ç´¢å¼•å¹¶æ’å…¥åˆ°æ–° Map ä¸­ï¼Œè¿™ç§ä¸€æ¬¡æ€§æ‰©å®¹æ–¹å¼æ˜¯è¾¾ä¸åˆ°ç”Ÿäº§ç¯å¢ƒçš„è¦æ±‚çš„ï¼Œå› ä¸ºæ—¶é—´å¤æ‚åº¦å¤ªé«˜äº†O(n)ï¼Œåœ¨æ•°æ®é‡å¤§çš„æƒ…å†µä¸‹æ€§èƒ½ä¼šå¾ˆå·®ã€‚ åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒMap æ‰©å®¹éƒ½æ˜¯åˆ†å¤šæ¬¡ã€æ¸è¿›å¼åœ°å®Œæˆï¼Œè€Œä¸æ˜¯ä¸€æ€§æ¬¡å®Œæˆæ‰©å®¹ã€‚ å…·ä½“å®ç° Golang Mapçš„å…·ä½“å®šä¹‰åœ¨src/runtime/map.goæ–‡ä»¶ä¸­ã€‚ ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:7:0","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"å¸¸é‡å®šä¹‰ const ( // ä¸€ä¸ªæ¡¶ä¸­æœ€å¤šèƒ½è£…è½½çš„é”®å€¼å¯¹çš„ä¸ªæ•°ä¸º8 bucketCntBits = 3 bucketCnt = 1 \u003c\u003c bucketCntBits // è§¦å‘æ‰©å®¹çš„è£…è½½å› æ­¤13/2=6.5 loadFactorNum = 13 loadFactorDen = 2 // é”®å’Œå€¼è¶…è¿‡128ä¸ªå­—èŠ‚ï¼Œå°±ä¼šè¢«è½¬ä¸ºæŒ‡é’ˆ maxKeySize = 128 maxElemSize = 128 // æ•°æ®åç§»é‡æ˜¯bmapç»“æ„ä½“çš„å¤§å°ï¼Œéœ€è¦å¯¹é½ã€‚ // å¯¹äºamd64p32è€Œè¨€ï¼Œæ„å‘³ç€ï¼Œå³ä½¿æŒ‡é’ˆæ—¶32ä½çš„ï¼Œä¹Ÿæ˜¯64ä½å¯¹é½ dataOffset = unsafe.Offsetof(struct { b bmap v int64 }{}.v) // æ¯ä¸ªæ¡¶ï¼ˆå¦‚æœæœ‰æº¢å‡ºï¼Œåˆ™åŒ…å«å®ƒçš„overflowçš„é“¾æ¡¶ï¼‰åœ¨æ¬è¿å®ŒæˆçŠ¶æ€(evacuated* states)ä¸‹ï¼Œè¦ä¹ˆåŒ…å«å®ƒçš„æ‰€æœ‰é”®å€¼å¯¹ï¼Œ // è¦ä¹ˆä¸€ä¸ªéƒ½ä¸åŒ…å«ï¼ˆä½†ä¸åŒ…æ‹¬è°ƒç”¨evacuate()æ–¹æ³•é˜¶æ®µï¼Œè¯¥æ–¹æ³•è°ƒç”¨åªä¼šåœ¨å¯¹mapå‘èµ·writeæ—¶å‘ç”Ÿï¼Œåœ¨è¯¥é˜¶æ®µå…¶ä»–goroutineæ˜¯æ— æ³•æŸ¥çœ‹è¯¥mapçš„ï¼‰ã€‚ // ç®€å•çš„è¯´ï¼Œæ¡¶é‡Œçš„æ•°æ®è¦ä¹ˆä¸€èµ·æ¬èµ°ï¼Œè¦ä¹ˆä¸€ä¸ªéƒ½è¿˜æœªæ¬ã€‚ // tophashé™¤äº†æ”¾ç½®æ­£å¸¸çš„é«˜8ä½hashå€¼ï¼Œè¿˜ä¼šå­˜å‚¨ä¸€äº›ç‰¹æ®ŠçŠ¶æ€å€¼ï¼ˆæ ‡å¿—è¯¥cellçš„æ¬è¿çŠ¶æ€ï¼‰ã€‚æ­£å¸¸çš„tophashå€¼ï¼Œæœ€å°åº”è¯¥æ˜¯5ï¼Œä»¥ä¸‹åˆ—å‡ºçš„å°±æ˜¯ä¸€äº›ç‰¹æ®ŠçŠ¶æ€å€¼ã€‚ // è¡¨ç¤ºcellä¸ºç©ºï¼Œå¹¶ä¸”æ¯”å®ƒé«˜ç´¢å¼•ä½çš„cellæˆ–è€…overflowsä¸­çš„celléƒ½æ˜¯ç©ºçš„ã€‚ï¼ˆåˆå§‹åŒ–bucketæ—¶ï¼Œå°±æ˜¯è¯¥çŠ¶æ€ï¼‰ emptyRest = 0 // this cell is empty, and there are no more non-empty cells at higher indexes or overflows. // ç©ºçš„cellï¼Œcellå·²ç»è¢«æ¬è¿åˆ°æ–°çš„bucket emptyOne = 1 // this cell is empty // é”®å€¼å¯¹å·²ç»æ¬è¿å®Œæ¯•ï¼Œkeyåœ¨æ–°bucketsæ•°ç»„çš„å‰åŠéƒ¨åˆ† evacuatedX = 2 // key/elem is valid. Entry has been evacuated to first half of larger table. // é”®å€¼å¯¹å·²ç»æ¬è¿å®Œæ¯•ï¼Œkeyåœ¨æ–°bucketsæ•°ç»„çš„ååŠéƒ¨åˆ† evacuatedY = 3 // same as above, but evacuated to second half of larger table. // cellä¸ºç©ºï¼Œæ•´ä¸ªbucketå·²ç»æ¬è¿å®Œæ¯• evacuatedEmpty = 4 // cell is empty, bucket is evacuated. // tophashçš„æœ€å°æ­£å¸¸å€¼ minTopHash = 5 // minimum tophash for a normal filled cell. // flags // å¯èƒ½æœ‰è¿­ä»£å™¨åœ¨ä½¿ç”¨buckets iterator = 1 // there may be an iterator using buckets // å¯èƒ½æœ‰è¿­ä»£å™¨åœ¨ä½¿ç”¨oldbuckets oldIterator = 2 // there may be an iterator using oldbuckets // æœ‰åç¨‹æ­£åœ¨å‘mapå†™å…¥key hashWriting = 4 // a goroutine is writing to the map // ç­‰é‡æ‰©å®¹ sameSizeGrow = 8 // the current map growth is to a new map of the same size // ç”¨äºè¿­ä»£å™¨æ£€æŸ¥çš„bucket ID noCheck = 1\u003c\u003c(8*sys.PtrSize) - 1 ) ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:8:0","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"è£…è½½å› å­ä¸ºä»€ä¹ˆæ˜¯6.5ï¼Ÿ è¿™ä¸ªå€¼å¤ªå¤§ä¼šå¯¼è‡´æº¢å‡ºæ¡¶ï¼ˆoverflow bucketsï¼‰è¿‡å¤šï¼ŒæŸ¥æ‰¾æ•ˆç‡é™ä½ï¼Œè¿‡å°åˆ™ä¼šæµªè´¹å­˜å‚¨ç©ºé—´ã€‚ æ® Google å¼€å‘äººå‘˜ç§°ï¼Œè¿™ä¸ªå€¼æ˜¯ä¸€ä¸ªæµ‹è¯•ç¨‹åºæµ‹é‡å‡ºæ¥çš„ä¸€ä¸ªç»éªŒå€¼ã€‚ %overflow ï¼šæº¢å‡ºç‡ï¼Œå¹³å‡æ¯ä¸ªæ¡¶ï¼ˆbucketï¼‰æœ‰å¤šå°‘é”®å€¼å¯¹ key/value æ—¶ä¼šæº¢å‡ºã€‚ bytes/entry ï¼šå­˜å‚¨ä¸€ä¸ªé”®å€¼å¯¹ key/value æ—¶ï¼Œ æ‰€éœ€çš„é¢å¤–å­˜å‚¨ç©ºé—´ï¼ˆå­—èŠ‚ï¼‰ã€‚ hitprobe ï¼šæŸ¥æ‰¾ä¸€ä¸ªå­˜åœ¨çš„ key æ—¶ï¼Œæ‰€éœ€çš„å¹³å‡æŸ¥æ‰¾æ¬¡æ•°ã€‚ missprobe ï¼šæŸ¥æ‰¾ä¸€ä¸ªä¸å­˜åœ¨çš„ key æ—¶ï¼Œæ‰€éœ€çš„å¹³å‡æŸ¥æ‰¾æ¬¡æ•°ã€‚ ç»è¿‡è¿™å‡ ç»„æµ‹è¯•æ•°æ®ï¼Œæœ€ç»ˆé€‰å®š 6.5 ä½œä¸ºä¸´ç•Œçš„è£…è½½å› å­ã€‚ ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:9:0","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"map headerå®šä¹‰ // A header for a Go map. type hmap struct { // Note: the format of the hmap is also encoded in cmd/compile/internal/gc/reflect.go. // Make sure this stays in sync with the compiler's definition. // é”®å€¼å¯¹çš„æ•°é‡ count int // # live cells == size of map. Must be first (used by len() builtin) // æ ‡è¯†çŠ¶æ€ flags uint8 // 2^B = len(buckets) B uint8 // log_2 of # of buckets (can hold up to loadFactor * 2^B items) // æº¢å‡ºæ¡¶é‡Œbmapå¤§è‡´æ•°é‡ noverflow uint16 // approximate number of overflow buckets; see incrnoverflow for details // hashå› å­ hash0 uint32 // hash seed // æŒ‡å‘ä¸€ä¸ªæ•°ç»„ï¼ˆè¿ç»­å†…å­˜ç©ºé—´ï¼‰ï¼Œæ•°ç»„ç±»å‹ä¸º[]bmapï¼Œbmapç±»å‹å°±æ˜¯å­˜åœ¨é”®å€¼å¯¹çš„ç»“æ„ buckets unsafe.Pointer // array of 2^B Buckets. may be nil if count==0. // æ‰©å®¹æ—¶ï¼Œå­˜æ”¾ä¹‹å‰çš„buckets oldbuckets unsafe.Pointer // previous bucket array of half the size, non-nil only when growing // åˆ†æµæ¬¡æ•°ï¼Œæˆå€æ‰©å®¹åˆ†æµæ“ä½œè®¡æ•°çš„å­—æ®µ nevacuate uintptr // progress counter for evacuation (buckets less than this have been evacuated) // æº¢å‡ºæ¡¶ç»“æ„ï¼Œæ­£å¸¸æ¡¶é‡Œé¢æŸä¸ªbmapå­˜æ»¡äº†ï¼Œä¼šä½¿ç”¨è¿™é‡Œé¢çš„å†…å­˜ç©ºé—´å­˜æ”¾é”®å€¼å¯¹ extra *mapextra // optional fields } åœ¨Golangçš„map headerç»“æ„ä¸­ï¼ŒåŒ…å«2ä¸ªæŒ‡å‘æ¡¶æ•°ç»„çš„æŒ‡é’ˆï¼ŒbucketsæŒ‡å‘æ–°çš„æ¡¶æ•°ç»„ï¼ŒoldbucketsæŒ‡å‘æ—§çš„æ¡¶æ•°ç»„ã€‚ oldbucketsåœ¨å“ˆå¸Œè¡¨æ‰©å®¹æ—¶ç”¨äºä¿å­˜æ—§æ¡¶æ•°æ®ï¼Œå®ƒçš„å¤§å°æ˜¯å½“å‰bucketsçš„ä¸€åŠã€‚ hmapçš„æœ€åä¸€ä¸ªå­—æ®µæŒ‡å‘ä¸€ä¸ªmapextraç»“æ„çš„æŒ‡é’ˆã€‚ // mapextra holds fields that are not present on all maps. type mapextra struct { // If both key and elem do not contain pointers and are inline, then we mark bucket // type as containing no pointers. This avoids scanning such maps. // However, bmap.overflow is a pointer. In order to keep overflow buckets // alive, we store pointers to all overflow buckets in hmap.extra.overflow and hmap.extra.oldoverflow. // overflow and oldoverflow are only used if key and elem do not contain pointers. // overflow contains overflow buckets for hmap.buckets. // oldoverflow contains overflow buckets for hmap.oldbuckets. // The indirection allows to store a pointer to the slice in hiter. // æº¢å‡ºæ¡¶ï¼Œå½“æ­£å¸¸æ¡¶å­˜æ»¡åå°±ä½¿ç”¨hmap.extra.overflowçš„bmap // bmap.overflowæ˜¯æŒ‡é’ˆç±»å‹ï¼Œå­˜æ”¾äº†å¯¹åº”ä½¿ç”¨çš„hmap.extra.overflowé‡Œçš„bmapåœ°å€ overflow *[]*bmap // æ‰©å®¹æ—¶å­˜æ”¾ä¹‹å‰çš„overflow oldoverflow *[]*bmap // nextOverflow holds a pointer to a free overflow bucket. // æŒ‡å‘æº¢å‡ºæ¡¶é‡Œä¸‹ä¸€ä¸ªå¯ä»¥ä½¿ç”¨çš„bmap nextOverflow *bmap } å¦‚ä¸Šå›¾æ‰€ç¤ºmapé‡Œçš„æ¡¶å°±æ˜¯bmapï¼Œæ¯ä¸€ä¸ªbmapèƒ½å­˜å‚¨8ä¸ªé”®å€¼å¯¹ã€‚ å½“mapä¸­å­˜å‚¨çš„æ•°æ®è¿‡å¤šï¼Œå•ä¸ªæ¡¶è£…æ»¡æ—¶å°±ä¼šä½¿ç”¨extra.overflowä¸­çš„æ¡¶å­˜å‚¨æº¢å‡ºçš„æ•°æ®ã€‚ ä¸Šé¢çš„é»„è‰²çš„bmapå°±æ˜¯æ­£å¸¸æ¡¶ï¼Œç»¿è‰²çš„bmapå°±æ˜¯æº¢å‡ºæ¡¶ã€‚ ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:10:0","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"æ¡¶çš„ç»“æ„ä½“bmap // A bucket for a Go map. type bmap struct { // tophash generally contains the top byte of the hash value // for each key in this bucket. If tophash[0] \u003c minTopHash, // tophash[0] is a bucket evacuation state instead. // tophashåŒ…å«æ­¤æ¡¶ä¸­æ¯ä¸ªé”®çš„å“ˆå¸Œå€¼æœ€é«˜å­—èŠ‚ï¼ˆé«˜8ä½ï¼‰ä¿¡æ¯ï¼ˆä¹Ÿå°±æ˜¯å‰é¢æ‰€è¿°çš„high-order bitsï¼‰ã€‚ // å¦‚æœtophash[0] \u003c minTopHashï¼Œtophash[0]åˆ™ä»£è¡¨æ¡¶çš„æ¬è¿ï¼ˆevacuationï¼‰çŠ¶æ€ã€‚ tophash [bucketCnt]uint8 // Followed by bucketCnt keys and then bucketCnt elems. // NOTE: packing all the keys together and then all the elems together makes the // code a bit more complicated than alternating key/elem/key/elem/... but it allows // us to eliminate padding which would be needed for, e.g., map[int64]int8. // Followed by an overflow pointer. } bmapç»“æ„ä½“å…¶å®ä¸æ­¢åŒ…å«tophashå­—æ®µï¼Œç”±äº Map ä¸­å¯èƒ½å­˜å‚¨ä¸åŒç±»å‹çš„é”®å€¼å¯¹ï¼Œå¹¶ä¸” Golang ä¸æ”¯æŒæ³›å‹ï¼Œæ‰€ä»¥é”®å€¼å¯¹å æ®çš„å†…å­˜ç©ºé—´å¤§å°åªèƒ½åœ¨ç¼–è¯‘æ—¶è¿›è¡Œæ¨å¯¼ï¼Œè¿™äº›é¢å¤–å­—æ®µåœ¨è¿è¡Œæ—¶éƒ½æ˜¯é€šè¿‡è®¡ç®—å†…å­˜åœ°å€çš„æ–¹å¼ç›´æ¥è®¿é—®çš„ï¼Œæ‰€ä»¥ bmap çš„å®šä¹‰ä¸­å°±æ²¡æœ‰åŒ…å«è¿™äº›é¢å¤–çš„å­—æ®µã€‚ è¿™ä¼šåœ¨ç¼–è¯‘æœŸé—´çš„cmd/compile/internal/gc/reflect.goé‡å»ºbmapçš„ç»“æ„ã€‚ type bmap struct { topbits [8]uint8 // é•¿åº¦ä¸º8çš„æ•°ç»„ï¼Œå…ƒç´ ä¸ºï¼škeyè·å–çš„hashçš„é«˜8ä½ï¼Œéå†æ—¶å¯¹æ¯”ä½¿ç”¨ï¼Œæé«˜æ€§èƒ½ã€‚ keys [8]keytype // é•¿åº¦ä¸º8çš„æ•°ç»„ï¼Œ[]keytypeï¼Œå…ƒç´ ä¸ºï¼šå…·ä½“çš„keyå€¼ values [8]valuetype // é•¿åº¦ä¸º8çš„æ•°ç»„ï¼Œ[]elemtypeï¼Œå…ƒç´ ä¸ºï¼šé”®å€¼å¯¹çš„keyå¯¹åº”çš„å€¼ overflow uintptr // æŒ‡å‘hmap.extra.overflowæº¢å‡ºæ¡¶é‡Œçš„`bmap`ï¼Œä¸Šé¢å­—æ®µé•¿åº¦ä¸º8ï¼Œæœ€å¤šå­˜8ç»„é”®å€¼å¯¹ï¼Œå­˜æ»¡äº†å°±å¾€è¿™é¡¹çš„è¿™ä¸ªbmapå­˜ } // bmap makes the map bucket type given the type of the map. func bmap(t *types.Type) *types.Type { ... field := make([]*types.Field, 0, 5) // The first field is: uint8 topbits[BUCKETSIZE]. arr := types.NewArray(types.Types[TUINT8], BUCKETSIZE) field = append(field, makefield(\"topbits\", arr)) arr = types.NewArray(keytype, BUCKETSIZE) arr.SetNoalg(true) keys := makefield(\"keys\", arr) field = append(field, keys) arr = types.NewArray(elemtype, BUCKETSIZE) arr.SetNoalg(true) elems := makefield(\"elems\", arr) field = append(field, elems) // If keys and elems have no pointers, the map implementation // can keep a list of overflow pointers on the side so that // buckets can be marked as having no pointers. // Arrange for the bucket to have no pointers by changing // the type of the overflow field to uintptr in this case. // See comment on hmap.overflow in runtime/map.go. otyp := types.NewPtr(bucket) if !types.Haspointers(elemtype) \u0026\u0026 !types.Haspointers(keytype) { otyp = types.Types[TUINTPTR] } overflow := makefield(\"overflow\", otyp) field = append(field, overflow) t.MapType().Bucket = bucket bucket.StructType().Map = t return bucket } ç¼–è¯‘æœŸé—´è¿˜ä¼šç”Ÿæˆmaptypeç»“æ„ä½“ï¼Œå®šä¹‰åœ¨runtime/type.goæ–‡ä»¶ä¸­ï¼š type maptype struct { typ _type key *_type elem *_type bucket *_type // internal type representing a hash bucket // function for hashing keys (ptr to key, seed) -\u003e hash // hasherçš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯æŒ‡å‘keyçš„æŒ‡é’ˆï¼Œh.hash0=fastrand()å¾—åˆ°çš„hash0ï¼Œå°±æ˜¯hasheræ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•° // hasheræ–¹æ³•è¿”å›çš„å°±æ˜¯hashå€¼ hasher func(unsafe.Pointer, uintptr) uintptr keysize uint8 // size of key slot elemsize uint8 // size of elem slot bucketsize uint16 // size of bucket flags uint32 } ä¸‹é¢æ˜¯mapçš„æ•´ä½“ç»“æ„å›¾ bmapæ˜¯å­˜æ”¾key/valueçš„åœ°æ–¹ï¼Œä¸‹é¢æ˜¯bmapçš„å†…éƒ¨ç»„æˆï¼š ä¸Šå›¾æ˜¯æ¡¶çš„å†…å­˜æ¨¡å‹ï¼ŒHOB Hash æŒ‡çš„æ˜¯ tophashã€‚æ³¨æ„åˆ° key å’Œ value æ˜¯å„è‡ªæ”¾åœ¨ä¸€èµ·çš„ï¼Œå¹¶ä¸æ˜¯ key/value/key/value/â€¦ è¿™æ ·çš„å½¢å¼ã€‚ å¦‚æœæŒ‰ç…§ key/value/key/value/â€¦ è¿™æ ·çš„å½¢å¼å­˜å‚¨ï¼Œä¸ºäº†å†…å­˜å¯¹é½ï¼Œåœ¨æ¯ä¸€å¯¹ key/value åé¢éƒ½è¦é¢å¤– padding 7 ä¸ªå­—èŠ‚ï¼› è€Œå°†æ‰€æœ‰çš„ keyï¼Œvalue åˆ†åˆ«ç»‘å®šåˆ°ä¸€èµ·ï¼Œè¿™ç§å½¢å¼ key/key/â€¦/value/value/â€¦ï¼Œåˆ™åªéœ€è¦åœ¨æœ€åæ·»åŠ  paddingã€‚ ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:11:0","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"æ–°å»ºmap æ–°å»ºmapæœ‰ä¸¤ç§æ–¹å¼ make(map[k]v) make(map[k]v,hint) å¯¹äºä¸æŒ‡å®šåˆå§‹åŒ–å¤§å°æˆ–åˆå§‹åŒ–å¤§å°hint\u003c=8æ—¶ï¼Œä¼šè°ƒç”¨makemap_smallå‡½æ•°ï¼Œç›´æ¥ä»å †ä¸Šåˆ†é…ã€‚å½“hint\u003e8æ—¶ï¼Œè°ƒç”¨makemapå‡½æ•°ã€‚ è€Œæˆ‘ä»¬è€ƒè™‘çš„æ˜¯makemapå‡½æ•°ï¼š ä¸»è¦å·¥ä½œå°±æ˜¯åˆ†é…å†…å­˜å¹¶åˆå§‹åŒ–hmapç»“æ„ä½“çš„å„é¡¹å­—æ®µï¼Œä¾‹å¦‚è®¡ç®—Bçš„å¤§å°ï¼Œè®¾ç½®å“ˆå¸Œç§å­hash0ç­‰ã€‚ func makemap(t *maptype, hint int, h *hmap) *hmap { // math.MulUintptrè¿”å›hintä¸t.bucket.sizeçš„ä¹˜ç§¯ï¼Œå¹¶åˆ¤æ–­è¯¥ä¹˜ç§¯æ˜¯å¦æº¢å‡ºã€‚ mem, overflow := math.MulUintptr(uintptr(hint), t.bucket.size) if overflow || mem \u003e maxAlloc { hint = 0 } // initialize Hmap if h == nil { h = new(hmap) } // å¾—åˆ°å“ˆå¸Œç§å­ h.hash0 = fastrand() // Find the size parameter B which will hold the requested # of elements. // For hint \u003c 0 overLoadFactor returns false since hint \u003c bucketCnt. // æ ¹æ®è¾“å…¥çš„å…ƒç´ ä¸ªæ•°hintï¼Œæ‰¾åˆ°èƒ½è£…ä¸‹è¿™äº›å…ƒç´ çš„Bå€¼ B := uint8(0) for overLoadFactor(hint, B) { B++ } h.B = B // åˆ†é…åˆå§‹å“ˆå¸Œè¡¨ // å¦‚æœ B==0ï¼Œé‚£ä¹ˆbucketså­—æ®µä¼šåœ¨åç»­çš„mapassignæ–¹æ³•ä¸­lazilyåˆ†é… // allocate initial hash table // if B == 0, the buckets field is allocated lazily later (in mapassign) // If hint is large zeroing this memory could take a while. if h.B != 0 { var nextOverflow *bmap // makeBucketArrayåˆ›å»ºä¸€ä¸ªmapçš„åº•å±‚ä¿å­˜bucketsçš„æ•°ç»„ï¼Œè‡³å°‘ä¼šåˆ†é… B^2 çš„å¤§å° h.buckets, nextOverflow = makeBucketArray(t, h.B, nil) if nextOverflow != nil { h.extra = new(mapextra) h.extra.nextOverflow = nextOverflow } } return h } åœ¨ B ä¸ä¸º 0 çš„æƒ…å†µä¸‹ï¼Œä¼šè°ƒç”¨ makeBucketArray å‡½æ•°åˆå§‹åŒ–æ¡¶ã€‚ å½“ B \u003c 4 çš„æ—¶å€™ï¼Œåˆå§‹åŒ– hmap åªä¼šç”Ÿæˆ 8 ä¸ªæ¡¶ï¼Œä¸ç”Ÿæˆæº¢å‡ºæ¡¶ï¼Œå› ä¸ºæ•°æ®å°‘å‡ ä¹ä¸å¯èƒ½ç”¨åˆ°æº¢å‡ºæ¡¶ï¼› å½“ B \u003e= 4 çš„æ—¶å€™ï¼Œä¼šé¢å¤–åˆ›å»º 2^(Bâˆ’4) ä¸ªæº¢å‡ºæ¡¶ã€‚ ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:12:0","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"æŸ¥æ‰¾key keyç»è¿‡å“ˆå¸Œåå¾—åˆ°64ä½å“ˆå¸Œå€¼ ç”¨å“ˆå¸Œå€¼æœ€åBä¸ªbitä½è®¡ç®—å®ƒè½åœ¨å“ªä¸ªæ¡¶ ç”¨å“ˆå¸Œå€¼é«˜8ä½è®¡ç®—å®ƒåœ¨æ¡¶ä¸­çš„ç´¢å¼•ä½ç½®ã€‚ ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:13:0","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"å“ˆå¸Œå‡½æ•° åœ¨åˆå§‹åŒ–goç¨‹åºç¯å¢ƒ(src/runtime/proc.goä¸­çš„schedinit)ï¼Œéœ€è¦é€šè¿‡alginitæ–¹æ³•å®Œæˆå¯¹å“ˆå¸Œçš„åˆå§‹åŒ–ã€‚ maps must not be used before this call func alginit() { // Install AES hash algorithms if the instructions needed are present. if (GOARCH == \"386\" || GOARCH == \"amd64\") \u0026\u0026 cpu.X86.HasAES \u0026\u0026 // AESENC cpu.X86.HasSSSE3 \u0026\u0026 // PSHUFB cpu.X86.HasSSE41 { // PINSR{D,Q} initAlgAES() return } if GOARCH == \"arm64\" \u0026\u0026 cpu.ARM64.HasAES { initAlgAES() return } getRandomData((*[len(hashkey) * sys.PtrSize]byte)(unsafe.Pointer(\u0026hashkey))[:]) hashkey[0] |= 1 // make sure these numbers are odd hashkey[1] |= 1 hashkey[2] |= 1 hashkey[3] |= 1 } å¯¹äºå“ˆå¸Œç®—æ³•çš„é€‰æ‹©ï¼Œç¨‹åºä¼šæ ¹æ®å½“å‰æ¶æ„åˆ¤æ–­æ˜¯å¦æ”¯æŒAES hashï¼Œä»£ç å®ç°ä½äº`src/runtime/asm_{386,amd64,arm64}.sä¸­ï¼› å¦‚æœä¸æ”¯æŒï¼Œå…¶hashå‡½æ•°åˆ™æ ¹æ®xxhashç®—æ³•ï¼ˆhttps://code.google.com/p/xxhash/ï¼‰å’Œcityhashç®—æ³•ï¼ˆhttps://code.google.com/p/cityhash/ï¼‰å¯å‘è€Œæ¥ï¼Œ ä»£ç åˆ†åˆ«å¯¹åº”äº32ä½ï¼ˆsrc/runtime/hash32.goï¼‰å’Œ64ä½æœºå™¨ï¼ˆsrc/runtime/hash32.goï¼‰ä¸­ ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:13:1","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"tophash æ¡¶æ•°Bï¼Œå¦‚æœB=5ï¼Œé‚£ä¹ˆæ¡¶çš„æ€»æ•°ä¸º2^5=32. ä¾‹å¦‚ï¼Œæœ‰ä¸€ä¸ªkeyç»è¿‡å“ˆå¸Œåï¼Œå¾—åˆ°çš„å“ˆå¸Œå€¼ä¸ºï¼š 10010111 | 000011110110110010001111001010100010010110010101010 â”‚ 01010 å–æœ€å5ä¸ªbitä½ï¼Œä¹Ÿå°±æ˜¯01010ï¼Œå€¼ä¸º10ï¼Œå®šä½åˆ°10å·æ¡¶ã€‚ å†ç”¨å“ˆå¸Œå€¼çš„é«˜8ä½ï¼Œæ‰¾åˆ°æ­¤keyåœ¨å½“å‰æ¡¶ï¼ˆ10å·æ¡¶ï¼‰ä¸­çš„ç´¢å¼•ä½ç½®ã€‚å¦‚æœæ¡¶ä¸­æ²¡æœ‰keyï¼Œæ–°åŠ å…¥çš„keyä¼šæ”¾å…¥ç¬¬ä¸€ä¸ªç©ºä½ // tophash calculates the tophash value for hash. func tophash(hash uintptr) uint8 { top := uint8(hash \u003e\u003e (sys.PtrSize*8 - 8)) if top \u003c minTopHash { top += minTopHash } return top } å½“ä¸¤ä¸ªä¸åŒçš„keyè½åœ¨äº†åŒä¸€ä¸ªæ¡¶ä¸­æ—¶ï¼Œè¿™æ—¶å°±å‘ç”Ÿäº†å“ˆå¸Œå†²çªã€‚ goé‡‡ç”¨é“¾åœ°å€æ³•ï¼šåœ¨æ¡¶ä¸­æŒ‰ç…§é¡ºåºå¯»åˆ°ç¬¬ä¸€ä¸ªç©ºä½å¹¶è®°å½•ä¸‹æ¥ï¼Œåç»­åœ¨è¯¥æ¡¶å’Œå®ƒçš„æº¢å‡ºæ¡¶ä¸­å‡ä¸ºå‘ç°å­˜åœ¨çš„è¯¥keyï¼Œå°†keyç½®äºç¬¬ä¸€ä¸ªç©ºä½ï¼›å¦åˆ™ï¼Œå»è¯¥æ¡¶çš„æº¢å‡ºæ¡¶ä¸­å¯»æ‰¾ç©ºä½ï¼Œå¦‚æœæ²¡æœ‰æº¢å‡ºæ¡¶ï¼Œæ·»åŠ æº¢å‡ºæ¡¶ï¼Œå¹¶å°†å…¶ç½®äºæº¢å‡ºæ¡¶çš„ç¬¬ä¸€ä¸ªç©ºä½. ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:13:2","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"æŸ¥æ‰¾æ“ä½œ v:=m[k],å¯¹åº”çš„æ˜¯mapaccess1æ–¹æ³• v,ok:=m[k]ï¼Œå¯¹åº”çš„æ˜¯mapaccess2æ–¹æ³• mapaccess2å’Œmapaccess1çš„æ–¹æ³•é€»è¾‘ç›¸åŒï¼Œåªæ˜¯å¤šè¿”å›äº†boolè¿”å›å€¼ã€‚ mapaccessKæ˜¯for rangeçš„é€»è¾‘ï¼Œè¿”å›äº†keyå’Œvalueï¼Œä»£ç é€»è¾‘ä¹Ÿæ˜¯ä¸€æ ·ã€‚ æˆ‘ä»¬æ¥çœ‹çœ‹mapaccess1å‡½æ•°ï¼š func mapaccess1(t *maptype, h *hmap, key unsafe.Pointer) unsafe.Pointer { // å¦‚æœmapä¸ºç©ºæˆ–å…ƒç´ ä¸ªæ•°ä¸º0ï¼Œè¿”å›é›¶å€¼ if h == nil || h.count == 0 { if t.hashMightPanic() { t.hasher(key, 0) // see issue 23734 } return unsafe.Pointer(\u0026zeroVal[0]) } // å¦‚æœflagä¸ºhashWritingï¼Œåˆ™æŠ¥é”™ï¼Œè¡¨ç¤ºmapä¸æ˜¯å¹¶å‘å®‰å…¨çš„ if h.flags\u0026hashWriting != 0 { throw(\"concurrent map read and map write\") } // ä¸åŒç±»å‹çš„keyï¼Œä¼šä½¿ç”¨ä¸åŒçš„hashç®—æ³•ï¼Œåœ¨alg.goä¸­çš„typehashçš„é€»è¾‘ hash := t.hasher(key, uintptr(h.hash0)) m := bucketMask(h.B) // æŒ‰ä½ä¸æ“ä½œï¼Œæ‰¾åˆ°å¯¹åº”çš„bucket b := (*bmap)(add(h.buckets, (hash\u0026m)*uintptr(t.bucketsize))) // å¦‚æœoldbucketsä¸ä¸ºç©ºï¼Œé‚£ä¹ˆè¯æ˜mapå‘ç”Ÿäº†æ‰©å®¹ // å¦‚æœæœ‰æ‰©å®¹å‘ç”Ÿï¼Œè€çš„bucketsä¸­çš„æ•°æ®å¯èƒ½è¿˜æœªæ¬è¿åˆ°æ–°çš„bucketä¸­ // æ‰€ä»¥è¦å…ˆåœ¨è€çš„bucketä¸­æŸ¥æ‰¾ if c := h.oldbuckets; c != nil { if !h.sameSizeGrow() { // There used to be half as many buckets; mask down one more power of two. m \u003e\u003e= 1 } oldb := (*bmap)(add(c, (hash\u0026m)*uintptr(t.bucketsize))) // å¦‚æœåœ¨oldbucketsä¸­çš„tophash[0]çš„å€¼ï¼Œä¸ºevacuatedXï¼ŒevacuatedYï¼ŒevacuatedEmptyå…¶ä¸­ä¹‹ä¸€ // åˆ™evacuated()è¿”å›ä¸ºtrueï¼Œä»£è¡¨æ¬è¿å®Œæˆ // å› æ­¤ï¼Œåªæœ‰å½“æ¬è¿æœªå®Œæˆæ—¶ï¼Œæœªå®Œæˆæ—¶ï¼Œæ‰ä¼šä»æ­¤oldbucketsä¸­éå† if !evacuated(oldb) { b = oldb } } // å–å‡ºå½“å‰keyçš„tophashå€¼ top := tophash(hash) // ä»¥ä¸‹æ˜¯æŸ¥æ‰¾çš„æ ¸å¿ƒé€»è¾‘ // åŒé‡å¾ªç¯éå†ï¼šå¤–å±‚å¾ªç¯æ˜¯ä»æ¡¶åˆ°æº¢å‡ºæ¡¶éå†ï¼›å†…å±‚æ˜¯æ¡¶ä¸­çš„celléå† // è·³å‡ºå¾ªç¯çš„æ¡ä»¶æœ‰ä¸‰ç§ï¼šç¬¬ä¸€ç§æ˜¯æ‰¾åˆ°keyå€¼ï¼›ç¬¬äºŒç§æ˜¯å½“å‰æ¡¶æ— æº¢å‡ºæ¡¶ï¼›ç¬¬ä¸‰ç§æ˜¯å½“å‰æ¡¶ä¸­æœ‰cellä½çš„tophash=emptyRestï¼Œä»£è¡¨æ¡¶è¿˜æœªä½¿ç”¨ï¼Œæ— éœ€éå† bucketloop: for ; b != nil; b = b.overflow(t) { for i := uintptr(0); i \u003c bucketCnt; i++ { // åˆ¤æ–­tophashæ˜¯å¦ç›¸ç­‰ if b.tophash[i] != top { if b.tophash[i] == emptyRest { break bucketloop } continue } // å› ä¸ºåœ¨bucketä¸­çš„keyä½¿ç”¨è¿ç»­çš„å­˜å‚¨ç©ºé—´å­˜å‚¨ï¼Œå› æ­¤å¯ä»¥é€šè¿‡bucket+æ•°æ®åç§»é‡ï¼ˆbmapç»“æ„ä½“å¤§å°ï¼‰+keysizeçš„å¤§å°å¾—åˆ°kçš„å¤§å° // åŒç†ï¼Œvalueçš„åœ°å€ä¹Ÿæ˜¯ç›¸ä¼¼çš„ç®—æ³•ï¼Œåªæ˜¯è¦åŠ ä¸Š8ä¸ªkeysizeçš„å†…å­˜åœ°å€ k := add(unsafe.Pointer(b), dataOffset+i*uintptr(t.keysize)) if t.indirectkey() { k = *((*unsafe.Pointer)(k)) } if t.key.equal(key, k) { e := add(unsafe.Pointer(b), dataOffset+bucketCnt*uintptr(t.keysize)+i*uintptr(t.elemsize)) if t.indirectelem() { e = *((*unsafe.Pointer)(e)) } return e } } } return unsafe.Pointer(\u0026zeroVal[0]) } è¿™é‡Œæä¸€ä¸‹å®šä½keyå’Œvalueçš„æ–¹æ³•ï¼š // keyçš„å®šä½å…¬å¼ k := add(unsafe.Pointer(b), dataOffset+i*uintptr(t.keysize)) // valueçš„å®šä½å…¬å¼ e := add(unsafe.Pointer(b), dataOffset+bucketCnt*uintptr(t.keysize)+i*uintptr(t.elemsize)) ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:13:3","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"æ’å…¥key æ’å…¥keyçš„è¿‡ç¨‹å’ŒæŸ¥æ‰¾keyçš„è¿‡ç¨‹å¤§ä½“ä¸€è‡´ã€‚ // Like mapaccess, but allocates a slot for the key if it is not present in the map. func mapassign(t *maptype, h *hmap, key unsafe.Pointer) unsafe.Pointer { if h == nil { panic(plainError(\"assignment to entry in nil map\")) } // å¦‚æœæœ‰å…¶ä»–goroutineæ­£åœ¨å†™mapï¼Œä¼šæŠ›é”™ if h.flags\u0026hashWriting != 0 { throw(\"concurrent map writes\") } // é€šè¿‡keyå’Œå“ˆå¸Œç§å­ï¼Œè®¡ç®—å“ˆå¸Œå€¼ hash := t.hasher(key, uintptr(h.hash0)) // Set hashWriting after calling t.hasher, since t.hasher may panic, // in which case we have not actually done a write. // è®¾ç½®å†™æ ‡è¯†ä½ h.flags ^= hashWriting if h.buckets == nil { h.buckets = newobject(t.bucket) // newarray(t.bucket, 1) } again: // é€šè¿‡hashä¸bucketMaskæŒ‰ä½ä¸æ“ä½œï¼Œè¿”å›åœ¨bucketsæ•°ç»„çš„ç¬¬å‡ å·æ¡¶ bucket := hash \u0026 bucketMask(h.B) // å¦‚æœmapæ­£åœ¨æ¬è¿ï¼ˆå³m.oldbuckets!=nilï¼‰ä¸­ï¼Œåˆ™å…ˆè¿›è¡Œæ¬è¿å·¥ä½œ if h.growing() { growWork(t, h, bucket) } // è®¡ç®—å‡ºä¸Šé¢æ±‚å‡ºçš„ç¬¬å‡ å·æ¡¶çš„å†…å­˜ä½ç½® b := (*bmap)(unsafe.Pointer(uintptr(h.buckets) + bucket*uintptr(t.bucketsize))) top := tophash(hash) var inserti *uint8 var insertk unsafe.Pointer var elem unsafe.Pointer bucketloop: for { // éå†æ¡¶ä¸­çš„8ä¸ªcell for i := uintptr(0); i \u003c bucketCnt; i++ { // è¿™é‡Œåˆ†ä¸ºä¸¤ç§æƒ…å†µ // ç¬¬ä¸€ç§æ˜¯cellä½çš„tophashå€¼å’Œå½“å‰tophashå€¼ä¸ç›¸ç­‰ï¼Œåœ¨b.tophash[i] != topçš„æƒ…å†µä¸‹ // ç†è®ºä¸Šä¼šæœ‰ä¸€ä¸ªç©ºæ§½ä½ï¼Œä¸€èˆ¬æƒ…å†µä¸‹mapçš„æ§½ä½åˆ†å¸ƒæ˜¯è¿™æ ·çš„ï¼Œeè¡¨ç¤ºempty // [h0][h1][h2][h3][h4][e][e][e] // ä½†æ‰§è¡Œè¿‡deleteæ“ä½œåï¼Œå¯èƒ½å˜æˆè¿™æ · // [h0][h1][e][e][h5][e][e][e] // æ‰€ä»¥å¦‚æœåé¢å†æ’å…¥çš„è¯ï¼Œä¼šå°½é‡å¾€å‰é¢çš„ä½ç½®æ’ // åœ¨å¾ªç¯çš„æ—¶å€™è¿˜è¦é¡ºä¾¿æŠŠå‰é¢çš„ç©ºä½ç½®å…ˆè®°ä¸‹æ¥ï¼Œå› ä¸ºæœ‰å¯èƒ½åœ¨åé¢æ‰¾åˆ°ç›¸ç­‰çš„key if b.tophash[i] != top { // å¦‚æœcellä½ä¸ºç©ºï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨å¯¹åº”ä½ç½®è¿›è¡Œæ’å…¥ if isEmpty(b.tophash[i]) \u0026\u0026 inserti == nil { // èµ‹å€¼å½“å‰hashçš„é«˜8ä½ï¼Œæ ‡è®°å†™å…¥æˆåŠŸ inserti = \u0026b.tophash[i] insertk = add(unsafe.Pointer(b), dataOffset+i*uintptr(t.keysize)) elem = add(unsafe.Pointer(b), dataOffset+bucketCnt*uintptr(t.keysize)+i*uintptr(t.elemsize)) } if b.tophash[i] == emptyRest { break bucketloop } continue } // ç¬¬äºŒç§æƒ…å†µæ˜¯cellä½çš„tophashå€¼å’Œå½“å‰tophashå€¼ç›¸ç­‰ k := add(unsafe.Pointer(b), dataOffset+i*uintptr(t.keysize)) if t.indirectkey() { k = *((*unsafe.Pointer)(k)) } // å³æ—¶å½“å‰cellä½çš„tophashå€¼ç›¸ç­‰ï¼Œä¸ä»£è¡¨å®ƒå¯¹åº”çš„keyå€¼ä¹Ÿæ˜¯ç›¸ç­‰çš„ï¼Œæ‰€ä»¥è¿˜è¦åškeyå€¼çš„åˆ¤æ–­ if !t.key.equal(key, k) { continue } // already have a mapping for key. Update it. // å¦‚æœå·²ç»æœ‰è¯¥keyäº†ï¼Œå°±æ›´æ–°å®ƒ if t.needkeyupdate() { typedmemmove(t.key, k, key) } // è¿™é‡Œè·å–åˆ°äº†è¦æ’å…¥keyå¯¹åº”çš„valueçš„å†…å­˜åœ°å€ // pos = start + dataOffset + 8*keysize + i * elemsize elem = add(unsafe.Pointer(b), dataOffset+bucketCnt*uintptr(t.keysize)+i*uintptr(t.elemsize)) goto done } // æ­£å¸¸æ¡¶çš„bmapéå†å®Œäº†ï¼Œç»§ç»­éå†æº¢å‡ºæ¡¶çš„bmapï¼Œå¦‚æœæœ‰çš„è¯ ovf := b.overflow(t) if ovf == nil { break } b = ovf } // åœ¨å·²æœ‰çš„æ¡¶å’Œæº¢å‡ºæ¡¶ä¸­éƒ½æœªæ‰¾åˆ°åˆé€‚çš„cellä¾›keyå†™å…¥ï¼Œé‚£ä¹ˆæœ‰å¯èƒ½ä¼šè§¦å‘ä»¥ä¸‹ä¸¤ç§æƒ…å†µ // 1ã€åˆ¤æ–­å½“å‰mapçš„è£…è½½å› å­æ˜¯å¦è¾¾åˆ°è®¾å®šçš„6.5é˜ˆå€¼ï¼Œæˆ–è€…å½“å‰mapçš„æº¢å‡ºæ¡¶æ•°é‡æ˜¯å¦è¿‡å¤šï¼Œå¦‚æœå­˜åœ¨è¿™ä¸¤ç§æƒ…å†µï¼Œè¿›è¡Œæ‰©å®¹æ“ä½œã€‚ // hashGrow()å®é™…å¹¶æœªå®Œæˆæ‰©å®¹ï¼Œå¯¹å“ˆå¸Œè¡¨æ•°æ®çš„æ¬è¿(å¤åˆ¶)æ“ä½œæ˜¯é€šè¿‡growWork()æ¥å®Œæˆçš„ // é‡æ–°è¿›å…¥againé€»è¾‘ï¼Œåœ¨å®ŒæˆgrowWork()æ“ä½œåï¼Œå†æ¬¡éå†æ–°çš„æ¡¶ // Did not find mapping for key. Allocate new cell \u0026 add entry. // If we hit the max load factor or we have too many overflow buckets, // and we're not already in the middle of growing, start growing. if !h.growing() \u0026\u0026 (overLoadFactor(h.count+1, h.B) || tooManyOverflowBuckets(h.noverflow, h.B)) { hashGrow(t, h) goto again // Growing the table invalidates everything, so try again } // 2ã€ä¸ºå½“å‰æ¡¶æ–°å»ºæ–°çš„æº¢å‡ºæ¡¶ï¼Œå¹¶å°†tophashï¼Œkeyæ’å…¥åˆ°æ–°å»ºæº¢å‡ºæ¡¶çš„å¯¹åº”å†…å­˜çš„0å·ä½ç½® if inserti == nil { // all current buckets are full, allocate a new one. // åˆ†é…æ–°çš„bmapå†™ newb := h.newoverflow(t, b) inserti = \u0026newb.tophash[0] insertk = add(unsafe.Pointer(newb), dataOffset) elem = add(insertk, bucketCnt*uintptr(t.keysize)) } // store new key/elem at insert position // åœ¨æ’å…¥ä½ç½®å­˜å…¥æ–°çš„keyå’Œvalue if t.indirectkey() { kmem := newobject(t.key) *(*unsafe.Pointer)(insertk) = kmem insertk = kmem } if t.indirectelem() { vmem := newobject(t.elem) *(*unsafe.Pointer)(elem) = vmem } typedmemmove(t.key, insertk, key) *inserti = top // mapä¸­çš„key+1 h.count++ done: if h.flags\u0026hashWriting == 0 { throw(\"concurrent map writes\") } h.flags \u0026^= hashWriting if t.indirectelem() { elem = *((*unsafe.Pointer)(elem)) } return elem } æ’å…¥keyå’ŒæŸ¥æ‰¾keyæœ‰å‡ ç‚¹ä¸åŒï¼š å¦‚æœæ‰¾åˆ°å¾…æ’å…¥çš„keyï¼Œåˆ™ç›´æ¥æ›´æ–°å¯¹åº”çš„valueå€¼ ä¼šåœ¨oldbucketä¸­æŸ¥æ‰¾keyï¼Œä½†ä¸ä¼šå†oldbucketä¸­æ’å…¥key å¦‚æœåœ¨bmapä¸­æ²¡æœ‰æ‰¾åˆ°å¾…æ’å…¥çš„key æƒ…å†µä¸€ï¼šbmapä¸­è¿˜æœ‰ç©ºä½ï¼Œåœ¨éå†bmapçš„æ—¶å€™é¢„å…ˆæ ‡è®°å¯æ’å…¥çš„ç©ºä½ï¼Œå¦‚æœæŸ¥æ‰¾ç»“æŸåä¹Ÿæ²¡æœ‰æ‰¾åˆ°keyï¼Œå°±æŠŠkeyæ”¾åœ¨é¢„å…ˆæ ‡è®°çš„ç©ºä½ä¸Š æƒ…å†µäºŒï¼šbmapä¸­æ²¡æœ‰ç©ºä½äº†ï¼Œæ­¤æ—¶æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦è¾¾åˆ°äº†æœ€å¤§è£…è½½å› å­ã€‚å¦‚æœè¾¾åˆ°äº†ï¼Œç«‹å³è¿›è¡Œæ‰©å®¹æ“ä½œã€‚æ‰©å®¹ååœ¨æ–°æ¡¶ä¸­æ’å…¥keyï¼Œå¦‚æœæ²¡æœ‰è¾¾åˆ°æœ€å¤§è£…è½½å› å­ï¼Œåˆ™æ–°ç”Ÿæˆä¸€ä¸ªbmapï¼Œå¹¶ä¸”æŠŠå‰ä¸€ä¸ªbmapçš„overflowæŒ‡é’ˆæŒ‡å‘æ–°çš„bmapã€‚ ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:14:0","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"åˆ é™¤key func mapdelete(t *maptype, h *hmap, key unsafe.Pointer) { if h == nil || h.count == 0 { if t.hashMightPanic() { t.hasher(key, 0) // see issue 23734 } return } if h.flags\u0026hashWriting != 0 { throw(\"concurrent map writes\") } // è®¡ç®—keyçš„å“ˆå¸Œå€¼ hash := t.hasher(key, uintptr(h.hash0)) // Set hashWriting after calling t.hasher, since t.hasher may panic, // in which case we have not actually done a write (delete). h.flags ^= hashWriting bucket := hash \u0026 bucketMask(h.B) // å¦‚æœåœ¨æ‰©å®¹ä¸­ï¼Œç»§ç»­æ‰©å®¹ if h.growing() { growWork(t, h, bucket) } // æ‰¾åˆ°æ¡¶çš„ä½ç½® b := (*bmap)(add(h.buckets, bucket*uintptr(t.bucketsize))) bOrig := b top := tophash(hash) search: for ; b != nil; b = b.overflow(t) { // éå†æ¡¶ for i := uintptr(0); i \u003c bucketCnt; i++ { if b.tophash[i] != top { if b.tophash[i] == emptyRest { break search } continue } k := add(unsafe.Pointer(b), dataOffset+i*uintptr(t.keysize)) k2 := k if t.indirectkey() { k2 = *((*unsafe.Pointer)(k2)) } if !t.key.equal(key, k2) { continue } // Only clear key if there are pointers in it. // æ‰¾åˆ°äº†keyï¼Œå¼€å§‹æ¸…é™¤keyå’Œå¯¹åº”çš„value if t.indirectkey() { // å¦‚æœæŒ‡å‘çš„æ˜¯æŒ‡é’ˆï¼Œåˆ™æŒ‡é’ˆç½®nil *(*unsafe.Pointer)(k) = nil } else if t.key.ptrdata != 0 { // æ¸…é™¤keyçš„å†…å­˜ memclrHasPointers(k, t.key.size) } // æ¸…é™¤value e := add(unsafe.Pointer(b), dataOffset+bucketCnt*uintptr(t.keysize)+i*uintptr(t.elemsize)) if t.indirectelem() { *(*unsafe.Pointer)(e) = nil } else if t.elem.ptrdata != 0 { memclrHasPointers(e, t.elem.size) } else { memclrNoHeapPointers(e, t.elem.size) } // æ ‡è®°å½“å‰æ¡¶çš„å½“å‰æ§½ä½ä¸ºç©º b.tophash[i] = emptyOne // If the bucket now ends in a bunch of emptyOne states, // change those to emptyRest states. // It would be nice to make this a separate function, but // for loops are not currently inlineable. if i == bucketCnt-1 { if b.overflow(t) != nil \u0026\u0026 b.overflow(t).tophash[0] != emptyRest { goto notLast } } else { if b.tophash[i+1] != emptyRest { goto notLast } } for { b.tophash[i] = emptyRest if i == 0 { if b == bOrig { break // beginning of initial bucket, we're done. } // Find previous bucket, continue at its last entry. c := b for b = bOrig; b.overflow(t) != c; b = b.overflow(t) { } i = bucketCnt - 1 } else { i-- } if b.tophash[i] != emptyOne { break } } notLast: h.count-- break search } } if h.flags\u0026hashWriting == 0 { throw(\"concurrent map writes\") } h.flags \u0026^= hashWriting } åˆ é™¤keyçš„æµç¨‹å’ŒæŸ¥æ‰¾keyçš„æµç¨‹å·®ä¸å¤šï¼š æ‰¾åˆ°å¯¹åº”çš„keyåï¼Œæ¸…é™¤å¯¹åº”çš„keyå’Œvalueã€‚å¦‚æœæ˜¯æŒ‡é’ˆç±»å‹ï¼Œå°±æŠŠæŒ‡é’ˆç½®ä¸ºnilï¼Œå¦‚æœæ˜¯å€¼å°±æ¸…ç©ºå€¼å¯¹åº”çš„å†…å­˜ã€‚ æ¸…é™¤tophashé‡Œçš„å€¼ï¼Œå¹¶åšä¸€äº›æ ‡è®° æŠŠhmapçš„è®¡æ•°å™¨å‡1 å¦‚æœæ˜¯åœ¨æ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œä¼šåœ¨æ‰©å®¹å®Œæˆååœ¨æ–°çš„bmapä¸­æ‰§è¡Œåˆ é™¤æ“ä½œ ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:15:0","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"æ‰©å®¹ ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:16:0","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"ä¸ºä»€ä¹ˆè¦æ‰©å®¹ï¼Ÿ å› ä¸ºï¼Œéšç€ Map ä¸­æ·»åŠ çš„ key è¶Šæ¥è¶Šå¤šï¼Œkey å‘ç”Ÿå“ˆå¸Œå†²çªçš„æ¦‚ç‡ä¹Ÿè¶Šæ¥è¶Šå¤§ã€‚æ¡¶ä¸­çš„ 8 ä¸ªæ§½ä½ä¼šè¢«é€æ¸å¡æ»¡ï¼ŒæŸ¥æ‰¾ã€æ’å…¥ã€åˆ é™¤ key çš„æ•ˆç‡ä¹Ÿä¼šè¶Šæ¥è¶Šä½ï¼Œå› æ­¤éœ€è¦åœ¨ Map è¾¾åˆ°ä¸€å®šè£…è½½ç‡åè¿›è¡Œæ‰©å®¹ï¼Œä¿è¯ Map çš„è¯»å†™æ€§èƒ½ã€‚ Golang è¡¡é‡è£…è½½ç‡çš„æŒ‡æ ‡æ˜¯è£…è½½å› å­ï¼Œå®ƒçš„è®¡ç®—æ–¹å¼æ˜¯ï¼š loadFactor := count / (2^B) å…¶ä¸­ï¼š count è¡¨ç¤º Map ä¸­çš„å…ƒç´ ä¸ªæ•° 2^B è¡¨ç¤ºæ¡¶æ•°é‡ æ‰€ä»¥è£…è½½å› å­ loadFactor çš„å«ä¹‰æ˜¯å¹³å‡æ¯ä¸ªæ¡¶è£…è½½çš„å…ƒç´ ä¸ªæ•°ã€‚Golang å®šä¹‰çš„è£…è½½å› å­é˜ˆå€¼æ˜¯ 6.5ã€‚ ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:16:1","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"ä»€ä¹ˆæ—¶å€™æ‰©å®¹ï¼Ÿ æ’å…¥ key æ—¶ä¼šåœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µè§¦å‘å“ˆå¸Œçš„æ‰©å®¹ï¼š è£…è½½å› å­è¶…è¿‡ 6.5ï¼Œå¢é‡æ‰©å®¹ï¼› ä½¿ç”¨äº†å¤ªå¤šæº¢å‡ºæ¡¶ï¼Œç­‰é‡æ‰©å®¹ï¼› æƒ…å†µ 2 ä¸­ï¼Œæº¢å‡ºæ¡¶å¤ªå¤šçš„åˆ¤å®šæ ‡å‡†æ˜¯ï¼š B \u003c 15 æ—¶ï¼Œæº¢å‡ºæ¡¶æ•°é‡ \u003e= 2^B B \u003e= 15 æ—¶ï¼Œæº¢å‡ºæ¡¶æ•°é‡ \u003e= 2^15 // mapassignä¸­è§¦å‘æ‰©å®¹çš„æ—¶æœº if !h.growing() \u0026\u0026 (overLoadFactor(h.count+1, h.B) || tooManyOverflowBuckets(h.noverflow, h.B)) { hashGrow(t, h) goto again // Growing the table invalidates everything, so try again } // overLoadFactor reports whether count items placed in 1\u003c\u003cB buckets is over loadFactor. // è¾¾åˆ°è£…è½½å› å­çš„ä¸´ç•Œç‚¹ func overLoadFactor(count int, B uint8) bool { return count \u003e bucketCnt \u0026\u0026 uintptr(count) \u003e loadFactorNum*(bucketShift(B)/loadFactorDen) } // tooManyOverflowBuckets reports whether noverflow buckets is too many for a map with 1\u003c\u003cB buckets. // Note that most of these overflow buckets must be in sparse use; // if use was dense, then we'd have already triggered regular map growth. // åˆ¤æ–­æº¢å‡ºæ¡¶æ˜¯å¦å¤ªå¤šã€‚ // å½“æ¡¶æ€»æ•°\u003c2^15æ—¶ï¼Œå¦‚æœæº¢å‡ºæ¡¶\u003e=æ¡¶æ€»æ•°ï¼Œåˆ™è®¤ä¸ºæº¢å‡ºæ¡¶è¿‡å¤šã€‚ // å½“æ¡¶æ€»æ•°\u003e2^15æ—¶ï¼Œå½“æº¢å‡ºæ¡¶\u003e=2^15ï¼Œåˆ™è®¤ä¸ºæº¢å‡ºæ¡¶è¿‡å¤š func tooManyOverflowBuckets(noverflow uint16, B uint8) bool { // If the threshold is too low, we do extraneous work. // If the threshold is too high, maps that grow and shrink can hold on to lots of unused memory. // \"too many\" means (approximately) as many overflow buckets as regular buckets. // See incrnoverflow for more details. if B \u003e 15 { B = 15 } // The compiler doesn't see here that B \u003c 16; mask B to generate shorter shift code. return noverflow \u003e= uint16(1)\u003c\u003c(B\u002615) } ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:16:2","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"ä»€ä¹ˆæ—¶å€™é‡‡ç”¨å¢é‡æ‰©å®¹ç­–ç•¥ï¼Ÿ è§¦å‘æ‰©å®¹çš„ç¬¬ä¸€ç§æƒ…å†µï¼Œéšç€mapä¸­ä¸æ–­æ’å…¥æ–°çš„å…ƒç´ ï¼Œè£…è½½å› å­ä¸æ–­å‡é«˜ç›´è‡³è¶…è¿‡6.5ï¼Œè¿™æ—¶éœ€è¦å¢é‡æ‰©å®¹ã€‚ å¢é‡æ‰©å®¹åï¼Œåˆ†é…çš„æ–°æ¡¶æ•°é‡æ˜¯æ—§æ¡¶çš„2å€ ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:16:3","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"ä»€ä¹ˆæ—¶å€™é‡‡ç”¨ç­‰é‡æ‰©å®¹ç­–ç•¥ï¼Ÿ è§¦å‘æ‰©å®¹çš„ç¬¬äºŒç§æƒ…å†µï¼Œåœ¨è£…è½½å› å­å¾ˆå°çš„æƒ…å†µï¼Œmapçš„è¯»å†™æ•ˆç‡ä¹Ÿå¾ˆä½ã€‚è¿™ç§æƒ…å†µä¸‹mapä¸­çš„å…ƒç´ å°‘ï¼Œä½†æ˜¯æº¢å‡ºæ¡¶å¤šã€‚ å¯èƒ½é€ æˆè¿™ç§æƒ…å†µçš„åŸå› æ˜¯ï¼šä¸æ–­æ’å…¥å…ƒç´ ï¼Œä¸æ–­åˆ é™¤å…ƒç´ ã€‚ ç­‰é‡æ‰©å®¹åï¼Œåˆ†é…çš„æ–°æ¡¶æ•°é‡å’Œæ—§æ¡¶æ•°é‡ç›¸åŒï¼Œä½†æ–°æ¡¶ä¸­å­˜å‚¨çš„æ•°æ®æ›´åŠ ç´§å¯†ã€‚ æ‰©å®¹çš„ç›¸å…³æ–¹æ³•æ˜¯hashGrow()ï¼Œä½†å®ƒåªæ˜¯åˆ†é…äº†æ–°æ¡¶ï¼Œå¹¶æ²¡æœ‰çœŸæ­£è¿ç§»æ•°æ® // æ²¡æœ‰çœŸæ­£æ¬è¿ï¼Œåªæ˜¯åˆ†é…å¥½æ–°çš„bucketsï¼Œå¹¶å°†è€çš„bucketsæŒ‚åˆ°oldbucketså­—æ®µä¸Š func hashGrow(t *maptype, h *hmap) { // If we've hit the load factor, get bigger. // Otherwise, there are too many overflow buckets, // so keep the same number of buckets and \"grow\" laterally. // çœ‹æ‰©å®¹ç±»å‹ bigger := uint8(1) if !overLoadFactor(h.count+1, h.B) { bigger = 0 h.flags |= sameSizeGrow } // è®°å½•è€çš„buckets oldbuckets := h.buckets // ç”³è¯·æ–°çš„bucketsç©ºé—´ newbuckets, nextOverflow := makeBucketArray(t, h.B+bigger, nil) // è½¬ç§»æ ‡å¿—ä½ flags := h.flags \u0026^ (iterator | oldIterator) if h.flags\u0026iterator != 0 { flags |= oldIterator } // commit the grow (atomic wrt gc) // æäº¤grow h.B += bigger h.flags = flags h.oldbuckets = oldbuckets h.buckets = newbuckets // æ¬è¿è¿›åº¦ä¸º0 h.nevacuate = 0 // noverflow bucketsæ•°ä¸º0 h.noverflow = 0 // å¦‚æœå‘ç°hmapæ˜¯é€šè¿‡extraå­—æ®µæ¥å­˜å‚¨overflow bucketsæ—¶ if h.extra != nil \u0026\u0026 h.extra.overflow != nil { // Promote current overflow buckets to the old generation. if h.extra.oldoverflow != nil { throw(\"oldoverflow is not nil\") } h.extra.oldoverflow = h.extra.overflow h.extra.overflow = nil } if nextOverflow != nil { if h.extra == nil { h.extra = new(mapextra) } h.extra.nextOverflow = nextOverflow } // the actual copying of the hash table data is done incrementally // by growWork() and evacuate(). } ","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:16:4","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"è¿ç§» æ‰§è¡Œè¿ç§»å·¥ä½œçš„æ–¹æ³•growWork func growWork(t *maptype, h *hmap, bucket uintptr) { // make sure we evacuate the oldbucket corresponding // to the bucket we're about to use // ä¸ºäº†ç¡®è®¤æ¬è¿çš„bucketæ˜¯æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨çš„bucket // å³å¦‚æœå½“å‰keyæ˜ å°„åˆ°è€çš„bucketï¼Œé‚£ä¹ˆå°±æ¬è¿è¯¥bucket evacuate(t, h, bucket\u0026h.oldbucketmask()) // evacuate one more oldbucket to make progress on growing // å¦‚æœè¿˜æœªå®Œæˆæ‰©å®¹ if h.growing() { evacuate(t, h, h.nevacuate) } } è´Ÿè´£è¿ç§»æ•°æ®çš„æ–¹æ³•evacuate func evacuate(t *maptype, h *hmap, oldbucket uintptr) { // é¦–å…ˆå®šä½è€çš„bucketçš„åœ°å€ b := (*bmap)(add(h.oldbuckets, oldbucket*uintptr(t.bucketsize))) // newbit ä»£è¡¨æ‰©å®¹ä¹‹å‰è€çš„bucketä¸ªæ•° newbit := h.noldbuckets() // åˆ¤æ–­è¯¥bucketæ˜¯å¦å·²ç»è¢«æ¬è¿ if !evacuated(b) { // TODO: reuse overflow buckets instead of using new ones, if there // is no iterator using the old buckets. (If !oldIterator.) // xy contains the x and y (low and high) evacuation destinations. // xyåŒ…å«äº†é«˜ä½åŒºé—´çš„æ¬è¿ç›®çš„åœ°å†…å­˜ä¿¡æ¯ // x.b æ˜¯å¯¹åº”çš„æ¬è¿ç›®æ ‡æ¡¶ // x.k æ˜¯æŒ‡å‘å¯¹åº”çš„ç›®çš„æ¡¶ä¸­å­˜å‚¨å½“å‰keyçš„å†…å­˜åœ°å€ // x.e æ˜¯æŒ‡å‘å¯¹åº”çš„ç›®çš„æ¡¶ä¸­å­˜å‚¨å½“å‰valueçš„å†…å­˜åœ°å€ var xy [2]evacDst x := \u0026xy[0] x.b = (*bmap)(add(h.buckets, oldbucket*uintptr(t.bucketsize))) x.k = add(unsafe.Pointer(x.b), dataOffset) x.e = add(x.k, bucketCnt*uintptr(t.keysize)) // åªæœ‰å½“å¢é‡æ‰©å®¹æ—¶æ‰è®¡ç®—bucket yçš„ç›¸å…³ä¿¡æ¯ if !h.sameSizeGrow() { // Only calculate y pointers if we're growing bigger. // Otherwise GC can see bad pointers. y := \u0026xy[1] y.b = (*bmap)(add(h.buckets, (oldbucket+newbit)*uintptr(t.bucketsize))) y.k = add(unsafe.Pointer(y.b), dataOffset) y.e = add(y.k, bucketCnt*uintptr(t.keysize)) } // evacuate æ¯æ¬¡åªå®Œæˆä¸€ä¸ªbucketçš„æ¬è¿å·¥ä½œï¼Œå› æ­¤éœ€éå†å®Œæ­¤bucketçš„æ‰€æœ‰cellï¼Œå°†æœ‰å€¼çš„cell copyåˆ°æ–°çš„åœ°æ–¹ // bucketè¿˜ä¼šé“¾æ¥overflow bucketï¼ŒåŒæ ·éœ€è¦æ¬è¿ for ; b != nil; b = b.overflow(t) { k := add(unsafe.Pointer(b), dataOffset) e := add(k, bucketCnt*uintptr(t.keysize)) // i,k,eå¯¹åº”tophashï¼Œkeyå’Œvalue for i := 0; i \u003c bucketCnt; i, k, e = i+1, add(k, uintptr(t.keysize)), add(e, uintptr(t.elemsize)) { top := b.tophash[i] // å¦‚æœå½“å‰cellçš„tophashæ˜¯ emptyOne/emptyRest ï¼Œåˆ™ä»£è¡¨æ­¤cellæ²¡æœ‰keyï¼Œå°†å…¶ç½®ä¸º evacuatedEmpty ï¼Œè¡¨ç¤ºå·²ç»æ¬è¿ if isEmpty(top) { b.tophash[i] = evacuatedEmpty continue } if top \u003c minTopHash { throw(\"bad map state\") } k2 := k if t.indirectkey() { k2 = *((*unsafe.Pointer)(k2)) } var useY uint8 // å¦‚æœæ˜¯å¢é‡æ‰©å®¹ if !h.sameSizeGrow() { // Compute hash to make our evacuation decision (whether we need // to send this key/elem to bucket x or bucket y). // è®¡ç®—å“ˆå¸Œå€¼ï¼Œåˆ¤æ–­å½“å‰çš„keyå’Œvalueæ˜¯å¦éœ€è¦æ¬è¿åˆ°bucket x/y hash := t.hasher(k2, uintptr(h.hash0)) if h.flags\u0026iterator != 0 \u0026\u0026 !t.reflexivekey() \u0026\u0026 !t.key.equal(k2, k2) { // If key != key (NaNs), then the hash could be (and probably // will be) entirely different from the old hash. Moreover, // it isn't reproducible. Reproducibility is required in the // presence of iterators, as our evacuation decision must // match whatever decision the iterator made. // Fortunately, we have the freedom to send these keys either // way. Also, tophash is meaningless for these kinds of keys. // We let the low bit of tophash drive the evacuation decision. // We recompute a new random tophash for the next level so // these keys will get evenly distributed across all buckets // after multiple grows. // æœ‰ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼šæœ‰ä¸€ç§keyï¼Œæ¯æ¬¡å¯¹å®ƒçš„è®¡ç®—hashå¾—åˆ°çš„ç»“æœä¸ä¸€æ ·ã€‚ // è¿™ä¸ªkeyå°±æ˜¯ math.NaN() çš„ç»“æœï¼Œå®ƒçš„å«ä¹‰æ˜¯not a numberï¼Œç±»å‹æ˜¯float64 // æŠŠå®ƒå½“åšmapçš„keyæ—¶ï¼Œä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼šå†æ¬¡è®¡ç®—å®ƒçš„å“ˆå¸Œå€¼å’Œå®ƒåˆšæ’å…¥mapæ—¶è®¡ç®—çš„å“ˆå¸Œå€¼ä¸ä¸€æ · // è¿™ä¸ªkeyæ˜¯æ°¸è¿œä¸ä¼šè¢«Getæ“ä½œè·å–çš„ï¼Œå½“ä½¿ç”¨m[math.NaN()]è¯­å¥æ—¶ï¼Œæ˜¯æŸ¥ä¸å‡ºç»“æœçš„ï¼Œè¿™ä¸ªkeyåªæœ‰åœ¨éå†æ•´ä¸ªmapæ—¶ï¼Œæ‰èƒ½è¢«æ‰¾åˆ° // å¹¶ä¸”ï¼Œå¯ä»¥å‘ä¸€ä¸ª map æ’å…¥å¤šä¸ªæ•°é‡çš„ math.NaN() ä½œä¸º keyï¼Œå®ƒä»¬å¹¶ä¸ä¼šè¢«äº’ç›¸è¦†ç›–ã€‚ // å½“æ¬è¿ç¢°åˆ° math.NaN() çš„ key æ—¶ï¼Œåªé€šè¿‡ tophash çš„æœ€ä½ä½å†³å®šåˆ†é…åˆ° X part è¿˜æ˜¯ Y partï¼ˆå¦‚æœæ‰©å®¹åæ˜¯åŸæ¥ buckets æ•°é‡çš„ 2 å€ï¼‰ã€‚ // å¦‚æœ tophash çš„æœ€ä½ä½æ˜¯ 0 ï¼Œåˆ†é…åˆ° X partï¼›å¦‚æœæ˜¯ 1 ï¼Œåˆ™åˆ†é…åˆ° Y partã€‚ useY = top \u0026 1 top = tophash(hash) } else { if hash\u0026newbit != 0 { useY = 1 } } } if evacuatedX+1 != evacuatedY || evacuatedX^1 != evacuatedY { throw(\"bad evacuatedN\") } b.tophash[i] = evacuatedX + useY // evacuatedX + 1 == evacuatedY // useYè¦ä¹ˆä¸º0ï¼Œè¦ä¹ˆä¸º1ã€‚è¿™é‡Œå°±æ˜¯é€‰å–åœ¨bucket xçš„èµ·å§‹å†…å­˜ä½ç½®ï¼Œæˆ–è€…é€‰æ‹©åœ¨bucket yçš„èµ·å§‹å†…å­˜ä½ç½®ï¼ˆåªæœ‰å¢é‡åŒæ­¥æ‰ä¼šæœ‰è¿™ä¸ªé€‰æ‹©å¯èƒ½ï¼‰ã€‚ dst := \u0026xy[useY] // evacuation destination // å¦‚æœç›®çš„åœ°æ¡¶å·²ç»è£…æ»¡ï¼ˆ8ä¸ªcellï¼‰ï¼Œé‚£ä¹ˆéœ€è¦æ–°å»ºä¸€ä¸ªæº¢å‡ºæ¡¶ï¼Œç»§ç»­æ¬è¿åˆ°æº¢å‡ºæ¡¶ä¸Šå» if dst.i == bucketCnt { dst.b = h.newoverflow(t, dst.b) dst.i = 0 dst.k = add(unsafe.Pointer(dst.b), dataOffset) dst.e = add(dst.k, bucketCnt*uintptr(t.keysize)) } dst.b.tophash[dst","date":"2021-07-14","objectID":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/:16:5","tags":["æºç è§£æ","map"],"title":"æ·±å…¥ç†è§£Golang Map","uri":"/2021/07/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3map/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"ä¸€ã€ä»€ä¹ˆæ˜¯å¹‚ç­‰ï¼Ÿ å¹‚ç­‰ï¼ˆidempotentã€idempotenceï¼‰æ˜¯ä¸€ä¸ªæ•°å­¦ä¸è®¡ç®—æœºå­¦æ¦‚å¿µï¼Œå¸¸è§äºæŠ½è±¡ä»£æ•°ä¸­ã€‚ åœ¨ç¼–ç¨‹ä¸­ä¸€ä¸ªå¹‚ç­‰æ“ä½œçš„ç‰¹ç‚¹æ˜¯å…¶ä»»æ„å¤šæ¬¡æ‰§è¡Œæ‰€äº§ç”Ÿçš„å½±å“å‡ä¸ä¸€æ¬¡æ‰§è¡Œçš„å½±å“ç›¸åŒã€‚å¹‚ç­‰å‡½æ•°ï¼Œæˆ–å¹‚ç­‰æ–¹æ³•ï¼Œæ˜¯æŒ‡å¯ä»¥ä½¿ç”¨ç›¸åŒå‚æ•°é‡å¤æ‰§è¡Œï¼Œå¹¶èƒ½è·å¾—ç›¸åŒç»“æœçš„å‡½æ•°ã€‚è¿™äº›å‡½æ•°ä¸ä¼šå½±å“ç³»ç»ŸçŠ¶æ€ï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒé‡å¤æ‰§è¡Œä¼šå¯¹ç³»ç»Ÿé€ æˆæ”¹å˜ã€‚ä¾‹å¦‚ï¼Œâ€œsetTrue()â€å‡½æ•°å°±æ˜¯ä¸€ä¸ªå¹‚ç­‰å‡½æ•°,æ— è®ºå¤šæ¬¡æ‰§è¡Œï¼Œå…¶ç»“æœéƒ½æ˜¯ä¸€æ ·çš„.æ›´å¤æ‚çš„æ“ä½œå¹‚ç­‰ä¿è¯æ˜¯åˆ©ç”¨å”¯ä¸€äº¤æ˜“å·(æµæ°´å·)å®ç°ã€‚ å¹‚ç­‰æ€§ï¼šå°±æ˜¯ç”¨æˆ·å¯¹äºåŒä¸€æ“ä½œå‘èµ·çš„ä¸€æ¬¡è¯·æ±‚æˆ–è€…å¤šæ¬¡è¯·æ±‚çš„ç»“æœæ˜¯ä¸€è‡´çš„ï¼Œä¸ä¼šå› ä¸ºå¤šæ¬¡ç‚¹å‡»è€Œäº§ç”Ÿäº†å‰¯ä½œç”¨ã€‚ ","date":"2021-07-07","objectID":"/2021/07/%E5%B9%82%E7%AD%89%E6%80%A7/:1:0","tags":["api"],"title":"å¹‚ç­‰æ€§","uri":"/2021/07/%E5%B9%82%E7%AD%89%E6%80%A7/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"äºŒã€ä½¿ç”¨åœºæ™¯ ","date":"2021-07-07","objectID":"/2021/07/%E5%B9%82%E7%AD%89%E6%80%A7/:2:0","tags":["api"],"title":"å¹‚ç­‰æ€§","uri":"/2021/07/%E5%B9%82%E7%AD%89%E6%80%A7/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"1ã€å‰ç«¯é‡å¤æäº¤ ç”¨æˆ·æ³¨å†Œï¼Œç”¨æˆ·åˆ›å»ºå•†å“ç­‰æ“ä½œï¼Œå‰ç«¯éƒ½ä¼šæäº¤ä¸€äº›æ•°æ®ç»™åå°æœåŠ¡ï¼Œåå°éœ€è¦æ ¹æ®ç”¨æˆ·æäº¤çš„æ•°æ®åœ¨æ•°æ®åº“ä¸­åˆ›å»ºè®°å½•ã€‚å¦‚æœç”¨æˆ·ä¸å°å¿ƒå¤šç‚¹äº†å‡ æ¬¡ï¼Œåç«¯æ”¶åˆ°äº†å¥½å‡ æ¬¡æäº¤ï¼Œè¿™æ—¶å°±ä¼šåœ¨æ•°æ®åº“ä¸­é‡å¤åˆ›å»ºäº†å¤šæ¡è®°å½•ã€‚è¿™å°±æ˜¯æ¥å£æ²¡æœ‰å¹‚ç­‰æ€§å¸¦æ¥çš„ bugã€‚ ","date":"2021-07-07","objectID":"/2021/07/%E5%B9%82%E7%AD%89%E6%80%A7/:2:1","tags":["api"],"title":"å¹‚ç­‰æ€§","uri":"/2021/07/%E5%B9%82%E7%AD%89%E6%80%A7/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"2ã€æ¥å£è¶…æ—¶é‡è¯• å¯¹äºç»™ç¬¬ä¸‰æ–¹è°ƒç”¨çš„æ¥å£ï¼Œæœ‰å¯èƒ½ä¼šå› ä¸ºç½‘ç»œåŸå› è€Œè°ƒç”¨å¤±è´¥ï¼Œè¿™æ—¶ï¼Œä¸€èˆ¬åœ¨è®¾è®¡çš„æ—¶å€™ä¼šå¯¹æ¥å£è°ƒç”¨åŠ ä¸Šå¤±è´¥é‡è¯•çš„æœºåˆ¶ã€‚å¦‚æœç¬¬ä¸€æ¬¡è°ƒç”¨å·²ç»æ‰§è¡Œäº†ä¸€åŠæ—¶ï¼Œå‘ç”Ÿäº†ç½‘ç»œå¼‚å¸¸ã€‚è¿™æ—¶å†æ¬¡è°ƒç”¨æ—¶å°±ä¼šå› ä¸ºè„æ•°æ®çš„å­˜åœ¨è€Œå‡ºç°è°ƒç”¨å¼‚å¸¸ã€‚ ","date":"2021-07-07","objectID":"/2021/07/%E5%B9%82%E7%AD%89%E6%80%A7/:2:2","tags":["api"],"title":"å¹‚ç­‰æ€§","uri":"/2021/07/%E5%B9%82%E7%AD%89%E6%80%A7/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"3ã€æ¶ˆæ¯é‡å¤æ¶ˆè´¹ åœ¨ä½¿ç”¨æ¶ˆæ¯ä¸­é—´ä»¶æ¥å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸”æ‰‹åŠ¨ ack ç¡®è®¤æ¶ˆæ¯è¢«æ­£å¸¸æ¶ˆè´¹æ—¶ã€‚å¦‚æœæ¶ˆè´¹è€…çªç„¶æ–­å¼€è¿æ¥ï¼Œé‚£ä¹ˆå·²ç»æ‰§è¡Œäº†ä¸€åŠçš„æ¶ˆæ¯ä¼šé‡æ–°æ”¾å›é˜Ÿåˆ—ã€‚ å½“æ¶ˆæ¯è¢«å…¶ä»–æ¶ˆè´¹è€…é‡æ–°æ¶ˆè´¹æ—¶ï¼Œå¦‚æœæ²¡æœ‰å¹‚ç­‰æ€§ï¼Œå°±ä¼šå¯¼è‡´æ¶ˆæ¯é‡å¤æ¶ˆè´¹æ—¶ç»“æœå¼‚å¸¸ï¼Œå¦‚æ•°æ®åº“é‡å¤æ•°æ®ï¼Œæ•°æ®åº“æ•°æ®å†²çªï¼Œèµ„æºé‡å¤ç­‰ã€‚ ","date":"2021-07-07","objectID":"/2021/07/%E5%B9%82%E7%AD%89%E6%80%A7/:2:3","tags":["api"],"title":"å¹‚ç­‰æ€§","uri":"/2021/07/%E5%B9%82%E7%AD%89%E6%80%A7/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"ä¸‰ã€è§£å†³æ–¹æ¡ˆ ","date":"2021-07-07","objectID":"/2021/07/%E5%B9%82%E7%AD%89%E6%80%A7/:3:0","tags":["api"],"title":"å¹‚ç­‰æ€§","uri":"/2021/07/%E5%B9%82%E7%AD%89%E6%80%A7/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"1ã€tokenæœºåˆ¶ é€šè¿‡token æœºåˆ¶å®ç°æ¥å£çš„å¹‚ç­‰æ€§,è¿™æ˜¯ä¸€ç§æ¯”è¾ƒé€šç”¨æ€§çš„å®ç°æ–¹æ³•ã€‚ æµç¨‹ï¼š 1ã€å®¢æˆ·ç«¯ä¼šå…ˆå‘é€ä¸€ä¸ªè¯·æ±‚å»è·å– tokenï¼ŒæœåŠ¡ç«¯ä¼šç”Ÿæˆä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ ID ä½œä¸º token ä¿å­˜åœ¨ redis ä¸­ï¼ŒåŒæ—¶æŠŠè¿™ä¸ª ID è¿”å›ç»™å®¢æˆ·ç«¯ 2ã€å®¢æˆ·ç«¯ç¬¬äºŒæ¬¡è°ƒç”¨ä¸šåŠ¡è¯·æ±‚çš„æ—¶å€™å¿…é¡»æºå¸¦è¿™ä¸ª token 3ã€æœåŠ¡ç«¯ä¼šæ ¡éªŒè¿™ä¸ª tokenï¼Œå¦‚æœæ ¡éªŒæˆåŠŸï¼Œåˆ™æ‰§è¡Œä¸šåŠ¡ï¼Œå¹¶åˆ é™¤ redis ä¸­çš„ token 4ã€å¦‚æœæ ¡éªŒå¤±è´¥ï¼Œè¯´æ˜ redis ä¸­å·²ç»æ²¡æœ‰å¯¹åº”çš„ tokenï¼Œåˆ™è¡¨ç¤ºé‡å¤æ“ä½œï¼Œç›´æ¥è¿”å›æŒ‡å®šçš„ç»“æœç»™å®¢æˆ·ç«¯ ","date":"2021-07-07","objectID":"/2021/07/%E5%B9%82%E7%AD%89%E6%80%A7/:3:1","tags":["api"],"title":"å¹‚ç­‰æ€§","uri":"/2021/07/%E5%B9%82%E7%AD%89%E6%80%A7/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"2ã€mysqlé” è¿™ç§å®ç°æ–¹å¼æ˜¯åˆ©ç”¨ mysql å”¯ä¸€ç´¢å¼•çš„ç‰¹æ€§ æµç¨‹ï¼š 1ã€å»ºç«‹ä¸€å¼ å»é‡è¡¨ï¼Œå…¶ä¸­æŸä¸ªå­—æ®µéœ€è¦å»ºç«‹å”¯ä¸€ç´¢å¼• 2ã€å®¢æˆ·ç«¯å»è¯·æ±‚æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯ä¼šå°†è¿™æ¬¡è¯·æ±‚çš„ä¸€äº›ä¿¡æ¯æ’å…¥è¿™å¼ å»é‡è¡¨ä¸­ 3ã€å› ä¸ºè¡¨ä¸­æŸä¸ªå­—æ®µå¸¦æœ‰å”¯ä¸€ç´¢å¼•ï¼Œå¦‚æœæ’å…¥æˆåŠŸï¼Œè¯æ˜è¡¨ä¸­æ²¡æœ‰è¿™æ¬¡è¯·æ±‚çš„ä¿¡æ¯ï¼Œåˆ™æ‰§è¡Œåç»­çš„ä¸šåŠ¡é€»è¾‘ 4ã€å¦‚æœæ’å…¥å¤±è´¥ï¼Œåˆ™ä»£è¡¨å·²ç»æ‰§è¡Œè¿‡å½“å‰è¯·æ±‚ï¼Œç›´æ¥è¿”å› ","date":"2021-07-07","objectID":"/2021/07/%E5%B9%82%E7%AD%89%E6%80%A7/:3:2","tags":["api"],"title":"å¹‚ç­‰æ€§","uri":"/2021/07/%E5%B9%82%E7%AD%89%E6%80%A7/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"3ã€redisé” è¿™ç§å®ç°æ–¹å¼æ˜¯åŸºäº SETNX å‘½ä»¤å®ç°çš„ æµç¨‹ï¼š 1ã€å®¢æˆ·ç«¯å…ˆè¯·æ±‚æœåŠ¡ç«¯ï¼Œä¼šæ‹¿åˆ°ä¸€ä¸ªèƒ½ä»£è¡¨è¿™æ¬¡è¯·æ±‚ä¸šåŠ¡çš„å”¯ä¸€å­—æ®µ 2ã€å°†è¯¥å­—æ®µä»¥ SETNX çš„æ–¹å¼å­˜å…¥ redis ä¸­ï¼Œå¹¶æ ¹æ®ä¸šåŠ¡è®¾ç½®ç›¸åº”çš„è¶…æ—¶æ—¶é—´ 3ã€å¦‚æœè®¾ç½®æˆåŠŸï¼Œè¯æ˜è¿™æ˜¯ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œåˆ™æ‰§è¡Œåç»­çš„ä¸šåŠ¡é€»è¾‘ 4ã€å¦‚æœè®¾ç½®å¤±è´¥ï¼Œåˆ™ä»£è¡¨å·²ç»æ‰§è¡Œè¿‡å½“å‰è¯·æ±‚ï¼Œç›´æ¥è¿”å› ","date":"2021-07-07","objectID":"/2021/07/%E5%B9%82%E7%AD%89%E6%80%A7/:3:3","tags":["api"],"title":"å¹‚ç­‰æ€§","uri":"/2021/07/%E5%B9%82%E7%AD%89%E6%80%A7/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"æ€»ç»“ è¿™å‡ ç§å®ç°å¹‚ç­‰çš„æ–¹å¼å…¶å®éƒ½æ˜¯å¤§åŒå°å¼‚çš„ï¼Œç±»ä¼¼çš„è¿˜æœ‰ä½¿ç”¨çŠ¶æ€æœºã€æ‚²è§‚é”ã€ä¹è§‚é”çš„æ–¹å¼æ¥å®ç°ï¼Œéƒ½æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚ ç±»ä¼¼äºåˆ†å¸ƒé”ï¼š æ•°æ®åº“é”ï¼Œä¸€ä¸ªè¡¨ä¸­åŒ…å«æ–¹æ³•åç­‰å­—æ®µï¼Œå¹¶åœ¨æ–¹æ³•åå­—æ®µä¸Šåˆ›å»ºå”¯ä¸€ç´¢å¼• redisé”ï¼Œsetnxä¸ºé”æ·»åŠ ä¸€ä¸ªè¶…æ—¶æ—¶é—´ zookeeperé”ï¼šåˆ›å»ºç›®å½•ï¼Œåœ¨ç›®å½•ä¸‹åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼Œè·å–æœ€å°é¡ºåºèŠ‚ç‚¹å· ","date":"2021-07-07","objectID":"/2021/07/%E5%B9%82%E7%AD%89%E6%80%A7/:4:0","tags":["api"],"title":"å¹‚ç­‰æ€§","uri":"/2021/07/%E5%B9%82%E7%AD%89%E6%80%A7/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"åœ¨æ ‡å‡†åº“ä¸­æœ‰ä¸ªsync/errgroupï¼Œå®ç°å¯¹å¤šgoroutineè¿›è¡Œé”™è¯¯å¤„ç†ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹æºç ï¼š type Group struct { cancel func() wg sync.WaitGroup errOnce sync.Once err error } func WithCancel(ctx context.Context) (*Group, context.Context) { ctx, cancel := context.WithCancel(ctx) return \u0026Group{cancel: cancel}, ctx } func (g *Group) Wait() error { g.wg.Wait() if g.cancel != nil { g.cancel() } return g.err } func (g *Group) Go(f func() error) { g.wg.Add(1) go func() { defer g.wg.Done() if err := f(); err != nil { g.errOnce.Do(func() { g.err = err if g.cancel != nil { g.cancel() } }) } }() } å¾ˆç®€å•çš„å®ç°ï¼Œä½¿ç”¨sync.WaitGroupåšå¹¶å‘æ§åˆ¶ï¼Œç”¨sync.Onceåšé”™è¯¯è¿”å›ï¼Œä½¿ç”¨contextåšä¸Šä¸‹æ–‡çš„å¤„ç†ã€‚ ","date":"2021-07-05","objectID":"/2021/07/errgroup%E7%9A%84%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8/:0:0","tags":["sync","errgroup"],"title":"Errgroupçš„å®é™…åº”ç”¨","uri":"/2021/07/errgroup%E7%9A%84%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"ä¾‹å­ä¸€ func main() { g := new(errgroup.Group) var urls = []string{ \"http://www.golang.org/\", \"https://golang2.eddycjy.com/\", \"https://eddycjy.com/\", } for _, url := range urls { url := url g.Go(func() error { resp, err := http.Get(url) if err == nil { resp.Body.Close() } return err }) } if err := g.Wait(); err == nil { fmt.Println(\"Successfully fetched all URLs.\") } else { fmt.Printf(\"Errors: %+v\", err) } } ","date":"2021-07-05","objectID":"/2021/07/errgroup%E7%9A%84%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8/:1:0","tags":["sync","errgroup"],"title":"Errgroupçš„å®é™…åº”ç”¨","uri":"/2021/07/errgroup%E7%9A%84%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"ä¾‹å­äºŒ func main() { g, ctx := errgroup.WithContext(context.Background()) svr := http.NewServer() // http server g.Go(func() error { fmt.Println(\"http\") go func() { \u003c-ctx.Done() fmt.Println(\"http ctx done\") svr.Shutdown(context.TODO()) }() return svr.Start() }) // signal g.Go(func() error { exitSignals := []os.Signal{os.Interrupt, syscall.SIGTERM, syscall.SIGQUIT, syscall.SIGINT} // SIGTERM is POSIX specific sig := make(chan os.Signal, len(exitSignals)) signal.Notify(sig, exitSignals...) for { fmt.Println(\"signal\") select { case \u003c-ctx.Done(): fmt.Println(\"signal ctx done\") return ctx.Err() case \u003c-sig: // do something return nil } } }) // inject error g.Go(func() error { fmt.Println(\"inject\") time.Sleep(time.Second) fmt.Println(\"inject finish\") return errors.New(\"inject error\") }) err := g.Wait() // first error return fmt.Println(err) } ","date":"2021-07-05","objectID":"/2021/07/errgroup%E7%9A%84%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8/:2:0","tags":["sync","errgroup"],"title":"Errgroupçš„å®é™…åº”ç”¨","uri":"/2021/07/errgroup%E7%9A%84%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"è™½ç„¶golangçš„å®šæ—¶å™¨ç»è¿‡å‡ ç‰ˆçš„æ”¹è¿›ä¼˜åŒ–ï¼Œä½†æ˜¯ä»ç„¶æ˜¯æ€§èƒ½çš„å¤§æ€æ‰‹ã€‚ ","date":"2021-07-01","objectID":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:0:0","tags":["æºç è§£æ","time"],"title":"Goå®šæ—¶å™¨æºç åˆ†æ","uri":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"golang1.13å’Œ1.14çš„åŒºåˆ« golangåœ¨1.10ç‰ˆæœ¬ä¹‹å‰æ˜¯ç”±ä¸€ä¸ªç‹¬ç«‹çš„timerprocé€šè¿‡å°é¡¶å †å’Œfutexsleepæ¥ç®¡ç†å®šæ—¶ä»»åŠ¡ã€‚1.10ç‰ˆæœ¬ä¹‹åæ˜¯æŠŠç‹¬ç«‹çš„timerprocå’Œå°é¡¶å †åˆ†æˆæœ€å¤š64ä¸ªtimerprocåç¨‹å’Œå››å‰å †ï¼Œç”¨æ¥ä¼‘çœ çš„æ–¹å¼è¿˜æ˜¯ futexsleep è€Œ1.14ç‰ˆçš„timeræ˜¯æŠŠå­˜æ”¾å®šæ—¶äº‹ä»¶çš„å››å‰å †æ”¾åˆ°äº†Pç»“æ„ä¸­ï¼ŒåŒæ—¶å–æ¶ˆäº†timerprocåç¨‹ï¼Œè½¬è€Œä½¿ç”¨netpollçš„epoll waitæ¥åšå°±è¿‘æ—¶é—´çš„ä¼‘çœ ç­‰å¾…ã€‚ ","date":"2021-07-01","objectID":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:1:0","tags":["æºç è§£æ","time"],"title":"Goå®šæ—¶å™¨æºç åˆ†æ","uri":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"å‡½æ•°ç­¾å å¯¹äºNewTimerå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å®ç° time/sleep.go#L82ã€‚å…¶å®æˆ‘ä»¬å¯ä»¥å‘ç°ï¼ŒNewTimerã€NewTickerã€Afterå…¶å®éƒ½æ˜¯è°ƒç”¨addTimeræ¥æ–°å¢å®šæ—¶ä»»åŠ¡ã€‚ type Timer struct { C \u003c-chan Time r runtimeTimer } // NewTimer creates a new Timer that will send // the current time on its channel after at least duration d. func NewTimer(d Duration) *Timer { c := make(chan Time, 1) t := \u0026Timer{ C: c, r: runtimeTimer{ when: when(d), f: sendTime, arg: c, }, } startTimer(\u0026t.r) return t } func sendTime(c interface{}, seq uintptr) { select { case c.(chan Time) \u003c- Now(): default: } } func NewTicker(d Duration) *Ticker { if d \u003c= 0 { panic(errors.New(\"non-positive interval for NewTicker\")) } c := make(chan Time, 1) t := \u0026Ticker{ C: c, r: runtimeTimer{ when: when(d), period: int64(d), f: sendTime, arg: c, }, } startTimer(\u0026t.r) return t } è¿™é‡Œä¸»è¦åˆ†æˆä¸¤æ­¥ï¼š 1ã€åˆ›å»ºä¸€ä¸ªTimerå¯¹è±¡ï¼ŒåŒ…å«ä¸€ä¸ªå…·æœ‰ç¼“å†²åŒºchannelçš„cï¼Œç”¨æ¥æ¥æ”¶Timeræ¶ˆæ¯çš„ï¼ŒåŒ…å«çš„runtimeTimerç»“æ„ä½“ï¼Œwhenæ˜¯ä»£è¡¨timerè§¦å‘çš„ç»å¯¹æ—¶é—´(å½“å‰æ—¶é—´+d)ï¼Œfæ˜¯timerè§¦å‘æ—¶çš„å›è°ƒå‡½æ•°ï¼Œargæ˜¯ä¼ ç»™fçš„å‚æ•°ã€‚ 2ã€è°ƒç”¨startTimerï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨runtimeåŒ…ä¸‹çš„addtimerå‡½æ•°ã€‚ 3ã€NewTickerè°ƒç”¨çš„æ˜¯ç›¸åŒçš„å‡½æ•°ï¼Œåªæ˜¯å¤šäº†ä¸€ä¸ªå­—æ®µperiodï¼Œè¡¨ç¤ºè®¡æ—¶å™¨å†æ¬¡è¢«å”¤é†’çš„æ—¶é—´ï¼Œåšè½®è¯¢è§¦å‘ã€‚ ","date":"2021-07-01","objectID":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:2:0","tags":["æºç è§£æ","time"],"title":"Goå®šæ—¶å™¨æºç åˆ†æ","uri":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"golang1.13çš„å®šæ—¶å™¨åŸç† é¦–å…ˆä¼šåˆå§‹åŒ–ä¸€ä¸ªé•¿åº¦ä¸º64çš„timersæ•°ç»„ï¼Œé€šè¿‡åç¨‹çš„pçš„idå–æ¨¡æ¥åˆ†é…timersBucketï¼Œå¦‚æœå‘ç°æ–°çš„å®šæ—¶ä»»åŠ¡æ¯”è¾ƒæ–°ï¼Œé‚£ä¹ˆè°ƒç”¨notewakeupæ¥æ¿€æ´»å”¤é†’timerprocçš„futexç­‰å¾…ã€‚å¦‚æœå‘ç°æ²¡æœ‰å®ä¾‹åŒ–timerprocï¼Œåˆ™å¯åŠ¨ã€‚ ","date":"2021-07-01","objectID":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:3:0","tags":["æºç è§£æ","time"],"title":"Goå®šæ—¶å™¨æºç åˆ†æ","uri":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"1ã€æ·»åŠ å®šæ—¶å™¨ func addtimer(t *timer) { tb := t.assignBucket() lock(\u0026tb.lock) ok := tb.addtimerLocked(t) unlock(\u0026tb.lock) if !ok { badTimer() } } å¯ä»¥çœ‹åˆ°addtimeråšäº†ä¸¤ä»¶äº‹ï¼š 1ã€assignBucketæ‰¾åˆ°å¯ä»¥è¢«æ’å…¥çš„bucket 2ã€addtimerLockedå°†timeræ’å…¥åˆ°bucket ","date":"2021-07-01","objectID":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:3:1","tags":["æºç è§£æ","time"],"title":"Goå®šæ—¶å™¨æºç åˆ†æ","uri":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"2ã€timersBucket const timersLen = 64 // timeråŒ…å«æ¯ä¸ªPçš„å †ï¼Œtimerè¿›å…¥é˜Ÿåˆ—ä¸­å…³è”å½“å‰çš„Pï¼Œæ‰€ä»¥æ¯ä¸ªPä¸­timeréƒ½æ˜¯ç‹¬ç«‹äºå…¶ä»–Pçš„ // å¦‚æœGOMAXPROCS \u003e timersLenï¼Œé‚£ä¹ˆtimersBucketå¯èƒ½ä¼šç®¡ç†å¤šä¸ªP var timers [timersLen]struct { timersBucket // å†…å­˜å¯¹é½ pad [cpu.CacheLinePadSize - unsafe.Sizeof(timersBucket{})%cpu.CacheLinePadSize]byte } type timersBucket struct { lock mutex gp *g created bool sleeping bool rescheduling bool sleepUntil int64 waitnote note t []*timer } åœ¨runtimeä¸­ï¼Œæœ‰64ä¸ªå…¨å±€å®šä¹‰çš„timer bucketã€‚æ¯ä¸ªbucketè´Ÿè´£ç®¡ç†timerã€‚timerçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸåŒ…æ‹¬åˆ›å»ºã€é”€æ¯ã€å”¤é†’ã€ç¡çœ ç­‰éƒ½æ˜¯ç”±timer bucketç®¡ç†å’Œè°ƒåº¦ã€‚ é—®ï¼šä¸ºä»€ä¹ˆæ˜¯64ä¸ªtimer bucket? ç­”ï¼šåœ¨1.10ç‰ˆæœ¬ä¹‹å‰ï¼Œåªæœ‰1ä¸ªtimerså¯¹è±¡ï¼Œåœ¨æ·»åŠ å®šæ—¶å™¨ä»»åŠ¡æ—¶éƒ½éœ€è¦å¯¹timersè¿›è¡ŒåŠ é”å’Œè§£é”æ“ä½œï¼Œå½±å“æ€§èƒ½ï¼›å½“timerè¿‡å¤šï¼Œtimersä¸­çš„tå¾ˆå¤šï¼Œæ·»åŠ è¿›å››å‰å †æ“ä½œå¯èƒ½è€—æ—¶æ¯”è¾ƒé•¿ï¼Œå¯èƒ½ä¼šå¯¼è‡´timerçš„å»¶è¿Ÿã€‚å› æ­¤å¼•å…¥å…¨å±€64ä¸ªåˆ†æ¡¶çš„ç­–ç•¥ï¼Œå°†timeråˆ†æ•£åˆ°æ¡¶ä¸­ï¼Œæ¯ä¸ªæ¡¶åªè´Ÿè´£è‡ªå·±çš„timerï¼Œæœ‰æ•ˆé™ä½äº†é”çš„ç²’åº¦å’Œtimerè°ƒåº¦çš„è´Ÿæ‹…ã€‚ è€Œæ ¹æ®æœ€ä¼˜çš„æƒ…å†µä¸‹ï¼Œåº”è¯¥æ˜¯åˆ†æ¡¶çš„æ•°é‡åº”è¯¥è¦å’ŒGOMAXPROCSæ•°é‡ä¸€è‡´ï¼Œæœ‰å¤šå°‘ä¸ªPå°±æœ‰å¤šå°‘ä¸ªtimer bucketã€‚ä½†æ˜¯ï¼Œè¿™å°±æ¶‰åŠåˆ°Pçš„åŠ¨æ€åˆ†é…é—®é¢˜ï¼Œæ‰€ä»¥åœ¨æ€§èƒ½çš„æƒè¡¡ä¸‹ï¼Œä½¿ç”¨64 èƒ½å¤Ÿè¦†ç›–å¤§å¤šæ•°çš„åœºæ™¯ã€‚ ","date":"2021-07-01","objectID":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:3:2","tags":["æºç è§£æ","time"],"title":"Goå®šæ—¶å™¨æºç åˆ†æ","uri":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"3ã€åˆ†é…æ¡¶ func (t *timer) assignBucket() *timersBucket { id := uint8(getg().m.p.ptr().id) % timersLen t.tb = \u0026timers[id].timersBucket return t.tb } ","date":"2021-07-01","objectID":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:3:3","tags":["æºç è§£æ","time"],"title":"Goå®šæ—¶å™¨æºç åˆ†æ","uri":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"4ã€æ·»åŠ timeråˆ°å››å‰å † func (tb *timersBucket) addtimerLocked(t *timer) bool { // æ­¤æ—¶whenåº”è¯¥æ˜¯å½“å‰æ—¶é—´+duration if t.when \u003c 0 { t.when = 1\u003c\u003c63 - 1 } // å°†timeræ·»åŠ åˆ°å››å‰å †ä¸­ t.i = len(tb.t) tb.t = append(tb.t, t) if !siftupTimer(tb.t, t.i) { return false } // é¦–æ¬¡æ·»åŠ  if t.i == 0 { // å¦‚æœtimerprocåœ¨sleepï¼Œå”¤é†’å®ƒ if tb.sleeping \u0026\u0026 tb.sleepUntil \u003e t.when { tb.sleeping = false notewakeup(\u0026tb.waitnote) } // å¦‚æœtimerprocè¢«æŒ‚èµ·äº†ï¼Œé‡æ–°è°ƒåº¦ if tb.rescheduling { tb.rescheduling = false goready(tb.gp, 0) } // å¦‚æœtimerçš„æ¡¶è¿˜æ²¡æœ‰åˆ›å»ºï¼Œåˆ›å»ºå¹¶å¼€å§‹timerproc if !tb.created { tb.created = true go timerproc(tb) } } return true } é—®ï¼šä¸ºä»€ä¹ˆæ˜¯å››å‰å †ï¼Ÿ ç­”ï¼šä¸Šæ¨èŠ‚ç‚¹çš„æ“ä½œæ›´å¿«ï¼›å¯¹ç¼“å­˜æ›´å‹å¥½ã€‚ ","date":"2021-07-01","objectID":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:3:4","tags":["æºç è§£æ","time"],"title":"Goå®šæ—¶å™¨æºç åˆ†æ","uri":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"5ã€timerproc // timerproc å¤–å±‚å¾ªç¯ä¸ä¼šé€€å‡º func timerproc(tb *timersBucket) { tb.gp = getg() for { lock(\u0026tb.lock) // ä¿®æ”¹ç¡çœ æ ‡è¯† tb.sleeping = false // å½“å‰æ—¶é—´ now := nanotime() delta := int64(-1) for { // å¦‚æœæ¡¶å†…æ²¡æœ‰timerï¼Œé€€å‡º if len(tb.t) == 0 { delta = -1 break } // è·å–æœ€æ—©è§¦å‘çš„timer t := tb.t[0] delta = t.when - now // è¿˜æ²¡æœ‰åˆ°è¾¾è§¦å‘æ—¶é—´ï¼Œé€€å‡º if delta \u003e 0 { break } ok := true if t.period \u003e 0 { // éœ€è¦å‘¨æœŸæ€§è§¦å‘å®šæ—¶å™¨ï¼Œéœ€è¦ä¿®æ”¹timerçš„è§¦å‘æ—¶é—´ï¼Œé‡æ–°æ·»åŠ åˆ°æœ€å°å †ä¸­ // leave in heap but adjust next time to fire t.when += t.period * (1 + -delta/t.period) if !siftdownTimer(tb.t, 0) { ok = false } } else { // ä»æœ€å°å †ä¸­ç§»é™¤ last := len(tb.t) - 1 if last \u003e 0 { tb.t[0] = tb.t[last] tb.t[0].i = 0 } tb.t[last] = nil tb.t = tb.t[:last] if last \u003e 0 { if !siftdownTimer(tb.t, 0) { ok = false } } t.i = -1 // ä¸‹æ ‡æ ‡è®°ä¸º-1ï¼Œdeltimerå‘ç°ä¸‹æ ‡ä¸º-1æ—¶å°±ä¸åˆ é™¤äº† } f := t.f arg := t.arg seq := t.seq unlock(\u0026tb.lock) if !ok { badTimer() } if raceenabled { raceacquire(unsafe.Pointer(t)) } f(arg, seq) lock(\u0026tb.lock) } if delta \u003c 0 || faketime \u003e 0 { // å¦‚æœæ¡¶ä¸­æ²¡æœ‰timerï¼ŒæŠŠåç¨‹æŒ‚èµ· tb.rescheduling = true goparkunlock(\u0026tb.lock, waitReasonTimerGoroutineIdle, traceEvGoBlock, 1) continue } // å¦‚æœè¿˜æœ‰timerï¼Œç¡çœ åˆ°æ¡¶å†…æœ€æ—©è§¦å‘çš„æ—¶é—´ç‚¹åå”¤é†’ tb.sleeping = true tb.sleepUntil = now + delta noteclear(\u0026tb.waitnote) unlock(\u0026tb.lock) notetsleepg(\u0026tb.waitnote, delta) } } ","date":"2021-07-01","objectID":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:3:5","tags":["æºç è§£æ","time"],"title":"Goå®šæ—¶å™¨æºç åˆ†æ","uri":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"6ã€å°ç»“ 1ã€é¦–é€‰é¢„åˆ†é…64ä¸ªçš„timer bucketï¼Œtimer bucketé‡Œé¢æ˜¯ä¸€ä¸ªå››å‰å †å­˜æ”¾timer 2ã€æ¯æ¬¡æ–°å¢çš„timerï¼Œæ·»åŠ åˆ°å››å‰å †ä¸­ï¼Œä¼šå°è¯•å”¤é†’å’Œè°ƒåº¦bucket 3ã€ç¬¬ä¸€æ¬¡æ–°å¢çš„bucketä¼šè¿è¡Œåç¨‹timerprocã€‚timerprocæ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œå‘¨æœŸæ€§åœ°æ£€æŸ¥å®šæ—¶å™¨çŠ¶æ€ã€‚ 4ã€æ¯æ¬¡ä»æœ€å°å †ä¸­å–å‡ºtimerï¼Œå¦‚æœæ˜¯è®¡æ—¶å™¨ï¼Œåˆ™é‡æ–°åŠ å…¥åˆ°bucketä¸­ã€‚å¦‚æœbucketæ²¡æœ‰timerï¼Œåˆ™å°†timerprocæŒ‚èµ·ã€‚å¦‚æœè¿˜æœ‰timerï¼Œåˆ™ç¡çœ åˆ°bucketä¸­å †é¡¶å”¤é†’çš„æ—¶é—´ã€‚ ","date":"2021-07-01","objectID":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:3:6","tags":["æºç è§£æ","time"],"title":"Goå®šæ—¶å™¨æºç åˆ†æ","uri":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"æ·±åº¦åˆ†ægolang1.14å®šæ—¶å™¨ ","date":"2021-07-01","objectID":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:4:0","tags":["æºç è§£æ","time"],"title":"Goå®šæ—¶å™¨æºç åˆ†æ","uri":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"1ã€timer type timer struct { // If this timer is on a heap, which P's heap it is on. // puintptr rather than *p to match uintptr in the versions // of this struct defined in other packages. pp puintptr // è®¡æ—¶å™¨æ‰€åœ¨çš„å¤„ç†å™¨Pçš„æŒ‡é’ˆåœ°å€ // Timer wakes up at when, and then at when+period, ... (period \u003e 0 only) // each time calling f(arg, now) in the timer goroutine, so f must be // a well-behaved function and not block. when int64 // è®¡æ—¶å™¨è¢«å”¤é†’çš„æ—¶é—´ period int64 // è®¡æ—¶å™¨å†æ¬¡è¢«å”¤é†’çš„æ—¶é—´ï¼ˆå‘¨æœŸï¼‰ f func(interface{}, uintptr) // å›è°ƒå‡½æ•°ï¼Œæ¯æ¬¡åœ¨è®¡æ—¶å™¨è¢«å”¤é†’æ—¶éƒ½ä¼šè°ƒç”¨ arg interface{} // å›è°ƒå‡½æ•°çš„å‚æ•° seq uintptr // å›è°ƒå‡½æ•°çš„å‚æ•°ï¼Œä»…åœ¨netpollçš„åº”ç”¨åœºæ™¯ä¸‹ä½¿ç”¨ // What to set the when field to in timerModifiedXX status. nextwhen int64 // å½“è®¡æ—¶å™¨çŠ¶æ€ä¸ºtimerModifiedXXæ—¶ï¼Œå°†ä¼šä½¿ç”¨nextwhenè®¾ç½®åˆ°whereå­—æ®µä¸Š // The status field holds one of the values below. status uint32 // è®¡æ—¶å™¨å½“å‰çš„çŠ¶æ€å€¼ } ","date":"2021-07-01","objectID":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:4:1","tags":["æºç è§£æ","time"],"title":"Goå®šæ—¶å™¨æºç åˆ†æ","uri":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"2ã€p åœ¨æ·»åŠ æ–¹å¼ä¸Šï¼Œgo1.14å‘ç”Ÿäº†å˜æ›´ï¼Œæ”¹ä¸ºå°†æ¯ä¸ªtimerå­˜å‚¨åœ¨å¤„ç†å™¨pä¸Šã€‚è¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¹‹å‰æåˆ°çš„ä¼˜åŒ–ç»“æ„ï¼Œ64åªèƒ½æ³›æŒ‡å¤§å¤šæ•°æƒ…å†µï¼Œå®é™…éƒ½æ˜¯éœ€è¦pè¿›è¡Œå¤„ç†ã€‚æ‰€ä»¥go1.14é‡Œçš„pç»“æ„ä¸­æœ‰äº†timerså­—æ®µã€‚ type p struct { ... timersLock mutex timers []*timer ... } åŒæ ·ï¼Œåœ¨timersæ•°ç»„ä»æ˜¯ä¸€ä¸ªæœ€å°å››å‰å †ã€‚ ","date":"2021-07-01","objectID":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:4:2","tags":["æºç è§£æ","time"],"title":"Goå®šæ—¶å™¨æºç åˆ†æ","uri":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"3ã€å®šæ—¶å™¨çŠ¶æ€ // Values for the timer status field. const ( // timerå°šæœªè®¾ç½®çŠ¶æ€ timerNoStatus = iota // ç­‰å¾…timerå¯åŠ¨ timerWaiting // è¿è¡Œtimerçš„å›è°ƒæ–¹æ³• timerRunning // timerå·²ç»è¢«åˆ é™¤ï¼Œä½†ä»ç„¶åœ¨æŸäº›pçš„å †ä¸­ timerDeleted // timerå³å°†è¢«åˆ é™¤ timerRemoving // timerå·²ç»åœæ­¢ï¼Œä¸”ä¸å­˜åœ¨ä»»ä½•pçš„å †ä¸­ timerRemoved // timeræ­£åœ¨è¢«ä¿®æ”¹ timerModifying // timerå·²è¢«ä¿®æ”¹ä¸ºæ›´æ—©çš„æ—¶é—´ï¼Œæ–°çš„æ—¶é—´è¢«è®¾ç½®åœ¨nextwhenå­—æ®µä¸­ï¼Œ timerModifiedEarlier // timerå·²è¢«ä¿®æ”¹ä¸ºæ›´è¿Ÿçš„æ—¶é—´ï¼Œæ–°çš„æ—¶é—´è¢«è®¾ç½®åœ¨nextwhenå­—æ®µä¸­ï¼Œ timerModifiedLater // timerå·²ç»è¢«ä¿®æ”¹ï¼Œæ­£åœ¨è¢«ç§»åŠ¨ timerMoving ) å› ä¸ºæ¶‰åŠåˆ°pçš„ç®¡ç†ï¼Œæ‰€ä»¥æ–°å¢äº†10ä¸ªtimerçš„çŠ¶æ€ç®¡ç†ã€‚ ","date":"2021-07-01","objectID":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:4:3","tags":["æºç è§£æ","time"],"title":"Goå®šæ—¶å™¨æºç åˆ†æ","uri":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"4ã€å¯åŠ¨å®šæ—¶å™¨ func addtimer(t *timer) { // when must never be negative; otherwise runtimer will overflow // during its delta calculation and never expire other runtime timers. // è¾¹ç•Œæ¡ä»¶åˆ¤æ–­ if t.when \u003c 0 { t.when = maxWhen } // timerçš„çŠ¶æ€ä¸ºtimerNoStatus if t.status != timerNoStatus { throw(\"addtimer called with initialized timer\") } t.status = timerWaiting when := t.when pp := getg().m.p.ptr() lock(\u0026pp.timersLock) // æ¸…é™¤å¤„ç†å™¨pä¸­çš„è®¡æ—¶å™¨é˜Ÿåˆ—ï¼Œå¯ä»¥åŠ å¿«åˆ›å»ºå’Œåˆ é™¤è®¡æ—¶å™¨çš„ç¨‹åºçš„é€Ÿåº¦ cleantimers(pp) // å°†å½“å‰æ‰€æ–°åˆ›å»ºçš„timeræ–°å¢åˆ°pçš„å †ä¸­ doaddtimer(pp, t) unlock(\u0026pp.timersLock) // å”¤é†’ç½‘ç»œè½®è¯¢å™¨ä¸­ä¼‘çœ çš„çº¿ç¨‹ï¼Œæ£€æŸ¥timerè¢«å”¤é†’çš„æ—¶é—´(when)æ˜¯å¦åœ¨å½“å‰è½®è¯¢é¢„æœŸè¿è¡Œçš„æ—¶é—´(pollerPollUntil)å†…ï¼Œè‹¥æ˜¯åˆ™å”¤é†’ wakeNetPoller(when) } æ·»åŠ timeråˆ°å½“å‰çš„pä¸Šï¼Œè¿™åº”è¯¥åªåœ¨ä¸€ä¸ªæ–°åˆ›å»ºçš„timerä¸­è°ƒç”¨ï¼Œè¿™é¿å…äº†æ›´æ”¹æŸäº›pçš„æœ€å°å †timerçš„whenå­—æ®µçš„é£é™©ï¼Œå› ä¸ºè¿™å¯èƒ½å¯¼è‡´æœ€å°å †ä¹±åºã€‚ ","date":"2021-07-01","objectID":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:4:4","tags":["æºç è§£æ","time"],"title":"Goå®šæ—¶å™¨æºç åˆ†æ","uri":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"5ã€åœæ­¢å®šæ—¶å™¨ åœ¨å®šæ—¶å™¨çš„è¿è¡Œä¸­ï¼Œä¸€èˆ¬ä¼šè°ƒç”¨timer.Stopæ–¹æ³•æ¥åœæ­¢/åˆ é™¤å®šæ—¶å™¨ï¼Œå…¶å®å°±æ˜¯è®©è¿™ä¸ªtimerä»å¤„ç†å™¨pçš„å †ä¸­ç§»é™¤ã€‚ timerWaiting/timerModifiedLaterï¼šä¿®æ”¹timerçŠ¶æ€ä¸ºtimerDeletedï¼Œåˆ é™¤æ•°é‡+1 timerModifiedEarlierï¼šä¿®æ”¹timerçŠ¶æ€ä¸ºtimerDeletedï¼Œåˆ é™¤æ•°é‡+1ï¼ŒadjustTimers+1 timerDeleted/timerRemoving/timerRemovedï¼šæ— éœ€å˜æ›´ï¼Œå·²ç»æ»¡è¶³æ¡ä»¶ timerRunning/timerMoving/timerModifyingï¼šæ­£åœ¨æ‰§è¡Œã€ç§»åŠ¨ä¸­ï¼Œæ— æ³•åœæ­¢ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡çŠ¶æ€æ£€æŸ¥å†å¤„ç† timerNoStatusï¼šæ— æ³•åœæ­¢ï¼Œä¸æ»¡è¶³æ¡ä»¶ ","date":"2021-07-01","objectID":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:4:5","tags":["æºç è§£æ","time"],"title":"Goå®šæ—¶å™¨æºç åˆ†æ","uri":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"6ã€ä¿®æ”¹/é‡ç½®å®šæ—¶å™¨ åœ¨ç¨‹åºè°ƒåº¦ä¸­ï¼Œæœ‰äº›å› ä¸ºé€»è¾‘æ”¹å˜ï¼Œéœ€è¦é‡ç½®å®šæ—¶å™¨ã€‚ä¸€èˆ¬ä¼šè°ƒç”¨timer.Reset()æ¥é‡è®¾Durationå€¼ã€‚ func resettimer(t *timer, when int64) { modtimer(t, when, t.period, t.f, t.arg, t.seq) } å®é™…è°ƒç”¨modtimeræ–¹æ³•ã€‚ timerRunning/timerRemoving/timerMoving/timerModifyingï¼šç­‰å¾…çŠ¶æ€æ”¹å˜ timerDeleted-\u003etimerModifying-\u003etimerModifiedXXX timerNoStatus/timerRemoved-\u003etimerModifying-\u003etimerWaiting timerWaiting/timerModifiedXXX-\u003etimerModifying-\u003etimerModifiedXXX åœ¨å¤„ç†å®Œå¤„ç†å™¨çš„çŠ¶æ€åï¼Œä¼šåˆ†ä¸ºä¸¤ç§æƒ…å†µè¿›è¡Œå¤„ç†ï¼š 1ã€å¾…ä¿®æ”¹çš„å®šæ—¶å™¨å·²ç»è¢«åˆ é™¤ï¼šç”±äºåŸå®šæ—¶å™¨æ²¡æœ‰äº†ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨doaddtimeræ–¹æ³•åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼Œå¹¶èµ‹å€¼åŸå…ˆçš„timerï¼Œå†è°ƒç”¨wakeNetPolleråœ¨é¢„å®šçš„æ—¶é—´å”¤é†’ç½‘ç»œè½®è¯¢å™¨ 2ã€æ­£å¸¸é€»è¾‘å¤„ç†ï¼šå¦‚æœä¿®æ”¹åçš„å®šæ—¶å™¨çš„è§¦å‘æ—¶é—´å°äºåŸæœ¬çš„è§¦å‘æ˜¯æŒ‰ï¼Œåˆ™ä¿®æ”¹å®šæ—¶å™¨çŠ¶æ€ä¸ºtimerModifiedEalierï¼Œå¹¶è°ƒç”¨wakeNetPolleråœ¨é¢„å®šçš„æ—¶é—´å”¤é†’ç½‘ç»œè½®è¯¢å™¨ ","date":"2021-07-01","objectID":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:4:6","tags":["æºç è§£æ","time"],"title":"Goå®šæ—¶å™¨æºç åˆ†æ","uri":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"7ã€è§¦å‘å®šæ—¶å™¨ å‰é¢æåˆ°è¿‡ï¼Œtimerså·²ç»å½’å±åˆ°pä¸­å»äº†ï¼Œæ‰€ä»¥å®šæ—¶å™¨çš„è§¦å‘åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼š é€šè¿‡è°ƒåº¦å™¨åœ¨è°ƒåº¦æ—¶è¿›è¡Œå®šæ—¶å™¨çš„è§¦å‘ é€šè¿‡ç³»ç»Ÿç›‘æ§æ£€æŸ¥å¹¶è§¦å‘å®šæ—¶å™¨ï¼ˆåˆ°æœŸæœªæ‰§è¡Œï¼‰ 1ã€è°ƒåº¦å™¨è§¦å‘ è°ƒåº¦å™¨è§¦å‘ä¸€èˆ¬åˆ†ä¸ºä¸¤ç§æƒ…å†µã€‚ ä¸€ç§æ˜¯è°ƒåº¦å¾ªç¯ä¸­è°ƒç”¨checkTimersæ–¹æ³•è¿›è¡Œè®¡æ—¶å™¨çš„è§¦å‘ func schedule() { _g_ := getg() ... top: pp := _g_.m.p.ptr() pp.preempt = false ... checkTimers(pp, 0) ... execute(gp, inheritTime) } å¦ä¸€ç§æ˜¯å½“å‰å¤„ç†å™¨pæ²¡æœ‰å¯æ‰§è¡Œçš„timerï¼Œä¸”æ²¡æœ‰å¯æ‰§è¡Œçš„Gã€‚é‚£ä¹ˆæŒ‰ç…§è°ƒåº¦æ¨¡å‹ï¼Œå°±ä¼šå»çªƒå–å…¶ä»–å®šæ—¶å™¨å’ŒG: func findrunnable() (gp *g, inheritTime bool) { _g_ := getg() ... top: _p_ := _g_.m.p.ptr() ... now, pollUntil, _ := checkTimers(_p_, 0) ... } æˆ‘ä»¬æ¥è¿›ä¸€æ­¥åˆ†æcheckTimersæ–¹æ³•ï¼š 1ã€æ£€æŸ¥å¤„ç†å™¨pä¸Šæ˜¯å¦æœ‰éœ€è¦å¤„ç†çš„timer 2ã€å¦‚æœæ²¡æœ‰éœ€è¦æ‰§è¡Œçš„timerï¼Œåˆ™ç›´æ¥è¿”å›ï¼›å¦åˆ™ï¼Œåˆ¤æ–­æ ‡è®°ä¸ºåˆ é™¤çš„timeræ•°é‡å¦‚æœå°äºpä¸Šçš„timeræ•°é‡åˆ™ç›´æ¥è¿”å› 3ã€å¯¹éœ€è¦å¤„ç†çš„timerï¼Œæ ¹æ®æ—¶é—´å°†timersé‡æ–°æ’åº 4ã€åœ¨è°ƒæ•´å®Œtimersåï¼Œè°ƒç”¨runtimeræ–¹æ³•çœŸæ­£æ‰§è¡Œtimerï¼Œè§¦å‘å®šæ—¶å™¨ 5ã€åœ¨æœ€åçš„é˜¶æ®µï¼Œå¦‚æœè¢«æ ‡è®°ä¸ºåˆ é™¤çš„timeræ•°é‡å¦‚æœå¤§äºpä¸Šçš„timeræ•°é‡ï¼Œåˆ™å¯¹æ ‡è®°ä¸ºåˆ é™¤çš„timerè¿›è¡Œæ¸…ç†ã€‚ 2ã€ç³»ç»Ÿç›‘æ§è§¦å‘ é€šè¿‡æ¯æ¬¡è°ƒåº¦å™¨è°ƒåº¦å’Œçªƒå–çš„æ˜¯å¦è§¦å‘ï¼Œè¿˜æ˜¯æœ‰ä¸€å®šçš„éšæœºæ€§ã€‚ å› æ­¤éœ€è¦ä¸€ä¸ªç³»ç»Ÿç›‘æ§æ¥è§¦å‘å®šæ—¶å™¨ã€‚ func sysmon() { ... for { ... next, _ := timeSleepUntil() if debug.schedtrace \u003c= 0 \u0026\u0026 (sched.gcwaiting != 0 || atomic.Load(\u0026sched.npidle) == uint32(gomaxprocs)) { lock(\u0026sched.lock) if atomic.Load(\u0026sched.gcwaiting) != 0 || atomic.Load(\u0026sched.npidle) == uint32(gomaxprocs) { if next \u003e now { atomic.Store(\u0026sched.sysmonwait, 1) unlock(\u0026sched.lock) // Make wake-up period small enough // for the sampling to be correct. sleep := forcegcperiod / 2 if next-now \u003c sleep { sleep = next - now } shouldRelax := sleep \u003e= osRelaxMinNS if shouldRelax { osRelax(true) } notetsleep(\u0026sched.sysmonnote, sleep) if shouldRelax { osRelax(false) } now = nanotime() next, _ = timeSleepUntil() lock(\u0026sched.lock) atomic.Store(\u0026sched.sysmonwait, 0) noteclear(\u0026sched.sysmonnote) } idle = 0 delay = 20 } unlock(\u0026sched.lock) } ... // poll network if not polled for more than 10ms lastpoll := int64(atomic.Load64(\u0026sched.lastpoll)) if netpollinited() \u0026\u0026 lastpoll != 0 \u0026\u0026 lastpoll+10*1000*1000 \u003c now { atomic.Cas64(\u0026sched.lastpoll, uint64(lastpoll), uint64(now)) list := netpoll(0) // non-blocking - returns list of goroutines if !list.empty() { incidlelocked(-1) injectglist(\u0026list) incidlelocked(1) } } if next \u003c now { startm(nil, false) } ... } } 1ã€åœ¨æ¯æ¬¡ç³»ç»Ÿç›‘æ§æ—¶ï¼Œéƒ½ä¼šåœ¨æµç¨‹ä¸Šè°ƒç”¨timeSleepUntilæ–¹æ³•å»è·å–ä¸‹ä¸€ä¸ªå®šæ—¶å™¨åº”è§¦å‘çš„æ—¶é—´ï¼Œä»¥åŠä¿å­˜æ”¹å®šæ—¶å™¨å·²ç»æ‰“å¼€çš„å®šæ—¶å™¨å †çš„p. 2ã€æ£€æŸ¥å½“å‰æ˜¯å¦å­˜åœ¨GCï¼Œè‹¥æ­£åœ¨STWåˆ™è·å–è°ƒåº¦äº’æ–¥é”ã€‚è‹¥å‘ç°ä¸‹ä¸€ä¸ªtimerè§¦å‘æ—¶é—´å·²ç»è¿‡å»ï¼Œåˆ™é‡æ–°è°ƒç”¨timeSleepUntilè·å–ä¸‹ä¸€ä¸ªå®šæ—¶å™¨çš„æ—¶é—´å’Œç›¸åº”çš„pã€‚ 3ã€å¦‚æœå‘ç°è¶…è¿‡10msæ²¡æœ‰è¿›è¡Œnetpollç½‘ç»œè½®è¯¢ï¼Œåˆ™ä¸»åŠ¨è°ƒç”¨netpollæ–¹æ³•è§¦å‘è½®è¯¢ ","date":"2021-07-01","objectID":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:4:7","tags":["æºç è§£æ","time"],"title":"Goå®šæ—¶å™¨æºç åˆ†æ","uri":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"8ã€è¿è¡Œå®šæ—¶å™¨ è¿™é‡Œæ¥åˆ†æä¸€ä¸‹runtimeræ–¹æ³•ï¼š åªæœ‰è¢«æ ‡è®°ä¸ºtimerWaitingçŠ¶æ€çš„å®šæ—¶å™¨æ‰èƒ½è¿è¡Œï¼Œå°è¯•å°†çŠ¶æ€æ›´æ–°ä¸ºtimerRunningï¼Œç„¶åæ‰§è¡ŒrunOneTimeræ–¹æ³•ã€‚ æ ‡è®°ä¸ºtimerDeletedçŠ¶æ€çš„å®šæ—¶å™¨ä¼šå»åˆ é™¤å®šæ—¶å™¨ï¼Œæ ‡è®°ä¸ºtimerModifiedXXXçŠ¶æ€çš„å®šæ—¶å™¨ä¼šå»é‡æ–°æ·»åŠ å®šæ—¶å™¨ã€‚ func runOneTimer(pp *p, t *timer, now int64) { f := t.f arg := t.arg seq := t.seq if t.period \u003e 0 { // tickerï¼Œéœ€è¦å†æ¬¡è§¦å‘ // é‡æ–°è®¡ç®—ä¸‹ä¸€æ¬¡çš„è§¦å‘æ—¶é—´ï¼Œå¹¶ä¸”æ›´æ–°å…¶åœ¨æœ€å°å † delta := t.when - now t.when += t.period * (1 + -delta/t.period) siftdownTimer(pp.timers, 0) // å°†çŠ¶æ€ä¿®æ”¹ä¸ºtimerWaiting if !atomic.Cas(\u0026t.status, timerRunning, timerWaiting) { badTimer() } // è®¾ç½®pçš„ä¸‹ä¸€æ¬¡è§¦å‘æ—¶é—´ updateTimer0When(pp) } else { // ç§»é™¤timer dodeltimer0(pp) if !atomic.Cas(\u0026t.status, timerRunning, timerNoStatus) { badTimer() } } unlock(\u0026pp.timersLock) // å›è°ƒæ–¹æ³• f(arg, seq) lock(\u0026pp.timersLock) } ","date":"2021-07-01","objectID":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:4:8","tags":["æºç è§£æ","time"],"title":"Goå®šæ—¶å™¨æºç åˆ†æ","uri":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"9ã€å°ç»“ é€šè¿‡å¤§è‡´çš„go1.14æºç åˆ†æï¼Œå¯ä»¥çœ‹å‡ºæœ‰ä»¥ä¸‹æ”¹å˜ï¼š åœ¨æ¯ä¸ªå¤„ç†å™¨pä¸­ï¼Œtimersä»¥æœ€å°å››å‰å †æ–¹å¼å­˜å‚¨ åœ¨è°ƒåº¦å™¨çš„æ¯è½®è·³è¯»ä¸­éƒ½ä¼šå¯¹å®šæ—¶å™¨è¿›è¡Œè§¦å‘å’Œæ£€æŸ¥ åœ¨ç³»ç»Ÿç›‘å¬netpollä¼šå®šæ—¶è¿›è¡Œå®šæ—¶å™¨çš„è§¦å‘å’Œæ£€æŸ¥ åœ¨å®šæ—¶å™¨çš„å¤„ç†ä¸­ï¼Œ10ä¸ªçŠ¶æ€çš„æµè½¬å’Œå¤„ç†å˜åŒ– ","date":"2021-07-01","objectID":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:4:9","tags":["æºç è§£æ","time"],"title":"Goå®šæ—¶å™¨æºç åˆ†æ","uri":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"æ€»ç»“ go1.13æœ€å¤šå¯ä»¥å¼€åˆ°GOMAXPROCSæ•°é‡çš„timerprocåç¨‹ï¼Œå½“ç„¶ä¸è¶…è¿‡64ã€‚ä½†æˆ‘ä»¬è¦çŸ¥é“timerprocè‡ªèº«å°±æ˜¯åç¨‹ï¼Œä¹Ÿéœ€è¦runtime pmgçš„è°ƒåº¦ã€‚åè€Œgo 1.14æŠŠæ£€æŸ¥åˆ°æœŸå®šæ—¶ä»»åŠ¡çš„å·¥ä½œäº¤ç»™äº†runtime.scheduleï¼Œä¸éœ€è¦é¢å¤–çš„è°ƒåº¦ï¼Œæ¯æ¬¡runtime.scheduleå’Œfindrunableæ—¶ç›´æ¥è¿è¡Œåˆ°æœŸçš„å®šæ—¶ä»»åŠ¡ã€‚ çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ï¼Ÿæ–°æ·»åŠ çš„å®šæ—¶ä»»åŠ¡çš„åˆ°æœŸæ—¶é—´æ›´å°æ—¶ï¼Œä¸ç®¡æ˜¯ä½¿ç”¨futexè¿˜æ˜¯epoll_waitç³»ç»Ÿè°ƒç”¨éƒ½ä¼šè¢«å”¤é†’é‡æ–°ä¼‘çœ ï¼Œè¢«å”¤é†’çš„çº¿ç¨‹ä¼šäº§ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ä½†ç”±äºgo1.14æ²¡æœ‰timerprocçš„å­˜åœ¨ï¼Œæ–°å®šæ—¶ä»»åŠ¡å¯ç›´æ¥æ’å…¥æˆ–å¤šæ¬¡æ’å…¥åå†è€ƒè™‘æ˜¯å¦ä¼‘çœ ã€‚ ç»“è®ºï¼Œgolang 1.13çš„å®šæ—¶å™¨åœ¨ä»»åŠ¡ç¹å¤šæ—¶ï¼Œå¿…ç„¶ä¼šé€ æˆæ›´å¤šçš„ä¸Šçº¿æ–‡åˆ‡æ¢åŠruntime pmgè°ƒåº¦ï¼Œè€Œgolang 1.14åšäº†æ›´å¥½çš„ä¼˜åŒ–ã€‚ ","date":"2021-07-01","objectID":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/:5:0","tags":["æºç è§£æ","time"],"title":"Goå®šæ—¶å™¨æºç åˆ†æ","uri":"/2021/07/go%E5%AE%9A%E6%97%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"é›¶ã€å‰è¨€ redisçš„ä¸»è¦çŸ¥è¯†ç‚¹ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:1:0","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"ä¸€ã€åŸºç¡€ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:2:0","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"1ã€redisæ˜¯ä»€ä¹ˆï¼Ÿ Redisæ˜¯ä¸€ä¸ªæ•°æ®åº“ï¼Œä¸è¿‡ä¸ä¼ ç»ŸRDBM(å…³ç³»å‹æ•°æ®åº“)ä¸åŒï¼ŒRediså±äºNoSQLï¼Œä¹Ÿå°±æ˜¯éå…³ç³»å‹æ•°æ®åº“ï¼Œå®ƒçš„å­˜å‚¨ç»“æ„æ˜¯Key-Valueã€‚Redisçš„æ•°æ®ç›´æ¥å­˜åœ¨å†…å­˜ä¸­ï¼Œè¯»å†™é€Ÿåº¦éå¸¸å¿«ï¼Œå› æ­¤ Redisè¢«å¹¿æ³›åº”ç”¨äºç¼“å­˜æ–¹å‘ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:2:1","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"2ã€NoSQLçš„BASEç†è®º BASEç†è®ºæ˜¯CAPä¸­ä¸€è‡´æ€§çš„å¦¥åã€‚å’Œä¼ ç»Ÿäº‹åŠ¡çš„ACIDæˆªç„¶ä¸åŒï¼ŒBASEä¸è¿½æ±‚å¼ºä¸€è‡´æ€§ï¼Œè€Œæ˜¯å…è®¸æ•°æ®åœ¨ä¸€æ®µæ—¶é—´å†…æ˜¯ä¸ä¸€è‡´çš„ï¼Œä½†æœ€ç»ˆè¾¾åˆ°ä¸€è‡´çŠ¶æ€ï¼Œä»è€Œè·å¾—æ›´é«˜çš„å¯ç”¨æ€§å’Œæ€§èƒ½ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:2:2","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"3ã€å¸¸ç”¨çš„rediså‘½ä»¤ è¯»æ“ä½œæ˜¯get aï¼Œè¡¨ç¤ºè·å–aå¯¹åº”çš„æ•°æ® å†™æ“ä½œæ˜¯setex a t bï¼Œè¡¨ç¤ºå°†açš„æ•°æ®è®¾ç½®ä¸ºbï¼Œå¹¶ä¸”åœ¨tç§’åè¿‡æœŸã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:2:3","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"4ã€Redisçš„è¿‡æœŸé”®æ¸…é™¤ç­–ç•¥ è¿‡æœŸé”®æ¸…é™¤ç­–ç•¥æœ‰ä¸‰ç§ï¼Œåˆ†åˆ«æ˜¯å®šæ—¶åˆ é™¤ã€å®šæœŸåˆ é™¤å’Œæƒ°æ€§åˆ é™¤ã€‚ å®šæ—¶åˆ é™¤ï¼Œæ˜¯åœ¨è®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´çš„åŒæ—¶ï¼Œåˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼Œè®©å®šæ—¶å™¨åœ¨é”®çš„è¿‡æœŸæ—¶é—´æ¥ä¸´æ—¶ï¼Œç«‹å³æ‰§è¡Œå¯¹é”®çš„åˆ é™¤æ“ä½œ å®šæœŸåˆ é™¤ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ï¼Œç¨‹åºå°±å¯¹æ•°æ®åº“è¿›è¡Œä¸€æ¬¡æ£€æŸ¥ï¼Œåˆ é™¤é‡Œé¢çš„è¿‡æœŸé”® æƒ°æ€§åˆ é™¤ï¼Œæ˜¯æŒ‡ä½¿ç”¨çš„æ—¶å€™ï¼Œå‘ç°Keyè¿‡æœŸäº†ï¼Œæ­¤æ—¶å†è¿›è¡Œåˆ é™¤ Redisè¿‡æœŸé”®é‡‡ç”¨çš„æ˜¯å®šæœŸåˆ é™¤+æƒ°æ€§åˆ é™¤äºŒè€…ç»“åˆçš„æ–¹å¼è¿›è¡Œåˆ é™¤çš„ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:2:4","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"5ã€å¦‚æœè¿‡æœŸé”®æ²¡æœ‰è¢«è®¿é—®ï¼Œè€Œå‘¨æœŸæ€§åˆ é™¤åˆè·Ÿä¸ä¸Šæ–°é”®äº§ç”Ÿçš„é€Ÿåº¦ï¼Œå†…å­˜ä¸å°±æ…¢æ…¢è€—å°½äº†å—ï¼Ÿ Redisæ”¯æŒå†…å­˜æ·˜æ±°ï¼Œé…ç½®å‚æ•°maxmemory_policyå†³å®šäº†å†…å­˜æ·˜æ±°ç­–ç•¥çš„ç­–ç•¥ã€‚è¿™ä¸ªå‚æ•°ä¸€å…±æœ‰8ä¸ªæšä¸¾å€¼ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:2:5","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"6ã€å†…å­˜æ·˜æ±°ç”¨åˆ°çš„æ˜¯LRUç®—æ³•ï¼Ÿ Redisç”¨çš„æ˜¯è¿‘ä¼¼LRUç®—æ³•ï¼ŒLRUç®—æ³•éœ€è¦ä¸€ä¸ªåŒå‘é“¾è¡¨æ¥è®°å½•æ•°æ®çš„æœ€è¿‘è¢«è®¿é—®é¡ºåºï¼Œä½†æ˜¯å‡ºäºèŠ‚çœå†…å­˜çš„è€ƒè™‘ï¼ŒRedisçš„LRUç®—æ³•å¹¶éå®Œæ•´çš„å®ç°ã€‚ Redisé€šè¿‡å¯¹å°‘é‡é”®è¿›è¡Œå–æ ·ï¼Œç„¶åå’Œç›®å‰ç»´æŒçš„æ·˜æ±°æ± ç»¼åˆæ¯”è¾ƒï¼Œå›æ”¶å…¶ä¸­çš„æœ€ä¹…æœªè¢«è®¿é—®çš„é”®ã€‚é€šè¿‡è°ƒæ•´æ¯æ¬¡å›æ”¶æ—¶çš„é‡‡æ ·æ•°é‡maxmemory-samplesï¼Œå¯ä»¥å®ç°è°ƒæ•´ç®—æ³•çš„ç²¾åº¦ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:2:6","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"äºŒã€æ•°æ®ç»“æ„ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:3:0","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"1ã€redisçš„æ•°æ®ç»“æ„ å¯¹å¤–æš´éœ²5ç§Rediså¯¹è±¡ï¼Œåˆ†åˆ«æ˜¯Stringã€Listã€Hashã€Setã€Zsetã€‚åº•å±‚å®ç°ä¾æ‰˜äºsdsã€ziplistã€skiplistã€dictç­‰æ›´åŸºç¡€æ•°æ®ç»“æ„ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:3:1","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"2ã€Rediså­—ç¬¦ä¸²çš„ç‰¹ç‚¹ Redisçš„å­—ç¬¦ä¸²å¦‚æœä¿å­˜çš„å¯¹è±¡æ˜¯æ•´æ•°ç±»å‹ï¼Œé‚£ä¹ˆå°±ç”¨intå­˜å‚¨ã€‚å¦‚æœä¸èƒ½ç”¨æ•´æ•°è¡¨ç¤ºï¼Œå°±ç”¨SDSæ¥è¡¨ç¤ºï¼ŒSDSé€šè¿‡è®°å½•é•¿åº¦ï¼Œå’Œé¢„åˆ†é…ç©ºé—´ï¼Œå¯ä»¥é«˜æ•ˆè®¡ç®—é•¿åº¦ï¼Œè¿›è¡Œappendæ“ä½œã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:3:2","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"3ã€hashæ‰©å®¹è¿‡ç¨‹ ä¸¤å¼ Hashè¡¨ï¼Œå¹³å¸¸èµ·ä½œç”¨çš„éƒ½æ˜¯0å·è¡¨ï¼Œå½“è£…è½½å› å­è¶…è¿‡é˜ˆå€¼æ—¶å°±ä¼šè¿›è¡ŒRehashï¼Œå°†0å·æ¯ä¸Šæ¯ä¸€ä¸ªbucketæ…¢æ…¢ç§»åŠ¨åˆ°1å·è¡¨ï¼Œæ‰€ä»¥å«æ¸è¿›å¼Rehashï¼Œè¿™ç§æ–¹å¼å¯ä»¥å‡å°‘è¿ç§»ç³»ç»Ÿçš„å½±å“ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:3:3","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"4ã€rehashè¿‡ç¨‹ å½“å‘¨æœŸå‡½æ•°å‘ç°ä¸ºè£…è½½å› å­è¶…è¿‡é˜ˆå€¼æ—¶å°±ä¼šè¿›è¡ŒRehashã€‚Rehashçš„æµç¨‹å¤§æ¦‚åˆ†æˆä¸‰æ­¥ã€‚ é¦–å…ˆï¼Œç”Ÿæˆæ–°Hashè¡¨ht[1]ï¼Œä¸º ht[1] åˆ†é…ç©ºé—´ã€‚æ­¤æ—¶å­—å…¸åŒæ—¶æŒæœ‰ht[0]å’Œht[1]ä¸¤ä¸ªå“ˆå¸Œè¡¨ã€‚å­—å…¸çš„åç§»ç´¢å¼•ä»é™é»˜çŠ¶æ€-1ï¼Œè®¾ç½®ä¸º0ï¼Œè¡¨ç¤ºRehash å·¥ä½œæ­£å¼å¼€å§‹ã€‚ ç„¶åï¼Œè¿ç§»ht[0]æ•°æ®åˆ°ht[1]ã€‚åœ¨ Rehashè¿›è¡ŒæœŸé—´ï¼Œæ¯æ¬¡å¯¹å­—å…¸æ‰§è¡Œå¢åˆ æŸ¥æ”¹æ“ä½œï¼Œç¨‹åºä¼šé¡ºå¸¦è¿ç§»ä¸€ä¸ªht[0]ä¸Šçš„æ•°æ®ï¼Œå¹¶æ›´æ–°åç§»ç´¢å¼•ã€‚ä¸æ­¤åŒæ—¶ï¼Œå‘¨æœŸå‡½æ•°ä¹Ÿä¼šå®šæ—¶è¿ç§»ä¸€æ‰¹ã€‚ æœ€åï¼Œht[1]å’Œht[0]æŒ‡é’ˆå¯¹è±¡äº¤æ¢ã€‚éšç€å­—å…¸æ“ä½œçš„ä¸æ–­æ‰§è¡Œï¼Œ æœ€ç»ˆåœ¨æŸä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œht[0]çš„æ‰€æœ‰é”®å€¼å¯¹éƒ½ä¼šè¢«Rehashè‡³ ht[1]ï¼Œæ­¤æ—¶å†å°†ht[1]å’Œht[0]æŒ‡é’ˆå¯¹è±¡äº’æ¢ï¼ŒåŒæ—¶æŠŠåç§»ç´¢å¼•çš„å€¼è®¾ä¸º-1ï¼Œè¡¨ç¤ºRehashæ“ä½œå·²å®Œæˆã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:3:4","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"5ã€å¦‚æœå­—å…¸æ­£åœ¨Rehashï¼Œæ­¤æ—¶æœ‰è¯·æ±‚è¿‡æ¥ï¼ŒRedisä¼šæ€ä¹ˆå¤„ç†ï¼Ÿ é’ˆå¯¹æ–°å¢Keyï¼Œæ˜¯å¾€ht[1]é‡Œé¢æ’å…¥ã€‚é’ˆå¯¹è¯»è¯·æ±‚ï¼Œå…ˆä»ht[0]è¯»ï¼Œæ²¡æ‰¾åˆ°å†å»ht[1]æ‰¾ã€‚è‡³äºåˆ é™¤å’Œæ›´æ–°ï¼Œå…¶å®æœ¬è´¨æ˜¯å…ˆæ‰¾åˆ°ä½ç½®ï¼Œå†è¿›è¡Œæ“ä½œï¼Œæ‰€ä»¥å’Œè¯»è¯·æ±‚ä¸€æ ·ï¼Œå…ˆæ‰¾ht[0]ï¼Œå†æ‰¾ht[1]ï¼Œæ‰¾åˆ°ä¹‹åå†è¿›è¡Œæ“ä½œã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:3:5","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"6ã€è·³è¡¨çš„å®ç° è·³è¡¨æœ¬è´¨ä¸Šæ˜¯å¯¹é“¾è¡¨çš„ä¸€ç§ä¼˜åŒ–ï¼Œé€šè¿‡é€å±‚è·³æ­¥é‡‡æ ·çš„æ–¹å¼æ„å»ºç´¢å¼•ï¼Œä»¥åŠ å¿«æŸ¥æ‰¾é€Ÿåº¦ã€‚å¦‚æœåªç”¨æ™®é€šé“¾è¡¨ï¼Œåªèƒ½ä¸€ä¸ªä¸€ä¸ªå¾€åæ‰¾ã€‚è·³è¡¨å°±ä¸ä¸€æ ·äº†ï¼Œå¯ä»¥é«˜å±‚ç´¢å¼•ï¼Œä¸€æ¬¡è·³è·ƒå¤šä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœæ‰¾è¿‡å¤´äº†ï¼Œå°±ç”¨æ›´ä¸‹å±‚çš„ç´¢å¼•ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:3:6","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"7ã€æ¯ä¸ªèŠ‚ç‚¹æœ‰å¤šå°‘å±‚ï¼Ÿ ä½¿ç”¨æ¦‚ç‡å‡è¡¡çš„æ€è·¯ï¼Œç¡®å®šæ–°æ’å…¥èŠ‚ç‚¹çš„å±‚æ•°ã€‚Redisä½¿ç”¨éšæœºå‡½æ•°å†³å®šå±‚æ•°ã€‚ç›´è§‚ä¸Šæ¥è¯´ï¼Œé»˜è®¤1å±‚ï¼Œå’Œä¸¢ç¡¬å¸ä¸€æ ·ï¼Œå¦‚æœæ˜¯æ­£é¢å°±ç»§ç»­å¾€ä¸Šï¼Œè¿™æ ·æŒç»­è¿­ä»£ï¼Œæœ€å¤§å±‚æ•°32å±‚ã€‚ 50%çš„æ¦‚ç‡è¢«åˆ†é…åˆ°ç¬¬ä¸€å±‚ï¼Œ25%çš„æ¦‚ç‡è¢«åˆ†é…åˆ°ç¬¬äºŒå±‚ï¼Œ12.5%çš„æ¦‚ç‡è¢«åˆ†é…åˆ°ç¬¬ä¸‰å±‚ã€‚è¿™ç§æ–¹å¼ä¿è¯äº†è¶Šä¸Šå±‚æ•°é‡è¶Šå°‘ï¼Œè‡ªç„¶è·¨è¶Šèµ·æ¥è¶Šæ–¹ä¾¿ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:3:7","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"8ã€Redisçš„Zsetä¸ºä»€ä¹ˆåŒæ—¶éœ€è¦å­—å…¸å’Œè·³è¡¨æ¥å®ç° Zsetæ˜¯ä¸€ä¸ªæœ‰åºåˆ—è¡¨ï¼Œå­—å…¸å’Œè·³è¡¨åˆ†åˆ«å¯¹åº”ä¸¤ç§æŸ¥è¯¢åœºæ™¯ï¼Œ**å­—å…¸ç”¨æ¥æ”¯æŒæŒ‰æˆå‘˜æŸ¥è¯¢æ•°æ®ï¼Œè·³è¡¨åˆ™ç”¨ä»¥å®ç°é«˜æ•ˆçš„èŒƒå›´æŸ¥è¯¢ï¼Œ**è¿™æ ·ä¸¤ä¸ªåœºæ™¯ï¼Œæ€§èƒ½éƒ½åšåˆ°äº†æè‡´ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:3:8","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"ä¸‰ã€ç³»ç»Ÿå®¹ç¾ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:4:0","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"1ã€Redisæ˜¯åŸºäºå†…å­˜çš„å­˜å‚¨ï¼Œå¦‚æœæœåŠ¡é‡å¯ï¼Œæ•°æ®ä¸å°±ä¸¢å¤±äº†å—ï¼Ÿ å¯ä»¥é€šè¿‡æŒä¹…åŒ–æœºåˆ¶ï¼Œå¤‡ä»½æ•°æ®ã€‚ æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯å¼€å¯RDBï¼ŒRDBæ˜¯Redisçš„äºŒè¿›åˆ¶å¿«ç…§æ–‡ä»¶ï¼Œä¼˜ç‚¹æ˜¯æ–‡ä»¶ç´§å‡‘ï¼Œå ç”¨ç©ºé—´å°ï¼Œæ¢å¤é€Ÿåº¦æ¯”è¾ƒå¿«ã€‚åŒæ—¶ï¼Œç”±äºæ˜¯å­è¿›ç¨‹Forkçš„æ¨¡å¼ï¼Œå¯¹Redisæœ¬èº«è¯»å†™æ€§èƒ½çš„å½±å“å¾ˆå°ã€‚ å¦ä¸€ç§æ–¹å¼æ˜¯AOFï¼ŒAOFä¸­è®°å½•äº†Redisçš„æ“ä½œå‘½ä»¤ï¼Œå¯ä»¥é‡æ”¾è¯·æ±‚æ¢å¤ç°åœºï¼ŒAOFçš„æ–‡ä»¶ä¼šæ¯”RDBå¤§å¾ˆå¤šã€‚ å‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œå¦‚æœå¼€å¯äº†AOFï¼Œä¼šå°†å‘½ä»¤å…ˆè®°å½•åœ¨AOFç¼“å†²ï¼Œä¹‹åå†åˆ·å…¥ç£ç›˜ã€‚æ•°æ®åˆ·å…¥ç£ç›˜çš„ æ—¶æœºæ ¹æ®å‚æ•°å†³å®šï¼Œæœ‰ä¸‰ç§æ¨¡å¼ï¼š1.å…³é—­æ—¶åˆ·å…¥ï¼›2.æ¯ç§’å®šæœŸåˆ·å…¥ï¼›3.æ‰§è¡Œå‘½ä»¤åç«‹åˆ»è§¦å‘ã€‚ AOFçš„ä¼˜ç‚¹æ˜¯æ•…éšœæƒ…å†µä¸‹ï¼Œä¸¢å¤±çš„æ•°æ®ä¼šæ¯”RDBæ›´å°‘ã€‚å¦‚æœæ˜¯æ‰§è¡Œå‘½ä»¤åç«‹é©¬åˆ·å…¥ï¼ŒAOFä¼šæ‹–ç´¯æ‰§è¡Œé€Ÿåº¦ï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½æ˜¯é…ç½®ä¸ºæ¯ç§’å®šæœŸåˆ·å…¥ï¼Œè¿™æ ·å¯¹æ€§èƒ½å½±å“ä¸ä¼šå¾ˆå¤§ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:4:1","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"2ã€è¿™æ ·çœ‹èµ·æ¥ï¼ŒAOFæ–‡ä»¶ä¼šè¶Šæ¥è¶Šå¤§ï¼Œæœ€åç£ç›˜éƒ½è£…ä¸ä¸‹ ä¸ä¼šçš„ï¼ŒRediså¯ä»¥åœ¨AOFæ–‡ä»¶ä½“ç§¯å˜å¾—è¿‡å¤§æ—¶ï¼Œè‡ªåŠ¨åœ°åœ¨åå°Forkä¸€ä¸ªå­è¿›ç¨‹ï¼Œä¸“é—¨å¯¹AOFè¿›è¡Œé‡å†™ã€‚è¯´ç™½äº†ï¼Œå°±æ˜¯é’ˆå¯¹ç›¸åŒKeyçš„æ“ä½œï¼Œè¿›è¡Œåˆå¹¶ï¼Œæ¯”å¦‚åŒä¸€ä¸ªKeyçš„setæ“ä½œï¼Œé‚£å°±æ˜¯åé¢è¦†ç›–å‰é¢ã€‚ åœ¨é‡å†™è¿‡ç¨‹ä¸­ï¼ŒRedisä¸ä½†å°†æ–°çš„æ“ä½œè®°å½•åœ¨åŸæœ‰çš„AOFç¼“å†²åŒºï¼Œè€Œä¸”è¿˜ä¼šè®°å½•åœ¨AOFé‡å†™ç¼“å†²åŒºã€‚ä¸€æ—¦æ–°AOFæ–‡ä»¶åˆ›å»ºå®Œæ¯•ï¼ŒRedis å°±ä¼šå°†é‡å†™ç¼“å†²åŒºå†…å®¹ï¼Œè¿½åŠ åˆ°æ–°çš„AOFæ–‡ä»¶ï¼Œå†ç”¨æ–°AOFæ–‡ä»¶æ›¿æ¢åŸæ¥çš„AOFæ–‡ä»¶ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:4:2","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"3ã€Redisæœºå™¨æŒ‚æ‰æ€ä¹ˆåŠï¼Ÿ å¯ä»¥ç”¨ä¸»ä»æ¨¡å¼éƒ¨ç½²ï¼Œå³æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå¤‡ç”¨æœºå™¨ï¼Œå¤‡ç”¨æœºä¼šä½œä¸ºSlaveåŒæ­¥Masterçš„æ•°æ®ï¼Œåœ¨Rediså‡ºç°é—®é¢˜çš„æ—¶å€™ï¼ŒæŠŠSlaveå‡çº§ä¸ºMasterã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:4:3","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"4ã€ä¸»ä»å¯ä»¥è‡ªåŠ¨åˆ‡æ¢å—ï¼Ÿ æœ¬èº«æ˜¯ä¸èƒ½ï¼Œä½†å¯ä»¥å†™è„šæœ¬å®ç°ï¼Œåªæ˜¯éœ€è¦è€ƒè™‘çš„é—®é¢˜æ¯”è¾ƒå¤šã€‚Rediså·²ç»æœ‰äº†ç°æˆçš„è§£å†³æ–¹æ¡ˆï¼šå“¨å…µæ¨¡å¼ã€‚å“¨å…µæ¥ç›‘æµ‹RedisæœåŠ¡æ˜¯å¦æ­£å¸¸ï¼Œå¼‚å¸¸æƒ…å†µä¸‹ï¼Œç”±å“¨å…µä»£ç†åˆ‡æ¢ã€‚ä¸ºé¿å…å“¨å…µæˆä¸ºå•ç‚¹ï¼Œå“¨å…µä¹Ÿéœ€è¦å¤šæœºéƒ¨ç½² ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:4:4","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"5ã€å¦‚æœMasteræŒ‚æ‰ï¼Œä¼šé€‰æ‹©å“ªä¸ªSlaveå‘¢ï¼Ÿ å½“å“¨å…µé›†ç¾¤é€‰ä¸¾å‡ºå“¨å…µLeaderåï¼Œç”±å“¨å…µLeaderä»Redisä»èŠ‚ç‚¹ä¸­é€‰æ‹©ä¸€ä¸ªRedisèŠ‚ç‚¹ä½œä¸ºä¸»èŠ‚ç‚¹ï¼š 1ã€è¿‡æ»¤æ•…éšœçš„èŠ‚ç‚¹ï¼› 2ã€é€‰æ‹©ä¼˜å…ˆçº§slave-priorityæœ€å¤§çš„ä»èŠ‚ç‚¹ä½œä¸ºä¸»èŠ‚ç‚¹ï¼Œå¦‚ä¸å­˜åœ¨ï¼Œåˆ™ç»§ç»­ 3ã€é€‰æ‹©å¤åˆ¶åç§»é‡æœ€å¤§çš„ä»èŠ‚ç‚¹ä½œä¸ºä¸»èŠ‚ç‚¹ï¼Œå¦‚æœéƒ½ä¸€æ ·ï¼Œåˆ™ç»§ç»­ã€‚è¿™é‡Œè§£é‡Šä¸‹ï¼Œæ•°æ®åç§»é‡è®°å½•å†™äº†å¤šå°‘æ•°æ®ï¼Œä¸»æœåŠ¡å™¨ä¼šæŠŠåç§»é‡åŒæ­¥ç»™ä»æœåŠ¡å™¨ï¼Œå½“ä¸»ä»çš„åç§»é‡ä¸€è‡´ï¼Œåˆ™æ•°æ®æ˜¯å®Œå…¨åŒæ­¥ 4ã€é€‰æ‹©runidæœ€å°çš„ä»èŠ‚ç‚¹ä½œä¸ºä¸»èŠ‚ç‚¹ã€‚Redisæ¯æ¬¡å¯åŠ¨çš„æ—¶å€™ç”Ÿæˆéšæœºçš„runidä½œä¸ºRedisçš„æ ‡è¯† ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:4:5","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"6ã€å“¨å…µLeaderï¼Œé‚£å®ƒæ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿ æ¯ä¸€ä¸ªå“¨å…µèŠ‚ç‚¹éƒ½å¯ä»¥æˆä¸ºLeaderï¼Œå½“ä¸€ä¸ªå“¨å…µèŠ‚ç‚¹ç¡®è®¤Redisé›†ç¾¤çš„ä¸»èŠ‚ç‚¹ä¸»è§‚ä¸‹çº¿åï¼Œä¼šè¯·æ±‚å…¶ä»–å“¨å…µèŠ‚ç‚¹è¦æ±‚å°†è‡ªå·±é€‰ä¸¾ä¸ºLeaderã€‚è¢«è¯·æ±‚çš„å“¨å…µèŠ‚ç‚¹å¦‚æœæ²¡æœ‰åŒæ„è¿‡å…¶ä»–å“¨å…µèŠ‚ç‚¹çš„é€‰ä¸¾è¯·æ±‚ï¼Œåˆ™åŒæ„è¯¥è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯é€‰ä¸¾ç¥¨æ•°+1ï¼Œå¦åˆ™ä¸åŒæ„ã€‚ å¦‚æœä¸€ä¸ªå“¨å…µèŠ‚ç‚¹è·å¾—çš„é€‰ä¸¾ç¥¨æ•°è¶…è¿‡èŠ‚ç‚¹æ•°çš„ä¸€åŠï¼Œä¸”å¤§äºquorumé…ç½®çš„å€¼ï¼Œåˆ™è¯¥å“¨å…µèŠ‚ç‚¹é€‰ä¸¾ä¸ºLeaderï¼›å¦åˆ™é‡æ–°è¿›è¡Œé€‰ä¸¾ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:4:6","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"å››ã€æ€§èƒ½ä¼˜åŒ– ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:5:0","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"1ã€redisæ€§èƒ½ åªèƒ½è¯´åœ¨åä¸‡çº§ã€‚ä½¿ç”¨ä¹‹å‰ï¼Œè¦è·‘BenchMarkï¼Œå®é™…æƒ…å†µä¸‹ä¼šå—å¸¦å®½ã€è´Ÿè½½ã€å•ä¸ªæ•°æ®å¤§å°ã€æ˜¯å¦å¼€å¯å¤šçº¿ç¨‹ç­‰å› ç´ å½±å“ï¼Œè„±å¼€å…·ä½“åœºæ™¯è°ˆæ€§èƒ½ï¼Œå°±æ²¡æœ‰æ„ä¹‰ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:5:1","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"2ã€Redisæ€§èƒ½è¿™ä¹ˆé«˜ï¼Œé‚£å®ƒæ˜¯åç¨‹æ¨¡å‹ï¼Œè¿˜æ˜¯å¤šçº¿ç¨‹æ¨¡å‹ Redisæ˜¯å•çº¿ç¨‹Reactoræ¨¡å‹ï¼Œé€šè¿‡é«˜æ•ˆçš„IOå¤ç”¨ä»¥åŠå†…å­˜å¤„ç†å®ç°é«˜æ€§èƒ½ã€‚å¦‚æœæ˜¯6.0ä¹‹å‰æˆ‘ä¼šæ¯«ä¸çŠ¹è±«è¯´æ˜¯å•çº¿ç¨‹ï¼Œ6.0ä¹‹åï¼Œæˆ‘è¿˜æ˜¯ä¼šè¯´å•çº¿ç¨‹ï¼Œä½†ä¼šè¡¥å……ä¸€å¥ï¼ŒIOè§£åŒ…é€šè¿‡å¤šçº¿ç¨‹è¿›è¡Œäº†ä¼˜åŒ–ï¼Œè€Œå¤„ç†é€»è¾‘ï¼Œè¿˜æ˜¯å•çº¿ç¨‹ã€‚ å¦å¤–ï¼Œå¦‚æœè€ƒè™‘åˆ°RDBçš„Forkï¼Œä¸€äº›å®šæ—¶ä»»åŠ¡çš„å¤„ç†ï¼Œé‚£ä¹ˆRedisä¹Ÿå¯ä»¥è¯´å¤šè¿›ç¨‹ï¼Œè¿™æ²¡æœ‰é—®é¢˜ã€‚ä½†æ˜¯Rediså¯¹æ•°æ®çš„å¤„ç†ï¼Œè‡³å§‹è‡³ç»ˆï¼Œéƒ½æ˜¯å•çº¿ç¨‹ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:5:2","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"3ã€6.0ç‰ˆæœ¬å‘å¸ƒçš„å¤šçº¿ç¨‹åŠŸèƒ½ å¤šçº¿ç¨‹åŠŸèƒ½ï¼Œä¸»è¦ç”¨äºæé«˜è§£åŒ…çš„æ•ˆç‡ã€‚å’Œä¼ ç»Ÿçš„Multi Reactorå¤šçº¿ç¨‹æ¨¡å‹ä¸åŒï¼ŒRedisçš„å¤šçº¿ç¨‹åªè´Ÿè´£å¤„ç†ç½‘ç»œIOçš„è§£åŒ…å’Œåè®®è½¬æ¢ï¼Œä¸€æ–¹é¢æ˜¯å› ä¸ºRedisçš„å•çº¿ç¨‹å¤„ç†è¶³å¤Ÿå¿«ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿæ˜¯ä¸ºäº†å…¼å®¹æ€§åšè€ƒè™‘ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:5:3","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"4ã€å¦‚æœæ•°æ®å¤ªå¤§ï¼ŒRediså­˜ä¸ä¸‹äº†æ€ä¹ˆåŠ ä½¿ç”¨é›†ç¾¤æ¨¡å¼ã€‚ä¹Ÿå°±æ˜¯å°†æ•°æ®åˆ†ç‰‡ï¼Œä¸åŒçš„Keyæ ¹æ®Hashè·¯ç”±åˆ°ä¸åŒçš„èŠ‚ç‚¹ã€‚é›†ç¾¤ç´¢å¼•æ˜¯é€šè¿‡ä¸€è‡´æ€§Hashç®—æ³•æ¥å®Œæˆï¼Œè¿™ç§ç®—æ³•å¯ä»¥è§£å†³æœåŠ¡å™¨æ•°é‡å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰çš„æœåŠ¡å™¨ç¼“å­˜åœ¨åŒä¸€æ—¶é—´å¤±æ•ˆçš„é—®é¢˜ã€‚ åŒæ—¶ï¼ŒåŸºäºGossipåè®®ï¼Œé›†ç¾¤çŠ¶æ€å˜åŒ–æ—¶ï¼Œå¦‚æ–°èŠ‚ç‚¹åŠ å…¥ã€èŠ‚ç‚¹å®•æœºã€Slaveæå‡ä¸ºæ–°Masterï¼Œè¿™äº›å˜åŒ–éƒ½èƒ½ä¼ æ’­åˆ°æ•´ä¸ªé›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹å¹¶è¾¾æˆä¸€è‡´ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:5:4","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"5ã€ä¸€è‡´æ€§Hash ä¼ ç»Ÿçš„Hashåˆ†ç‰‡ï¼Œå¯ä»¥å°†æŸä¸ªKeyï¼Œè½åˆ°æŸä¸ªèŠ‚ç‚¹ã€‚ä½†æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå½“èŠ‚ç‚¹æ‰©å®¹æˆ–è€…ç¼©å®¹ï¼Œè·¯ç”±ä¼šè¢«å®Œå…¨æ‰“ä¹±ã€‚å¦‚æœæ˜¯ç¼“å­˜åœºæ™¯ï¼Œå¾ˆå®¹æ˜“é€ æˆç¼“å­˜é›ªå´©é—®é¢˜ã€‚ ä¸ºäº†ä¼˜åŒ–è¿™ç§æƒ…å†µï¼Œä¸€è‡´æ€§Hashå°±åº”è¿è€Œç”Ÿäº†ã€‚ä¸€è‡´æ€§Hashæ˜¯è¯´å°†æ•°æ®å’ŒæœåŠ¡å™¨ï¼Œä»¥ç›¸åŒçš„Hashå‡½æ•°ï¼Œæ˜ å°„åˆ°åŒä¸€ä¸ªHashç¯ä¸Šï¼Œé’ˆå¯¹ä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨å“ˆå¸Œç¯ä¸Šé¡ºæ—¶é’ˆæŸ¥æ‰¾è·å…¶æœ€è¿‘çš„æœºå™¨ï¼Œè¿™ä¸ªæœºå™¨å°±è´Ÿè´£å¤„ç†è¯¥å¯¹è±¡çš„ç›¸å…³è¯·æ±‚ã€‚ è¿™ç§æƒ…å†µä¸‹ï¼Œå¢åŠ èŠ‚ç‚¹ï¼Œåªä¼šåˆ†æµåé¢ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®ã€‚å‡å°‘èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¯·æ±‚ä¼šç”±åä¸€ä¸ªèŠ‚ç‚¹ç»§æ‰¿ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒèŠ‚ç‚¹å˜åŒ–æ“ä½œï¼Œæœ€å¤šåªä¼šå½±å“åé¢ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:5:5","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"äº”ã€åº”ç”¨åœºæ™¯ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:6:0","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"1ã€Redisç»å¸¸ç”¨ä½œç¼“å­˜ï¼Œé‚£æ•°æ®ä¸€è‡´æ€§æ€ä¹ˆä¿è¯ï¼Ÿ ä»è®¾è®¡æ€è·¯æ¥è¯´ï¼Œæœ‰Cache Asideå’ŒRead/Write Throughä¸¤ç§æ¨¡å¼ï¼Œå‰è€…æ˜¯æŠŠç¼“å­˜è´£ä»»äº¤ç»™åº”ç”¨å±‚ï¼Œåè€…æ˜¯å°†ç¼“å­˜çš„è´£ä»»ï¼Œæ”¾ç½®åˆ°æœåŠ¡æä¾›æ–¹ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:6:1","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"2ã€å“ªç§æ¨¡å¼æ›´å¥½ ä¸¤ç§æ¨¡å¼å„æœ‰ä¼˜ç¼ºç‚¹ï¼Œä»é€æ˜æ€§è€ƒè™‘ï¼ŒæœåŠ¡æ–¹æ¯”è¾ƒåˆé€‚ï¼›å¦‚æœä»æ€§èƒ½æè‡´æ¥è¯´ï¼Œä¸šåŠ¡æ–¹ä¼šæ›´æœ‰ä¼˜åŠ¿ï¼Œæ¯•ç«Ÿå¯ä»¥å‡å»æœåŠ¡RPCçš„æŸè€—ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:6:2","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"3ã€å¦‚æœæ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œå¦‚ä½•æ›´æ–°ç¼“å­˜ æ›´æ–°æ–¹å¼çš„è¯ï¼Œå¤§æ¦‚æœ‰å››ç§ï¼š 1ã€æ•°æ®å­˜åˆ°æ•°æ®åº“ä¸­ï¼ŒæˆåŠŸåï¼Œå†è®©ç¼“å­˜å¤±æ•ˆï¼Œç­‰åˆ°è¯»ç¼“å­˜ä¸å‘½ä¸­çš„æ—¶å€™ï¼Œå†åŠ è½½è¿›å»ï¼› 2ã€é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—æ›´æ–°ç¼“å­˜ 3ã€å…ˆæ›´æ–°ç¼“å­˜ï¼Œå†æ›´æ–°æœåŠ¡ï¼Œè¿™ç§æƒ…å†µç›¸å½“äºæŠŠCacheä¹ŸåšBufferç”¨ 4ã€èµ·ä¸€ä¸ªåŒæ­¥æœåŠ¡ï¼Œä½œä¸ºMySQLä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œé€šè¿‡è§£æbinlogåŒæ­¥é‡è¦ç¼“å­˜ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:6:3","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"4ã€ç¼“å­˜é›ªå´© ç¼“å­˜é›ªå´©è¡¨ç¤ºåœ¨æŸä¸€æ—¶é—´æ®µï¼Œç¼“å­˜é›†ä¸­å¤±æ•ˆï¼Œå¯¼è‡´è¯·æ±‚å…¨éƒ¨èµ°æ•°æ®åº“ï¼Œæœ‰å¯èƒ½æå®æ•°æ®åº“ï¼Œä½¿æ•´ä¸ªæœåŠ¡ç˜«ç—ªã€‚é›ªå´©åŸå› ä¸€èˆ¬æ˜¯ç”±äºç¼“å­˜è¿‡æœŸæ—¶é—´è®¾ç½®å¾—ç›¸åŒé€ æˆçš„ã€‚ é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œå¯ä»¥å€Ÿé‰´ETCDä¸­Rafté€‰ä¸¾çš„ä¼˜åŒ–ï¼Œè®©è¿‡æœŸæ—¶é—´éšæœºåŒ–ï¼Œé¿å…åŒä¸€æ‰¹è¯·æ±‚ï¼Œåœ¨åŒä¸€æ—¶é—´è¿‡æœŸã€‚å¦ä¸€æ–¹é¢ï¼Œè¿˜å¯ä»¥ä¸šåŠ¡å±‚é¢å®¹ç¾ï¼Œä¸ºçƒ­ç‚¹æ•°æ®ä½¿ç”¨åŒç¼“å­˜ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:6:4","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"5ã€ç¼“å­˜ç©¿é€ ç¼“å­˜ç©¿é€æŒ‡è¯·æ±‚æ•°æ®åº“é‡Œé¢æ ¹æœ¬æ²¡æœ‰çš„æ•°æ®ï¼Œé«˜é¢‘è¯·æ±‚ä¸å­˜åœ¨çš„Keyï¼Œæœ‰å¯èƒ½æ˜¯æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘ï¼Œä½†æ›´å¯èƒ½çš„ï¼Œæ˜¯é»‘å®¢çš„æ”»å‡»ã€‚ å¯ä»¥ç”¨å¸ƒéš†è¿‡æ»¤å™¨æ¥åº”å¯¹ï¼Œå¸ƒéš†è¿‡æ»¤å™¨æ˜¯ä¸€ç§æ¯”è¾ƒå·§å¦™çš„æ¦‚ç‡å‹æ•°æ®ç»“æ„ï¼Œç‰¹ç‚¹æ˜¯é«˜æ•ˆåœ°æ’å…¥å’ŒæŸ¥è¯¢ï¼Œå¯ä»¥ç”¨æ¥å‘Šè¯‰æˆ‘ä»¬ æŸæ ·ä¸œè¥¿ä¸€å®šä¸å­˜åœ¨æˆ–è€…å¯èƒ½å­˜åœ¨ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:6:5","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"6ã€å¸ƒéš†è¿‡æ»¤å™¨çš„å®ç° å¸ƒéš†è¿‡æ»¤å™¨åº•å±‚æ˜¯ä¸€ä¸ª64ä½çš„æ•´å‹ï¼Œå°†å­—ç¬¦ä¸²ç”¨å¤šä¸ªHashå‡½æ•°æ˜ å°„ä¸åŒçš„äºŒè¿›åˆ¶ä½ç½®ï¼Œå°†æ•´å‹ä¸­å¯¹åº”ä½ç½®è®¾ç½®ä¸º1ã€‚ åœ¨æŸ¥è¯¢çš„æ—¶å€™ï¼Œå¦‚æœä¸€ä¸ªå­—ç¬¦ä¸²æ‰€æœ‰Hashå‡½æ•°æ˜ å°„çš„å€¼éƒ½å­˜åœ¨ï¼Œé‚£ä¹ˆæ•°æ®å¯èƒ½å­˜åœ¨ã€‚ä¸ºä»€ä¹ˆè¯´å¯èƒ½å‘¢ï¼Œå°±æ˜¯å› ä¸ºå…¶ä»–å­—ç¬¦å¯èƒ½å æ®è¯¥å€¼ï¼Œæå‰ç‚¹äº®ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œå¸ƒéš†è¿‡æ»¤å™¨ä¼˜ç¼ºç‚¹éƒ½å¾ˆæ˜æ˜¾ï¼Œä¼˜ç‚¹æ˜¯ç©ºé—´ã€æ—¶é—´æ¶ˆè€—éƒ½å¾ˆå°ï¼Œç¼ºç‚¹æ˜¯ç»“æœä¸æ˜¯å®Œå…¨å‡†ç¡®ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:6:6","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"7ã€ç¼“å­˜å‡»ç©¿ æŒ‡æŸä¸€çƒ­é”®ï¼Œè¢«è¶…é«˜çš„å¹¶å‘è®¿é—®ï¼Œåœ¨å¤±æ•ˆçš„ä¸€ç¬é—´ï¼Œè¿˜æ²¡æ¥å¾—åŠé‡æ–°äº§ç”Ÿï¼Œå°±æœ‰æµ·é‡æ•°æ®ï¼Œç›´è¾¾æ•°æ®åº“ã€‚ è¿™ç§æƒ…å†µå’Œç¼“å­˜é›ªå´©çš„ä¸åŒä¹‹å¤„ï¼Œåœ¨äºé›ªå´©æ˜¯å¤§é‡ç¼“å­˜èµ¶å·§å„¿ä¸€èµ·è¿‡æœŸï¼Œå‡»ç©¿åªæ˜¯å•ä¸ªè¶…çƒ­é”®å¤±æ•ˆã€‚ è¿™ç§è¶…é«˜é¢‘Keyï¼Œå¯ä»¥è®©å®ƒä¸è¿‡æœŸï¼Œå†å•ç‹¬å®ç°æ•°æ®åŒæ­¥é€»è¾‘ï¼Œæ¥ç»´æŠ¤æ•°æ®çš„ä¸€è‡´æ€§ã€‚å½“ç„¶ï¼Œæ— è®ºå¦‚ä½•ï¼Œå¯¹åç«¯è‚¯å®šæ˜¯éœ€è¦é™é¢‘çš„ï¼Œä¸ç„¶å¦‚æœRedisæ•°æ®ä¸¢å¤±ï¼Œæ•°æ®åº“è¿˜æ˜¯ä¼šè¢«æ‰“å´©ã€‚é™é¢‘æ–¹å¼å¯ä»¥æ˜¯åˆ†å¸ƒå¼é”æˆ–åˆ†å¸ƒå¼ä»¤ç‰Œæ¡¶ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:6:7","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"8ã€redisæ¶ˆæ¯é˜Ÿåˆ— Redisæœ¬èº«æ²¡æœ‰æ”¯æŒAMQPè§„èŒƒï¼Œæ¶ˆæ¯å¯é æ€§ä¸å¼ºã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:6:8","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"9ã€redisåœ¨ç§’æ€åœºæ™¯çš„åº”ç”¨ Redisä¸»è¦æ˜¯èµ·åˆ°é€‰æ‹”æµé‡çš„ä½œç”¨ï¼Œè®°å½•å•†å“æ€»æ•°ï¼Œè¿˜æœ‰å°±æ˜¯å·²ä¸‹å•æ•°ï¼Œç­‰è¾¾åˆ°æ€»æ•°ä¹‹åæ‹¦æˆªæ‰€æœ‰è¯·æ±‚ã€‚å¯ä»¥å¤šæ”¾äº›è¯·æ±‚è¿›æ¥ï¼Œç„¶åå¡å…¥æ¶ˆæ¯é˜Ÿåˆ—ã€‚ èš‚èšé‡‘æœçš„äº‘Redisæåˆ°æ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥ç”¨Redisæ¥å®ç°ï¼Œä½†æˆ‘è§‰å¾—æ›´å¥½çš„æ–¹å¼æ˜¯ç”¨Kafkaè¿™ç§æ ‡å‡†æ¶ˆæ¯é˜Ÿåˆ—ç»„ä»¶ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:6:9","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"10ã€redisåˆ†å¸ƒå¼é” é”æ˜¯è®¡ç®—æœºé¢†åŸŸä¸€ä¸ªéå¸¸å¸¸è§çš„æ¦‚å¿µï¼Œåˆ†å¸ƒå¼é”ä¹Ÿä¾èµ–å­˜å‚¨ç»„ä»¶ï¼Œé’ˆå¯¹è¯·æ±‚é‡çš„ä¸åŒï¼Œå¯ä»¥é€‰æ‹©Etcdã€MySQLã€Redisç­‰ã€‚å‰ä¸¤è€…å¯é æ€§æ›´å¼ºï¼ŒRedisæ€§èƒ½æ›´é«˜ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:6:10","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"11ã€redisé™æµ åœ¨å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œé™é¢‘å™¨ä¹Ÿéœ€è¦åˆ†å¸ƒå¼åŒ–ã€‚æ— è®ºæ˜¯å“ªç§ç®—æ³•ï¼Œéƒ½å¯ä»¥ç»“åˆRedisæ¥å®ç°ã€‚è¿™é‡Œæˆ‘æ¯”è¾ƒç†Ÿæ‚‰çš„æ˜¯åŸºäºRedisçš„åˆ†å¸ƒå¼ä»¤ç‰Œæ¡¶ã€‚ å¾ˆæ˜¾ç„¶ï¼ŒRedisè´Ÿè´£ç®¡ç†ä»¤ç‰Œï¼Œå¾®æœåŠ¡éœ€è¦è¿›è¡Œå‡½æ•°æ“ä½œï¼Œå°±å‘Redisç”³è¯·ä»¤ç‰Œï¼Œå¦‚æœRediså½“å‰è¿˜æœ‰ä»¤ç‰Œï¼Œå°±å‘æ”¾ç»™å®ƒã€‚æ‹¿åˆ°ä»¤ç‰Œï¼Œæ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚ å¦ä¸€æ–¹é¢ï¼Œä»¤ç‰Œä¸å…‰è¦æ¶ˆè€—ï¼Œè¿˜éœ€è¦è¡¥å……ï¼Œå‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œå¯ä»¥ä½¿ç”¨æ‡’ç”Ÿæˆçš„æ–¹å¼ï¼šä½¿ç”¨ä»¤ç‰Œæ—¶ï¼Œé¡ºä¾¿ç”Ÿæˆä»¤ç‰Œã€‚è¿™æ ·å­è¿˜æœ‰ä¸ªå¥½å¤„ï¼šä»¤ç‰Œçš„è·å–ï¼Œå’Œä»¤ç‰Œçš„ç”Ÿæˆï¼Œéƒ½å¯ä»¥åœ¨ä¸€ä¸ªLuaè„šæœ¬ä¸­ï¼Œä¿è¯äº†åŸå­æ€§ã€‚ ","date":"2021-07-01","objectID":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/:6:11","tags":["redis"],"title":"RedisçŸ¥è¯†å›¾è°±","uri":"/2021/07/redis%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"é™æµåˆç§°ä¸ºæµé‡æ§åˆ¶ï¼Œæ˜¯é™åˆ¶åˆ°è¾¾ç³»ç»Ÿçš„å¹¶å‘è¯·æ±‚æ•°ï¼Œå½“è¾¾åˆ°é™åˆ¶æ¡ä»¶æ—¶å¯ä»¥æ‹’ç»è¯·æ±‚ï¼Œå¯ä»¥èµ·åˆ°ä¿æŠ¤ä¸‹æ¸¸æœåŠ¡ï¼Œç†”æ–­æµé‡çš„ä½œç”¨ã€‚å¸¸ç”¨çš„é™æµç­–ç•¥æœ‰æ¼æ¡¶ç®—æ³•ã€ä»¤ç‰Œæ¡¶ç®—æ³•ã€æ»‘åŠ¨çª—å£ã€‚ ","date":"2021-06-28","objectID":"/2021/06/%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E4%B8%8B%E7%9A%84%E9%99%90%E9%80%9F%E7%AD%96%E7%95%A5/:0:0","tags":["golang"],"title":"é«˜å¹¶å‘ç³»ç»Ÿä¸‹çš„é™é€Ÿç­–ç•¥","uri":"/2021/06/%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E4%B8%8B%E7%9A%84%E9%99%90%E9%80%9F%E7%AD%96%E7%95%A5/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"é™æµç®—æ³• ","date":"2021-06-28","objectID":"/2021/06/%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E4%B8%8B%E7%9A%84%E9%99%90%E9%80%9F%E7%AD%96%E7%95%A5/:1:0","tags":["golang"],"title":"é«˜å¹¶å‘ç³»ç»Ÿä¸‹çš„é™é€Ÿç­–ç•¥","uri":"/2021/06/%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E4%B8%8B%E7%9A%84%E9%99%90%E9%80%9F%E7%AD%96%E7%95%A5/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"è®¡æ•°å™¨ç®—æ³• è®¡æ•°å™¨ç®—æ³•æ˜¯é™æµç®—æ³•ä¸­æœ€ç®€å•ä¹Ÿæ˜¯æœ€å®¹æ˜“å®ç°çš„ä¸€ç§ç®—æ³•ã€‚è®¾ç½®æŸæ®µæ—¶é—´å†…çš„è®¡æ•°å™¨æ˜¯ä¸€ä¸ªå®šå€¼ï¼Œå½“è¯·æ±‚å€¼åœ¨èŒƒå›´å†…åˆ™æ”¾è¡Œï¼Œå¦‚æœè¶…è¿‡è®¡æ•°å™¨åˆ™é™æµã€‚ func New(duration time.Duration, allowRequests int32) *fixedWindowCounter { c := \u0026fixedWindowCounter{duration: duration, allowRequests: allowRequests} go func() { for { select { case \u003c-time.After(c.duration): atomic.StoreInt32(\u0026c.currentRequests, 0) } } }() return c } func (c *fixedWindowCounter) Take() error { curRequest := atomic.LoadInt32(\u0026c.currentRequests) if curRequest \u003e= c.allowRequests { return ErrExceededLimit } if !atomic.CompareAndSwapInt32(\u0026c.currentRequests, curRequest, curRequest+1) { return ErrExceededLimit } return nil } ","date":"2021-06-28","objectID":"/2021/06/%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E4%B8%8B%E7%9A%84%E9%99%90%E9%80%9F%E7%AD%96%E7%95%A5/:1:1","tags":["golang"],"title":"é«˜å¹¶å‘ç³»ç»Ÿä¸‹çš„é™é€Ÿç­–ç•¥","uri":"/2021/06/%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E4%B8%8B%E7%9A%84%E9%99%90%E9%80%9F%E7%AD%96%E7%95%A5/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"æ»‘åŠ¨çª—å£ è®¡æ•°å™¨ç®—æ³•è™½ç„¶ç®€å•ï¼Œä½†æ˜¯ä¼šæœ‰ä¸´ç•Œé—®é¢˜ï¼Œå¦‚æœæœ‰æ¶æ„è¯·æ±‚åœ¨æ—¶é—´è¾¹ç•Œå¤„å¤§é‡è¯·æ±‚ï¼Œè¿™ä¼šå¯¼è‡´ç¬é—´çš„è¯·æ±‚é‡å˜å¤§ã€‚ æ‰€ä»¥å¼•å…¥æ»‘åŠ¨çª—å£ï¼Œä¾‹å¦‚æŠŠ1åˆ†é’ŸåŒ–æˆ6æ ¼ï¼Œæ¯æ ¼å°±æ˜¯10ç§’ï¼Œæ¯è¿‡10ç§’ï¼Œæ»‘åŠ¨çª—å£å°±ä¼šå‘å³æ»‘åŠ¨ä¸€æ ¼ï¼Œæ¯ä¸ªæ ¼å­éƒ½æœ‰è‡ªå·±çš„è®¡æ•°å™¨ã€‚ ç”±æ­¤å¯è§ï¼Œå½“æ»‘åŠ¨çª—å£çš„æ ¼å­åˆ’åˆ†çš„è¶Šå¤šï¼Œé‚£ä¹ˆæ»‘åŠ¨çª—å£çš„æ»šåŠ¨å°±è¶Šå¹³æ»‘ï¼Œé™æµçš„ç»Ÿè®¡å°±ä¼šè¶Šç²¾ç¡®ã€‚ var ( ErrExceededLimit = errors.New(\"Too many requests, exceed the limit. \") ) type slidingWindowCounter struct { total, slot time.Duration durationRequests chan int32 inDurRequests int32 currentRequests, allowRequests int32 } func New(slot, total time.Duration, allowRequests int32) *slidingWindowCounter { c := \u0026slidingWindowCounter{durationRequests: make(chan int32, total/slot/1000), total: total, slot: slot, allowRequests: allowRequests} go func() { go sliding(c) go calculate(c) }() return c } func (c *slidingWindowCounter) Take() error { curRequest := atomic.LoadInt32(\u0026c.currentRequests) if curRequest \u003e= c.allowRequests { return ErrExceededLimit } if !atomic.CompareAndSwapInt32(\u0026c.currentRequests, curRequest, curRequest+1) { return ErrExceededLimit } atomic.AddInt32(\u0026c.inDurRequests,1) return nil } func sliding(c *slidingWindowCounter) { for { select { case \u003c-time.After(c.slot): t := atomic.SwapInt32(\u0026c.inDurRequests, 0) c.durationRequests \u003c- t } } } func calculate(c *slidingWindowCounter) { // é€šé“åŠ æ»¡ for { \u003c-time.After(c.slot) if len(c.durationRequests) == cap(c.durationRequests) { break } } // å®šæ—¶ä»é€šé“ä¸­å–å‡ºæ•°æ®ï¼Œå¯¹currentRequestsç½®0 for { \u003c-time.After(c.slot) t := \u003c- c.durationRequests if t != 0 { atomic.AddInt32(\u0026c.currentRequests, -t) } } } ","date":"2021-06-28","objectID":"/2021/06/%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E4%B8%8B%E7%9A%84%E9%99%90%E9%80%9F%E7%AD%96%E7%95%A5/:1:2","tags":["golang"],"title":"é«˜å¹¶å‘ç³»ç»Ÿä¸‹çš„é™é€Ÿç­–ç•¥","uri":"/2021/06/%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E4%B8%8B%E7%9A%84%E9%99%90%E9%80%9F%E7%AD%96%E7%95%A5/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"æ¼æ¡¶ç®—æ³• æ°´ï¼ˆè¯·æ±‚ï¼‰å…ˆåˆ°æ¼æ¡¶ä¸­ï¼Œæ¼æ¡¶ä»¥ä¸€å®šé€Ÿç‡å‡ºæ°´ï¼Œå½“æ°´çš„æµå…¥é€Ÿåº¦è¿‡å¤§æ—¶ä¼šç›´æ¥æº¢å‡ºï¼Œå¯ä»¥çœ‹å‡ºæ¼æ¡¶ç®—æ³•èƒ½å¼ºè¡Œé™åˆ¶æ•°æ®çš„ä¼ è¾“é€Ÿç‡ã€‚ var ( ErrExceededLimit = errors.New(\"Too many requests, exceed the limit. \") ) type leakyBucket struct { duration time.Duration bucketSize chan struct{} allowRequests int32 } func New(duration time.Duration, bucketSize, allowRequests int32) *leakyBucket { c := \u0026leakyBucket{duration: duration, bucketSize: make(chan struct{}, allowRequests/bucketSize), allowRequests: allowRequests} go func() { for { select { case \u003c-time.After(time.Duration(c.duration.Nanoseconds()/int64(c.allowRequests))): c.bucketSize \u003c- struct{}{} } } }() return c } func (c *leakyBucket) Take() error { select { case \u003c-c.bucketSize: return nil default: } return ErrExceededLimit } ","date":"2021-06-28","objectID":"/2021/06/%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E4%B8%8B%E7%9A%84%E9%99%90%E9%80%9F%E7%AD%96%E7%95%A5/:1:3","tags":["golang"],"title":"é«˜å¹¶å‘ç³»ç»Ÿä¸‹çš„é™é€Ÿç­–ç•¥","uri":"/2021/06/%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E4%B8%8B%E7%9A%84%E9%99%90%E9%80%9F%E7%AD%96%E7%95%A5/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"ä»¤ç‰Œæ¡¶ç®—æ³• ä»¤ç‰Œæ¡¶æ˜¯ä¸€ç§å¸¸è§äºç”¨äºæ§åˆ¶é€Ÿç‡çš„æ§æµç®—æ³•ã€‚ç³»ç»Ÿä¼šä»¥ä¸€ä¸ªæ’å®šçš„é€Ÿåº¦å¾€æ¡¶é‡Œæ”¾å…¥ä»¤ç‰Œï¼Œè€Œå¦‚æœè¯·æ±‚éœ€è¦è¢«å¤„ç†ï¼Œåˆ™éœ€è¦å…ˆä»æ¡¶é‡Œè·å–ä¸€ä¸ªä»¤ç‰Œï¼Œå½“æ¡¶é‡Œæ²¡æœ‰ä»¤ç‰Œå¯å–æ—¶ï¼Œåˆ™æ‹’ç»æœåŠ¡ã€‚ var ( ErrExceededLimit = errors.New(\"Too many requests, exceed the limit. \") ) type leakyBucket struct { duration time.Duration token chan struct{} allowRequests int32 } func New(duration time.Duration, allowRequests int32) *leakyBucket { c := \u0026leakyBucket{duration: duration, token: make(chan struct{}, allowRequests), allowRequests: allowRequests} go func() { for { select { case \u003c-time.After(time.Duration(c.duration.Nanoseconds()/int64(c.allowRequests))): c.token \u003c- struct{}{} } } }() return c } func (c *leakyBucket) Take() error { select { case \u003c-c.token: return nil default: } return ErrExceededLimit } ","date":"2021-06-28","objectID":"/2021/06/%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E4%B8%8B%E7%9A%84%E9%99%90%E9%80%9F%E7%AD%96%E7%95%A5/:1:4","tags":["golang"],"title":"é«˜å¹¶å‘ç³»ç»Ÿä¸‹çš„é™é€Ÿç­–ç•¥","uri":"/2021/06/%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E4%B8%8B%E7%9A%84%E9%99%90%E9%80%9F%E7%AD%96%E7%95%A5/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"å°ç»“ è®¡æ•°å™¨ç®—æ³•ä¼˜ç‚¹æ˜¯ç®€å•ï¼Œèƒ½å¤Ÿæ»¡è¶³ç®€å•çš„é™æµéœ€æ±‚ï¼Œç¼ºç‚¹æ˜¯ä¸´ç•Œé—®é¢˜ï¼Œæµé‡æ›²çº¿å¯èƒ½ä¸å¤Ÿå¹³æ»‘ï¼Œä¼šæœ‰â€œçªåˆºç°è±¡â€ï¼Œåœ¨çª—å£åˆ‡æ¢æ—¶å¯èƒ½ä¼šäº§ç”Ÿä¸¤å€äºé˜ˆå€¼çš„æµé‡è¯·æ±‚ã€‚ æ»‘åŠ¨çª—å£ç®—æ³•ä½œä¸ºå¯¹è®¡æ•°å™¨ç®—æ³•çš„æ”¹è¿›ï¼Œèƒ½æœ‰æ•ˆè§£å†³çª—å£åˆ‡æ¢æ—¶å¯èƒ½ä¼šäº§ç”Ÿä¸¤å€äºé˜ˆå€¼çš„æµé‡è¯·æ±‚çš„é—®é¢˜ã€‚ æ¼æ¡¶ç®—æ³•çš„å‡ºæ°´é€Ÿåº¦æ˜¯æ’å®šçš„ï¼Œé‚£ä¹ˆç¬æ—¶å¤§æµé‡ï¼Œå°†æœ‰å¤§éƒ¨åˆ†è¯·æ±‚ä¼šè¢«ä¸¢å¼ƒã€‚ ä»¤ç‰Œæ¡¶ç®—æ³•ç”Ÿæˆçš„ä»¤ç‰Œé€Ÿåº¦æ˜¯æ’å®šçš„ï¼Œè€Œè¯·æ±‚å»æ‹¿ä»¤ç‰Œæ¡¶æ˜¯æ²¡æœ‰é€Ÿåº¦é™åˆ¶çš„ï¼Œè¿™æ„å‘³ç€é¢å¯¹ç¬æ—¶æµé‡ï¼Œå¯ä»¥çŸ­æ—¶é—´å†…æ‹¿åˆ°å¤§é‡ä»¤ç‰Œã€‚ ","date":"2021-06-28","objectID":"/2021/06/%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E4%B8%8B%E7%9A%84%E9%99%90%E9%80%9F%E7%AD%96%E7%95%A5/:1:5","tags":["golang"],"title":"é«˜å¹¶å‘ç³»ç»Ÿä¸‹çš„é™é€Ÿç­–ç•¥","uri":"/2021/06/%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E4%B8%8B%E7%9A%84%E9%99%90%E9%80%9F%E7%AD%96%E7%95%A5/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"é™æµæºç  ","date":"2021-06-28","objectID":"/2021/06/%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E4%B8%8B%E7%9A%84%E9%99%90%E9%80%9F%E7%AD%96%E7%95%A5/:2:0","tags":["golang"],"title":"é«˜å¹¶å‘ç³»ç»Ÿä¸‹çš„é™é€Ÿç­–ç•¥","uri":"/2021/06/%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E4%B8%8B%E7%9A%84%E9%99%90%E9%80%9F%E7%AD%96%E7%95%A5/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"golang.org/x/time/rate æ˜¯ä¸€ä¸ªä»¤ç‰Œæ¡¶ç®—æ³•ã€‚ Limiteræœ‰ä¸‰ä¸ªä¸»è¦çš„æ–¹æ³• Allowã€Reserveå’ŒWaitï¼Œæœ€å¸¸ç”¨çš„æ˜¯Waitå’ŒAllowæ–¹æ³• è¿™ä¸‰ä¸ªæ–¹æ³•æ¯è°ƒç”¨ä¸€æ¬¡éƒ½ä¼šæ¶ˆè€—ä¸€ä¸ªä»¤ç‰Œï¼Œè¿™ä¸‰ä¸ªæ–¹æ³•çš„åŒºåˆ«åœ¨äºæ²¡æœ‰ä»¤ç‰Œæ—¶ï¼Œä»–ä»¬çš„å¤„ç†æ–¹å¼ä¸åŒ Allowï¼š å¦‚æœæ²¡æœ‰ä»¤ç‰Œï¼Œåˆ™ç›´æ¥è¿”å›false Reserveï¼šå¦‚æœæ²¡æœ‰ä»¤ç‰Œï¼Œåˆ™è¿”å›ä¸€ä¸ªreservationï¼Œ Waitï¼šå¦‚æœæ²¡æœ‰ä»¤ç‰Œï¼Œåˆ™ç­‰å¾…ç›´åˆ°è·å–ä¸€ä¸ªä»¤ç‰Œæˆ–è€…å…¶ä¸Šä¸‹æ–‡è¢«å–æ¶ˆã€‚ tokensæ›´æ–°çš„ç­–ç•¥ï¼š 1ã€ æˆåŠŸè·å–åˆ°ä»¤ç‰Œæˆ–æˆåŠŸé¢„çº¦(Reserve)åˆ°ä»¤ç‰Œ 2ã€é¢„çº¦å–æ¶ˆæ—¶(Cancel)å¹¶ä¸”éœ€è¦è¿˜åŸä»¤ç‰Œåˆ°ä»¤ç‰Œæ¡¶ä¸­æ—¶ 3ã€é‡æ–°è®¾ç½®é™æµå™¨çš„é€Ÿç‡æ—¶(SetLimit) 4ã€é‡æ–°è®¾ç½®é™æµå™¨çš„å®¹é‡æ—¶(SetBurst) Limitç±»å‹ // Limit å°±æ˜¯float64çš„åˆ«åï¼Œå®šä¹‰äº‹ä»¶çš„æœ€å¤§é¢‘ç‡ï¼Œè¡¨ç¤ºæ¯ç§’å‘ç”Ÿçš„äº‹ä»¶æ•°ã€‚0è¡¨ç¤ºæ— é™åˆ¶ã€‚ type Limit float64 // Inf æ˜¯æ— é™é€Ÿç‡é™åˆ¶å…è®¸æ‰€æœ‰äº‹ä»¶(å³ä½¿çªå‘ä¸º0) const Inf = Limit(math.MaxFloat64) // Every æŒ‡å®šå‘Tokenæ¡¶ä¸­é˜²æ­¢tokençš„é—´éš”ï¼Œè®¡ç®—å‡ºæ¯ç§’çš„æ•°æ®é‡ func Every(interval time.Duration) Limit { if interval \u003c= 0 { return Inf } return 1 / Limit(interval.Seconds()) } Limiterç»“æ„ä½“ // The methods AllowN, ReserveN, and WaitN consume n tokens. type Limiter struct { mu sync.Mutex limit Limit burst int // ä»¤ç‰Œæ¡¶çš„æœ€å¤§æ•°é‡ï¼Œå¦‚æœburst=0ä¸”limit=Infï¼Œåˆ™å…è®¸å¤„ç†ä»»ä½•äº‹ä»¶ tokens float64 // å¯ç”¨ä»¤ç‰Œæ•° last time.Time // è®°å½•ä¸Šæ¬¡limiterçš„tokensè¢«æ›´æ–°çš„æ—¶é—´ lastEvent time.Time // è®°å½•é€Ÿç‡å—é™çš„æ—¶é—´ç‚¹ï¼ˆè¿‡å»æ—¶é—´ç‚¹æˆ–æœªæ¥æ—¶é—´ç‚¹ï¼‰ } Revervationç»“æ„ä½“ // Reservation é¢„å®šä»¤ç‰Œçš„æ“ä½œï¼ŒtimeToAct æ˜¯æœ¬æ¬¡é¢„çº¦éœ€è¦ç­‰å¾…åˆ°çš„æŒ‡å®šæ—¶é—´ç‚¹æ‰æœ‰è¶³å¤Ÿé¢„çº¦çš„ä»¤ç‰Œã€‚ type Reservation struct { ok bool // åˆ°æˆªæ­¢æ—¶é—´æ˜¯å¦èƒ½å¤Ÿè·å–è¶³å¤Ÿçš„ä»¤ç‰Œ lim *Limiter tokens int // éœ€è¦è·å–çš„ä»¤ç‰Œæ•° timeToAct time.Time // éœ€è¦ç­‰å¾…çš„æ—¶é—´ç‚¹ limit Limit // ä»£è¡¨é¢„å®šçš„æ—¶é—´ï¼Œå¯ä»¥è¢«æ›´æ”¹ } Limiteræ¶ˆè´¹token Limiteræœ‰3ä¸ªæ¶ˆè´¹tokençš„æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯Allow/Reverse/Waitï¼Œæœ€ç»ˆè¿™äº›æ–¹æ³•è°ƒç”¨reserveNå’Œadvanceæ¥å®ç°ã€‚ advanceçš„å®ç° // advance æ›´æ–°ä»¤ç‰Œæ¡¶çš„çŠ¶æ€ï¼Œè®¡ç®—å‡ºä»¤ç‰Œæ¡¶æœªæ›´æ–°çš„æ—¶é—´ï¼Œç„¶åè®¡ç®—å‡ºéœ€è¦å‘ä»¤ç‰Œæ¡¶ä¸­æ·»åŠ çš„ä»¤ç‰Œæ•° func (lim *Limiter) advance(now time.Time) (newNow time.Time, newLast time.Time, newTokens float64) { // lastä¸èƒ½åœ¨nowä¹‹åï¼Œå¦åˆ™è®¡ç®—å‡ºæ¥çš„elapsedä¸ºè´Ÿæ•°ï¼Œä¼šå¯¼è‡´ä»¤ç‰Œæ¡¶æ•°é‡å‡å°‘ last := lim.last if now.Before(last) { last = now } // æ ¹æ®ä»¤ç‰Œæ¡¶çš„ä½™æ•°è®¡ç®—å‡ºä»¤ç‰Œæ¡¶æœªè¿›è¡Œæ›´æ–°çš„æœ€å¤§æ—¶é—´ maxElapsed := lim.limit.durationFromTokens(float64(lim.burst) - lim.tokens) elapsed := now.Sub(last) if elapsed \u003e maxElapsed { elapsed = maxElapsed } // æ ¹æ®æœªæ›´æ–°çš„æ—¶é—´ï¼ˆæœªå‘æ¡¶ä¸­åŠ å…¥ä»¤ç‰Œçš„æ—¶é—´æ®µï¼‰è®¡ç®—å‡ºäº§ç”Ÿçš„ä»¤ç‰Œæ•° delta := lim.limit.tokensFromDuration(elapsed) tokens := lim.tokens + delta if burst := float64(lim.burst); tokens \u003e burst { tokens = burst } return now, last, tokens } reverseNçš„å®ç° // reserveN is a helper method for AllowN, ReserveN, and WaitN. // reserveN åˆ¤æ–­åœ¨maxFutureReserveæ—¶é—´å†…æ˜¯å¦æœ‰è¶³å¤Ÿçš„ä»¤ç‰Œ func (lim *Limiter) reserveN(now time.Time, n int, maxFutureReserve time.Duration) Reservation { lim.mu.Lock() if lim.limit == Inf { lim.mu.Unlock() return Reservation{ ok: true, // æ¡¶ä¸­æœ‰è¶³å¤Ÿçš„ä»¤ç‰Œ lim: lim, tokens: n, timeToAct: now, } } // æ›´æ–°æ¡¶çš„çŠ¶æ€ï¼Œtokensä¸ºæ¡¶å¯ç”¨çš„ä»¤ç‰Œæ•° now, last, tokens := lim.advance(now) // è®¡ç®—å–å®Œåæ¡¶ä¸­å‰©ä¸‹çš„ä»¤ç‰Œæ•° tokens -= float64(n) // å¦‚æœtokens\u003c0ï¼Œè¯´æ˜tokensä¸å¤Ÿï¼Œè®¡ç®—éœ€è¦ç­‰å¾…çš„æ—¶é—´ var waitDuration time.Duration if tokens \u003c 0 { waitDuration = lim.limit.durationFromTokens(-tokens) } ok := n \u003c= lim.burst \u0026\u0026 waitDuration \u003c= maxFutureReserve // Prepare reservation r := Reservation{ ok: ok, lim: lim, limit: lim.limit, } if ok { r.tokens = n r.timeToAct = now.Add(waitDuration) } // æ›´æ–°æ¡¶ä¸­çš„tokenï¼Œæ—¶é—´ï¼ŒlastEvent if ok { lim.last = now lim.tokens = tokens lim.lastEvent = r.timeToAct } else { lim.last = last } lim.mu.Unlock() return r } è¿™ä¸Šé¢æåˆ°äº†durationFromTokenså’ŒtokensFromDurationä¸¤ç§æ–¹æ³•ã€‚ // durationFromTokens é™åˆ¶ä»¤ç‰Œæ‰€èŠ±è´¹çš„æ—¶é—´ func (limit Limit) durationFromTokens(tokens float64) time.Duration { seconds := tokens / float64(limit) return time.Nanosecond * time.Duration(1e9*seconds) // 1s * seconds } // tokensFromDuration æ ¹æ®æ—¶é—´å¯ä»¥äº§ç”Ÿçš„ä»¤ç‰Œæ•° func (limit Limit) tokensFromDuration(d time.Duration) float64 { // Split the integer and fractional parts ourself to minimize rounding errors. // See golang.org/issues/34861. // ä¹‹å‰çš„ç‰ˆæœ¬å¦‚ä¸‹ // return d.Seconds() * float64(limit) // è¿™é‡Œçš„d.Seconds()å·²ç»æ˜¯å°æ•°äº†ï¼Œä¸¤ä¸ªå°æ•°ç›¸ä¹˜ä¼šå¸¦æ¥ç²¾åº¦çš„ç¼ºå¤±ã€‚ sec := float64(d/time.Second) * float64(limit) nsec := float64(d%time.Second) * float64(limit) return sec + nsec/1e9 } Limiterå½’è¿˜token func (r *Reservation) CancelAt(now time.Time) { if !r.ok { return } r.lim.mu.Lock() defer r.lim.mu.Unlock() // å¦‚æœæ— éœ€é™æµæˆ–tokensä¸º0æˆ–è¿‡äº†æˆªæ­¢æ—¶é—´ï¼Œæ— éœ€å¤„ç†å–æ¶ˆæ“ä½œ if r.lim.limit == Inf || r.tokens == 0 || r.timeToAct.Before(now) { return } // è®¡ç®—éœ€è¦è¿˜åŸçš„ä»¤ç‰Œæ•°é‡ restoreTokens := float64(r.tokens) - r.limit.tokensFromDuration(r.lim.lastEvent.Sub(r.timeToAct)) if restoreTokens \u003c= 0 { return } // é‡æ–°è®¡ç®—ä»¤ç‰Œæ¡¶çš„çŠ¶æ€ now, _, tokens := r.lim.advance(now) // è¿˜åŸå½“å‰ä»¤ç‰Œæ¡¶çš„ä»¤ç‰Œæ•°é‡ï¼Œå½“å‰çš„ä»¤ç‰Œæ•°tokensåŠ ä¸Šéœ€è¦è¿˜åŸçš„ä»¤ç‰Œæ•°restoreTokens tokens += restoreT","date":"2021-06-28","objectID":"/2021/06/%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E4%B8%8B%E7%9A%84%E9%99%90%E9%80%9F%E7%AD%96%E7%95%A5/:2:1","tags":["golang"],"title":"é«˜å¹¶å‘ç³»ç»Ÿä¸‹çš„é™é€Ÿç­–ç•¥","uri":"/2021/06/%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E4%B8%8B%E7%9A%84%E9%99%90%E9%80%9F%E7%AD%96%E7%95%A5/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"uber-go/ratelimit åŸºäºæ¼æ¡¶å®ç°ã€‚ ä¾‹å­ rl := ratelimit.New(100) // per second prev := time.Now() for i := 0; i \u003c 10; i++ { now := rl.Take() fmt.Println(i, now.Sub(prev)) prev = now } // Output: // 0 0 // 1 10ms // 2 10ms // 3 10ms // 4 10ms // 5 10ms // 6 10ms // 7 10ms // 8 10ms // 9 10ms åŸºæœ¬å®ç° è¦å®ç°ä¸Šé¢çš„æ¯ç§’å›ºå®šé€Ÿç‡ï¼Œå¾ˆç®€å•ã€‚ åœ¨ratelimitçš„Newå‡½æ•°ä¸­ï¼Œä¼ å…¥çš„å‚æ•°æ˜¯æ¯ç§’å…è®¸è¯·æ±‚é‡(Requests Per Second)ã€‚ æˆ‘ä»¬å°±èƒ½å¾ˆè½»æ¾è®¡ç®—å‡ºæ¯ä¸ªè¯·æ±‚çš„æ—¶é—´é—´éš”ï¼š perRequest := time.Second / time.Duration(rate) å¦‚å›¾ï¼Œå½“è¯·æ±‚1å¤„ç†ç»“æŸåï¼Œè®°å½•è¯·æ±‚1çš„å¤„ç†å®Œæˆæ—¶é—´ï¼Œè®°ä¸ºlimiter.lastã€‚è¯·æ±‚2åˆ°è¾¾æ—¶ï¼Œå¦‚æœæ­¤æ—¶çš„æ—¶é—´ä¸limiter.lastçš„æ—¶é—´é—´éš”å°äºpreRequestï¼Œé‚£ä¹ˆsleepä¸€æ®µæ—¶é—´ã€‚ sleepFor = t.PreRequest - now.Sub(t.last) if sleepFor \u003e 0 { t.clock.Sleep(sleepFor) t.last = now.Add(sleepFor) } else { t.last = now } ç„¶è€Œï¼Œåœ¨ç°å®è¯·æ±‚ä¸­ï¼Œæµé‡ç»å¸¸æ˜¯çªå‘çš„ï¼Œæœ‰äº›è¯·æ±‚é—´éš”æ¯”è¾ƒé•¿ï¼Œæœ‰äº›è¯·æ±‚é—´éš”æ¯”è¾ƒçŸ­ã€‚ æ‰€ä»¥uberå¼•å…¥æœ€å¤§æ¾å¼›é‡ï¼ŒæŠŠä¹‹å‰é—´éš”æ¯”è¾ƒé•¿çš„è¯·æ±‚æ—¶é—´ï¼ŒåŒ€ç»™åé¢çš„ä½¿ç”¨ã€‚ è€Œå®ç°èµ·æ¥ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠæ¯ä¸ªè¯·æ±‚å¤šå‡ºçš„ç­‰å¾…æ—¶é—´ç´¯åŠ èµ·æ¥ï¼Œç»™åé¢çš„è¯·æ±‚å†²æŠµã€‚ t.sleepFor += t.preReqeust - now.Sub(t.last) if t.sleepFor \u003c t.maxSlack { t.sleepFor = t.maxSlack } if t.sleepFor \u003e 0 { t.clock.Sleep(t.sleepFor) t.last = now.Add(t.sleepFor) t.sleepFor = 0 } else { t.last = now } æºç è§£æï¼š func New(rate int, opts ...Option) Limiter { return newAtomicBased(rate, opts...) } // buildConfig combines defaults with options. func buildConfig(opts []Option) config { c := config{ clock: clock.New(), slack: 10, per: time.Second, } for _, opt := range opts { opt.apply(\u0026c) } return c } func newAtomicBased(rate int, opts ...Option) *atomicLimiter { config := buildConfig(opts) // ä¸¤ä¸ªè¯·æ±‚çš„æœ€å°æ—¶é—´é—´éš” perRequest := config.per / time.Duration(rate) l := \u0026atomicLimiter{ perRequest: perRequest, maxSlack: -1 * time.Duration(config.slack) * perRequest, // æœ€å¤§æ¾å¼›é‡ clock: config.clock, } initialState := state{ last: time.Time{}, sleepFor: 0, } atomic.StorePointer(\u0026l.state, unsafe.Pointer(\u0026initialState)) return l } func (t *atomicLimiter) Take() time.Time { var ( newState state taken bool interval time.Duration ) for !taken { now := t.clock.Now() previousStatePointer := atomic.LoadPointer(\u0026t.state) oldState := (*state)(previousStatePointer) newState = state{ last: now, sleepFor: oldState.sleepFor, } // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œæ›´æ–°çŠ¶æ€ if oldState.last.IsZero() { taken = atomic.CompareAndSwapPointer(\u0026t.state, previousStatePointer, unsafe.Pointer(\u0026newState)) continue } newState.sleepFor += t.perRequest - now.Sub(oldState.last) // ä¾‹å¦‚è¯·æ±‚1å®Œæˆåï¼Œè¯·æ±‚2åœ¨å‡ ä¸ªå°æ—¶ååˆ°è¾¾ï¼Œé‚£ä¹ˆå¯¹äºnow.Sub(oldState.last)ä¼šéå¸¸å¤§ï¼Œè€Œè¿™é‡ŒnewState.sleepForè¡¨ç¤ºå…è®¸å†²æŠµçš„æœ€é•¿æ—¶é—´ã€‚ if newState.sleepFor \u003c t.maxSlack { // t.maxSlacké»˜è®¤10ä¸ªè¯·æ±‚çš„é—´éš”å¤§å° newState.sleepFor = t.maxSlack } if newState.sleepFor \u003e 0 { // ä»£è¡¨æ­¤å‰çš„è¯·æ±‚å¤šä½™å‡ºçš„æ—¶é—´ï¼Œæ— æ³•å®Œå…¨å†²æŠµæ­¤æ¬¡æ‰€éœ€é‡ newState.last = newState.last.Add(newState.sleepFor) interval, newState.sleepFor = newState.sleepFor, 0 } taken = atomic.CompareAndSwapPointer(\u0026t.state, previousStatePointer, unsafe.Pointer(\u0026newState)) } t.clock.Sleep(interval) return newState.last } ","date":"2021-06-28","objectID":"/2021/06/%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E4%B8%8B%E7%9A%84%E9%99%90%E9%80%9F%E7%AD%96%E7%95%A5/:2:2","tags":["golang"],"title":"é«˜å¹¶å‘ç³»ç»Ÿä¸‹çš„é™é€Ÿç­–ç•¥","uri":"/2021/06/%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E4%B8%8B%E7%9A%84%E9%99%90%E9%80%9F%E7%AD%96%E7%95%A5/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"åŸå­æ“ä½œ æˆ‘ä»¬å…ˆç»™åŸå­æ“ä½œä¸‹ä¸€ä¸ªå®šä¹‰ï¼š åŸå­(atom)ï¼šåœ¨åŒ–å­¦ååº”ä¸­ä¸å¯å†åˆ†çš„åŸºæœ¬å¾®ç²’ã€‚ åŸå­æ“ä½œ(atomic operation)ï¼šä¸ä¼šè¢«çº¿ç¨‹è°ƒåº¦æœºåˆ¶æ‰“æ–­çš„æ“ä½œï¼Œè¿™ç§æ“ä½œä¸€æ—¦å¼€å§‹ï¼Œå°±ä¸€ç›´è¿è¡Œåˆ°ç»“æŸï¼Œä¸­é—´ä¸ä¼šæœ‰ä»»ä½•çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€å—å†…å­˜çš„æ“ä½œæ˜¯ä¸²è¡Œçš„ï¼Œä¸ä¼šå› ä¸ºå¹¶å‘æ“ä½œè€ŒåŒæ—¶è¯»å†™å†…å­˜ã€‚ ","date":"2021-06-03","objectID":"/2021/06/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/:1:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹åŸå­æ“ä½œ","uri":"/2021/06/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"åŸå­æ€§ åœ¨å¤„ç†å™¨å±‚é¢ï¼ŒåŸºäºç¼“å­˜åŠ é”æˆ–æ€»çº¿åŠ é”çš„æ–¹å¼æ¥å®ç°å¤šå¤„ç†å™¨ä¹‹é—´çš„åŸå­æ“ä½œã€‚é€šè¿‡åŠ é”ä¿è¯ä»ç³»ç»Ÿå†…å­˜ä¸­è¯»å–æˆ–å†™å…¥ä¸€ä¸ªå­—èŠ‚æ˜¯åŸå­çš„ï¼Œä¹Ÿå°±æ˜¯å½“ä¸€ä¸ªå¤„ç†å™¨è¯»å–ä¸€ä¸ªå­—èŠ‚æ—¶ï¼Œå…¶ä»–å¤„ç†å™¨ä¸èƒ½è®¿é—®è¿™ä¸ªå­—èŠ‚çš„å†…å­˜åœ°å€ã€‚ æ€»çº¿é” å¦‚æœå¤šä¸ªå¤„ç†å™¨åŒæ—¶å¯¹å…±äº«å˜é‡è¿›è¡Œè¯»å†™æ“ä½œ(i++)ï¼Œé‚£ä¹ˆå…±äº«å˜é‡å°±ä¼šè¢«å¤šä¸ªå¤„ç†å™¨åŒæ—¶è¿›è¡Œæ“ä½œï¼Œè¿™æ ·è¯»å†™æ“ä½œå°±ä¸æ˜¯åŸå­çš„ï¼Œæ“ä½œå®Œä¹‹åå…±äº«å˜é‡çš„å€¼ä¼šå’ŒæœŸæœ›çš„ä¸ä¸€è‡´ã€‚ æ€»çº¿é”å…¶å®å°±æ˜¯å¤„ç†å™¨æä¾›ä¸€ä¸ªLOCK#ä¿¡å·ï¼Œå½“ä¸€ä¸ªå¤„ç†å™¨åœ¨æ€»çº¿ä¸Šè¾“å‡ºä¿¡å·æ—¶ï¼Œå…¶ä»–å¤„ç†å™¨çš„è¯·æ±‚å°†è¢«é˜»å¡ï¼Œé‚£ä¹ˆæ”¹å¤„ç†å™¨å°±èƒ½ç‹¬å å…±äº«å†…å­˜ã€‚ åœ¨åŒä¸€æ—¶åˆ»ï¼Œåªéœ€ä¿è¯å¯¹æŸä¸ªå†…å­˜åœ°å€çš„æ“ä½œæ˜¯åŸå­æ€§å³å¯ï¼Œä½†æ€»çº¿é”æŠŠCPUå’Œå†…å­˜ä¹‹é—´çš„é€šä¿¡é”ä½äº†ï¼Œä½¿å¾—å…¶ä»–å¤„ç†å™¨ä¸èƒ½æ“ä½œå…¶ä»–å†…å­˜åœ°å€çš„æ•°æ®ï¼Œæ‰€ä»¥æ€»çº¿é”çš„å¼€é”€æ¯”è¾ƒå¤§ï¼Œç¼“å­˜é”å¯ä»¥åœ¨æŸäº›åœºåˆä»£æ›¿æ€»çº¿é”è¿›è¡Œä¼˜åŒ–ã€‚ ç¼“å­˜é” å†…å­˜åŒºåŸŸå¦‚æœè¢«ç¼“å­˜åœ¨å¤„ç†å™¨çš„ç¼“å­˜è¡Œä¸­ï¼Œå¹¶ä¸”åœ¨LOCK#æ“ä½œæœŸé—´ï¼Œé‚£ä¹ˆå½“å®ƒæ‰§è¡Œæ“ä½œå›å†™åˆ°å†…å­˜æ—¶ï¼Œå¤„ç†å™¨ä¸èƒ½åœ¨æ€»çº¿ä¸Šå£°æ˜LOCK#ä¿¡å·ï¼Œè€Œæ˜¯ä¿®æ”¹å†…éƒ¨çš„å†…å­˜åœ°å€ï¼Œå…è®¸å®ƒçš„ç¼“å­˜ä¸€è‡´æ€§æœºåˆ¶æ¥ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œå› ä¸ºç¼“å­˜ä¸€è‡´æ€§ä¼šé˜»æ­¢åŒæ—¶ä¿®æ”¹ä¸¤ä¸ªä»¥ä¸Šå¤„ç†å™¨ç¼“å­˜çš„å†…å­˜åŒºåŸŸæ•°æ®ï¼Œå½“å…¶ä»–å¤„ç†å™¨å›å†™å·²è¢«é”å®šçš„ç¼“å­˜è¡Œæ•°æ®æ—¶ï¼Œä¼šä½¿ç¼“å­˜è¡Œæ— æ•ˆã€‚ ä½†æœ‰ä¸¤ç§æƒ…å†µä¸‹å¤„ç†å™¨ä¸ä¼šä½¿ç”¨ç¼“å­˜é”å®šï¼š 1ã€å½“æ“ä½œçš„æ•°æ®ä¸èƒ½è¢«ç¼“å­˜åœ¨å¤„ç†å™¨å†…éƒ¨ï¼Œæˆ–æ“ä½œçš„æ•°æ®è·¨å¤šä¸ªç¼“å­˜è¡Œ(cache line)ï¼Œåˆ™å¤„ç†å™¨ä¼šè°ƒç”¨æ€»çº¿é” 2ã€æœ‰äº›å¤„ç†å™¨ä¸æ”¯æŒç¼“å­˜é”å®šã€‚ é”æœºåˆ¶è™½ç„¶èƒ½ä¿è¯åŸå­æ€§ï¼Œä½†æ˜¯é”æœºåˆ¶æœ€ä¸»è¦çš„é—®é¢˜ï¼šå¤šçº¿ç¨‹ç«äº‰çš„æƒ…å†µä¸‹ï¼Œä¼šå‡ºç°çº¿ç¨‹é˜»å¡å’Œå”¤é†’é”å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ï¼Œäº’æ–¥åŒæ­¥(é˜»å¡åŒæ­¥)ã€‚ é”æœºåˆ¶é‡‡ç”¨çš„æ˜¯æ‚²è§‚é”ç­–ç•¥ï¼Œå¹¶ä¸æ˜¯ä¸€ç§ç‰¹åˆ«é«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚å¯ä»¥é‡‡ç”¨ä¹è§‚é”ï¼Œæ¯æ¬¡ä¸åŠ é”ï¼Œè€Œæ˜¯å‡è®¾æ²¡æœ‰å†²çªå»å®ŒæˆæŸé¡¹æ“ä½œï¼Œå¦‚æœæœ‰å†²çªå°±é‡è¯•ï¼ŒçŸ¥é“æˆåŠŸä¸ºæ­¢ã€‚è¿™å°±æ˜¯æ— é”æ“ä½œCAS(Compare and swap)ã€‚ ","date":"2021-06-03","objectID":"/2021/06/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/:2:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹åŸå­æ“ä½œ","uri":"/2021/06/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"CAS CASæ˜¯ä¸€æ¡åŸå­æŒ‡ä»¤ï¼ŒCAS(V,O,N)ï¼ŒåŒ…å«ä¸‰ä¸ªå€¼åˆ†åˆ«ä¸ºï¼šVå†…å­˜åœ°å€å­˜æ”¾çš„å®é™…å€¼ï¼ŒOé¢„æœŸçš„å€¼(æ—§å€¼)ï¼ŒNæ›´æ–°çš„å€¼ï¼Œä½œç”¨æ˜¯è®©CPUå…ˆæ¯”è¾ƒæ—§å€¼Oå’Œå†…å­˜å®é™…å€¼Vï¼Œå¦‚æœç›¸ç­‰å°±è¡¨æ˜æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡ï¼Œå°±ä¼šæŠŠæ–°å€¼Nèµ‹å€¼ç»™Vã€‚åä¹‹ï¼ŒVå’ŒOä¸ç›¸ç­‰ï¼Œä¸èƒ½æŠŠNèµ‹å€¼ç»™Vï¼Œè¿”å›Vå³å¯ã€‚ ä¼ªä»£ç ï¼š func CompareAndSwap(addr *int, oldValue,newValue int) bool { if addr == nil { return false } if *addr == oldValue { *addr = newValue return true } return false } ä¸è¿‡ä¸Šé¢çš„ä»£ç å¯èƒ½ä¼šå‘ç”Ÿä¸€ä¸ªé—®é¢˜ï¼Œä¹Ÿå°±æ˜¯ABAé—®é¢˜ã€‚å› ä¸ºCASéœ€è¦åœ¨æ“ä½œå€¼çš„æ—¶å€™æ£€æŸ¥å€¼æœ‰æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœæ²¡æœ‰å‘ç”Ÿå˜åŒ–åˆ™æ›´æ–°ï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ªå€¼åŸæ¥æ˜¯Aï¼Œå˜æˆäº†Bï¼Œåˆå˜å›äº†Aï¼Œé‚£ä¹ˆä½¿ç”¨CASæ£€æŸ¥æ—¶ä¼šå‘ç°å®ƒçš„å€¼æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œä½†å®é™…ä¸Šå‘ç”Ÿäº†å˜åŒ–ã€‚ABAé—®é¢˜çš„è§£å†³æ€è·¯å°±æ˜¯ä½¿ç”¨ç‰ˆæœ¬å·ï¼Œåœ¨éå†å‰é¢è¿½åŠ ç‰ˆæœ¬å·ï¼Œæ¯æ¬¡æ›´æ–°çš„æ—¶å€™éƒ½ä¼šæŠŠç‰ˆæœ¬å·åŠ 1ï¼Œé‚£ä¹ˆA-B-Aå°±ä¼šå˜æˆ1A-2B-3Aã€‚ ","date":"2021-06-03","objectID":"/2021/06/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/:3:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹åŸå­æ“ä½œ","uri":"/2021/06/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"goåŒ…ä¸­çš„åŸå­æ“ä½œ åœ¨src/sync/atomic/doc.goä¸‹ï¼ŒæŠŠåº•å±‚ç¡¬ä»¶æä¾›çš„åŸå­æ“ä½œå°è£…æˆäº†Goçš„å‡½æ•°ï¼Œåˆ†ä¸º5ä¸ªç³»åˆ—ï¼š 1ã€SwapXXX(addr *int32, new int32) (old int32)ï¼šåŸå­æ€§çš„å°†newçš„å€¼ä¿å­˜åˆ°*addrå¹¶è¿”å›æ—§å€¼ 2ã€CompareAndSwapInt32(addr *int32, old, new int32) (swapped bool)ï¼šåŸå­æ€§æ¯”è¾ƒ*addrå’Œoldçš„å€¼ï¼Œå¦‚æœç›¸åŒåˆ™å°†newèµ‹å€¼ç»™*addrå¹¶è¿”å›true 3ã€AddInt32(addr *int32, delta int32) (new int32)ï¼šåŸå­æ€§çš„å°†deltaçš„å€¼åŠ åˆ°*addrå¹¶è¿”å›æ–°å€¼ 4ã€LoadInt32(addr *int32) (val int32)ï¼šåŸå­æ€§çš„è·å–*addrçš„å€¼ 5ã€StoreInt32(addr *int32, val int32)ï¼šåŸå­æ€§çš„å°†valçš„å€¼ä¿å­˜åˆ°*addr ","date":"2021-06-03","objectID":"/2021/06/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/:4:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹åŸå­æ“ä½œ","uri":"/2021/06/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"æºç è§£æ åŸå­æ“ä½œæ˜¯åŸºäºæ±‡ç¼–å®ç°çš„ï¼ŒåŸºäºplan9çš„ã€‚ æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹value.goæ–‡ä»¶çš„æºç ã€‚ type Value struct { v interface{} } è™½ç„¶è¿™é‡Œæ˜¯interfaceç±»å‹ï¼Œä½†æ˜¯è¿™é‡Œå…¶å®æ˜¯åˆ†è§£äº†ç±»å‹å’Œå€¼çš„ã€‚ type ifaceWords struct { typ unsafe.Pointer data unsafe.Pointer } ","date":"2021-06-03","objectID":"/2021/06/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/:5:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹åŸå­æ“ä½œ","uri":"/2021/06/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"Valueçš„å†™å…¥ func (v *Value) Store(x interface{}) { if x == nil { panic(\"sync/atomic: store of nil value into Value\") } vp := (*ifaceWords)(unsafe.Pointer(v)) xp := (*ifaceWords)(unsafe.Pointer(\u0026x)) for { typ := LoadPointer(\u0026vp.typ) if typ == nil { // Attempt to start first store. // Disable preemption so that other goroutines can use // active spin wait to wait for completion; and so that // GC does not see the fake type accidentally. runtime_procPin() if !CompareAndSwapPointer(\u0026vp.typ, nil, unsafe.Pointer(^uintptr(0))) { runtime_procUnpin() continue } // Complete first store. StorePointer(\u0026vp.data, xp.data) StorePointer(\u0026vp.typ, xp.typ) runtime_procUnpin() return } if uintptr(typ) == ^uintptr(0) { // First store in progress. Wait. // Since we disable preemption around the first store, // we can wait with active spinning. continue } // First store completed. Check type and overwrite data. if typ != xp.typ { panic(\"sync/atomic: store of inconsistently typed value into Value\") } StorePointer(\u0026vp.data, xp.data) return } } // Disable/enable preemption, implemented in runtime. func runtime_procPin() func runtime_procUnpin() é€šè¿‡æŠ¥é”™ä¿¡æ¯å’Œæ³¨é‡Šæˆ‘ä»¬çŸ¥é“ï¼Œå­˜å…¥çš„å€¼ä¸èƒ½ä¸ºnilï¼Œç±»å‹å¿…é¡»ä¸åŸç±»å‹ç›¸åŒã€‚ å†™å…¥æ­¥éª¤ï¼š 1ã€åˆ¤æ–­å†™å…¥å€¼ä¸èƒ½ä¸ºnilï¼Œå¦åˆ™è§¦å‘panic 2ã€å°†oldValueå’ŒnewValueè½¬æ¢æˆifaceWordsç±»å‹ï¼Œæ–¹ä¾¿è·å–ç±»å‹å’Œå€¼ 3ã€ä¸ºäº†ä¿è¯åŸå­æ€§ï¼Œå¾ªç¯å¤„ç†ï¼Œå½“å·²ç»æœ‰Storeæ­£åœ¨å†™å…¥æ—¶ï¼Œä¼šè¿›è¡Œç­‰å¾…ã€‚ 4ã€å¦‚æœè¿˜æ²¡æœ‰å†™å…¥æ•°æ®ï¼Œç±»å‹ä¸ºç©ºï¼Œé‚£ä¹ˆä¼šå¼€å§‹ç¬¬ä¸€æ¬¡å†™å…¥æ“ä½œï¼Œä¼šå…ˆè°ƒç”¨runtime_procPinæ–¹æ³•ç¦æ­¢è°ƒåº¦å™¨å¯¹å½“å‰goroutineçš„æŠ¢å  5ã€è°ƒç”¨CASæ–¹æ³•æ¥åˆ¤æ–­å½“å‰åœ°å€æ˜¯å¦æœ‰è¢«æŠ¢å ï¼Œå¦‚æœå¤±è´¥ï¼Œå°±ä¼šè§£é™¤æŠ¢å é”ï¼Œè§£é™¤ç¦æ­¢è°ƒåº¦å™¨ï¼Œå¾ªç¯ç­‰å¾… 6ã€è®¾ç½®ä¸­é—´å€¼æˆåŠŸåï¼Œå¯ä»¥å®‰å…¨çš„æŠŠvè®¾ä¸ºä¼ å…¥çš„æ–°å€¼äº†ï¼Œå†™å…¥å€¼å’Œç±»å‹ã€‚ 7ã€ç¬¬ä¸€æ¬¡å†™å…¥æ²¡æœ‰å®Œæˆï¼Œé€šè¿‡uintptr(typ) == ^uintptr(0)æ¥åˆ¤æ–­ï¼Œå› ä¸ºè¿˜æ˜¯ç¬¬ä¸€æ¬¡æ”¾å…¥çš„ä¸­é—´ç±»å‹ï¼Œä¼šç»§ç»­ç­‰å¾…ç¬¬ä¸€æ¬¡å®Œæˆ 8ã€å¦‚æœç¬¬ä¸€æ¬¡å†™å…¥å®Œæˆï¼Œä¼šæ£€æŸ¥ç±»å‹æ˜¯å¦ä¸€è‡´ï¼Œç„¶åå†™å…¥æ•°æ® ","date":"2021-06-03","objectID":"/2021/06/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/:5:1","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹åŸå­æ“ä½œ","uri":"/2021/06/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"Valueçš„è¯»å– func (v *Value) Load() (x interface{}) { vp := (*ifaceWords)(unsafe.Pointer(v)) typ := LoadPointer(\u0026vp.typ) if typ == nil || uintptr(typ) == ^uintptr(0) { // First store not yet completed. return nil } data := LoadPointer(\u0026vp.data) xp := (*ifaceWords)(unsafe.Pointer(\u0026x)) xp.typ = typ xp.data = data return } å…ˆè½¬æ¢oldValueï¼Œç„¶åæ ¹æ®ç±»å‹åˆ¤æ–­æ˜¯å¦æœ‰æ•°æ®æˆ–ç¬¬ä¸€æ¬¡å†™å…¥æœ‰æ²¡æœ‰å®Œæˆï¼Œé€šè¿‡æ£€æŸ¥åï¼Œè·å–å€¼ã€‚ ","date":"2021-06-03","objectID":"/2021/06/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/:5:2","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹åŸå­æ“ä½œ","uri":"/2021/06/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"æ€»ç»“ golangåŒ…ä¸­çš„åŸå­æ“ä½œå¯ä»¥çœ‹æˆæ˜¯ä¹è§‚é”ï¼Œè€Œäº’æ–¥é”å¯ä»¥çœ‹æˆæ˜¯æ‚²è§‚é”ã€‚ åŸå­é”æ“ä½œæ›´åŠ è½»é‡ï¼Œå¯ä»¥åœ¨ä¸å½¢æˆä¸´ç•ŒåŒºå’Œåˆ›å»ºäº’æ–¥é‡çš„æƒ…å†µä¸‹å¹¶å‘å®‰å…¨çš„å€¼æ›¿æ¢æ“ä½œï¼Œå¯ä»¥å¤§å¤§å‡å°‘åŒæ­¥å¯¹ç¨‹åºæ€§èƒ½çš„æŸè€—ã€‚ ","date":"2021-06-03","objectID":"/2021/06/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/:6:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹åŸå­æ“ä½œ","uri":"/2021/06/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/"},{"categories":["æœˆéœœå¤©çš„GO"],"content":"å‚è€ƒèµ„æ–™ åŸå­æ“ä½œ ","date":"2021-06-03","objectID":"/2021/06/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/:7:0","tags":["æºç è§£æ","sync"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹åŸå­æ“ä½œ","uri":"/2021/06/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"ä¸€ã€ç®€ä»‹ å½“é›†ç¾¤ä¸­çš„æŸä¸ªæœåŠ¡éœ€è¦å‡çº§æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åœæ­¢ç›®å‰ä¸è¯¥æœåŠ¡çš„ç›¸å…³çš„æ‰€æœ‰podï¼Œç„¶åä¸‹è½½æ–°ç‰ˆæœ¬é•œåƒå¹¶åˆ›å»ºæ–°çš„podã€‚å¦‚æœé›†ç¾¤è§„æ¨¡æ¯”è¾ƒå¤§ï¼Œåˆ™è¿™ä¸ªå·¥ä½œå°±ä¼šå¾ˆéº»çƒ¦ã€‚kubernetesæä¾›äº†æ»šåŠ¨å‡çº§åŠŸèƒ½æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ ","date":"2021-03-24","objectID":"/2021/03/pod%E5%8D%87%E7%BA%A7%E4%B8%8E%E5%9B%9E%E6%BB%9A/:1:0","tags":["kubernetes","pod"],"title":"Podå‡çº§ä¸å›æ»š","uri":"/2021/03/pod%E5%8D%87%E7%BA%A7%E4%B8%8E%E5%9B%9E%E6%BB%9A/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"äºŒã€Deploymentçš„å‡çº§ nginx-deployment.yamlapiVersion:apps/v1kind:Deploymentmetadata:name:nginx-deploymentspec:selector:matchLabels:app:nginxreplicas:3template:metadata:labels:app:nginxspec:containers:- name:nginximage:nginx:1.7.9ports:- containerPort:80 å½“podçš„é•œåƒéœ€è¦è¢«å‡çº§ä¸ºnginx:1.9.1æ—¶ï¼Œå¯ä»¥é€šè¿‡kubectl set imageå‘½ä»¤ kubectl set image deployment/nginx-deploymnet nginx=nginx:1.9.1 æˆ–é€šè¿‡kubectl editä¿®æ”¹Deploymenté…ç½®ã€‚ åœ¨Deploymentçš„å®šä¹‰ä¸­ï¼Œå¯ä»¥é€šè¿‡spec.strategyæŒ‡å®šPodæ›´æ–°çš„ç­–ç•¥ï¼Œç›®å‰æ”¯æŒRecreateï¼ˆé‡å»ºï¼‰å’ŒRollingUpdateï¼ˆæ»šåŠ¨æ›´æ–°ï¼‰ï¼Œé»˜è®¤å€¼ä¸ºæ»šåŠ¨æ›´æ–°ã€‚ Recreateï¼šè¡¨ç¤ºDeploymentåœ¨æ›´æ–°podæ—¶ï¼Œä¼šå…ˆæ€æ‰æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„Podï¼Œç„¶ååˆ›å»ºæ–°çš„Pod RollingUpdateï¼šä¼šä»¥æ»šåŠ¨æ›´æ–°çš„æ–¹å¼é€ä¸ªæ›´æ–°Podã€‚ spec.strategy.rollingUpdate.maxUnavailableï¼šç”¨äºæŒ‡å®šDeploymentåœ¨æ›´æ–°è¿‡ç¨‹ä¸­ä¸å¯ç”¨çŠ¶æ€çš„Podæ•°é‡ä¸Šé™ã€‚ spec.strategy.rollingUpdate.maxSurgeï¼šç”¨äºæŒ‡å®šDeploymentæ›´æ–°Podçš„è¿‡ç¨‹ä¸­Podæ€»æ•°è¶…è¿‡PodæœŸæœ›å‰¯æœ¬æ•°éƒ¨åˆ†çš„æœ€å¤§å€¼ã€‚ å¤šé‡æ›´æ–°ï¼ˆRolloverï¼‰ å¦‚æœDeploymentçš„ä¸Šä¸€æ¬¡æ›´æ–°æ­£åœ¨è¿›è¡Œï¼Œæ­¤æ—¶ç”¨æˆ·å†æ¬¡å‘èµ·Deploymentçš„æ›´æ–°æ“ä½œï¼Œé‚£ä¹ˆDeploymentä¼šä¸ºæ¯ä¸€æ¬¡æ›´æ–°éƒ½åˆ›å»ºä¸€ä¸ªReplicaSetï¼Œè€Œæ¯æ¬¡åœ¨æ–°çš„ReplicaSetåˆ›å»ºæˆåŠŸåï¼Œä¼šé€ä¸ªå¢åŠ Podå‰¯æœ¬æ•°ï¼ŒåŒæ—¶å°†ä¹‹å‰æ­£åœ¨æ‰©å®¹çš„ReplicaSetåœæ­¢æ‰©å®¹ï¼Œå¹¶å°†å…¶åŠ å…¥æ—§ç‰ˆæœ¬ReplicaSetåˆ—è¡¨ä¸­ï¼Œç„¶åå¼€å§‹ç¼©å®¹è‡³0çš„æ“ä½œã€‚ ","date":"2021-03-24","objectID":"/2021/03/pod%E5%8D%87%E7%BA%A7%E4%B8%8E%E5%9B%9E%E6%BB%9A/:2:0","tags":["kubernetes","pod"],"title":"Podå‡çº§ä¸å›æ»š","uri":"/2021/03/pod%E5%8D%87%E7%BA%A7%E4%B8%8E%E5%9B%9E%E6%BB%9A/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"ä¸‰ã€Deploymentçš„å›æ»š å¯ä»¥ä½¿ç”¨kubectl rollout historyå‘½ä»¤æ£€æŸ¥Deploymentéƒ¨ç½²çš„å†å²è®°å½•ã€‚ kubectl rollout history deployment/nginx-deployment æ³¨æ„ï¼šè¿™é‡Œéœ€è¦åœ¨æ–°å»ºDeploymentæ—¶ä½¿ç”¨--recordå‚æ•°ã€‚ å¦‚æœéœ€è¦æŸ¥çœ‹ç‰¹å®šç‰ˆæœ¬çš„è¯¦ç»†ä¿¡æ¯ï¼Œåˆ™å¯ä»¥åŠ ä¸Š--revision=\u003cN\u003eå‚æ•°ã€‚ æ’¤é”€æœ¬æ¬¡å‘å¸ƒå¹¶å›æ»šåˆ°ä¸Šä¸€ä¸ªéƒ¨ç½²ç‰ˆæœ¬ kubectl rollout undo deployment/nginx-deployment å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨--to-revisionå‚æ•°æŒ‡å®šå›æ»šåˆ°çš„éƒ¨ç½²ç‰ˆæœ¬å·ã€‚ ","date":"2021-03-24","objectID":"/2021/03/pod%E5%8D%87%E7%BA%A7%E4%B8%8E%E5%9B%9E%E6%BB%9A/:3:0","tags":["kubernetes","pod"],"title":"Podå‡çº§ä¸å›æ»š","uri":"/2021/03/pod%E5%8D%87%E7%BA%A7%E4%B8%8E%E5%9B%9E%E6%BB%9A/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"å››ã€æš‚åœå’Œæ¢å¤Deploymentçš„éƒ¨ç½²æ“ä½œ å¯¹äºä¸€æ¬¡å¤æ‚çš„Deploymenté…ç½®ä¿®æ”¹ï¼Œä¸ºäº†é¿å…é¢‘ç¹è§¦å‘Deploymentçš„æ›´æ–°æ“ä½œï¼Œå¯ä»¥å…ˆæš‚åœDeploymentçš„æ›´æ–°æ“ä½œï¼Œç„¶åè¿›è¡Œé…ç½®ä¿®æ”¹ï¼Œå†æ¢å¤Deploymentï¼Œä¸€æ¬¡è§¦å‘å®Œæ•´çš„æ›´æ–°æ“ä½œã€‚ é€šè¿‡ä½¿ç”¨kubectl rollout pauseæš‚åœDeploymentçš„æ›´æ–°æ“ä½œ kubectl rollout pause deployment/nginx-deployment é€šè¿‡ä½¿ç”¨kubectl rollout resumeæ¢å¤æ“ä½œ kubectl rollout resume deploy/nginx-deployment ","date":"2021-03-24","objectID":"/2021/03/pod%E5%8D%87%E7%BA%A7%E4%B8%8E%E5%9B%9E%E6%BB%9A/:4:0","tags":["kubernetes","pod"],"title":"Podå‡çº§ä¸å›æ»š","uri":"/2021/03/pod%E5%8D%87%E7%BA%A7%E4%B8%8E%E5%9B%9E%E6%BB%9A/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"äº”ã€å…¶ä»–æ›´æ–°æ“ä½œ 1ã€RCçš„æ»šåŠ¨æ›´æ–° kubectl rolling-updateå‘½ä»¤ï¼Œé€šè¿‡é…ç½®æ–‡ä»¶ RCåå­—ä¸ä¸æ—§RCç›¸åŒï¼›åœ¨selectorä¸­åº”è‡³å°‘æœ‰ä¸€ä¸ªLabelä¸æ—§RCçš„Labelä¸åŒï¼Œä»¥æ ‡è¯†å…¶ä¸ºæ–°RCã€‚ kubectl rolling-update redis-master -f redis-master-ctl-v2.yaml kubectl rolling-updateå‘½ä»¤ï¼Œä¸é€šè¿‡é…ç½®æ–‡ä»¶ kubectl rolling-update redis-master --image=redis-master:2.0 æ‰§è¡Œç»“æœæ˜¯æ—§RCè¢«åˆ é™¤ï¼Œæ–°çš„RCå°†ä½¿ç”¨æ—§RCçš„åç§° 2ã€DaemonSetçš„æ›´æ–°ç­–ç•¥ OnDeleteï¼šé»˜è®¤çš„å‡çº§ç­–ç•¥ï¼Œæ–°çš„Podå¹¶ä¸ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œç›´åˆ°ç”¨æˆ·æ‰‹åŠ¨åˆ é™¤æ—§ç‰ˆæœ¬çš„Podï¼Œæ‰è§¦å‘æ–°å»ºæ“ä½œã€‚ RollingUpdateï¼šæ•´ä¸ªè¿‡ç¨‹å’ŒDeploymentç±»ä¼¼ï¼Œä½†ä¸æ”¯æŒæŸ¥çœ‹DaemonSetçš„æ›´æ–°å†å²è®°å½•ï¼›ä¸èƒ½é€šè¿‡rollbackå›æ»šï¼Œå¿…é¡»é€šè¿‡å†æ¬¡æäº¤æ—§ç‰ˆæœ¬é…ç½®çš„æ–¹å¼å®ç°ã€‚ 3ã€Statefulsetçš„æ›´æ–°ç­–ç•¥ å®ç°äº†RollingUpdateã€OnDeleteå’ŒParitionedç­–ç•¥ã€‚ Partition:3è¡¨ç¤ºç´¢å¼•3ä»¥ä¸Šçš„å¯¹è±¡æ›´æ–°ã€‚ ","date":"2021-03-24","objectID":"/2021/03/pod%E5%8D%87%E7%BA%A7%E4%B8%8E%E5%9B%9E%E6%BB%9A/:5:0","tags":["kubernetes","pod"],"title":"Podå‡çº§ä¸å›æ»š","uri":"/2021/03/pod%E5%8D%87%E7%BA%A7%E4%B8%8E%E5%9B%9E%E6%BB%9A/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"ä¸€ã€ç®€ä»‹ åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸å…³å¿ƒpodä¼šè¢«è°ƒåº¦åˆ°å“ªä¸ªèŠ‚ç‚¹ï¼Œåªå…³å¿ƒpodæ˜¯å¦è¢«æˆåŠŸè°ƒåº¦åˆ°é›†ç¾¤çš„ä¸€ä¸ªå¯ç”¨èŠ‚ç‚¹ã€‚ä½†æ˜¯ï¼Œåœ¨çœŸå®ç”Ÿäº§ç¯å¢ƒä¸­å­˜åœ¨ä¸€ç§éœ€æ±‚ï¼šå¸Œæœ›æŸç§podå…¨éƒ¨è¿è¡Œåœ¨ä¸€ä¸ªæˆ–ä¸€äº›èŠ‚ç‚¹ä¸Šã€‚æ¯”å¦‚éœ€è¦ssdçš„podéƒ½è¿è¡Œåœ¨å…·æœ‰ssdç£ç›˜çš„ç›®æ ‡èŠ‚ç‚¹ä¸Šã€‚ ","date":"2021-03-23","objectID":"/2021/03/pod%E8%B0%83%E5%BA%A6/:1:0","tags":["kubernetes","pod"],"title":"Podè°ƒåº¦","uri":"/2021/03/pod%E8%B0%83%E5%BA%A6/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"äºŒã€å…¨è‡ªåŠ¨è°ƒåº¦ deploymentæˆ–rcçš„ä¸»è¦åŠŸèƒ½ä¹‹ä¸€å°±æ˜¯è‡ªåŠ¨éƒ¨ç½²ä¸€ä¸ªå®¹å™¨åº”ç”¨çš„å¤šä»½å‰¯æœ¬ï¼Œä»¥åŠæŒç»­ç›‘æ§å‰¯æœ¬çš„æ•°é‡ï¼Œåœ¨é›†ç¾¤ä¸­å§‹ç»ˆç»´æŒç”¨æˆ·æŒ‡å®šçš„å‰¯æœ¬æ•°é‡ã€‚ nginx-deployment.yamlapiVersion:apps/v1kind:Deploymentmetadata:name:nginx-deploymentspec:selector:matchLabels:app:nginxreplicas:3template:metadata:labels:app:nginxspec:containers:- name:nginximage:nginx:1.7.9ports:- containerPort:80 ä½¿ç”¨kubectl createå‘½ä»¤åˆ›å»ºè¿™ä¸ªdeploymentï¼š # kubectl create -f nginx-deployment.yaml deployment \"nginx-deployment\" created å¯ä»¥çœ‹åˆ°Deploymentå·²ç»åˆ›å»ºå¥½3ä¸ªå‰¯æœ¬ï¼Œå¹¶ä¸”æ‰€æœ‰å‰¯æœ¬éƒ½æ˜¯æœ€æ–°å¯ç”¨çš„ã€‚ä»è°ƒåº¦ç­–ç•¥ä¸Šæ¥è¯´ï¼Œè¿™3ä¸ªpodç”±ç³»ç»Ÿå…¨è‡ªåŠ¨å®Œæˆè°ƒåº¦ï¼Œç”¨æˆ·æ— æ³•å¹²é¢„è°ƒåº¦è¿‡ç¨‹å’Œç»“æœã€‚ ","date":"2021-03-23","objectID":"/2021/03/pod%E8%B0%83%E5%BA%A6/:2:0","tags":["kubernetes","pod"],"title":"Podè°ƒåº¦","uri":"/2021/03/pod%E8%B0%83%E5%BA%A6/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"ä¸‰ã€NodeSelectorï¼šå®šå‘è°ƒåº¦ é€šè¿‡Nodeçš„æ ‡ç­¾ï¼ˆLabelï¼‰å’ŒPodçš„nodeSelectorå±æ€§ç›¸åŒ¹é…æ¥è®²Podè°ƒåº¦åˆ°æŒ‡å®šçš„ä¸€äº›Nodeä¸Šã€‚ 1ã€é€šè¿‡kubectl labelå‘½ä»¤ç»™ç›®æ ‡Nodeæ‰“ä¸Šä¸€äº›æ ‡ç­¾ï¼š kubectl label nodes \u003cnode-name\u003e \u003clabel-key\u003e=\u003clabel-value\u003e 2ã€åœ¨Podçš„å®šä¹‰ä¸­åŠ ä¸ŠnodeSelectorçš„è®¾ç½® apiVersion:v1kind:ReplicationControllermetadata:name:redis-masterlabels:name:redis-masterspec:replicas:3selector:name:redis-mastertemplate:metadata:labels:name:redis-masterspec:containers:- name:masterimage:reids-masterports:- containerPort:6379nodeSelector: # èŠ‚ç‚¹æ ‡ç­¾é€‰æ‹©å™¨zone:north å¦‚æœç»™å¤šä¸ªNodeéƒ½å®šä¹‰äº†ç›¸åŒçš„æ ‡ç­¾ï¼Œåˆ™schedulerä¼šæ ¹æ®è°ƒåº¦ç®—æ³•ä»Nodeç»„ä¸­æŒ‘é€‰ä¸€ä¸ªå¯ç”¨çš„Nodeè¿›è¡Œè°ƒåº¦ã€‚ é™¤äº†ç”¨æˆ·å¯ä»¥è‡ªè¡Œç»™Nodeæ·»åŠ æ ‡ç­¾ï¼Œkubernetesä¹Ÿä¼šç»™Nodeé¢„å®šä¹‰ä¸€äº›æ ‡ç­¾ã€‚ kubernetes.io/hostname kubernetes.io/os kubernetes.io/arch ","date":"2021-03-23","objectID":"/2021/03/pod%E8%B0%83%E5%BA%A6/:3:0","tags":["kubernetes","pod"],"title":"Podè°ƒåº¦","uri":"/2021/03/pod%E8%B0%83%E5%BA%A6/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"å››ã€NodeAffinityï¼šNodeäº²å’Œæ€§è°ƒåº¦ NodeAffinityä¸ºNodeäº²å’Œæ€§çš„è°ƒåº¦ç­–ç•¥ï¼Œæ˜¯ç”¨äºæ›¿æ¢NodeSelectorçš„å…¨æ–°è°ƒåº¦ç­–ç•¥ã€‚ç›®å‰æœ‰ä¸¤ç§èŠ‚ç‚¹äº²å’Œæ€§è¡¨è¾¾ã€‚ RequiredDuringSchedulingIgnoredDuringExecutionï¼šå¿…é¡»æ»¡è¶³æŒ‡å®šçš„è§„åˆ™æ‰èƒ½è°ƒåº¦Podåˆ°Nodeä¸Šï¼Œç›¸å½“äºç¡¬é™åˆ¶ã€‚ PreferredDuringSchedulingIgnoredDuringExecutionï¼šå¼ºè°ƒä¼˜å…ˆæ»¡è¶³æŒ‡å®šè§„åˆ™ï¼Œè°ƒåº¦å™¨ä¼šå°è¯•è°ƒåº¦Podåˆ°Nodeä¸Šï¼Œä½†ä¸å¼ºæ±‚ï¼Œç›¸å½“äºè½¯é™åˆ¶ã€‚å¤šä¸ªä¼˜å…ˆçº§è§„åˆ™è¿˜å¯ä»¥è®¾ç½®æƒé‡(weight)å€¼ï¼Œä»¥å®šä¹‰æ‰§è¡Œçš„å…ˆåé¡ºåºã€‚ IgnoredDuringExecutionï¼šå¦‚æœä¸€ä¸ªPodæ‰€åœ¨çš„ç»“ç‚¹åœ¨Podè¿è¡ŒæœŸé—´æ ‡ç­¾å‘ç”Ÿäº†å˜æ›´ï¼Œä¸å†ç¬¦åˆPodçš„ç»“ç‚¹äº²å’Œæ€§éœ€æ±‚ï¼Œåˆ™ç³»ç»Ÿå°†å¿½ç•¥Nodeä¸Šçš„Labelå˜åŒ–ï¼Œè¯¥Podèƒ½ç»§ç»­åœ¨è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚ apiVersion:v1kind:Podmetadata:name:with-node-affinityspec:affinity:nodeAffinity:# è¦æ±‚åªåœ¨amd64çš„èŠ‚ç‚¹ä¸Šè¿è¡ŒrequiredDuringSchedulingIgnoredDuringExecution:nodeSelectorTerms:- matchExpressions:- key:beta.kubernetes.io/archoperator:Invalues:- amd64preferredDuringSchedulingIgnoredDuringExecution:- weight:1# å°½é‡è¿è¡Œåœ¨ç£ç›˜ç±»å‹ä¸ºssdçš„èŠ‚ç‚¹ä¸Špreference:matchExpressions:- key:disk-typeoperator:Invalues:- ssdcontainers:- name:with-node-affinityimage:pause:2.0 NodeAffinityè¯­æ³•æ”¯æŒçš„æ“ä½œç¬¦åŒ…æ‹¬Inã€NotInã€Existsã€DoesNotExistã€Gtã€Ltã€‚ NodeAffinityè§„åˆ™è®¾ç½®çš„æ³¨æ„äº‹é¡¹ï¼š å¦‚æœåŒæ—¶å®šä¹‰äº†nodeSelectorå’ŒnodeAffinityï¼Œé‚£ä¹ˆå¿…é¡»ä¸¤ä¸ªæ¡ä»¶éƒ½å¾—åˆ°æ»¡è¶³ï¼ŒPodæ‰èƒ½æœ€ç»ˆè¿è¡Œåœ¨æŒ‡å®šçš„Nodeä¸Š å¦‚æœnodeAffinityæŒ‡å®šäº†å¤šä¸ªnodeSelectorTermsï¼Œé‚£ä¹ˆå…¶ä¸­ä¸€ä¸ªèƒ½å¤ŸåŒ¹é…æˆåŠŸå³å¯ å¦‚æœnodeSelectorTermsä¸­æœ‰å¤šä¸ªmatchExpressionsï¼Œåˆ™ä¸€ä¸ªèŠ‚ç‚¹å¿…é¡»æ»¡è¶³æ‰€æœ‰matchExpressionsæ‰èƒ½è¿è¡ŒPodã€‚ ","date":"2021-03-23","objectID":"/2021/03/pod%E8%B0%83%E5%BA%A6/:4:0","tags":["kubernetes","pod"],"title":"Podè°ƒåº¦","uri":"/2021/03/pod%E8%B0%83%E5%BA%A6/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"äº”ã€PodAffinityï¼šPodäº²å’Œä¸äº’æ–¥è°ƒåº¦ç­–ç•¥ å¦‚æœåœ¨å…·æœ‰æ ‡ç­¾ç›¸åŒçš„Nodeä¸Šè¿è¡Œäº†ä¸€ä¸ªæˆ–å¤šä¸ªç¬¦åˆæ¡ä»¶çš„Podï¼Œé‚£ä¹ˆPodåº”è¯¥è¿è¡Œåœ¨è¿™ä¸ªNodeä¸Šã€‚ topologyKeyï¼šèŠ‚ç‚¹æ‰€å±çš„topoloty kubernets.io/hostname failure-domain.beta.kubernetse.io/zone failure-domain.beta.kubernets.io/region podçš„äº²å’Œä¸äº’æ–¥çš„æ¡ä»¶è®¾ç½®ä¹Ÿæ˜¯RequiredDuringSchedulingIgnoredDuringExecutionå’ŒPreferredDuringSchedulingIgnoredDuringExecutionã€‚ Podçš„äº²å’Œæ€§è¢«å®šä¹‰åœ¨podAffinityï¼ŒPodçš„äº’æ–¥æ€§è¢«å®šä¹‰åœ¨podAntiAffinityã€‚ 1ã€å‚è€ƒç›®æ ‡Pod åˆ›å»ºä¸€ä¸ªåä¸ºpod-flagçš„podï¼Œå¸¦æœ‰æ ‡ç­¾security=S1å’Œapp=nginxã€‚ apiVerson:v1kind:Podmetadata:name:pod-flaglabels:security:\"S1\"app:\"nginx\"spec:containers:- name:nginximage:nginx 2ã€Podçš„äº²å’Œæ€§è°ƒåº¦ apiVerson:v1kind:Podmetadata:name:pod-affinityspec:affinity:podAffinity:requiredDuringSchedulingIgnoredDuringExecution:- labelSelector:matchExpressions:- key:securityoperator:Invalues:- S1topologyKey:kubernets.io/hostnamecontainers:- name:with-pod-affinityimage:pause:2.0 3ã€Podçš„äº’æ–¥æ€§è°ƒåº¦ apiVerson:v1kind:Podmetadata:name:anti-affinityspec:affinity:podAffinity:requiredDuringSchedulingIgnoredDuringExecution:- labelSelector:matchExpressions:- key:securityoperator:Invalues:- S1topologyKey:failure-domain.beta.kubernets.io/zonepodAntiAffinity:requiredDuringSchedulingIgnoredDuringExecution:- labelSelector:matchExpressions:- key:securityoperator:Invalues:- nginxtopologyKey:kubernets.io/hostnamecontainers:- name:anti-pod-affinityimage:pause:2.0 æ–°podä¸security=S1çš„podä¸ºåŒä¸€ä¸ªzoneï¼Œä½†ä¸ä¸app=nginxçš„Podä¸ºåŒä¸€ä¸ªzoneã€‚ topologyKeyçš„é™åˆ¶ï¼ˆå‡ºäºæ€§èƒ½å’Œå®‰å…¨æ–¹é¢è€ƒè™‘ï¼‰ï¼š åœ¨Podäº²å’Œæ€§å’ŒRequiredDuringScheduingçš„Podäº’æ–¥æ€§çš„å®šä¹‰ä¸­ï¼Œä¸å…è®¸ä½¿ç”¨ç©ºçš„topologyKeyã€‚ å¦‚æœAdmission ControlleråŒ…å«äº†LimitPodHardAntiAffinityTopologyï¼Œé‚£ä¹ˆé’ˆå¯¹Required DuringSchedulingçš„Podäº’æ–¥æ€§å®šä¹‰å°±è¢«é™åˆ¶ä¸ºkubernetes.io/hostnameï¼Œè¦ä½¿ç”¨è‡ªå®šä¹‰çš„topologyKeyå°±è¦æ”¹å†™æˆ–ç¦ç”¨è¯¥æ§åˆ¶å™¨ã€‚ åœ¨PreferredDruingSchedulingç±»å‹çš„Podäº’æ–¥æ€§å®šä¹‰ä¸­ï¼Œç©ºçš„topologyKeyä¼šè¢«è§£é‡Šä¸ºkubernets.io/hostnameã€failure-domain.beta.kubernetse.io/zoneã€failure-domain.beta.kubernets.io/regionçš„ç»„åˆã€‚ å¦‚æœä¸æ˜¯ä¸Šè¿°æƒ…å†µï¼Œå°±å¯ä»¥é‡‡ç”¨ä»»æ„åˆæ³•çš„topologyKeyã€‚ PodAffinityè§„åˆ™è®¾ç½®çš„æ³¨æ„äº‹é¡¹ï¼š é™¤äº†è®¾ç½®Label Selectorå’ŒtopologyKeyï¼Œç”¨æˆ·è¿˜å¯ä»¥æŒ‡å®šNamespaceåˆ—è¡¨æ¥è¿›è¡Œé™åˆ¶ï¼ŒåŒæ ·ï¼Œä½¿ç”¨Label Selectorå¯¹Namespaceè¿›è¡Œé€‰æ‹©ã€‚ åœ¨æ‰€æœ‰å…³è”requiredDuringSchedulingIgnoredDuringExecutionçš„matchExpressionså…¨éƒ¨æ»¡è¶³ä¹‹åï¼Œç³»ç»Ÿæ‰èƒ½å°†Podè°ƒåº¦åˆ°æŸä¸ªNodeä¸Šã€‚ ","date":"2021-03-23","objectID":"/2021/03/pod%E8%B0%83%E5%BA%A6/:5:0","tags":["kubernetes","pod"],"title":"Podè°ƒåº¦","uri":"/2021/03/pod%E8%B0%83%E5%BA%A6/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"å…­ã€Taintså’ŒTolerationsï¼ˆæ±¡ç‚¹å’Œå®¹å¿ï¼‰ åœ¨Nodeä¸Šè®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ªTaintä¹‹åï¼Œé™¤éPodæ˜ç¡®å£°æ˜èƒ½å¤Ÿå®¹å¿è¿™äº›æ±¡ç‚¹ï¼Œå¦åˆ™æ— æ³•åœ¨è¿™äº›Nodeä¸Šè¿è¡Œã€‚Tolerationæ˜¯Podçš„å±æ€§ï¼Œè®©Podèƒ½å¤Ÿè¿è¡Œåœ¨æ ‡æ³¨äº†taintçš„Nodeä¸Šã€‚ # kubectl taint nodes node1 key=value:NoSchedule ç„¶ååœ¨podä¸Šå£°æ˜tolerationã€‚ tolerations:- key:\"key\"operator:\"Equal\"value:\"value\"effect:\"NoSchedule\"tolerations:- key:\"key\"operator:\"Exists\"effect:\"NoSchedule\" å¦‚æœä¸æŒ‡å®šoperatorï¼Œé»˜è®¤å€¼ä¸ºEqualã€‚ç©ºçš„keyé…åˆExistsèƒ½å¤ŸåŒ¹é…æ‰€æœ‰é”®å’Œå€¼ã€‚ç©ºçš„effectèƒ½å¤ŸåŒ¹é…æ‰€æœ‰çš„effectã€‚ NoScheduleï¼šä¸è°ƒåº¦ PreferNoScheduleï¼šä¸ä¼˜å…ˆè°ƒåº¦ NoExecuteï¼šä¸è¿è¡Œï¼Œå·²ç»åœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šçš„Podä¼šè¢«é©±é€ã€‚ ","date":"2021-03-23","objectID":"/2021/03/pod%E8%B0%83%E5%BA%A6/:6:0","tags":["kubernetes","pod"],"title":"Podè°ƒåº¦","uri":"/2021/03/pod%E8%B0%83%E5%BA%A6/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"ä¸ƒã€Pod Priority Preemptionï¼šPodä¼˜å…ˆçº§è°ƒåº¦ ä¼˜å…ˆçº§æŠ¢å è°ƒåº¦ç­–ç•¥çš„æ ¸å¿ƒè¡Œä¸ºåˆ†åˆ«æ˜¯é©±é€ï¼ˆEvictionï¼‰å’ŒæŠ¢å ï¼ˆPreemptionï¼‰ã€‚Evectionæ˜¯kubeletè¡Œä¸ºï¼Œå³å½“ä¸€ä¸ªNodeå‘ç”Ÿèµ„æºä¸è¶³æƒ…å†µæ—¶ï¼Œè¯¥èŠ‚ç‚¹ä¸Šçš„kubeletè¿›ç¨‹ä¼šå‘ç”Ÿé©±é€åŠ¨ä½œï¼Œæ­¤æ—¶kubeletä¼šç»¼åˆè€ƒè™‘Podçš„ä¼˜å…ˆçº§ã€èµ„æºç”³è¯·é‡ä¸å®é™…ä½¿ç”¨é‡ç­‰ä¿¡æ¯è®¡ç®—å“ªäº›Podéœ€è¦è¢«é©±é€ï¼›å½“åŒæ ·ä¼˜å…ˆçº§çš„Podéœ€è¦è¢«é©±é€æ—¶ï¼Œå®é™…ä½¿ç”¨çš„èµ„æºé‡è¶…è¿‡ç”³è¯·é‡æœ€å¤§å€æ•°çš„é«˜è€—èƒ½Podä¼šè¢«é¦–å…ˆé©±é€ã€‚ æœåŠ¡è´¨é‡ç­‰çº§Qosï¼š Guaranteedï¼špodè®¾ç½®äº†limitæˆ–limit=request Burstableï¼špodé‡Œçš„ä¸€ä¸ªå®¹å™¨limitï¼=request Best-Effortï¼šlimitå’Œrequestå‡æœªè®¾ç½® 1ã€åˆ›å»ºPriorityClasses apiVersion:scheduling.k8s.io/v1beta1kind:PriorityClassmetadata:name:high-priorityvalue:1000000globalDefault:falsedescription:\"This priority class should be used for service pods only\" 2ã€å¯ä»¥åœ¨ä»»æ„podä¸­å¼•ç”¨ä¼˜å…ˆçº§ç±»åˆ« apiVersion:v1kind:Podmetadata:name:nginxlabels:env:testspec:containers:- name:nginximage:nginximagePullPolicy:IfNotPresentpriorityClassName:high-priority ","date":"2021-03-23","objectID":"/2021/03/pod%E8%B0%83%E5%BA%A6/:7:0","tags":["kubernetes","pod"],"title":"Podè°ƒåº¦","uri":"/2021/03/pod%E8%B0%83%E5%BA%A6/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"å…«ã€å…¶ä»–æƒ…å†µ 1ã€DaemonSetï¼šåœ¨æ¯ä¸ªNodeä¸Šéƒ½è°ƒåº¦ä¸€ä¸ªPod 2ã€Jobå’ŒCronJobçš„æ‰¹å¤„ç†è°ƒåº¦ï¼Œå¯ä»¥è®¾ç½®ä»»åŠ¡æ•°completionså’Œå¹¶è¡Œåº¦parallelism ","date":"2021-03-23","objectID":"/2021/03/pod%E8%B0%83%E5%BA%A6/:8:0","tags":["kubernetes","pod"],"title":"Podè°ƒåº¦","uri":"/2021/03/pod%E8%B0%83%E5%BA%A6/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"ä¸€ã€ç®€ä»‹ podåœ¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­è¢«ç³»ç»Ÿå®šä¹‰ä¸ºå„ç§çŠ¶æ€ï¼Œç†Ÿæ‚‰podçš„å„ç§çŠ¶æ€å¯¹äºç†è§£å¦‚ä½•è®¾ç½®podçš„è°ƒåº¦ç­–ç•¥ã€é‡å¯ç­–ç•¥éƒ½æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚ ","date":"2021-03-22","objectID":"/2021/03/pod%E5%9F%BA%E7%A1%80/:1:0","tags":["kubernetes","pod"],"title":"Podçš„åŸºç¡€","uri":"/2021/03/pod%E5%9F%BA%E7%A1%80/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"äºŒã€podçŠ¶æ€ Pendingï¼šAPI Serverå·²ç»åˆ›å»ºè¯¥Podï¼Œä½†åœ¨Podå†…è¿˜æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨çš„é•œåƒæ²¡æœ‰åˆ›å»ºï¼ŒåŒ…æ‹¬æ­£åœ¨ä¸‹è½½é•œåƒçš„è¿‡ç¨‹ Runningï¼šPodå†…æ‰€æœ‰å®¹å™¨å‡å·²åˆ›å»ºï¼Œä¸”è‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨å¤„äºè¿è¡ŒçŠ¶æ€ã€‚æ­£åœ¨å¯åŠ¨çŠ¶æ€æˆ–é‡å¯çŠ¶æ€ Succeededï¼šPodå†…æ‰€æœ‰å®¹å™¨å‡æˆåŠŸæ‰§è¡Œåé€€å‡ºï¼Œä¸”ä¸ä¼šå†é‡å¯ Failedï¼šPodå†…æ‰€æœ‰å®¹å™¨å‡å·²é€€å‡ºï¼Œä½†è‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨é€€å‡ºä¸ºå¤±è´¥çŠ¶æ€ï¼Œé€€å‡ºç ä¸ä¸º0 Unknownï¼šç”±äºæŸç§åŸå› æ— æ³•è·å–è¯¥Podçš„çŠ¶æ€ï¼Œå¯èƒ½ç”±äºç½‘ç»œé€šä¿¡ä¸ç•…å¯¼è‡´ï¼ˆæ— æ³•è¿æ¥API Serverï¼‰ ","date":"2021-03-22","objectID":"/2021/03/pod%E5%9F%BA%E7%A1%80/:2:0","tags":["kubernetes","pod"],"title":"Podçš„åŸºç¡€","uri":"/2021/03/pod%E5%9F%BA%E7%A1%80/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"ä¸‰ã€Podé‡å¯ç­–ç•¥ podçš„é‡å¯ç­–ç•¥ï¼ˆRestartPolicyï¼‰åº”ç”¨äºPodå†…çš„æ‰€æœ‰å®¹å™¨ï¼Œå¹¶ä¸”ä»…åœ¨Podæ‰€å¤„çš„Nodeä¸Šç”±kubeletè¿›è¡Œåˆ¤æ–­å’Œé‡å¯æ“ä½œã€‚å½“æŸä¸ªå®¹å™¨å¼‚å¸¸é€€å‡ºæˆ–å¥åº·æ£€æŸ¥å¤±è´¥æ—¶ï¼Œkubeletä¼šæ ¹æ®é‡å¯ç­–ç•¥æ¥è¿›è¡Œç›¸åº”çš„æ“ä½œã€‚ Alwaysï¼šé»˜è®¤ç­–ç•¥ï¼Œå½“å®¹å™¨å¤±æ•ˆæ—¶ï¼Œç”±kubeletè‡ªåŠ¨é‡å¯å®¹å™¨ OnFailureï¼šå½“å®¹å™¨ç»ˆæ­¢è¿è¡Œä¸”é€€å‡ºç ä¸ä¸º0æ—¶ï¼Œç”±kubeletè‡ªåŠ¨é‡å¯è¯¥å®¹å™¨ Neverï¼šä¸è®ºå®¹å™¨çš„è¿è¡ŒçŠ¶æ€éƒ½ä¸é‡å¯ kubeleté‡å¯å®¹å™¨çš„æ—¶é—´é—´éš”ä»¥sync-frequencyä¹˜ä»¥2æ¥è®¡ç®—ï¼Œä¾‹å¦‚1ã€2ã€4ã€8å€ç­‰ï¼Œæœ€é•¿5minï¼Œå¹¶ä¸”åœ¨æˆåŠŸé‡å¯å10minåé‡ç½®è¯¥æ—¶é—´ã€‚ æ¯ç§æ§åˆ¶å™¨å¯¹podçš„é‡å¯ç­–ç•¥è¦æ±‚ï¼š RCå’ŒDaemonSetï¼šå¿…é¡»ä¸ºAlwaysï¼Œéœ€è¦ä¿è¯å®¹å™¨æŒç»­è¿è¡Œ Jobï¼šOnFailureæˆ–Neverï¼Œç¡®ä¿å®¹å™¨æ‰§è¡Œå®Œæˆåä¸å†é‡å¯ kubeletï¼šåœ¨podå¤±æ•ˆåé‡å¯ï¼Œä¸è®ºå°†RestartPolicyè®¾ç½®ä¸ºä»€ä¹ˆå€¼ï¼Œä¹Ÿä¸ä¼šå¯¹podè¿›è¡Œå¥åº·æ£€æŸ¥ å¸¸è§çš„çŠ¶æ€è½¬æ¢åœºæ™¯ï¼ˆæœ€ç»ˆçŠ¶æ€ï¼‰ podåŒ…å«çš„å®¹å™¨æ•° podå½“å‰çš„çŠ¶æ€ å‘ç”Ÿäº‹ä»¶ always OnFailure Never 1 running æˆåŠŸé€€å‡º running succeed succeed 1 running å¤±è´¥é€€å‡º running running failed 2 running 1ä¸ªå¤±è´¥é€€å‡º running running running 2 running oom running running failed ","date":"2021-03-22","objectID":"/2021/03/pod%E5%9F%BA%E7%A1%80/:3:0","tags":["kubernetes","pod"],"title":"Podçš„åŸºç¡€","uri":"/2021/03/pod%E5%9F%BA%E7%A1%80/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"å››ã€å¥åº·æ£€æŸ¥ LivenessProbeå­˜æ´»æ¢é’ˆï¼šåˆ¤æ–­å®¹å™¨æ˜¯å¦å­˜æ´»ï¼ˆrunningçŠ¶æ€ï¼‰ã€‚å¦‚æœæ¢é’ˆæ¢æµ‹åˆ°å®¹å™¨ä¸å¥åº·ï¼Œkubeletä¼šæ€æ‰å®¹å™¨ï¼Œå¹¶æ ¹æ®å®¹å™¨çš„é‡å¯ç­–ç•¥å¤„ç†ã€‚å¦‚æœå®¹å™¨ä¸åŒ…å«å­˜æ´»æ¢é’ˆï¼Œé‚£ä¹ˆä¼šè®¤ä¸ºå®¹å™¨ä¸€ç›´å¥åº·ã€‚ ReadinessProbeå°±ç»ªæ¢é’ˆï¼šåˆ¤æ–­å®¹å™¨æœåŠ¡æ˜¯å¦å¯ç”¨ï¼ˆreadyçŠ¶æ€ï¼‰ï¼Œè¾¾åˆ°readyçŠ¶æ€çš„podæ‰èƒ½æ¥å—è¯·æ±‚ã€‚å¦‚æœåœ¨è¿è¡Œè¿‡ç¨‹ä¸­readyçŠ¶æ€å˜ä¸ºfalseï¼Œåˆ™ç³»ç»Ÿè‡ªåŠ¨å°†å…¶ä»serviceçš„åç«¯endpointåˆ—è¡¨ä¸­éš”ç¦»å‡ºå»ï¼Œåç»­å†æŠŠæ¢å¤åˆ°readyçŠ¶æ€çš„podåŠ å›åˆ°endpointåˆ—è¡¨ã€‚è¿™æ ·å°±èƒ½ä¿è¯å®¢æˆ·ç«¯å†è®¿é—®serviceæ—¶ä¸ä¼šè¢«è½¬å‘åˆ°æœåŠ¡ä¸å¯ç”¨çš„podå®ä¾‹ä¸Šã€‚ ä¸‰ç§å®ç°æ–¹å¼ï¼š ExecActionï¼šåœ¨å®¹å™¨å†…éƒ¨æ‰§è¡Œå‘½ä»¤ï¼Œå¦‚æœå‘½ä»¤çš„çŠ¶æ€ç è¿”å›0ï¼Œåˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚ livenessProbe:exec:command:- cat- /tmp/health TCPSocketActionï¼šé€šè¿‡å®¹å™¨çš„IPåœ°å€å’Œç«¯å£å·Portæ‰§è¡ŒTCPæ£€æŸ¥ï¼Œå¦‚æœèƒ½å¤Ÿå»ºç«‹TCPè¿æ¥ï¼Œåˆ™è¡¨æ˜å®¹å™¨å¥åº· livenessProbe:tcpSocket:port:80 HTTPGetActionï¼šé€šè¿‡å®¹å™¨çš„IPåœ°å€ã€ç«¯å£å·åŠè·¯å¾„è°ƒç”¨HTTP Getæ–¹æ³•ï¼Œå¦‚æœå“åº”çš„çŠ¶æ€ç å¤§äºç­‰äº200ä¸”å°äº400ï¼Œåˆ™è®¤ä¸ºå®¹å™¨å¥åº· livenessProbe:httpGet:path:/_status/healthzport:80 å¯¹äºæ¯ç§æ¢æµ‹æ–¹å¼ï¼Œéƒ½éœ€è¦è®¾ç½®å‚æ•° initialDelaySecondsï¼šå¯åŠ¨å®¹å™¨åè¿›è¡Œé¦–æ¬¡å¥åº·æ£€æŸ¥çš„ç­‰å¾…æ—¶é—´ timeoutSecondsï¼šå¥åº·æ£€æŸ¥å‘é€è¯·æ±‚åç­‰å¾…å“åº”çš„è¶…æ—¶æ—¶é—´ ","date":"2021-03-22","objectID":"/2021/03/pod%E5%9F%BA%E7%A1%80/:4:0","tags":["kubernetes","pod"],"title":"Podçš„åŸºç¡€","uri":"/2021/03/pod%E5%9F%BA%E7%A1%80/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"ä¸€èˆ¬æ¥è¯´ï¼Œæ¨¡å—ä½œè€…éœ€è¦ä½¿ç”¨ä¸€ç§æ–¹æ³•æ¥åªæ˜¯ä¸åº”è¯¥ä½¿ç”¨æŸä¸ªå·²å‘å¸ƒçš„æ¨¡å—ã€‚ å‡ºç°ä¸€ä¸ªä¸¥é‡çš„å®‰å…¨æ¼æ´ ä¸é—²ä¸å…¼å®¹æˆ–bug ç‰ˆæœ¬å‘å¸ƒé”™è¯¯ å‡ºç°è¿‡æ¨¡å—æœ€æ–°ç‰ˆæœ¬ä¸º1.0.0ï¼Œé”™è¯¯å‘å¸ƒ1.1.0ï¼Œç„¶ååœ¨githubä¸ŠæŠŠç‰ˆæœ¬åˆ é™¤ï¼Œä½¿ç”¨1.0.1ç‰ˆæœ¬ï¼Œä½†æ˜¯æœ‰äººä½¿ç”¨ä»£ç†æ¨¡å—å¹¶ä¸”ä¸‹è½½äº†1.1.0ç‰ˆæœ¬ï¼Œæ‰€ä»¥å…¶ä»–äººå†ä¸‹è½½æŒ‡å®šlatestä¼šä¸‹è½½1.1.0ç‰ˆæœ¬çš„ä»£ç ã€‚ ","date":"2021-02-25","objectID":"/2021/02/golang_retract/:0:0","tags":["golang"],"title":"Golang 1.16ç‰ˆæœ¬æ–°ç‰¹æ€§ =\u003e æ’¤å›ç‰ˆæœ¬(retract)","uri":"/2021/02/golang_retract/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"å‡†å¤‡å·¥ä½œ retractæ¨¡å—ï¼Œgithubçš„å®Œæ•´è·¯å¾„æ˜¯https://github.com/betterfor/retractï¼Œä½ å¯ä»¥ä½¿ç”¨è‡ªå·±çš„æ¨¡å—å®éªŒã€‚ awesomeProjcetï¼Œæœ¬åœ°æ¨¡å—ï¼Œä½¿ç”¨äº†teståŒ…çš„ä¾èµ–çš„ç®€å•mainå‡½æ•°ã€‚ è¯·ç¡®ä¿golangç‰ˆæœ¬æ˜¯1.16+ ","date":"2021-02-25","objectID":"/2021/02/golang_retract/:1:0","tags":["golang"],"title":"Golang 1.16ç‰ˆæœ¬æ–°ç‰¹æ€§ =\u003e æ’¤å›ç‰ˆæœ¬(retract)","uri":"/2021/02/golang_retract/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"åˆ›å»ºtestæ¨¡å— 1ã€å…ˆåœ¨githubä¸Šåˆ›å»ºå¥½ä»“åº“ 2ã€æ‹‰å–ä»£ç ä»“åº“ $ git clone https://github.com/betterfor/retract.git $ cd retract/ $ go mod init go: creating new go.mod: module github.com/betterfor/retract 3ã€åœ¨æ¨¡å—ä¸­æ–°å»ºfoo.goæ–‡ä»¶ package retract func Foo() string { return \"v0.0.1\" } 4ã€å°†retractæ¨¡å—çš„æ”¹åŠ¨æäº¤gitå¹¶push $ git add . $ git commit -m \"Initial commit\" $ git push -u origin master è¿™æ˜¯æ¨¡å—çš„åˆå§‹ç‰ˆæœ¬ï¼Œæˆ‘ä»¬ç”¨v0ç‰ˆæœ¬æ¥è¡¨ç¤ºï¼Œä»£è¡¨å®ƒä¸ç¨³å®šã€‚ $ git tag v0.1.0 $ git push origin v0.1.0 To https://github.com/betterfor/retract.git * [new tag] v0.1.0 -\u003e v0.1.0 æ­¤æ—¶retractæ¨¡å—ç¬¬ä¸€ä¸ªç‰ˆæœ¬å·²ç»å‘å¸ƒï¼Œæˆ‘ä»¬åœ¨awesomeProjceté¡¹ç›®ä½¿ç”¨å®ƒã€‚ 5ã€åˆ›å»ºawesomeProjcetæœ¬åœ°é¡¹ç›®ï¼Œå¼•ç”¨retractæ¨¡å—ã€‚ $ mkdir awesomeProjcet $ cd awesomeProjcet/ $ go mod init package main import ( \"fmt\" \"github.com/betterfor/retract\" ) func main() { fmt.Println(retract.Foo()) } $ go get github.com/betterfor/retract@v0.1.0 æ­¤æ—¶ç‰ˆæœ¬æ­£å¸¸ä½¿ç”¨ã€‚ 6ã€retractæ¨¡å—æ›´æ–° foo.goæ–‡ä»¶ä¿®æ”¹ package retract func Foo() string { return \"v0.2.0\" } æˆ‘ä»¬æäº¤å¹¶æ¨é€åˆ°githubä¸Šï¼Œç»™å®ƒæ ‡è®°ä¸€ä¸ªæ–°çš„æ ‡ç­¾v0.2.0. $ git tag v0.2.0 $ git push origin v0.2.0 7ã€ç„¶åæˆ‘ä»¬åœ¨awesomeProjceté¡¹ç›®ä¸­ä½¿ç”¨retractçš„v0.2.0ç‰ˆæœ¬ï¼Œå‘ç°å¯ä»¥æ­£å¸¸è¿è¡Œã€‚ $ go get github.com/betterfor/retract@v0.2.0 go: downloading github.com/betterfor/retract v0.2.0 go get: upgraded github.com/betterfor/retract v0.1.0 =\u003e v0.2.0 $ go run main.go v0.2.0 8ã€æ’¤å›ç‰ˆæœ¬ æ­¤æ—¶æˆ‘ä»¬ä½œä¸ºretractæ¨¡å—çš„ä½œè€…ï¼Œå‘ç°v0.2.0ç‰ˆæœ¬ä¸å®Œå–„ï¼Œéœ€è¦æ’¤å›è¿™ä¸ªç‰ˆæœ¬ï¼Œåº”è¯¥æ€ä¹ˆåšï¼Ÿ æˆ‘ä»¬å¯ä»¥åœ¨go.modä¸­å¢åŠ retractæŒ‡ä»¤æ¥æ’¤å›æŸä¸ªæ¨¡å—ç‰ˆæœ¬ã€‚ $ go mod edit -retract=v0.2.0 æ­¤æ—¶go.modå†…å®¹å¦‚ä¸‹ module github.com/betterfor/retract go 1.16 // tag version error retract v0.2.0 å½“ç„¶ä½ ä¹Ÿå¯ä»¥ä¸ä½¿ç”¨å‘½ä»¤ï¼Œç›´æ¥åœ¨go.modæ–‡ä»¶ä¸­ä¿®æ”¹ï¼Œä¸€èˆ¬ä¼šåœ¨retractåŠ ä¸Šæ’¤å›åŸå› .go getã€go listç­‰ä¼šæ˜¾ç¤ºè¿™ä¸ªåŸå› ã€‚ æäº¤ä¿®æ”¹å†…å®¹è‡³githubï¼Œç»™å®ƒæ ‡è®°ä¸€ä¸ªæ–°çš„æ ‡ç­¾v0.3.0ã€‚ awesomeProjceté¡¹ç›®ä¸­ä½¿ç”¨retractçš„v0.3.0ç‰ˆæœ¬ï¼Œå‘ç°å¯ä»¥æ­£å¸¸è¿è¡Œã€‚ $ go get github.com/betterfor/retract@v0.3.0 go: downloading github.com/betterfor/retract v0.3.0 go get: upgraded github.com/betterfor/retract v0.2.0 =\u003e v0.3.0 $ go get github.com/betterfor/retract@v0.2.0 go: warning: github.com/betterfor/retract@v0.2.0: retracted by module author: tag version error go: to switch to the latest unretracted version, run: go get github.com/betterfor/retract@latestgo get: downgraded github.com/betterfor/retract v0.3.0 =\u003e v0.2.0 æˆ‘ä»¬å‘ç°å‡ºç°warningä¿¡æ¯ï¼Œä½†æ˜¯è¿™ä¸ªç‰ˆæœ¬çš„åŒ…è¿˜æ˜¯å¯ç”¨çš„ã€‚ æˆ‘ä»¬æ¥æŸ¥çœ‹æ¨¡å—çš„ç‰ˆæœ¬åˆ—è¡¨ $ go list -m -versions github.com/betterfor/retract github.com/betterfor/retract v0.1.0 v0.3.0 æ­¤æ—¶æˆ‘ä»¬æŸ¥çœ‹æ¨¡å—çš„ç‰ˆæœ¬å‘ç°ï¼Œæ²¡æœ‰v0.2.0ç‰ˆæœ¬äº†ã€‚ é€šè¿‡å¢åŠ -retractedé€‰é¡¹å¯ä»¥æŸ¥çœ‹æ’¤å›çš„ç‰ˆæœ¬ã€‚ $ go list -m -versions -retracted github.com/betterfor/retract github.com/betterfor/retract v0.1.0 v0.2.0 v0.3.0 é‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆçŸ¥é“æˆ‘ä»¬çš„é¡¹ç›®æœ‰æ²¡æœ‰ä¾èµ–å·²æ’¤å›ç‰ˆæœ¬çš„æ¨¡å—å‘¢ï¼Ÿä½¿ç”¨go listå‘½ä»¤ $ go list -m -u all awesomeProjcet github.com/betterfor/retract v0.2.0 (retracted) [v0.3.0] ","date":"2021-02-25","objectID":"/2021/02/golang_retract/:2:0","tags":["golang"],"title":"Golang 1.16ç‰ˆæœ¬æ–°ç‰¹æ€§ =\u003e æ’¤å›ç‰ˆæœ¬(retract)","uri":"/2021/02/golang_retract/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"é—®é¢˜ å¦‚æœæ¨¡å—ç°åœ¨çš„ç‰ˆæœ¬æ˜¯v0ç‰ˆæœ¬ï¼Œä¸å°å¿ƒå‘å¸ƒäº†v1ç‰ˆæœ¬ï¼Œéœ€è¦æ’¤å›v1ç‰ˆæœ¬ï¼Œè¯¥æ€ä¹ˆæ“ä½œï¼Ÿ 1ã€æŒ‰ç…§ä¸Šé¢çš„æ“ä½œæ­¥éª¤è¿›è¡Œï¼Œæˆ‘ä»¬å‘ç°æ‰“è¿‡v1.0.0ç‰ˆæœ¬å,ä»ä¼šæ˜¾ç¤ºv1.0.0 $ go list -m -versions github.com/betterfor/retract github.com/betterfor/retract v0.1.0 v0.3.0 v0.4.0 v1.0.0 è¿™å°±è¦æ±‚æˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€ä¸ªæ¯”v1.0.0å¤§çš„ç‰ˆæœ¬å·v1.0.1æ¥å†™å…¥æ’¤å›ä¿¡æ¯ã€‚ module github.com/betterfor/retract go 1.16 retract ( // tag version error v0.2.0 // v1 æå‰å‘å¸ƒäº† [v1.0.0, v1.0.1] ) å°†è¿™æ¬¡æ”¹åŠ¨æäº¤ï¼Œå¹¶æ ‡è®°ä¸€ä¸ªæ–°çš„ç‰ˆæœ¬v1.0.1ã€‚ ç„¶åæ‹‰å–æ¨¡å— $ go get github.com/betterfor/retract@v1.0.0 $ go get github.com/betterfor/retract@v1.0.1 $ go get github.com/betterfor/retract@v0.4.0 go list -m -versions github.com/betterfor/retract github.com/betterfor/retract v0.1.0 v0.3.0 v0.4.0 ok! v0.4.0å°±æ˜¯æœ€æ–°çš„ç‰ˆæœ¬ å¦‚æœä½ å°†æ¥å‘å¸ƒv1ç‰ˆæœ¬æ—¶ï¼Œåº”è¯¥è¦ä»v1.0.2å¼€å§‹ï¼Œå› ä¸ºv1.0.0å’Œv1.0.1å·²ç»è¢«å ç”¨äº† ","date":"2021-02-25","objectID":"/2021/02/golang_retract/:3:0","tags":["golang"],"title":"Golang 1.16ç‰ˆæœ¬æ–°ç‰¹æ€§ =\u003e æ’¤å›ç‰ˆæœ¬(retract)","uri":"/2021/02/golang_retract/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":" Dockeræ˜¯ä¸€ä¸ªè™šæ‹Ÿç¯å¢ƒå®¹å™¨ï¼Œå¯ä»¥å°†ä½ çš„å¼€å‘ç¯å¢ƒã€ä»£ç ã€é…ç½®æ–‡ä»¶ç­‰ä¸€å¹¶æ‰“åŒ…åˆ°è¿™ä¸ªå®¹å™¨ä¸­ï¼Œå¹¶å‘å¸ƒå’Œåº”ç”¨åˆ°ä»»æ„å¹³å°ä¸­ã€‚æ‰€ä»¥ä½ éœ€è¦çŸ¥é“ä¸€ç‚¹dockerçš„å‘½ä»¤ã€‚ è¿™é‡Œæ˜¯å…³äºdockerçš„åŸºç¡€å‘½ä»¤ï¼ˆç¬¬ä¸€èŠ‚ï¼‰ ç‰ˆæœ¬ä¿¡æ¯ï¼šæŸ¥çœ‹dockerçš„å„é¡¹åŸºç¡€ä¿¡æ¯ ä»“åº“ç®¡ç†ï¼šç®¡ç†é•œåƒå­˜å‚¨çš„ä»“åº“ ç‰ˆæœ¬ä¿¡æ¯ ","date":"2021-02-12","objectID":"/2021/02/docker_command/:0:0","tags":["docker"],"title":"Dockerå‘½ä»¤å¤§å…¨","uri":"/2021/02/docker_command/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"info docker infoï¼šæ˜¾ç¤ºDockerç³»ç»Ÿä¿¡æ¯ï¼ŒåŒ…æ‹¬é•œåƒã€å®¹å™¨æ•°é‡å’Œé•œåƒä»“åº“ã€‚ è¯­æ³• docker info [OPTIONS] Options: -f, --format string æ˜¾ç¤ºè¿”å›å€¼çš„æ¨¡æ¿æ–‡ä»¶ å®ä¾‹ Client: Context: default Debug Mode: false Plugins: app: Docker App (Docker Inc., v0.9.1-beta3) buildx: Build with BuildKit (Docker Inc., v0.5.1-docker) Server: Containers: 1 Running: 1 Paused: 0 Stopped: 0 Images: 1 Server Version: 20.10.3 Storage Driver: overlay2 Backing Filesystem: xfs Supports d_type: true Native Overlay Diff: true Logging Driver: json-file Cgroup Driver: cgroupfs Cgroup Version: 1 Plugins: Volume: local Network: bridge host ipvlan macvlan null overlay Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog Swarm: inactive Runtimes: runc io.containerd.runc.v2 io.containerd.runtime.v1.linux Default Runtime: runc Init Binary: docker-init containerd version: 269548fa27e0089a8b8278fc4fc781d7f65a939b runc version: ff819c7e9184c13b7c2607fe6c30ae19403a7aff init version: de40ad0 Security Options: seccomp Profile: default Kernel Version: 3.10.0-1160.15.2.el7.x86_64 Operating System: CentOS Linux 7 (Core) OSType: linux Architecture: x86_64 CPUs: 2 Total Memory: 1.795GiB Name: localhost.localdomain ID: 4NYR:4KA5:NBOL:V6Y7:SE6H:B2R7:2LRD:FNIL:CK5J:4L4J:6K63:5RMO Docker Root Dir: /var/lib/docker Debug Mode: false Registry: https://index.docker.io/v1/ Labels: Experimental: false Insecure Registries: 127.0.0.0/8 Live Restore Enabled: false ","date":"2021-02-12","objectID":"/2021/02/docker_command/:1:0","tags":["docker"],"title":"Dockerå‘½ä»¤å¤§å…¨","uri":"/2021/02/docker_command/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"version docker versionï¼šæ˜¾ç¤ºDockerç‰ˆæœ¬ä¿¡æ¯ã€‚ è¯­æ³• docker version [OPTIONS] Options: -f, --format string æ˜¾ç¤ºè¿”å›å€¼æŒ‡å®šçš„æ¨¡æ¿æ–‡ä»¶ --kubeconfig string k8sé…ç½®æ–‡ä»¶ å®ä¾‹ Client: Docker Engine - Community Version: 20.10.3 API version: 1.41 Go version: go1.13.15 Git commit: 48d30b5 Built: Fri Jan 29 14:34:14 2021 OS/Arch: linux/amd64 Context: default Experimental: true Server: Docker Engine - Community Engine: Version: 20.10.3 API version: 1.41 (minimum version 1.12) Go version: go1.13.15 Git commit: 46229ca Built: Fri Jan 29 14:32:37 2021 OS/Arch: linux/amd64 Experimental: false containerd: Version: 1.4.3 GitCommit: 269548fa27e0089a8b8278fc4fc781d7f65a939b runc: Version: 1.0.0-rc92 GitCommit: ff819c7e9184c13b7c2607fe6c30ae19403a7aff docker-init: Version: 0.19.0 GitCommit: de40ad0 é€šå¸¸åˆšå®‰è£…å®Œdockeræ—¶ï¼Œä½¿ç”¨docker versionæ¥éªŒè¯dockerçš„clientå’Œserveræ˜¯å¦å¯ç”¨ã€‚å¦‚æœserveræ˜¾ç¤ºæƒé™ä¸è¶³ï¼Œå¯ä»¥é€šè¿‡sudo dockeræˆ– ç»™dockeræ·»åŠ sudoæƒé™ã€‚ é•œåƒä»“åº“ ","date":"2021-02-12","objectID":"/2021/02/docker_command/:2:0","tags":["docker"],"title":"Dockerå‘½ä»¤å¤§å…¨","uri":"/2021/02/docker_command/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"login docker loginï¼šç™»å½•åˆ°ä¸€ä¸ªDockeré•œåƒä»“åº“ï¼Œå¦‚æœæœªæŒ‡å®šé•œåƒä»“åº“åœ°å€ï¼Œé»˜è®¤ä¸ºå®˜æ–¹ä»“åº“ã€‚ è¯­æ³• docker login [OPTIONS] [SERVER] Options: -p, --password string ç™»å½•çš„å¯†ç  --password-stdin ä½¿ç”¨æ ‡å‡†è¾“å…¥è¾“å…¥å¯†ç  -u, --username string ç™»å½•çš„ç”¨æˆ·å å®ä¾‹ docker login -u ç”¨æˆ·å -p å¯†ç  ","date":"2021-02-12","objectID":"/2021/02/docker_command/:3:0","tags":["docker"],"title":"Dockerå‘½ä»¤å¤§å…¨","uri":"/2021/02/docker_command/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"logout docker logoutï¼šç™»å‡ºä¸€ä¸ªDockeré•œåƒä»“åº“ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šé•œåƒä»“åº“åœ°å€ï¼Œé»˜è®¤ä¸ºå®˜æ–¹ä»“åº“ã€‚ è¯­æ³• docker logout [SERVER] å®ä¾‹ docker logout ","date":"2021-02-12","objectID":"/2021/02/docker_command/:4:0","tags":["docker"],"title":"Dockerå‘½ä»¤å¤§å…¨","uri":"/2021/02/docker_command/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"pull docker pullï¼šä»é•œåƒä»“åº“ä¸­æ‹‰å–æˆ–è€…æ›´æ–°æŒ‡å®šé•œåƒã€‚ è¯­æ³• docker pull [OPTIONS] NAME[:TAG|@DIGEST] Options: -a, --all-tags ä¸‹è½½é•œåƒåœ¨ä»“åº“ä¸­çš„æ‰€æœ‰ç‰ˆæœ¬ --disable-content-trust å¿½ç•¥é•œåƒçš„æ ¡éªŒï¼Œé»˜è®¤å¼€å¯ --platform string å¦‚æœæœåŠ¡å™¨æ”¯æŒå¤šå¹³å°ï¼Œè®¾ç½®å¹³å° -q, --quiet é™é»˜æ‹‰å– å®ä¾‹ docker pull hello-world docker pull hello-world -a docker pull hello-wprld -q ","date":"2021-02-12","objectID":"/2021/02/docker_command/:5:0","tags":["docker"],"title":"Dockerå‘½ä»¤å¤§å…¨","uri":"/2021/02/docker_command/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"push docker pushï¼šå°†æœ¬åœ°çš„é•œåƒä¸Šä¼ åˆ°é•œåƒä»“åº“ï¼ˆå·²ç»ç™»å½•åˆ°é•œåƒä»“åº“ï¼‰ã€‚ è¯­æ³• docker push [OPTIONS] NAME[:TAG] Options: -a, --all-tags æ¨é€æœ¬åœ°æ‰€æœ‰æ‰“è¿‡tagçš„é•œåƒ --disable-content-trust å¿½ç•¥é•œåƒçš„æ£€éªŒï¼Œé»˜è®¤å¼€å¯ -q, --quiet é™é»˜ä¸Šä¼  å®ä¾‹ docker push hello-world:v1 ","date":"2021-02-12","objectID":"/2021/02/docker_command/:6:0","tags":["docker"],"title":"Dockerå‘½ä»¤å¤§å…¨","uri":"/2021/02/docker_command/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"search docker searchï¼šä»é•œåƒä»“åº“ä¸­æŸ¥æ‰¾é•œåƒã€‚ è¯­æ³• docker search [OPTIONS] TERM Options: -f, --filter filter æ ¹æ®è¿‡æ»¤çš„æ¡ä»¶è¾“å‡ºç»“æœ --format string ä½¿ç”¨ç‰¹å®šçš„æ¨¡æ¿è¾“å‡ºæœç´¢ç»“æœ --limit int æœ€å¤§æœç´¢ç»“æœï¼Œé»˜è®¤25 --no-trunc æ˜¾ç¤ºå®Œæ•´çš„é•œåƒæè¿° å®ä¾‹ docker search hello-world -f STARS=10 --limit=2 NAME DESCRIPTION STARS OFFICIAL AUTOMATED hello-world Hello World! (an example of minimal Dockerizâ€¦ 1380 [OK] tutum/hello-world Image to test docker deployments. Has Apacheâ€¦ 78 [OK] å‚æ•°è¯´æ˜ï¼š NAMEï¼šé•œåƒä»“åº“æºçš„åç§° DESCRIPTIONï¼šé•œåƒçš„æè¿° STARSï¼šè¡¨ç¤ºç‚¹èµï¼Œå…³æ³¨çš„ä¸ªæ•° OFFICIALï¼šæ˜¯å¦æ˜¯å®˜æ–¹å‘å¸ƒ AUTOMATEDï¼šè‡ªåŠ¨æ„å»º ","date":"2021-02-12","objectID":"/2021/02/docker_command/:7:0","tags":["docker"],"title":"Dockerå‘½ä»¤å¤§å…¨","uri":"/2021/02/docker_command/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"images docker imagesï¼šåˆ—å‡ºæœ¬åœ°é•œåƒ è¯­æ³• docker images [OPTIONS] [REPOSITORY[:TAG]] Options: -a, --all åˆ—å‡ºæœ¬åœ°æ‰€æœ‰çš„é•œåƒï¼ˆå«ä¸­é—´æ˜ åƒå±‚ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè¿‡æ»¤æ‰ä¸­é—´æ˜ åƒå±‚ï¼‰ --digests æ˜¾ç¤ºé•œåƒçš„æ‘˜è¦ä¿¡æ¯ -f, --filter filter æ˜¾ç¤ºæ»¡è¶³æ¡ä»¶çš„é•œåƒ --format string æŒ‡å®šè¿”å›å€¼çš„æ¨¡æ¿æ–‡ä»¶ --no-trunc æ˜¾ç¤ºå®Œæ•´çš„é•œåƒä¿¡æ¯ -q, --quiet åªæ˜¾ç¤ºé•œåƒID å®ä¾‹ docker images REPOSITORY TAG IMAGE ID CREATED SIZE registry.cn-hangzhou.aliyuncs.com/google_containers/kicbase v0.0.15-snapshot4 06db6ca72446 2 months ago 941MB hello-world latest bf756fb1ae65 13 months ago 13.3kB ","date":"2021-02-12","objectID":"/2021/02/docker_command/:8:0","tags":["docker"],"title":"Dockerå‘½ä»¤å¤§å…¨","uri":"/2021/02/docker_command/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"rmi docker rmiï¼šåˆ é™¤æœ¬åœ°ä¸€ä¸ªæˆ–å¤šä¸ªé•œåƒ è¯­æ³• docker rmi [OPTIONS] IMAGE [IMAGE...] Options: -f, --force å¼ºåˆ¶åˆ é™¤ --no-prune ä¸ç§»é™¤è¯¥é•œåƒçš„è¿‡ç¨‹é•œåƒï¼Œé»˜è®¤ç§»é™¤ å®ä¾‹ docker rmi hello-world -f Untagged: hello-world:latest Untagged: hello-world@sha256:31b9c7d48790f0d8c50ab433d9c3b7e17666d6993084c002c2ff1ca09b96391d Deleted: sha256:bf756fb1ae65adf866bd8c456593cd24beb6a0a061dedf42b26a993176745f6b Deleted: sha256:9c27e219663c25e0f28493790cc0b88bc973ba3b1686355f221c38a36978ac63 ","date":"2021-02-12","objectID":"/2021/02/docker_command/:9:0","tags":["docker"],"title":"Dockerå‘½ä»¤å¤§å…¨","uri":"/2021/02/docker_command/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"tag docker tagï¼šæ ‡è®°æœ¬åœ°é•œåƒï¼Œå°†å…¶å½’å…¥æŸä¸€ä»“åº“ã€‚ è¯­æ³• docker tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG] ç”¨æ³• docker tag hello-world hello-world:v1 docker images hello-world REPOSITORY TAG IMAGE ID CREATED SIZE hello-world latest bf756fb1ae65 13 months ago 13.3kB hello-world v1 bf756fb1ae65 13 months ago 13.3kB ","date":"2021-02-12","objectID":"/2021/02/docker_command/:10:0","tags":["docker"],"title":"Dockerå‘½ä»¤å¤§å…¨","uri":"/2021/02/docker_command/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"build docker buildï¼šä½¿ç”¨Dockerfileåˆ›å»ºé•œåƒã€‚ è¯­æ³• docker build [OPTIONS] PATH | URL | - Options: --add-host list æ·»åŠ (host:ip) --build-arg list è®¾ç½®é•œåƒåˆ›å»ºæ—¶çš„å˜é‡ --cache-from strings é•œåƒç¼“å­˜ --cgroup-parent string å®¹å™¨å¯é€‰çš„çˆ¶cgroup --compress å‹ç¼©æ„å»ºä¸Šä¸‹æ–‡ä½¿ç”¨gzip --cpu-period int é™åˆ¶cpu cfså‘¨æœŸ --cpu-quota int é™åˆ¶cpu cfsé…é¢ -c, --cpu-shares int è®¾ç½®cpuä½¿ç”¨æƒé‡ --cpuset-cpus string è®¾ç½®ä½¿ç”¨çš„cpu id --cpuset-mems string è®¾ç½®ä½¿ç”¨çš„å†…å­˜id --disable-content-trust å¿½ç•¥æ ¡éªŒï¼Œé»˜è®¤å¼€å¯ -f, --file string æŒ‡å®šè¦ä½¿ç”¨çš„Dockerfileè·¯å¾„ï¼Œé»˜è®¤æ˜¯'PATH/Dockerfile' --force-rm è®¾ç½®é•œåƒè¿‡ç¨‹ä¸­åˆ é™¤ä¸­é—´å®¹å™¨ --iidfile string å†™å…¥é•œåƒidåˆ°æ–‡ä»¶ --isolation string ä½¿ç”¨å®¹å™¨éš”ç¦»æŠ€æœ¯ --label list è®¾ç½®é•œåƒä½¿ç”¨çš„å…ƒæ•°æ® -m, --memory bytes è®¾ç½®å†…å­˜æœ€å¤§å€¼ --memory-swap bytes è®¾ç½®swapçš„æœ€å¤§å€¼ä¸ºå†…å­˜+swapï¼Œ-1è¡¨ç¤ºä¸å—é™ --network string åœ¨æ„å»ºæœŸé—´è®¾ç½®RUNæŒ‡ä»¤çš„ç½‘ç»œæ¨¡å¼ï¼Œé»˜è®¤ä¸º\"default\" --no-cache åˆ›å»ºé•œåƒè¿‡ç¨‹ä¸­ä¸ä½¿ç”¨ç¼“å­˜ --pull å°è¯•å»æ›´æ–°é•œåƒçš„æœ€æ–°ç‰ˆæœ¬ -q, --quiet å®‰é™æ¨¡å¼ï¼ŒæˆåŠŸååªè¾“å‡ºé•œåƒID --rm è®¾ç½®é•œåƒæˆåŠŸååˆ é™¤ä¸­é—´å®¹å™¨ --security-opt strings å®‰å…¨é€‰é¡¹ --shm-size bytes è®¾ç½®/dev/shmï¼Œé»˜è®¤å€¼æ˜¯64M -t, --tag list é•œåƒçš„åå­—åŠæ ‡ç­¾ï¼Œé€šå¸¸ä¸º'name:tag'æ ¼å¼ï¼Œå¯ä»¥åœ¨ä¸€æ¬¡æ„å»ºä¸­ä¸ºä¸€ä¸ªé•œåƒè®¾ç½®å¤šä¸ªæ ‡ç­¾ --target string è®¾ç½®æŒ‡å®šæ„å»ºæ­¥éª¤ --ulimit ulimit Ulimité€‰é¡¹ ç”¨æ³• docker build -t my-image:v1 . ","date":"2021-02-12","objectID":"/2021/02/docker_command/:11:0","tags":["docker"],"title":"Dockerå‘½ä»¤å¤§å…¨","uri":"/2021/02/docker_command/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"history docker historyï¼šå±•ç¤ºä¸€ä¸ªé•œåƒçš„å†å²ã€‚ è¯­æ³• docker history [OPTIONS] IMAGE Options: --format string æŒ‡å®šæ¨¡æ¿è¾“å‡º -H, --human ä»¥å¯è¯»çš„æ ¼å¼æ‰“å°é•œåƒå¤§å°å’Œæ—¥æœŸï¼Œé»˜è®¤true --no-trunc æ˜¾ç¤ºå®Œæ•´çš„æäº¤è®°å½• -q, --quiet ä»…åˆ—å‡ºæäº¤è®°å½•çš„ID å®ä¾‹ docker history hello-world:v1 IMAGE CREATED CREATED BY SIZE COMMENT bf756fb1ae65 13 months ago /bin/sh -c #(nop) CMD [\"/hello\"] 0B \u003cmissing\u003e 13 months ago /bin/sh -c #(nop) COPY file:7bf12aab75c3867aâ€¦ 13.3kB ","date":"2021-02-12","objectID":"/2021/02/docker_command/:12:0","tags":["docker"],"title":"Dockerå‘½ä»¤å¤§å…¨","uri":"/2021/02/docker_command/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"save docker saveï¼šä¿å­˜ä¸€ä¸ªæˆ–å¤šä¸ªé•œåƒæˆtarå½’æ¡£æ–‡ä»¶ï¼ˆé»˜è®¤æ ‡å‡†è¾“å‡ºï¼‰ã€‚ è¯­æ³• docker save [OPTIONS] IMAGE [IMAGE...] Options: -o, --output string è¾“å‡ºåˆ°çš„æ–‡ä»¶ å®ä¾‹ docker save -o hello.tar hello-world:v1 ll hello.tar -rw-------. 1 golang golang 24576 2æœˆ 11 19:57 hello.tar ","date":"2021-02-12","objectID":"/2021/02/docker_command/:13:0","tags":["docker"],"title":"Dockerå‘½ä»¤å¤§å…¨","uri":"/2021/02/docker_command/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"load docker loadï¼šå¯¼å…¥ä½¿ç”¨docker saveå‘½ä»¤å¯¼å‡ºçš„é•œåƒã€‚ è¯­æ³• docker load [OPTIONS] Options: -i, --input string æŒ‡å®šå¯¼å…¥çš„æ–‡ä»¶ï¼Œä»£æ›¿æ ‡å‡†è¾“å…¥ -q, --quiet ç²¾ç®€è¾“å‡ºä¿¡æ¯ å®ä¾‹ $ docker images hello-world REPOSITORY TAG IMAGE ID CREATED SIZE $ docker load -i hello.tar 9c27e219663c: Loading layer [==================================================\u003e] 15.36kB/15.36kB Loaded image: hello-world:v1 $ docker images hello-world REPOSITORY TAG IMAGE ID CREATED SIZE hello-world v1 bf756fb1ae65 13 months ago 13.3kB ","date":"2021-02-12","objectID":"/2021/02/docker_command/:14:0","tags":["docker"],"title":"Dockerå‘½ä»¤å¤§å…¨","uri":"/2021/02/docker_command/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"import docker importï¼šä»å½’æ¡£æ–‡ä»¶ä¸­åˆ›å»ºé•œåƒã€‚ è¯­æ³• docker import [OPTIONS] file|URL|- [REPOSITORY[:TAG]] Options: -c, --change list åº”ç”¨dockeræŒ‡ä»¤åˆ›å»ºé•œåƒ -m, --message string æäº¤æ—¶çš„è¯´æ˜æ–‡å­— --platform string è®¾ç½®å¤šå¹³å°å¯ç”¨ å®ä¾‹ $ docker import hello.tar hello-world:v2 sha256:0243f312226d99ba0cd5e167e894c2910803595a8f81aec270305ae52dca41e6 $ docker images hello-world REPOSITORY TAG IMAGE ID CREATED SIZE hello-world v2 0243f312226d 7 seconds ago 18.3kB ","date":"2021-02-12","objectID":"/2021/02/docker_command/:15:0","tags":["docker"],"title":"Dockerå‘½ä»¤å¤§å…¨","uri":"/2021/02/docker_command/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"image docker imageï¼šç®¡ç†é•œåƒ è¯­æ³• docker image COMMAND Commands: build åŒdocker build history åŒdocker history import åŒdocker import inspect å±•ç¤ºé•œåƒçš„è¯¦ç»†ä¿¡æ¯ load åŒdocker load ls åˆ—ä¸¾é•œåƒ prune åˆ é™¤æœªä½¿ç”¨çš„é•œåƒ pull åŒdocker pull push åŒdocker push rm åŒdocker rmi save åŒdocker save tag åŒdocker tag ","date":"2021-02-12","objectID":"/2021/02/docker_command/:16:0","tags":["docker"],"title":"Dockerå‘½ä»¤å¤§å…¨","uri":"/2021/02/docker_command/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"ä»€ä¹ˆæ˜¯deferï¼Ÿ deferæ˜¯goè¯­è¨€æä¾›çš„ä¸€ç§ç”¨äºæ³¨å†Œå»¶è¿Ÿè°ƒç”¨çš„æœºåˆ¶ï¼Œè®©å‡½æ•°æˆ–è¯­å¥å¯ä»¥åœ¨å½“å‰å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼ˆåŒ…æ‹¬é€šè¿‡returnæ­£å¸¸ç»“æŸæˆ–panicå¯¼è‡´çš„å¼‚å¸¸ç»“æŸï¼‰æ‰§è¡Œã€‚ é€‚ç”¨åœºæ™¯ï¼š æ‰“å¼€/å…³é—­è¿æ¥ åŠ é”/é‡Šæ”¾é” æ‰“å¼€/å…³é—­æ–‡ä»¶ç­‰ deferåœ¨ä¸€äº›éœ€è¦å›æ”¶èµ„æºçš„åœºæ™¯éå¸¸æœ‰ç”¨ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ¨å‡½æ•°ç»“æŸå‰åšä¸€äº›æ¸…ç†å·¥ä½œã€‚ ","date":"2021-02-11","objectID":"/2021/02/defer/:1:0","tags":["defer","golang"],"title":"Deferçš„ä½¿ç”¨æ–¹æ³•","uri":"/2021/02/defer/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"ä¸ºä»€ä¹ˆè¦ç”¨deferï¼Ÿ åœ¨ç¼–ç¨‹è¿‡ç¨‹ä¸­ï¼Œç»å¸¸éœ€è¦æ‰“å¼€ä¸€äº›èµ„æºï¼Œæ¯”å¦‚æ•°æ®åº“ã€æ–‡ä»¶ã€é”ç­‰ï¼Œè¿™äº›èµ„æºéƒ½éœ€è¦ç”¨å®Œé‡Šæ”¾ï¼Œå¦åˆ™ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚ å½“ç„¶åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥åœ¨å‡½æ•°ç»“æŸæ—¶æ˜¾å¼å…³é—­èµ„æºï¼Œä½†æ˜¯å¦‚æœåœ¨æ‰“å¼€å’Œå…³é—­èµ„æºä¹‹é—´å¦‚æœå‘ç”Ÿäº†panicä¼šé€€å‡ºå‡½æ•°ï¼Œå¯¼è‡´å…³é—­èµ„æºæ²¡æœ‰è¢«æ‰§è¡Œã€‚å› ä¸ºè¿™æ ·ä¸€é¢—è¯­æ³•ç³–ï¼Œå‡å°‘äº†å¾ˆå¤šèµ„æºæ³„æ¼çš„æƒ…å†µã€‚ ","date":"2021-02-11","objectID":"/2021/02/defer/:2:0","tags":["defer","golang"],"title":"Deferçš„ä½¿ç”¨æ–¹æ³•","uri":"/2021/02/defer/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"deferåº•å±‚ å®˜æ–¹å¯¹deferçš„è§£é‡Šï¼š Each time a â€œdeferâ€ statement executes, the function value and parameters to the call are evaluated as usual and saved anew but the actual function is not invoked. Instead, deferred functions are invoked immediately before the surrounding function returns, in the reverse order they were deferred. If a deferred function value evaluates to nil, execution panics when the function is invoked, not when the â€œdeferâ€ statement is executed. æ¯æ¬¡deferè¯­å¥æ‰§è¡Œæ—¶ï¼Œä¼šæŠŠå‡½æ•°â€œå‹æ ˆâ€ï¼Œå‡½æ•°çš„å‚æ•°ä¼šè¢«æ‹·è´ä¸‹æ¥ï¼Œå½“å¤–å±‚å‡½æ•°é€€å‡ºæ—¶ï¼Œdeferå‡½æ•°æŒ‰ç…§å®šä¹‰çš„é€†åºæ‰§è¡Œï¼Œå¦‚æœdeferæ‰§è¡Œçš„å‡½æ•°ä¸ºnilï¼Œé‚£ä¹ˆä¼šåœ¨æœ€ç»ˆè°ƒç”¨å‡½æ•°äº§ç”Ÿpanicã€‚ è¿™é‡Œæœ‰ä¸€é“ç»å…¸é¢˜ï¼š func main() { a,b := 1,2 defer cal(\"1\",a,cal(\"10\",a,b)) a = 0 defer cal(\"2\",a,cal(\"20\",a,b)) } func cal(index string, a, b int) int { ret := a + b fmt.Println(index,a,b,ret) return ret } // Output: 10 1 2 3 20 0 2 2 2 0 2 2 1 1 3 4 è¿™æ˜¯éµå¾ªå…ˆå…¥åå‡ºçš„åŸåˆ™ï¼ŒåŒæ—¶ä¿ç•™å½“å‰å˜é‡çš„å€¼ã€‚ çœ‹çœ‹ä¸‹é¢è¿™é“é¢˜ï¼š func f1() (r int) { defer func() { r++ } return 0 } func f2() (r int) { t := 5 defer func() { t = t + 5 } return t } func f3() (r int) { defer func(r int) { r = r + 5 }(r) return 1 } // Output: 1 5 1 ä½ èƒ½æ­£ç¡®ç­”å¯¹å—ï¼Ÿ å…³é”®ç‚¹åœ¨äºç†è§£è¿™æ¡è¯­å¥ï¼š return xxx è¿™æ¡è¯­å¥å¹¶ä¸æ˜¯ä¸€ä¸ªåŸå­å‘½ä»¤ï¼Œç»è¿‡ç¼–è¯‘åï¼Œå˜æˆ3æ¡æŒ‡ä»¤ï¼š 1ã€è¿”å›å€¼=xxx 2ã€è°ƒç”¨deferå‡½æ•° 3ã€ç©ºçš„return é‚£ä¹ˆæˆ‘ä»¬æ¥æ‹†è§£ä¸Šé¢3ä¸ªå‡½æ•°ã€‚ func f1() (r int) { // 1ã€èµ‹å€¼ r = 0 // 2ã€é—­åŒ…å¼•ç”¨ defer func() { r++ } // 3ã€ç©ºçš„return return 0 } // deferæ˜¯é—­åŒ…å¼•ç”¨ï¼Œæ‰€ä»¥è¿”å›å€¼è¢«ä¿®æ”¹ï¼Œæ‰€ä»¥f1()è¿”å›1 func f2() (r int) { t := 5 // 1ã€èµ‹å€¼ r = t // 2ã€é—­åŒ…å¼•ç”¨ï¼Œä½†æ²¡æœ‰ä¿®æ”¹r defer func() { t = t + 5 } // 3ã€ç©ºçš„return return t } // æ²¡æ¶‰åŠè¿”å›å€¼rçš„æ“ä½œï¼Œæ‰€ä»¥è¿”å›5 func f3() (r int) { // 1ã€èµ‹å€¼ r = 1 // 2ã€rä½œä¸ºå‚æ•°ä¼ å€¼ï¼Œä¸ä¼šä¿®æ”¹è¿”å›å€¼çš„r defer func(r int) { r = r + 5 }(r) // 3ã€ç©ºçš„return return } // ç¬¬äºŒæ­¥ræ˜¯ä½œä¸ºå‡½æ•°å‚æ•°ä½¿ç”¨çš„ï¼Œæ˜¯ä¸€ä»½å¤åˆ¶ï¼Œdeferè¯­å¥ä¸­çš„rå’Œå¤–é¢çš„ræ˜¯ä¸¤ä¸ªå˜é‡ï¼Œé‡Œé¢rçš„å˜åŒ–ä¸ä¼šæ”¹å˜å¤–é¢rï¼Œæ‰€ä»¥è¿”å›1. ","date":"2021-02-11","objectID":"/2021/02/defer/:3:0","tags":["defer","golang"],"title":"Deferçš„ä½¿ç”¨æ–¹æ³•","uri":"/2021/02/defer/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"iotaæ˜¯golangè¯­è¨€çš„å¸¸æ•°è®¡é‡å™¨ï¼Œåªèƒ½åœ¨å¸¸é‡çš„è¡¨è¾¾å¼ä¸­ä½¿ç”¨ã€‚ iotaåœ¨constå…³é”®å­—å‡ºç°æ—¶è¢«é‡ç½®ä¸º0(constå†…éƒ¨çš„ç¬¬ä¸€è¡Œä¹‹å‰)ã€‚ä½¿ç”¨iotaèƒ½ç®€åŒ–å®šä¹‰ã€‚ 1ã€iotaåªèƒ½åœ¨å¸¸é‡çš„è¡¨è¾¾å¼ä½¿ç”¨ã€‚ 2ã€æ¯æ¬¡constå‡ºç°æ—¶ï¼Œéƒ½ä¼šè®©iotaåˆå§‹åŒ–ä¸º0ï¼Œä½¿åé¢çš„å˜é‡è‡ªåŠ¨å¢é•¿ã€‚ const ( a = iota // 0 b // 1 c // 2 ) 3ã€å…è®¸è‡ªå®šä¹‰ç±»å‹ // go/src/time/time.go type Weekday int const ( Sunday Weekday = iota Monday Tuesday Wednesday Thursday Friday Saturday ) å‘¨æ—¥å¯¹åº”0ï¼Œå‘¨ä¸€å¯¹åº”1ï¼Œå¦‚æ­¤ç±»æ¨ã€‚ 4ã€å¯ä»¥è·³è¿‡çš„å€¼ type Weekday int const ( Sunday Weekday = iota Monday _ _ Thursday Friday Saturday ) å¯¹åº”çš„å€¼ä¸å˜ï¼Œé€‚ç”¨åœºæ™¯ï¼šæŸäº›æšä¸¾å€¼å¯èƒ½ä¸éœ€è¦ã€‚ 5ã€ä½æ©ç  const ( a = 1\u003c\u003ciota // 1 b // 2 c // 4 ) æ˜¯è¿ç»­çš„2çš„å¹‚ã€‚ 6ã€æ•°é‡çº§ const ( B = 1 \u003c\u003c (10*iota) KB MB GB TB ) æŒ‰ç…§è¿™æ ·çš„ç”Ÿæˆè§„åˆ™å¯ä»¥æŒ‰ç…§æ•°é‡çº§ç”Ÿæˆå€¼ã€‚ 7ã€å®šä¹‰åœ¨ä¸€è¡Œçš„æƒ…å†µ const ( a,b = iota,iota+1 // 0,1 c,d // 1,2 e,f // 2,3 ) iotaä¼šåœ¨ä¸‹ä¸€è¡Œå¾—åˆ°å¢é•¿ï¼Œè€Œä¸æ˜¯ç«‹å³è·å–å®ƒçš„åº”ç”¨ã€‚ 8ã€ä¸­é—´æ’é˜Ÿ const ( a = iota // 0 b = 2 // 2 c // 2 d = iota // 3 ) const ( a = 2 // 2 b = iota // 1 c // 2 ) ","date":"2021-02-10","objectID":"/2021/02/itoa/:0:0","tags":["iota","golang"],"title":"Iotaçš„ä½¿ç”¨æ–¹æ³•","uri":"/2021/02/itoa/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"èƒŒæ™¯ åœ¨å¤æ‚çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¾€å¾€éœ€è¦å¯¹å¤§é‡çš„æ•°æ®å’Œæ¶ˆæ¯è¿›è¡Œå”¯ä¸€æ ‡è¯†ã€‚æ•°æ®æ—¥ç›Šå¢é•¿ï¼Œå¯¹æ•°æ®åº“éœ€è¦è¿›è¡Œåˆ‡åˆ†ï¼Œè€Œæ°´å¹³åˆ‡åˆ†æ•°æ®åº“éœ€è¦ä¸€ä¸ªå”¯ä¸€IDæ¥æ ‡è¯†ä¸€æ¡æ•°æ®æˆ–æ¶ˆæ¯ï¼Œæ•°æ®åº“çš„è‡ªå¢IDæ˜¾ç„¶ä¸èƒ½æ»¡è¶³éœ€æ±‚ã€‚é‚£ä¹ˆå¯¹äºåˆ†å¸ƒå¼å…¨å±€IDæœ‰ä»€ä¹ˆè¦æ±‚å‘¢ï¼Ÿ å…¨å±€å”¯ä¸€æ€§ï¼šä¸èƒ½å‡ºç°é‡å¤çš„IDå·ã€‚ è¶‹åŠ¿é€’å¢ï¼šåœ¨MySQL InnoDBå¼•æ“ä¸­ä½¿ç”¨çš„æ˜¯èšé›†ç´¢å¼•ï¼Œç”±äºå¤šæ•°RDBMSä½¿ç”¨B-treeçš„æ•°æ®ç»“æ„æ¥å­˜å‚¨ç´¢å¼•æ•°æ®ï¼Œåœ¨ä¸»é”®çš„é€‰æ‹©ä¸Šé¢æˆ‘ä»¬åº”è¯¥å°½é‡ä½¿ç”¨æœ‰åºçš„ä¸»é”®ä¿è¯å†™å…¥æ€§èƒ½ã€‚ å•è°ƒé€’å¢ï¼šä¿è¯ä¸‹ä¸€ä¸ªIDä¸€å®šå¤§äºä¸Šä¸€ä¸ªIDï¼Œä¾‹å¦‚äº‹åŠ¡ç‰ˆæœ¬å·ã€IMå¢é‡æ¶ˆæ¯ã€æ’åºç­‰ç‰¹æ®Šéœ€æ±‚ã€‚ ä¿¡æ¯å®‰å…¨ï¼šå¦‚æœIDæ˜¯è¿ç»­çš„ï¼Œä¼šå‡ºç°å®‰å…¨é—®é¢˜ï¼Œåœ¨ä¸€äº›åœºæ™¯ä¸­ï¼Œä¼šéœ€è¦IDæ— è§„åˆ™ï¼Œä¸è§„åˆ™ã€‚ ","date":"2021-02-08","objectID":"/2021/02/uuid/:1:0","tags":["uuid","snowflake"],"title":"ç”Ÿæˆuuidçš„å‡ ç§æ–¹å¼","uri":"/2021/02/uuid/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"UUID UUID(Universally Unique Identifier)æ˜¯ä¸€ä¸ª128ä½æ ‡è¯†ç¬¦ï¼Œåœ¨å…¶è§„èŒƒçš„æ–‡æœ¬è¡¨ç¤ºä¸­ï¼ŒUUID çš„ 16 ä¸ª 8 ä½å­—èŠ‚è¡¨ç¤ºä¸º 32 ä¸ªåå…­è¿›åˆ¶ï¼ˆåŸºæ•°16ï¼‰æ•°å­—ï¼Œæ˜¾ç¤ºåœ¨ç”±è¿å­—ç¬¦åˆ†éš” â€˜-â€™ çš„äº”ä¸ªç»„ä¸­ï¼Œâ€œ8-4-4-4-12â€ æ€»å…± 36 ä¸ªå­—ç¬¦ï¼ˆ32 ä¸ªå­—æ¯æ•°å­—å­—ç¬¦å’Œ 4 ä¸ªè¿å­—ç¬¦ï¼‰ã€‚ä¾‹å¦‚ï¼š123e4567-e89b-12d3-a456-426655440000ã€‚ ä¼˜ç‚¹ï¼šæ€§èƒ½é«˜ï¼Œæœ¬åœ°ç”Ÿæˆï¼Œæ²¡æœ‰ç½‘ç»œæ¶ˆè€— ç¼ºç‚¹ï¼š 1ã€ä¸æ˜“å­˜å‚¨ï¼šUUIDå¤ªé•¿ï¼Œå¾ˆå¤šåœºæ™¯ä¸é€‚ç”¨ã€‚ 2ã€ä¿¡æ¯ä¸å®‰å…¨ï¼šåŸºäºMACåœ°å€ç”Ÿæˆçš„UUIDç®—æ³•å¯èƒ½é€ æˆMACåœ°å€æ³„éœ²ã€‚ 3ã€æ²¡æœ‰æ’åºï¼Œæ— æ³•ä¿è¯é€’å¢è¶‹åŠ¿ã€‚ 4ã€ä¸æ˜“è¯»ï¼Œå­˜å‚¨ç©ºé—´å¤§ã€‚ goä¸¤ç§ç”ŸæˆUUIDçš„ç¬¬ä¸‰æ–¹åŒ…ï¼š github.com/google/uuid github.com/satori/go.uuid ","date":"2021-02-08","objectID":"/2021/02/uuid/:2:0","tags":["uuid","snowflake"],"title":"ç”Ÿæˆuuidçš„å‡ ç§æ–¹å¼","uri":"/2021/02/uuid/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"Snowflake snowflakeæ˜¯Twitterå¼€æºçš„åˆ†å¸ƒå¼IDç”Ÿæˆç®—æ³•ï¼Œç»“æœæ˜¯ä¸€ä¸ªlongå‹çš„IDã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šä½¿ç”¨41bitä½œä¸ºæ¯«ç§’æ•°ï¼Œ10bitä½œä¸ºæœºå™¨çš„IDï¼ˆ5ä¸ªbitæ˜¯æ•°æ®ä¸­å¿ƒï¼Œ5ä¸ªbitçš„æœºå™¨IDï¼‰ï¼Œ12bitä½œä¸ºæ¯«ç§’å†…çš„æµæ°´å·ï¼ˆæ„å‘³ç€æ¯ä¸ªèŠ‚ç‚¹åœ¨æ¯æ¯«ç§’å¯ä»¥äº§ç”Ÿ 4096 ä¸ª IDï¼‰ï¼Œæœ€åè¿˜æœ‰ä¸€ä¸ªç¬¦å·ä½ï¼Œæ°¸è¿œæ˜¯0ã€‚ 1ã€å®ç°åŸç†ï¼š 1ä½æœ€é«˜ä½ï¼šç¬¦å·ä½ä¸ä½¿ç”¨ï¼Œ0è¡¨ç¤ºæ­£æ•°ï¼Œ1è¡¨ç¤ºè´Ÿæ•°ã€‚ 41ä½æ—¶é—´æˆ³ï¼š1\u003c\u003c41 = 1000*3600*24*365 = 69 å¹´ã€‚ 10ä½å·¥ä½œæœºå™¨idï¼šå¦‚æœæˆ‘ä»¬å¯¹IDCåˆ’åˆ†æœ‰éœ€æ±‚å¯ä»¥ç”¨5ä½ç»™IDCï¼Œ5ä½ç»™å·¥ä½œæœºå™¨ï¼Œè¿™æ ·å°±å¯ä»¥è¡¨ç¤º32ä¸ªIDCï¼Œæ¯ä¸ªIDCä¸‹æœ‰32å°æœºå™¨ã€‚ 12ä½è‡ªå¢IDï¼šå¯ä»¥è¡¨ç¤º2^12^ä¸ªIDã€‚ ç†è®ºä¸Šsnowflakeæ–¹æ¡ˆçš„QPSçº¦ä¸º409.3w/sï¼Œè¿™ç§åˆ†é…æ–¹å¼å¯ä»¥ä¿è¯åœ¨ä»»ä½•ä¸€ä¸ªIDCçš„ä»»ä½•ä¸€å°æœºå™¨åœ¨ä»»æ„æ¯«ç§’å†…ç”Ÿæˆçš„IDéƒ½æ˜¯ä¸åŒçš„ã€‚ ä¼˜ç‚¹ï¼š æ¯«ç§’æ•°åœ¨é«˜ä½ï¼Œè‡ªå¢åºåˆ—åœ¨ä½ä½ï¼Œæ•´ä¸ªIDéƒ½æ˜¯è¶‹åŠ¿é€’å¢çš„ã€‚ ä¸ä¾èµ–æ•°æ®åº“ç­‰ç¬¬ä¸‰æ–¹ç³»ç»Ÿï¼Œä»¥æœåŠ¡çš„æ–¹å¼éƒ¨ç½²ï¼Œç¨³å®šæ€§æ›´é«˜ï¼Œç”ŸæˆIDçš„æ€§èƒ½ä¹Ÿæ˜¯éå¸¸é«˜çš„ã€‚ å¯ä»¥æ ¹æ®è‡ªèº«ä¸šåŠ¡ç‰¹æ€§åˆ†é…bitä½ï¼Œéå¸¸çµæ´»ã€‚ ç¼ºç‚¹ï¼š å¼ºä¾èµ–æœºå™¨æ—¶é’Ÿï¼Œå¦‚æœæœºå™¨ä¸Šæ—¶é’Ÿå›æ‹¨ï¼Œä¼šå¯¼è‡´å‘å·é‡å¤æˆ–è€…æœåŠ¡ä¼šå¤„äºä¸å¯ç”¨çŠ¶æ€ã€‚ ä»£ç å®ç°ï¼š package main import ( \"errors\" \"fmt\" \"runtime\" \"sync\" \"time\" ) //global var var sequence int = 0 var lastTime int = -1 //every segment bit var workerIdBits = 5 var datacenterIdBits = 5 var sequenceBits = 12 //every segment max number var maxWorkerId int = -1 ^ (-1 \u003c\u003c workerIdBits) var maxDatacenterId int = -1 ^ (-1 \u003c\u003c datacenterIdBits) var maxSequence int = -1 ^ (-1 \u003c\u003c sequenceBits) //bit operation shift var workerIdShift = sequenceBits var datacenterShift = workerIdBits + sequenceBits var timestampShift = datacenterIdBits + workerIdBits + sequenceBits type Snowflake struct { datacenterId int workerId int epoch int mt *sync.Mutex } func NewSnowflake(datacenterId int, workerId int, epoch int) (*Snowflake, error) { if datacenterId \u003e maxDatacenterId || datacenterId \u003c 0 { return nil, errors.New(fmt.Sprintf(\"datacenterId cant be greater than %d or less than 0\", maxDatacenterId)) } if workerId \u003e maxWorkerId || workerId \u003c 0 { return nil, errors.New(fmt.Sprintf(\"workerId cant be greater than %d or less than 0\", maxWorkerId)) } if epoch \u003e getCurrentTime() { return nil, errors.New(fmt.Sprintf(\"epoch time cant be after now\")) } sf := Snowflake{datacenterId, workerId, epoch, new(sync.Mutex)} return \u0026sf, nil } func (sf *Snowflake) getUniqueId() int { sf.mt.Lock() defer sf.mt.Unlock() //get current time currentTime := getCurrentTime() //compute sequence if currentTime \u003c lastTime { //occur clock back //panic or wait,wait is not the best way.can be optimized. currentTime = waitUntilNextTime(lastTime) sequence = 0 } else if currentTime == lastTime { //at the same time(micro-second) sequence = (sequence + 1) \u0026 maxSequence if sequence == 0 { //overflow max num,wait next time currentTime = waitUntilNextTime(lastTime) } } else if currentTime \u003e lastTime { //next time sequence = 0 lastTime = currentTime } //generate id return (currentTime-sf.epoch)\u003c\u003ctimestampShift | sf.datacenterId\u003c\u003cdatacenterShift | sf.workerId\u003c\u003cworkerIdShift | sequence } func waitUntilNextTime(lasttime int) int { currentTime := getCurrentTime() for currentTime \u003c= lasttime { time.Sleep(1 * time.Second / 1000) //sleep micro second currentTime = getCurrentTime() } return currentTime } func getCurrentTime() int { return int(time.Now().UnixNano() / 1e6) //micro second } func main() { runtime.GOMAXPROCS(runtime.NumCPU()) datacenterId := 0 workerId := 0 epoch := 1596850974657 s, err := NewSnowflake(datacenterId, workerId, epoch) if err != nil { panic(err) } var wg sync.WaitGroup for i := 0; i \u003c 1000000; i++ { wg.Add(1) go func() { fmt.Println(s.getUniqueId()) wg.Done() }() } wg.Wait() } ","date":"2021-02-08","objectID":"/2021/02/uuid/:3:0","tags":["uuid","snowflake"],"title":"ç”Ÿæˆuuidçš„å‡ ç§æ–¹å¼","uri":"/2021/02/uuid/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"æ•°æ®åº“ID åˆ©ç”¨æ•°æ®åº“å­—æ®µè®¾ç½®auto_increment_incrementå’Œauto_increment_offsetæ¥ä¿è¯IDè‡ªå¢ï¼Œæ¯æ¬¡ä¸šåŠ¡ä½¿ç”¨ä¸€ä¸‹SQLè¯»å†™MySQLå¾—åˆ°IDã€‚ begin;REPLACEintoTickets(id)values(null);selectLAST_INSERT_ID();commit; ä¼˜ç‚¹ï¼šç®€å•ï¼Œåˆ©ç”¨æ•°æ®åº“çš„åŠŸèƒ½å®ç°ï¼Œæˆæœ¬å°ï¼›idå•è°ƒé€’å¢ã€‚ ç¼ºç‚¹ï¼šå¼ºä¾èµ–æ•°æ®åº“ï¼Œå½“æ•°æ®åº“ä¸å¯ç”¨æ—¶ï¼Œæ˜¯è‡´å‘½é—®é¢˜ï¼›IDå‘å·æ€§èƒ½ç“¶é¢ˆé™åˆ¶åœ¨å•å°MySQLçš„è¯»å†™æ€§èƒ½ä¸Šã€‚ å¯¹äºMySQLæ€§èƒ½é—®é¢˜ï¼Œå¯ç”¨å¦‚ä¸‹æ–¹æ³•è§£å†³ï¼š åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­éƒ¨ç½²å¤šå°æœºå™¨ï¼Œæ¯å°æœºå™¨è®¾ç½®ä¸åŒçš„åˆå§‹å€¼ï¼Œä¸”æ­¥é•¿ç›¸ç­‰ã€‚ä¾‹å¦‚è®¾ç½®æ­¥é•¿ä¸º2ï¼ŒTicketServer1çš„åˆå§‹å€¼ä¸º1 (1,3,5,7...), TicketServer1çš„åˆå§‹å€¼ä¸º2(2,4,6,8...)ã€‚ ä¸»é”®ç”Ÿæˆç­–ç•¥ ç¼ºç‚¹ï¼š æ°´å¹³æ‰©å±•æ¯”è¾ƒå›°éš¾ï¼Œäº‹å…ˆå®šå¥½æ­¥é•¿å’Œæœºå™¨åï¼Œå¦‚æœåç»­æ–°å¢æœºå™¨ï¼Œä¸å®¹æ˜“æ‰©å®¹ã€‚ æ•°æ®åº“å‹åŠ›è¿˜æ˜¯å¤§ï¼Œåªèƒ½é å †æœºå™¨æ¥æé«˜æ€§èƒ½ã€‚ ","date":"2021-02-08","objectID":"/2021/02/uuid/:4:0","tags":["uuid","snowflake"],"title":"ç”Ÿæˆuuidçš„å‡ ç§æ–¹å¼","uri":"/2021/02/uuid/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"MongoDB ID MongoDBå®˜æ–¹æ–‡æ¡£ ObjectIDå’Œsnowflakeç®—æ³•ç±»ä¼¼ï¼Œå®ƒè®¾è®¡æˆè½»é‡å‹çš„ï¼Œä¸åŒçš„æœºå™¨éƒ½èƒ½ç”¨å…¨å±€å”¯ä¸€çš„åŒç§æ–¹æ³•ä¾¿åˆ©ç”Ÿæˆã€‚é€šè¿‡ æ—¶é—´æˆ³+æœºå™¨+pid+è‡ªå¢id å…±12ä¸ªå­—èŠ‚ï¼Œé€šè¿‡ 4+3+2+3 çš„æ–¹å¼ç”Ÿæˆ24ä½çš„åå…­è¿›åˆ¶å­—ç¬¦ã€‚ ","date":"2021-02-08","objectID":"/2021/02/uuid/:5:0","tags":["uuid","snowflake"],"title":"ç”Ÿæˆuuidçš„å‡ ç§æ–¹å¼","uri":"/2021/02/uuid/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"Zookeeper ID zookeeperä¸»è¦é€šè¿‡å…¶znodeæ•°æ®ç‰ˆæœ¬æ¥ç”Ÿæˆåºåˆ—å·ï¼Œå¯ä»¥ç”Ÿæˆ32ä½å’Œ64ä½çš„æ•°æ®ç‰ˆæœ¬å·ï¼Œå®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨è¿™ä¸ªç‰ˆæœ¬å·æ¥ä½œä¸ºå”¯ä¸€çš„åºåˆ—å·ã€‚ å¾ˆå°‘ä¼šä½¿ç”¨zookeeperæ¥ç”Ÿæˆå”¯ä¸€IDã€‚ä¸»è¦æ˜¯ç”±äºéœ€è¦ä¾èµ–zookeeperï¼Œå¹¶ä¸”æ˜¯å¤šæ­¥è°ƒç”¨APIï¼Œå¦‚æœåœ¨ç«äº‰è¾ƒå¤§çš„æƒ…å†µä¸‹ï¼Œéœ€è¦è€ƒè™‘ä½¿ç”¨åˆ†å¸ƒå¼é”ã€‚å› æ­¤ï¼Œæ€§èƒ½åœ¨é«˜å¹¶å‘çš„åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œä¹Ÿä¸ç”šç†æƒ³ã€‚ ","date":"2021-02-08","objectID":"/2021/02/uuid/:6:0","tags":["uuid","snowflake"],"title":"ç”Ÿæˆuuidçš„å‡ ç§æ–¹å¼","uri":"/2021/02/uuid/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"äºŒç»´æ•°ç»„çš„æ’åˆ—é¡ºåº æ•°ç»„åœ¨å†…å­˜ä¸­æ˜¯æŒ‰è¡Œå­˜å‚¨çš„ï¼ŒæŒ‰è¡Œéå†æ—¶å¯ä»¥ç”±æŒ‡å‘æ•°ç»„çš„ç¬¬ä¸€ä¸ªæ•°çš„æŒ‡é’ˆä¸€ç›´å‘åéå†ï¼Œç”±äºäºŒç»´æ•°ç»„çš„å†…å­˜åœ°å€æ˜¯è¿ç»­çš„ï¼Œå½“å‰è¡Œçš„å°¾å’Œä¸‹ä¸€è¡Œçš„å¤´ç›¸é‚»ã€‚ ç”¨ä»£ç æ¥æ‰“å°æ•°ç»„çš„åœ°å€ã€‚ func main() { var a int32 fmt.Println(unsafe.Sizeof(a)) n := 4 array := generateArray(n) for i := 0; i \u003c n; i++ { fmt.Printf(\"%p \\n\",array[i]) } } func generateArray(n int) [][]int32 { var arr = make([][]int32,n) for i := 0; i \u003c n; i++ { arr[i] = make([]int32,n) for j := 0; j \u003c n; j++ { arr[i][j] = 1 } } return arr } // Output: 4 0xc0000a0090 0xc0000a00a0 0xc0000a00b0 0xc0000a00c0 int32å ç”¨4ä¸ªå­—èŠ‚ï¼Œ4ä¸ªint32å ç”¨16ä¸ªå­—èŠ‚ï¼Œè¿™ä¸æˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªæ•°ç»„çš„åœ°å€æ˜¯å¯¹åº”çš„ã€‚ æˆ‘ä»¬çœ¼ä¸­çš„äºŒç»´æ•°ç»„ å†…å­˜ä¸­çš„äºŒç»´æ•°ç»„ é‚£ä¹ˆäºŒç»´æ•°ç»„æŒ‰è¡Œéå†ç›¸å½“äºæŒ‰ç…§å†…å­˜é¡ºåºè¯»å–ï¼Œè€ŒæŒ‰åˆ—éå†ä¸æŒ‰å†…å­˜é¡ºåºè¯»å–ã€‚ æŒ‰è¡Œè¯»å–æ¯”æŒ‰åˆ—è¯»å–çš„æ•ˆç‡é«˜ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š CPUé«˜é€Ÿç¼“å­˜ï¼šåœ¨è®¡ç®—æœºç³»ç»Ÿä¸­ï¼ŒCPUé«˜é€Ÿç¼“å­˜ï¼ˆè‹±è¯­ï¼šCPU Cacheï¼Œåœ¨æœ¬æ–‡ä¸­ç®€ç§°ç¼“å­˜ï¼‰æ˜¯ç”¨äºå‡å°‘å¤„ç†å™¨è®¿é—®å†…å­˜æ‰€éœ€å¹³å‡æ—¶é—´çš„éƒ¨ä»¶ã€‚åœ¨é‡‘å­—å¡”å¼å­˜å‚¨ä½“ç³»ä¸­å®ƒä½äºè‡ªé¡¶å‘ä¸‹çš„ç¬¬äºŒå±‚ï¼Œä»…æ¬¡äºCPUå¯„å­˜å™¨ã€‚å…¶å®¹é‡è¿œå°äºå†…å­˜ï¼Œä½†é€Ÿåº¦å´å¯ä»¥æ¥è¿‘å¤„ç†å™¨çš„é¢‘ç‡ã€‚å½“å¤„ç†å™¨å‘å‡ºå†…å­˜è®¿é—®è¯·æ±‚æ—¶ï¼Œä¼šå…ˆæŸ¥çœ‹ç¼“å­˜å†…æ˜¯å¦æœ‰è¯·æ±‚æ•°æ®ã€‚å¦‚æœå­˜åœ¨ï¼ˆå‘½ä¸­ï¼‰ï¼Œåˆ™ä¸ç»è®¿é—®å†…å­˜ç›´æ¥è¿”å›è¯¥æ•°æ®ï¼›å¦‚æœä¸å­˜åœ¨ï¼ˆå¤±æ•ˆï¼‰ï¼Œåˆ™è¦å…ˆæŠŠå†…å­˜ä¸­çš„ç›¸åº”æ•°æ®è½½å…¥ç¼“å­˜ï¼Œå†å°†å…¶è¿”å›å¤„ç†å™¨ã€‚ç¼“å­˜ä¹‹æ‰€ä»¥æœ‰æ•ˆï¼Œä¸»è¦æ˜¯å› ä¸ºç¨‹åºè¿è¡Œæ—¶å¯¹å†…å­˜çš„è®¿é—®å‘ˆç°å±€éƒ¨æ€§ï¼ˆLocalityï¼‰ç‰¹å¾ã€‚è¿™ç§å±€éƒ¨æ€§æ—¢åŒ…æ‹¬ç©ºé—´å±€éƒ¨æ€§ï¼ˆSpatial Localityï¼‰ï¼Œä¹ŸåŒ…æ‹¬æ—¶é—´å±€éƒ¨æ€§ï¼ˆTemporal Localityï¼‰ã€‚æœ‰æ•ˆåˆ©ç”¨è¿™ç§å±€éƒ¨æ€§ï¼Œç¼“å­˜å¯ä»¥è¾¾åˆ°æé«˜çš„å‘½ä¸­ç‡ã€‚ ç¼“å­˜ä»å†…å­˜ä¸­æŠ“å–ä¸€èˆ¬éƒ½æ˜¯æ•´ä¸ªæ•°æ®å—ï¼Œæ‰€ä»¥å®ƒçš„ç‰©ç†å†…å­˜æ˜¯è¿ç»­çš„ï¼Œå‡ ä¹éƒ½æ˜¯åŒè¡Œä¸åŒåˆ—çš„ï¼Œè€Œå¦‚æœå†…å¾ªç¯ä»¥åˆ—çš„æ–¹å¼è¿›è¡Œéå†çš„è¯ï¼Œå°†ä¼šä½¿æ•´ä¸ªç¼“å­˜å—æ— æ³•è¢«åˆ©ç”¨ï¼Œè€Œä¸å¾—ä¸ä»å†…å­˜ä¸­è¯»å–æ•°æ®ï¼Œè€Œä»å†…å­˜è¯»å–é€Ÿåº¦æ˜¯è¿œè¿œå°äºä»ç¼“å­˜ä¸­è¯»å–æ•°æ®çš„ã€‚éšç€æ•°ç»„å…ƒç´ è¶Šæ¥è¶Šå¤šï¼ŒæŒ‰åˆ—è¯»å–é€Ÿåº¦ä¹Ÿä¼šè¶Šæ¥è¶Šæ…¢ã€‚ ä»£ç éªŒè¯ func main() { arr := generateArray(2000) t0 := time.Now() readCols(arr) t1 := time.Now() readRows(arr) t2 := time.Now() fmt.Println(t1.Sub(t0),t2.Sub(t1)) } func generateArray(n int) [][]int32 { var arr = make([][]int32,n) for i := 0; i \u003c n; i++ { arr[i] = make([]int32,n) for j := 0; j \u003c n; j++ { arr[i][j] = 1 } } return arr } func readCols(arr [][]int) { for i := 0; i \u003c len(arr); i++ { for j := 0; j \u003c len(arr[0]); j++ { arr[i][j] = 1 } } } func readRows(arr [][]int) { for i := 0; i \u003c len(arr); i++ { for j := 0; j \u003c len(arr[0]); j++ { arr[j][i] = 1 } } } å¯ä»¥éªŒè¯æŒ‰åˆ—è¯»å–çš„æ—¶é—´è¿œè¿œå¤§äºæŒ‰è¡Œè¯»å–ã€‚ ","date":"2021-02-08","objectID":"/2021/02/%E4%BA%8C%E7%BB%B4%E6%95%B0%E7%BB%84%E9%81%8D%E5%8E%86%E6%95%88%E7%8E%87/:1:0","tags":["äºŒç»´æ•°ç»„"],"title":"äºŒç»´æ•°ç»„æŒ‰è¡Œå’ŒæŒ‰åˆ—éå†çš„æ•ˆç‡","uri":"/2021/02/%E4%BA%8C%E7%BB%B4%E6%95%B0%E7%BB%84%E9%81%8D%E5%8E%86%E6%95%88%E7%8E%87/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"æ’åºç®—æ³• æ‰€è°“çš„æ’åºç®—æ³•å°±æ˜¯å°†ä¸€ä¸²è®°å½•ï¼ŒæŒ‰ç…§é€’å¢æˆ–é€’å‡çš„é¡ºåºæ’åˆ—èµ·æ¥ã€‚ é€šå¸¸æåˆ°çš„ä¸€å…±æœ‰åç§æ’åºï¼šå†’æ³¡ã€é€‰æ‹©ã€æ’å…¥ã€å¿«é€Ÿã€å½’å¹¶ã€å †ã€å¸Œå°”ã€è®¡æ•°ã€æ¡¶ã€åŸºæ•° æ¯”è¾ƒç±»æ’åºï¼šé€šè¿‡æ¯”è¾ƒæ¥å†³å®šå…ƒç´ é—´çš„ç›¸å¯¹æ¬¡åºï¼Œé€šå¸¸å…¶æ—¶é—´å¤æ‚åº¦ä¸èƒ½çªç ´O(nlogn)ï¼Œå› æ­¤åˆç§°ä¸ºéçº¿æ€§æ—¶é—´æ¯”è¾ƒç±»æ’åºã€‚ éæ¯”è¾ƒç±»æ’åºï¼šä¸é€šè¿‡æ¯”è¾ƒå…ƒç´ é—´çš„ç›¸å¯¹æ¬¡åºï¼Œå¯ä»¥çªç ´åŸºäºæ¯”è¾ƒæ’åºçš„æ—¶é—´ä¸‹é™ï¼Œä»¥çº¿æ€§æ—¶é—´è¿è¡Œï¼Œå› æ­¤åˆç§°ä¸ºçº¿æ€§æ—¶é—´éæ¯”è¾ƒç±»æ’åºã€‚ æ—¶é—´å¤æ‚åº¦ï¼š æ’åºæ–¹æ³• æ—¶é—´å¤æ‚åº¦(å¹³å‡) æ—¶é—´å¤æ‚åº¦(æœ€å) æ—¶é—´å¤æ‚åº¦(æœ€å¥½) ç©ºé—´å¤æ‚åº¦ ç¨³å®šæ€§ å†’æ³¡æ’åº O(n^2^) O(n^2^) O(n) O(1) ç¨³å®š é€‰æ‹©æ’åº O(n^2^) O(n^2^) O(n^2^) O(1) ä¸ç¨³å®š æ’å…¥æ’åº O(n^2^) O(n^2^) O(n) O(1) ç¨³å®š å¿«é€Ÿæ’åº O(nlogn) O(n^2^) O(nlogn) O(nlogn) ä¸ç¨³å®š å½’å¹¶æ’åº O(nlogn) O(nlogn) O(nlogn) O(n) ç¨³å®š å †æ’åº O(nlogn) O(nlogn) O(nlogn) O(1) ä¸ç¨³å®š å¸Œå°”æ’åº O(n^1.3^) O(n^2^) O(n) O(1) ç¨³å®š è®¡æ•°æ’åº O(n+k) O(n+k) O(n+k) O(n+k) ç¨³å®š æ¡¶æ’åº O(n+k) O(n^2^) O(n) O(n+k) ç¨³å®š åŸºæ•°æ’åº O(n*k) O(n*k) O(n*k) O(n+k) ç¨³å®š ç¨³å®šæ€§ï¼šå¦‚æœa=bï¼Œå¹¶ä¸”aåœ¨bçš„å‰é¢ï¼Œæ’åºåaä¸€å®šåœ¨bçš„å‰é¢ï¼Œé‚£ä¹ˆç§°ç®—æ³•æ˜¯ç¨³å®šçš„ï¼Œå¦‚æœä¸ä¸€å®šåœ¨å‰é¢ï¼Œé‚£ä¹ˆç§°ç®—æ³•æ˜¯ä¸ç¨³å®šçš„ã€‚ ","date":"2021-02-07","objectID":"/2021/02/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95/:1:0","tags":["golang","ç®—æ³•"],"title":"åå¤§åŸºç¡€æ’åºç®—æ³•","uri":"/2021/02/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"å†’æ³¡æ’åº å†’æ³¡æ’åº(Bubble Sort)æ˜¯ä¸€ç§ç®€å•ç›´è§‚çš„æ’åºç®—æ³•ã€‚å®ƒé‡å¤åœ°è®¿é—®è¦æ’åºçš„æ•°åˆ—ï¼Œä¸€æ¬¡æ¯”è¾ƒä¸¤ä¸ªå…ƒç´ ï¼Œå¦‚æœé¡ºåºé”™è¯¯å°±è°ƒæ¢é¡ºåºã€‚èµ°è®¿æ•°åˆ—çš„å·¥ä½œæ˜¯é‡å¤åœ°è¿›è¡ŒæŒ‡å¯¼æ²¡æœ‰å†éœ€è¦å…ƒç´ äº¤æ¢ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥æ•°åˆ—å·²ç»æ’åºå®Œæˆã€‚ç”±äºè¶Šå°çš„å…ƒç´ ä¼šç»è¿‡äº¤æ¢æ…¢æ…¢åœ°åˆ°è¾¾é¡¶ç«¯ï¼Œå°±åƒæ³¡æ³¡ä¸€æ ·ä¼šä¸Šæµ®ï¼Œæ‰€ä»¥ç§°ä¸ºå†’æ³¡æ’åºã€‚ 1ã€ç®—æ³•æ­¥éª¤ â€‹ 1ã€æ¯”è¾ƒç›¸é‚»çš„å…ƒç´ ï¼Œå¦‚æœç¬¬ä¸€ä¸ªæ¯”ç¬¬äºŒä¸ªå¤§ï¼Œå°±äº¤æ¢å®ƒä»¬ã€‚ â€‹ 2ã€å¯¹æ¯ä¸€å¯¹ç›¸é‚»å…ƒç´ åšåŒæ ·çš„å·¥ä½œï¼Œä»å¼€å§‹ç¬¬ä¸€å¯¹åˆ°ç»“å°¾çš„æœ€åä¸€å¯¹ï¼Œè¿™æ­¥åšå®Œåï¼Œæœ«å°¾å…ƒç´ æ˜¯æœ€å¤§çš„å…ƒç´ ã€‚ â€‹ 3ã€é’ˆå¯¹æ‰€æœ‰çš„å…ƒç´ é‡å¤ä»¥ä¸Šæ­¥éª¤ï¼Œé™¤äº†æœ€åä¸€ä¸ªå…ƒç´  â€‹ 4ã€é‡å¤æ­¥éª¤1~3ï¼Œç›´åˆ°æ²¡æœ‰ä»»æ„ä¸€å¯¹å…ƒç´ éœ€è¦æ¯”è¾ƒã€‚ 2ã€åŠ¨ç”»æ¼”ç¤º 3ã€æƒ…å†µ æœ€å¥½æƒ…å†µï¼šæ•°åˆ—æ˜¯æ­£åºï¼Œåªéœ€è¦éå†ä¸€éï¼Œæ—¶é—´å¤æ‚åº¦æœ€å¥½ä¸ºO(n)ã€‚ æœ€åæƒ…å†µï¼šæ•°åˆ—æ˜¯å€’åºï¼Œæ¯ä¸€å¯¹éƒ½éœ€è¦è¿›è¡Œæ¯”è¾ƒï¼Œæ—¶é—´å¤æ‚åº¦æœ€åä¸ºO(n^2^)ã€‚ æ—¶é—´å¤æ‚åº¦å¹³å‡ä¸ºO(n^2^)ï¼Œç©ºé—´å¤æ‚åº¦ä¸ºO(1)ï¼Œæ˜¯ç¨³å®šæ’åºã€‚ 4ã€Golangå®ç° func bubbleSort(arr []int) { n := len(arr) for i := 0; i \u003c n-1; i++ { for j := i + 1; j \u003c n; j++ { if arr[i] \u003e arr[j] { arr[i], arr[j] = arr[j], arr[i] } } } } ","date":"2021-02-07","objectID":"/2021/02/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95/:2:0","tags":["golang","ç®—æ³•"],"title":"åå¤§åŸºç¡€æ’åºç®—æ³•","uri":"/2021/02/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"é€‰æ‹©æ’åº é€‰æ‹©æ’åº(Selection Sort)æ˜¯ä¸€ç§ç®€å•ç›´è§‚çš„æ’åºç®—æ³•ã€‚å®ƒçš„å·¥ä½œåŸç†æ˜¯ï¼šé¦–å…ˆåœ¨åºåˆ—ä¸­æ‰¾åˆ°æœ€å°å…ƒç´ ï¼Œæ”¾åœ¨åºåˆ—çš„é¦–ä½ï¼Œç„¶åå†ä»å‰©ä¸‹çš„åºåˆ—ä¸­å¯»æ‰¾æœ€å°å…ƒç´ ï¼Œæ”¾åˆ°å·²æ’åºåºåˆ—çš„æœ«å°¾ã€‚ 1ã€ç®—æ³•æ­¥éª¤ â€‹ 1ã€é¦–å…ˆåœ¨æœªæ’åºåºåˆ—ä¸­æ‰¾åˆ°æœ€å°å…ƒç´ ï¼Œå­˜æ”¾åˆ°æ’åºåºåˆ—çš„èµ·å§‹ä½ç½® â€‹ 2ã€å†ä»å‰©ä½™æœªæ’åºåºåˆ—ä¸­ç»§ç»­å¯»æ‰¾æœ€å°å…ƒç´ ï¼Œå­˜æ”¾åˆ°æ’åºåºåˆ—çš„æœ«å°¾ â€‹ 3ã€é‡å¤ç¬¬2æ­¥ï¼Œç›´åˆ°æ‰€æœ‰å…ƒç´ æ’åºå®Œæ¯•ã€‚ 2ã€åŠ¨ç”»æ¼”ç¤º 3ã€æƒ…å†µ æ—¶é—´å¤æ‚åº¦ä¸ºO(n^2^)ï¼Œå› ä¸ºæ— è®ºå¦‚ä½•éƒ½éœ€è¦éå†åºåˆ—æ‰¾åˆ°æœ€å°å€¼ï¼Œæ‰€ä»¥æœ€å¥½å’Œæœ€åéƒ½æ˜¯O(n^2^)ã€‚ ç©ºé—´å¤æ‚åº¦ä¸ºO(n^2^)ï¼Œæ˜¯ä¸ç¨³å®šæ’åºã€‚ 4ã€Golangå®ç° func selectionSort(arr []int) { for i := 0; i \u003c len(arr); i++ { min := i for j := i + 1; j \u003c len(arr); j++ { if arr[j] \u003c arr[min] { min = j } } arr[min], arr[i] = arr[i], arr[min] } } ","date":"2021-02-07","objectID":"/2021/02/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95/:3:0","tags":["golang","ç®—æ³•"],"title":"åå¤§åŸºç¡€æ’åºç®—æ³•","uri":"/2021/02/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"æ’å…¥æ’åº æ’å…¥æ’åº(Insertion Sort)æ˜¯ä¸€ç§ç®€å•ç›´è§‚çš„æ’åºç®—æ³•ã€‚å®ƒçš„å·¥ä½œåŸç†æ˜¯é€šè¿‡æ„å»ºæœ‰åºåºåˆ—ï¼Œå¯¹äºæœªæ’åºæ•°æ®ï¼Œåœ¨å·²æ’åºåºåˆ—ç”±åå‘å‰æ‰«æï¼Œæ‰¾åˆ°ç›¸åº”ä½ç½®å¹¶æ’å…¥ã€‚ 1ã€ç®—æ³•æ­¥éª¤ â€‹ 1ã€æŠŠç¬¬ä¸€ä¸ªå…ƒç´ çœ‹æˆä¸€ä¸ªæœ‰åºåºåˆ—ï¼ŒæŠŠç¬¬äºŒä¸ªå…ƒç´ åˆ°æœ€åä¸€ä¸ªå…ƒç´ çœ‹æˆä¸€ä¸ªæœªæ’åºåºåˆ—ã€‚ â€‹ 2ã€ä»å¤´æ‰«æï¼Œå°†æ‰«æåˆ°çš„æ¯ä¸ªå…ƒç´ æ’å…¥æœ‰åºåºåˆ—çš„é€‚å½“ä½ç½®ã€‚ 2ã€åŠ¨ç”»æ¼”ç¤º 3ã€æƒ…å†µ æœ€åæƒ…å†µï¼šæ¯ä¸€ä¸ªå¾…æ’å…¥çš„å…ƒç´ éƒ½éœ€è¦æ’å…¥åˆ°åºåˆ—é¦–ä½ï¼Œå³åŸåºåˆ—æ˜¯å€’åºåºåˆ—ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(n^2^)ã€‚ æœ€å¥½æƒ…å†µï¼šæ¯ä¸€ä¸ªå¾…æ’å…¥çš„å…ƒç´ éƒ½éœ€è¦æ’å…¥åˆ°åºåˆ—æœ«ä½ï¼Œå³åŸåºåˆ—æ˜¯æ­£åºåºåˆ—ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(n) ã€‚ æ—¶é—´å¤æ‚åº¦å¹³å‡ä¸º O(n^2^)ï¼Œç©ºé—´å¤æ‚åº¦ä¸ºO(1) æ˜¯ç¨³å®šæ’åºã€‚ 4ã€Golangå®ç° func insertionSort(arr []int) { for i := 1; i \u003c len(arr); i++ { current := arr[i] preIndex := i - 1 for ; preIndex \u003e= 0 \u0026\u0026 current \u003c arr[preIndex]; preIndex-- { arr[preIndex+1] = arr[preIndex] } arr[preIndex+1] = current } } ","date":"2021-02-07","objectID":"/2021/02/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95/:4:0","tags":["golang","ç®—æ³•"],"title":"åå¤§åŸºç¡€æ’åºç®—æ³•","uri":"/2021/02/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"å¿«é€Ÿæ’åº å¿«é€Ÿæ’åº(Quick Sort)æ˜¯é€šè¿‡ä¸€è¶Ÿæ’åºå°†å¾…æ’è®°å½•åˆ†éš”æˆç‹¬ç«‹çš„ä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­ä¸€éƒ¨åˆ†çš„å…³é”®å­—æ¯”å¦ä¸€éƒ¨åˆ†çš„å…³é”®å­—å°ï¼Œåˆ™å¯åˆ†åˆ«å¯¹è¿™ä¸¤éƒ¨åˆ†è®°å½•ç»§ç»­è¿›è¡Œæ’åºï¼Œç›´åˆ°æ•´ä¸ªåºåˆ—æœ‰åºã€‚ 1ã€ç®—æ³•æ­¥éª¤ â€‹ 1ã€ä»åºåˆ—ä¸­æŒ‘å‡ºä¸€ä¸ªå…ƒç´ ï¼Œä½œä¸ºåŸºå‡†ã€‚ â€‹ 2ã€é‡æ–°æ’åˆ—æ•°åˆ—ï¼Œæ‰€æœ‰å…ƒç´ æ¯”åŸºå‡†å°çš„æ”¾åœ¨åŸºå‡†å‰é¢ï¼Œæ‰€æœ‰å…ƒç´ æ¯”åŸºå‡†å¤§çš„æ”¾åœ¨åŸºå‡†åé¢ã€‚ â€‹ 3ã€é€’å½’åœ°æŠŠå°äºåŸºå‡†å…ƒç´ çš„å­åºåˆ—å’Œå¤§äºåŸºå‡†å…ƒç´ çš„å­åºåˆ—æ’åºã€‚ 2ã€åŠ¨ç”»æ¼”ç¤º 3ã€æƒ…å†µ æ—¶é—´å¤æ‚åº¦å¹³å‡ä¸ºO(nlogn) ï¼Œç©ºé—´å¤æ‚åº¦ä¸ºO(nlogn)ï¼Œæ˜¯ä¸ç¨³å®šæ’åºã€‚ 4ã€Golangå®ç° func quickSort(nums []int, left, right int) { if left \u003c right { mid := partition(nums,left,right) quickSort(nums,left,mid) quickSort(nums,mid+1,right) } } func partition(nums []int, left, right int) int { i,j := left+1,right for i\u003cj { if nums[i] \u003e nums[left] { nums[i],nums[j] = nums[j],nums[i] j-- } else { i++ } } if nums[i] \u003e= nums[left] { i-- } nums[left],nums[i] = nums[i],nums[left] return i } ","date":"2021-02-07","objectID":"/2021/02/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95/:5:0","tags":["golang","ç®—æ³•"],"title":"åå¤§åŸºç¡€æ’åºç®—æ³•","uri":"/2021/02/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"å½’å¹¶æ’åº å½’å¹¶æ’åº(Merge Sort)æ˜¯å»ºç«‹åœ¨å½’å¹¶æ“ä½œä¸Šçš„ä¸€ç§æœ‰æ•ˆæ’åºç®—æ³•ï¼Œé‡‡ç”¨äº†åˆ†è€Œæ²»ä¹‹çš„æ€æƒ³ã€‚ 1ã€ç®—æ³•æ­¥éª¤ â€‹ 1ã€æŠŠé•¿åº¦ä¸ºnçš„åºåˆ—åˆ†ä¸ºä¸¤ä¸ªé•¿åº¦ä¸ºn/2çš„å­åºåˆ—ã€‚ â€‹ 2ã€å¯¹è¿™ä¸¤ä¸ªå­åºåˆ—åˆ†åˆ«é‡‡ç”¨å½’å¹¶æ’åºã€‚ â€‹ 3ã€å°†ä¸¤ä¸ªæ’åºå¥½çš„å­åºåˆ—åˆå¹¶æˆä¸€ä¸ªæœ€ç»ˆçš„æ’åºåºåˆ—ã€‚ 2ã€åŠ¨ç”»æ¼”ç¤º 3ã€æƒ…å†µ æ—¶é—´å¤æ‚åº¦ä¸ºO(nlogn)ï¼Œç©ºé—´å¤æ‚åº¦ä¸ºO(n)ï¼Œæ˜¯ç¨³å®šæ’åºæ–¹æ³•ã€‚ 4ã€Golangå®ç° func mergeSort(nums []int, start,end int) { if start \u003c end { mid := (start+end)/2 mergeSort(nums,start,mid) // å·¦è¾¹æ’åº mergeSort(nums,mid+1,end) // å³è¾¹æ’åº merge(nums,start,mid,end) // åˆå¹¶æ•°ç»„ } } func merge(nums []int, start, mid, end int) { i,j := start,mid+1 ret := []int{} for i \u003c= mid \u0026\u0026 j \u003c= end { if nums[i] \u003c= nums[j] { ret = append(ret, nums[i]) i++ } else { ret = append(ret, nums[j]) j++ } } ret = append(ret, nums[i:mid+1]...) ret = append(ret, nums[j:end+1]...) for k, v := range ret { nums[start+k] = v } } ","date":"2021-02-07","objectID":"/2021/02/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95/:6:0","tags":["golang","ç®—æ³•"],"title":"åå¤§åŸºç¡€æ’åºç®—æ³•","uri":"/2021/02/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"å †æ’åº å †æ’åº(Heap Sort)æ˜¯æŒ‡åˆ©ç”¨å †è¿™ç§æ•°æ®ç»“æ„æ‰€è®¾è®¡çš„ä¸€ç§æ’åºç®—æ³•ã€‚å †æ˜¯ä¸€ç§è¿‘ä¼¼äºå®Œå…¨äºŒå‰æ ‘çš„ç»“æ„ï¼Œå¹¶åŒæ—¶æ»¡è¶³å †ç§¯çš„æ€§è´¨ï¼šå­èŠ‚ç‚¹çš„é”®å€¼æˆ–ç´¢å¼•æ€»å°äº(æˆ–å¤§äº)çˆ¶èŠ‚ç‚¹ã€‚ å¤§æ ¹å †ï¼šæ¯ä¸ªèŠ‚ç‚¹çš„å€¼éƒ½å¤§äºæˆ–ç­‰äºå…¶å­èŠ‚ç‚¹çš„å€¼ï¼Œåœ¨å †æ’åºç®—æ³•ä¸­ç”¨äºå‡åºæ’åˆ—ï¼› å°æ ¹å †ï¼šæ¯ä¸ªèŠ‚ç‚¹çš„å€¼éƒ½å°äºæˆ–ç­‰äºå…¶å­èŠ‚ç‚¹çš„å€¼ï¼Œåœ¨å †æ’åºç®—æ³•ä¸­ç”¨äºé™åºæ’åˆ—ï¼› 1ã€ç®—æ³•æ­¥éª¤ â€‹ 1ã€å°†å¾…æ’åºåˆ—æ„å»ºæˆä¸€ä¸ªå † H[0â€¦â€¦n-1]ï¼Œæ ¹æ®(å‡åºé™åº)é€‰æ‹©å¤§æ ¹å †æˆ–å°è·Ÿå †ã€‚ â€‹ 2ã€æŠŠå †é¡¶å’Œå †å°¾äº’æ¢ã€‚ â€‹ 3ã€æŠŠå †çš„å°ºå¯¸ç¼©å° 1ï¼Œå¹¶è°ƒç”¨ shift_down(0)ï¼Œç›®çš„æ˜¯æŠŠæ–°çš„æ•°ç»„é¡¶ç«¯æ•°æ®è°ƒæ•´åˆ°ç›¸åº”ä½ç½®ï¼› â€‹ 4ã€é‡å¤æ­¥éª¤ 2ï¼Œç›´åˆ°å †çš„å°ºå¯¸ä¸º 1ã€‚ 2ã€åŠ¨ç”»æ¼”ç¤º 3ã€æƒ…å†µ æ—¶é—´å¤æ‚åº¦å¹³å‡ä¸ºO(nlogn) ï¼Œç©ºé—´å¤æ‚åº¦ O(1)ï¼Œ æ˜¯ä¸ç¨³å®šæ’åºã€‚ 4ã€Golangå®ç° func heapSort(arr []int) []int { arrLen := len(arr) buildMaxHeap(arr, arrLen) for i := arrLen - 1; i \u003e= 0; i-- { swap(arr, 0, i) arrLen -= 1 heapify(arr, 0, arrLen) } return arr } func buildMaxHeap(arr []int, arrLen int) { for i := arrLen / 2; i \u003e= 0; i-- { heapify(arr, i, arrLen) } } func heapify(arr []int, i, arrLen int) { left := 2*i + 1 right := 2*i + 2 largest := i if left \u003c arrLen \u0026\u0026 arr[left] \u003e arr[largest] { largest = left } if right \u003c arrLen \u0026\u0026 arr[right] \u003e arr[largest] { largest = right } if largest != i { swap(arr, i, largest) heapify(arr, largest, arrLen) } } func swap(arr []int, i, j int) { arr[i], arr[j] = arr[j], arr[i] } ","date":"2021-02-07","objectID":"/2021/02/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95/:7:0","tags":["golang","ç®—æ³•"],"title":"åå¤§åŸºç¡€æ’åºç®—æ³•","uri":"/2021/02/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"å¸Œå°”æ’åº å¸Œå°”æ’åºæ˜¯æ’å…¥æ’åºçš„æ”¹è¿›ç‰ˆæœ¬ï¼Œä¸æ’å…¥æ’åºä¸åŒä¹‹å¤„åœ¨äºï¼Œå®ƒä¼šä¼˜å…ˆæ¯”è¾ƒè·ç¦»è¾ƒè¿œçš„å…ƒç´ ï¼Œåˆç§°ç¼©å°å¢é‡æ’åºã€‚ åŸºæœ¬æ€æƒ³æ˜¯ï¼šå…ˆå°†æ•´ä¸ªå¾…æ’åºçš„åºåˆ—åˆ†å‰²æˆè‹¥å¹²ä¸ªå­åºåˆ—åˆ†åˆ«è¿›è¡Œæ’å…¥æ’åºï¼Œå¾…æ•´ä¸ªåºåˆ—â€œåŸºæœ¬æœ‰åºâ€æ—¶ï¼Œåœ¨ä¾æ¬¡è¿›è¡Œæ’å…¥æ’åºã€‚ 1ã€ç®—æ³•æ­¥éª¤ â€‹ 1ã€é€‰æ‹©ä¸€ä¸ªå¢é‡åºåˆ— t1,t2, â€¦â€¦, tkï¼Œå…¶ä¸­ti \u003e tjï¼Œtk=1; â€‹ 2ã€æŒ‰å¢é‡åºåˆ—ä¸ªæ•°kï¼Œå¯¹åºåˆ—è¿›è¡Œkè¶Ÿæ’åº â€‹ 3ã€æ¯è¶Ÿæ’åºï¼Œæ ¹æ®å¯¹åº”çš„å¢é‡tiï¼Œå°†å¾…æ’åºåˆ†å‰²æˆè‹¥å¹²é•¿åº¦ä¸ºmçš„å­åºåˆ—ï¼Œåˆ†åˆ«å¯¹å„å­è¡¨è¿›è¡Œç›´æ¥æ’å…¥æ’åºã€‚å½“å¢é‡å› å­ä¸º1æ—¶ï¼Œæ•´ä¸ªåºåˆ—ä½œä¸ºä¸€ä¸ªè¡¨æ¥å¤„ç†ï¼Œè¡¨é•¿åº¦å³ä¸ºæ•´ä¸ªåºåˆ—çš„é•¿åº¦ã€‚ 2ã€åŠ¨ç”»æ¼”ç¤º 3ã€Golangå®ç° func shellSort(arr []int) { n := len(arr) for step := n / 2; step \u003e= 1; step /= 2 { for i := step; i \u003c n; i += step { for j := i - step; j \u003e= 0; j -= step { if arr[j] \u003e arr[j+step] { arr[j], arr[j+step] = arr[j+step], arr[j] continue } break } } } } ","date":"2021-02-07","objectID":"/2021/02/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95/:8:0","tags":["golang","ç®—æ³•"],"title":"åå¤§åŸºç¡€æ’åºç®—æ³•","uri":"/2021/02/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"è®¡æ•°æ’åº è®¡æ•°æ’åº(Counting Sort)ä¸æ˜¯åŸºäºæ¯”è¾ƒçš„æ’åºç®—æ³•ï¼Œå…¶æ ¸å¿ƒåœ¨äºå°†è¾“å…¥çš„æ•°æ®å€¼è½¬åŒ–ä¸ºé”®å­˜å‚¨åœ¨é¢å¤–å¼€è¾Ÿçš„æ•°ç»„ç©ºé—´ä¸­ã€‚ä½œä¸ºä¸€ç§çº¿æ€§æ—¶é—´å¤æ‚åº¦çš„æ’åºï¼Œè®¡æ•°æ’åºè¦æ±‚è¾“å…¥çš„æ•°æ®å¿…é¡»æ˜¯æœ‰ç¡®å®šèŒƒå›´çš„æ•´æ•°ã€‚ 1ã€ç®—æ³•æ­¥éª¤ â€‹ 1ã€æ‰¾å‡ºåŸæ•°ç»„ä¸­å…ƒç´ æœ€å¤§å€¼ï¼Œè®°ä¸ºmaxã€‚ â€‹ 2ã€åˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„countï¼Œå…¶é•¿åº¦æ˜¯max+1ï¼Œå…¶å…ƒç´ é»˜è®¤ä¸º0 ã€‚ â€‹ 3ã€éå†åŸæ•°ç»„ä¸­çš„å…ƒç´ ï¼Œä»¥åŸæ•°ç»„ä¸­çš„å…ƒç´ ä½œä¸ºcountæ•°ç»„çš„ç´¢å¼•ï¼Œä»¥åŸæ•°ç»„ä¸­å‡ºç°çš„å…ƒç´ æ¬¡æ•°ä½œä¸ºcountæ•°ç»„çš„å…ƒç´ å€¼ã€‚ â€‹ 4ã€åˆ›å»ºç»“æœæ•°ç»„resultï¼Œèµ·å§‹ç´¢å¼•indexã€‚ â€‹ 5ã€éå†countæ•°ç»„ï¼Œæ‰¾å‡ºå…¶ä¸­å…ƒç´ å€¼å¤§äº0çš„å…ƒç´ ï¼Œå°†å…¶å¯¹åº”çš„ç´¢å¼•ä½œä¸ºå…ƒç´ å€¼å¡«å……åˆ°resultæ•°ç»„ä¸­å»ï¼Œæ¯å¤„ç†ä¸€æ¬¡ï¼Œcountä¸­çš„è¯¥å…ƒç´ å€¼å‡1ï¼Œç›´åˆ°è¯¥å…ƒç´ å€¼ä¸å¤§äº0ï¼Œä¾æ¬¡å¤„ç†countä¸­å‰©ä¸‹çš„å…ƒç´ ã€‚ â€‹ 6ã€è¿”å›ç»“æœæ•°ç»„resultã€‚ 2ã€åŠ¨ç”»æ¼”ç¤º 3ã€æƒ…å†µ æ—¶é—´å¤æ‚åº¦ä¸ºO(n+k)ï¼Œç©ºé—´å¤æ‚åº¦ä¸ºO(n+k)ï¼Œæ˜¯ç¨³å®šæ’åºã€‚ 4ã€Golangå®ç° func countingSort(arr []int, maxVal int) { n := maxVal+1 nums := make([]int,n) var sortedIndex int for i := 0; i \u003c len(arr); i++ { nums[arr[i]]++ } for i := 0; i \u003c n; i++ { for nums[i] \u003e 0 { arr[sortedIndex] = i sortedIndex++ nums[i]-- } } } ","date":"2021-02-07","objectID":"/2021/02/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95/:9:0","tags":["golang","ç®—æ³•"],"title":"åå¤§åŸºç¡€æ’åºç®—æ³•","uri":"/2021/02/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"æ¡¶æ’åº æ¡¶æ’åº(Bucket Sort)æ˜¯è®¡æ•°æ’åºçš„å‡çº§ç‰ˆï¼Œåˆ©ç”¨å‡½æ•°çš„æ˜ å°„å…³ç³»ï¼Œé«˜æ•ˆä¸å¦çš„å…³é”®åœ¨äºæ˜ å°„å‡½æ•°çš„ç¡®å®šã€‚å‡è®¾è¾“å…¥æ•°æ®æœä»å‡åŒ€åˆ†å¸ƒï¼Œå°†æ•°æ®åˆ†åˆ°æœ‰é™æ•°é‡çš„æ¡¶é‡Œï¼Œæ¯ä¸ªæ¡¶å†åˆ†åˆ«æ’åºï¼ˆæœ‰å¯èƒ½å†ä½¿ç”¨åˆ«çš„æ’åºç®—æ³•æˆ–æ˜¯ä»¥é€’å½’æ–¹å¼ç»§ç»­ä½¿ç”¨æ¡¶æ’åºè¿›è¡Œæ’ï¼‰ã€‚ 1ã€ç®—æ³•æ­¥éª¤ â€‹ 1ã€è®¾ç½®ä¸€ä¸ªå®šé‡çš„æ•°ç»„å½“åšç©ºæ¡¶ã€‚ â€‹ 2ã€éå†æ•°æ®ï¼Œå¹¶ä¸”æŠŠæ•°æ®ä¸€ä¸ªä¸ªæ”¾å…¥åˆ°å¯¹åº”çš„æ¡¶ä¸­ã€‚ â€‹ 3ã€å¯¹æ¯ä¸ªä¸æ˜¯ç©ºæ¡¶è¿›è¡Œæ’åºã€‚ â€‹ 4ã€ä»ä¸æ˜¯ç©ºæ¡¶é‡ŒæŠŠæ’å¥½åºçš„æ•°æ®æ‹¼æ¥èµ·æ¥ã€‚ 2ã€åŠ¨ç”»æ¼”ç¤º 3ã€æƒ…å†µ æœ€å¥½æƒ…å†µï¼šå½“è¾“å…¥çš„æ•°æ®å‡åŒ€åˆ†é…åˆ°æ¯ä¸ªæ¡¶ä¸­ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(n) ã€‚ æœ€åæƒ…å†µï¼šè¾“å…¥çš„æ•°æ®è¢«åˆ†é…åˆ°åŒä¸€ä¸ªæ¡¶ä¸­ï¼Œæ—¶é—´å¤æ‚åº¦O(n^2^) ã€‚ æ—¶é—´å¤æ‚åº¦å¹³å‡ä¸ºO(n+k) ï¼Œç©ºé—´å¤æ‚åº¦ä¸ºO(n+k)ï¼Œæ˜¯ç¨³å®šæ’åºç®—æ³•ã€‚ 4ã€Golangå®ç° func quickSort(nums []int, start, end int) []int { if start \u003c end { i, j := start, end key := nums[(start+end)/2] for i \u003c= j { for nums[i] \u003c key { i++ } for nums[j] \u003e key { j-- } if i \u003c= j { nums[i], nums[j] = nums[j], nums[i] i++ j-- } } if start \u003c j { nums = quickSort(nums, start, j) } if end \u003e i { nums = quickSort(nums, i, end) } } return nums } func bucketSort(nums []int, bucketNum int) []int { bucket := [][]int{} for i := 0; i \u003c bucketNum; i++ { tmp := make([]int, 1) bucket = append(bucket, tmp) } //å°†æ•°æ®åˆ†é…åˆ°æ¡¶ä¸­ for i := 0; i \u003c len(nums); i++ { bucket[nums[i]/bucketNum] = append(bucket[nums[i]/bucketNum], nums[i]) } //å¾ªç¯æ‰€æœ‰çš„æ¡¶è¿›è¡Œæ’åº index := 0 for i := 0; i \u003c bucketNum; i++ { if len(bucket[i]) \u003e 1 { //å¯¹æ¯ä¸ªæ¡¶å†…éƒ¨è¿›è¡Œæ’åº,ä½¿ç”¨å¿«æ’ bucket[i] = quickSort(bucket[i], 0, len(bucket[i])-1) for j := 1; j \u003c len(bucket[i]); j++ { //å»æ‰ä¸€å¼€å§‹çš„tmp nums[index] = bucket[i][j] index++ } } } return nums } ","date":"2021-02-07","objectID":"/2021/02/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95/:10:0","tags":["golang","ç®—æ³•"],"title":"åå¤§åŸºç¡€æ’åºç®—æ³•","uri":"/2021/02/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"åŸºæ•°æ’åº åŸºæ•°æ’åº(Radix Sort)çš„åŸç†æ˜¯æŒ‰ç…§æ•´æ•°ä½æ•°åˆ‡å‰²æˆä¸åŒçš„æ•°å­—ï¼Œç„¶åæŒ‰æ¯ä¸ªä½æ•°åˆ†åˆ«æ¯”è¾ƒã€‚ ç„¶åæˆ‘ä»¬å‘ç°ï¼Œè®¡æ•°æ’åºã€æ¡¶æ’åºã€åŸºæ•°æ’åºéƒ½ç”¨åˆ°äº†æ¡¶çš„æ¦‚å¿µã€‚ è®¡æ•°æ’åºï¼šæ¯ä¸ªæ¡¶åªå­˜å•ä¸€é”®å€¼ åŸºæ•°æ’åºï¼šæ ¹æ®é”®å€¼çš„æ¯ä½æ•°å­—æ¥åˆ†é…æ¡¶ æ¡¶æ’åºï¼šæ¯ä¸ªæ¡¶å­˜å‚¨ä¸€å®šèŒƒå›´çš„æ•°å€¼ 1ã€ç®—æ³•æ­¥éª¤ â€‹ 1ã€å–å¾—æ•°ç»„ä¸­çš„æœ€å¤§æ•°ï¼Œå¹¶å–å¾—ä½æ•° â€‹ 2ã€arrä¸ºåŸå§‹æ•°ç»„ï¼Œä»æœ€ä½ä½å¼€å§‹å–ä¸ªä½ç»„æˆradixæ•°ç»„ â€‹ 3ã€å¯¹radixè¿›è¡Œè®¡æ•°æ’åº 2ã€åŠ¨ç”»æ¼”ç¤º 3ã€æƒ…å†µ æ—¶é—´å¤æ‚åº¦ä¸ºO(n*k)ï¼Œç©ºé—´å¤æ‚åº¦ä¸ºO(n+k)ï¼Œæ˜¯ç¨³å®šæ’åºç®—æ³•ã€‚ 4ã€Golangå®ç° func RadixSort(arr[] int) []int{ if len(arr)\u003c2{ return arr } maxl:=MaxLen(arr) return RadixCore(arr,0,maxl) } func RadixCore(arr []int,digit,maxl int) []int{ if digit\u003e=maxl{ return arr } radix:=10 count:=make([]int,radix) bucket:=make([]int,len(arr)) for i:=0;i\u003clen(arr);i++{ count[GetDigit(arr[i],digit)]++ } for i:=1;i\u003cradix;i++{ count[i]+=count[i-1] } for i:=len(arr)-1;i\u003e=0;i--{ d:=GetDigit(arr[i],digit) bucket[count[d]-1]=arr[i] count[d]-- } return RadixCore(bucket,digit+1,maxl) } func GetDigit(x,d int) int{ a:=[]int{1,10,100,1000,10000,100000,1000000} return (x/a[d])%10 } func MaxLen(arr []int) int{ var maxl,curl int for i:=0;i\u003clen(arr);i++{ curl=len(strconv.Itoa(arr[i])) if curl\u003emaxl{ maxl=curl } } return maxl } ","date":"2021-02-07","objectID":"/2021/02/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95/:11:0","tags":["golang","ç®—æ³•"],"title":"åå¤§åŸºç¡€æ’åºç®—æ³•","uri":"/2021/02/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"ä½¿ç”¨Navicate 15è¿æ¥Oracleæ•°æ®åº“å‡ºç°å¦‚ä¸‹é”™è¯¯ é€šè¿‡æŸ¥è¯¢å¯çŸ¥æ˜¯oci.dllç‰ˆæœ¬å¤ªä½ï¼Œä½¿ç”¨çš„11.2ç‰ˆæœ¬ã€‚å› ä¸ºNavicateæ˜¯é€šè¿‡Oracleå®¢æˆ·ç«¯è¿æ¥OracleæœåŠ¡å™¨ï¼ŒOracleçš„å®¢æˆ·ç«¯åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯æ ‡å‡†ç‰ˆï¼Œä¸€ç§æ˜¯ç®€æ´ç‰ˆï¼Œå³Oracle Install Clientã€‚å‡ºç°ORA-28547é”™è¯¯æ—¶ï¼Œå¤šæ•°æ˜¯å› ä¸ºNavicatæœ¬åœ°çš„OCIç‰ˆæœ¬ä¸OracleæœåŠ¡å™¨æœåŠ¡å™¨ä¸ç¬¦é€ æˆçš„ã€‚ OCIä¸‹è½½åœ°å€ è¿™é‡Œçœ‹åˆ°è®¸å¤šæ–‡ç« æç¤ºä¸ç®¡ä½¿ç”¨çš„32ä½ç³»ç»Ÿè¿˜æ˜¯64ä½ç³»ç»Ÿéƒ½åº”ä¸‹è½½32ä¸ºçš„Install Client è¿™é‡Œæˆ‘å®é™…æ“ä½œäº†ä¸€ä¸‹ï¼Œ64ä½çš„ç³»ç»Ÿå¹¶ä¸æ”¯æŒ32ä½ï¼Œæ‰€ä»¥ä¸€å®šè¦æ ¹æ®è‡ªå·±çš„ç³»ç»Ÿç‰ˆæœ¬ä¸‹è½½ã€‚ æ‰“å¼€Navicateç¨‹åºï¼Œæ‰“å¼€ â€œå·¥å…·â€ -\u003e â€œé€‰é¡¹â€ -\u003e â€œç¯å¢ƒâ€ -\u003e â€œOCIç¯å¢ƒâ€ å°†åˆšæ‰ä¸‹è½½çš„oci.dllæ–‡ä»¶å®Œæ•´ç›®å½•å¡«ä¸Šï¼Œç¡®å®šåé‡å¯Navicateï¼Œå°±ä¼šå‘ç°å¯ä»¥æˆåŠŸè¿æ¥äº†ã€‚ ","date":"2021-01-18","objectID":"/2021/01/oracle_connect/:0:0","tags":["é—®é¢˜","oracle"],"title":"ä½¿ç”¨Navicateè¿æ¥Oracleå¤±è´¥ ORA-25847:connection to server failed,probable Orable Net admin error","uri":"/2021/01/oracle_connect/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"å¹¶æŸ¥é›† ç›®çš„: è§£å†³å…ƒç´ åˆ†ç»„é—®é¢˜ ç”¨é€”: 1ã€åˆ¤æ–­æœ‰å‘å›¾ä¸­æ˜¯å¦äº§ç”Ÿç¯ 2ã€ç»´æŠ¤æ— å‘å›¾çš„è¿é€šæ€§ï¼Œåˆ¤æ–­ä¸¤ä¸ªç‚¹æ˜¯å¦åœ¨åŒä¸€ä¸ªè¿é€šå—ä¸­ æ“ä½œ: 1ã€åˆå§‹åŒ–: æ¯ä¸ªé›†åˆçš„parentéƒ½æ˜¯è‡ªå·± 2ã€æŸ¥è¯¢: æŸ¥è¯¢é›†åˆçš„parent 3ã€åˆå¹¶: æŠŠä¸ç›¸è¿çš„å…ƒç´ åˆå¹¶åˆ°åŒä¸€ä¸ªé›†åˆä¸­ ","date":"2021-01-11","objectID":"/2021/01/%E5%B9%B6%E6%9F%A5%E9%9B%86/:0:1","tags":["golang","ç®—æ³•"],"title":"å¹¶æŸ¥é›†","uri":"/2021/01/%E5%B9%B6%E6%9F%A5%E9%9B%86/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"æ–¹æ³• 1ã€åˆå§‹åŒ– å‡å¦‚æœ‰ç¼–å·ä¸º1, 2, 3, â€¦, nçš„nä¸ªå…ƒç´ ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªæ•°ç»„fa[]æ¥å­˜å‚¨æ¯ä¸ªå…ƒç´ çš„çˆ¶èŠ‚ç‚¹ï¼ˆå› ä¸ºæ¯ä¸ªå…ƒç´ æœ‰ä¸”åªæœ‰ä¸€ä¸ªçˆ¶èŠ‚ç‚¹ï¼Œæ‰€ä»¥è¿™æ˜¯å¯è¡Œçš„ï¼‰ã€‚ ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬å…ˆå°†å®ƒä»¬çš„çˆ¶èŠ‚ç‚¹è®¾ä¸ºè‡ªå·±ã€‚ var fa = make([]int,n) for i := 0; i \u003c n; i++ { fa[i] = i } 2ã€æŸ¥è¯¢ æˆ‘ä»¬ç”¨é€’å½’çš„å†™æ³•å®ç°å¯¹ä»£è¡¨å…ƒç´ çš„æŸ¥è¯¢ï¼šä¸€å±‚ä¸€å±‚è®¿é—®çˆ¶èŠ‚ç‚¹ï¼Œç›´è‡³æ ¹èŠ‚ç‚¹ï¼ˆæ ¹èŠ‚ç‚¹çš„æ ‡å¿—å°±æ˜¯çˆ¶èŠ‚ç‚¹æ˜¯æœ¬èº«ï¼‰ã€‚ è¦åˆ¤æ–­ä¸¤ä¸ªå…ƒç´ æ˜¯å¦å±äºåŒä¸€ä¸ªé›†åˆï¼Œåªéœ€è¦çœ‹å®ƒä»¬çš„æ ¹èŠ‚ç‚¹æ˜¯å¦ç›¸åŒå³å¯ã€‚ find = func(x int) int { if x == fa[x] { return x } return find(fa[x]) } è·¯å¾„å‹ç¼©æ–¹æ³• find = func(x int) int { if x != fa[x] { fa[x] = find(fa[x]) } return fa[x] } 3ã€åˆå¹¶ åˆå¹¶æ“ä½œä¹Ÿæ˜¯å¾ˆç®€å•çš„ï¼Œå…ˆæ‰¾åˆ°ä¸¤ä¸ªé›†åˆçš„ä»£è¡¨å…ƒç´ ï¼Œç„¶åå°†å‰è€…çš„çˆ¶èŠ‚ç‚¹è®¾ä¸ºåè€…å³å¯ã€‚ merge := func(i,j int) { fa[find(i)] = find(j) } æŒ‰ç§©åˆå¹¶ merge := func(i,j int) { xFa,yFa := find(i),find(j) if xFa==yFa { return } // xå’Œyä¸åœ¨åŒä¸€ä¸ªé›†åˆä¸­ï¼Œåˆå¹¶å®ƒä»¬ if xFa\u003cyFa { fa[xFa]=yFa } else if xFa \u003e yFa { fa[yFa]=xFa } else { fa[yFa]=xFa rank[x]++ } } åŒæ—¶ä½¿ç”¨è·¯å¾„å‹ç¼©ã€æŒ‰ç§©ï¼ˆrankï¼‰åˆå¹¶ä¼˜åŒ–çš„ç¨‹åºæ¯ä¸ªæ“ä½œçš„å¹³å‡æ—¶é—´ä»…ä¸º O(alpha (n))ï¼Œ å…¶ä¸­ alpha (n) æ˜¯ { n=f(x)=A(x,x)} çš„åå‡½æ•°ï¼ŒA æ˜¯æ€¥é€Ÿå¢åŠ çš„é˜¿å…‹æ›¼å‡½æ•°ã€‚ å› ä¸º alpha (n) æ˜¯å…¶åå‡½æ•°ï¼Œæ•… alpha (n) åœ¨ n ååˆ†å·¨å¤§æ—¶è¿˜æ˜¯å°äº5ã€‚ å› æ­¤ï¼Œå¹³å‡è¿è¡Œæ—¶é—´æ˜¯ä¸€ä¸ªæå°çš„å¸¸æ•°ã€‚ å®é™…ä¸Šï¼Œè¿™æ˜¯æ¸è¿‘æœ€ä¼˜ç®—æ³•ï¼šFredman å’Œ Saks åœ¨ 1989 å¹´è§£é‡Šäº† Omega (alpha (n)) çš„å¹³å‡æ—¶é—´å†…å¯ä»¥è·å¾—ä»»ä½•å¹¶æŸ¥é›†ã€‚ ","date":"2021-01-11","objectID":"/2021/01/%E5%B9%B6%E6%9F%A5%E9%9B%86/:0:2","tags":["golang","ç®—æ³•"],"title":"å¹¶æŸ¥é›†","uri":"/2021/01/%E5%B9%B6%E6%9F%A5%E9%9B%86/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"ä¾‹é¢˜ Leetcode547 ç­ä¸Šæœ‰Â NÂ åå­¦ç”Ÿã€‚å…¶ä¸­æœ‰äº›äººæ˜¯æœ‹å‹ï¼Œæœ‰äº›åˆ™ä¸æ˜¯ã€‚ä»–ä»¬çš„å‹è°Šå…·æœ‰æ˜¯ä¼ é€’æ€§ã€‚å¦‚æœå·²çŸ¥ A æ˜¯ BÂ çš„æœ‹å‹ï¼ŒB æ˜¯ CÂ çš„æœ‹å‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è®¤ä¸º A ä¹Ÿæ˜¯ CÂ çš„æœ‹å‹ã€‚æ‰€è°“çš„æœ‹å‹åœˆï¼Œæ˜¯æŒ‡æ‰€æœ‰æœ‹å‹çš„é›†åˆã€‚ ç»™å®šä¸€ä¸ªÂ N * NÂ çš„çŸ©é˜µÂ Mï¼Œè¡¨ç¤ºç­çº§ä¸­å­¦ç”Ÿä¹‹é—´çš„æœ‹å‹å…³ç³»ã€‚å¦‚æœM[i][j] = 1ï¼Œè¡¨ç¤ºå·²çŸ¥ç¬¬ i ä¸ªå’Œ j ä¸ªå­¦ç”Ÿäº’ä¸ºæœ‹å‹å…³ç³»ï¼Œå¦åˆ™ä¸ºä¸çŸ¥é“ã€‚ä½ å¿…é¡»è¾“å‡ºæ‰€æœ‰å­¦ç”Ÿä¸­çš„å·²çŸ¥çš„æœ‹å‹åœˆæ€»æ•°ã€‚ ç¤ºä¾‹ 1: è¾“å…¥: [[1,1,0], [1,1,0], [0,0,1]] è¾“å‡º: 2 è¯´æ˜ï¼šå·²çŸ¥å­¦ç”Ÿ0å’Œå­¦ç”Ÿ1äº’ä¸ºæœ‹å‹ï¼Œä»–ä»¬åœ¨ä¸€ä¸ªæœ‹å‹åœˆã€‚ ç¬¬2ä¸ªå­¦ç”Ÿè‡ªå·±åœ¨ä¸€ä¸ªæœ‹å‹åœˆã€‚æ‰€ä»¥è¿”å›2ã€‚ ç¤ºä¾‹ 2: è¾“å…¥: [[1,1,0], [1,1,1], [0,1,1]] è¾“å‡º: 1 è¯´æ˜ï¼šå·²çŸ¥å­¦ç”Ÿ0å’Œå­¦ç”Ÿ1äº’ä¸ºæœ‹å‹ï¼Œå­¦ç”Ÿ1å’Œå­¦ç”Ÿ2äº’ä¸ºæœ‹å‹ï¼Œæ‰€ä»¥å­¦ç”Ÿ0å’Œå­¦ç”Ÿ2ä¹Ÿæ˜¯æœ‹å‹ï¼Œæ‰€ä»¥ä»–ä»¬ä¸‰ä¸ªåœ¨ä¸€ä¸ªæœ‹å‹åœˆï¼Œè¿”å›1ã€‚ æ³¨æ„ï¼š N åœ¨[1,200]çš„èŒƒå›´å†…ã€‚ å¯¹äºæ‰€æœ‰å­¦ç”Ÿï¼Œæœ‰M[i][i] = 1ã€‚ å¦‚æœæœ‰M[i][j] = 1ï¼Œåˆ™æœ‰M[j][i] = 1ã€‚ é¢˜è§£: func findCircleNum(isConnected [][]int) (ans int) { n := len(isConnected) parent := make([]int,n) for i := range parent { parent[i] = i } var find func(x int) int find = func(x int) int { if parent[x] != x { parent[x] = find(parent[x]) } return parent[x] } merge := func(from,to int) { parent[find(from)] = find(to) } for i := 0; i \u003c n; i++ { for j := i+1; j \u003c n; j++ { if isConnected[i][j] == 1 { merge(i,j) } } } for i, p := range parent { if i == p { ans++ } } return } ","date":"2021-01-11","objectID":"/2021/01/%E5%B9%B6%E6%9F%A5%E9%9B%86/:0:3","tags":["golang","ç®—æ³•"],"title":"å¹¶æŸ¥é›†","uri":"/2021/01/%E5%B9%B6%E6%9F%A5%E9%9B%86/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"RocketMQ æ¶ˆæ¯é˜Ÿåˆ—ä½œä¸ºé«˜å¹¶å‘ç³»ç»Ÿçš„ç»„ä»¶ä¹‹ä¸€ï¼Œèƒ½å¤Ÿå¸®åŠ©ä¸šåŠ¡ç³»ç»Ÿè§£æ„æé«˜å¼€å‘æ•ˆç‡å’Œç³»ç»Ÿç¨³å®šæ€§ã€‚ ä¼˜åŠ¿ï¼š å‰Šå³°å¡«è°·ï¼šè§£å†³ç¬æ—¶å†™å‹åŠ›å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±ã€ç³»ç»Ÿå´©æºƒç­‰é—®é¢˜ ç³»ç»Ÿè§£è€¦ï¼šå¤„ç†ä¸åŒé‡è¦ç¨‹åº¦å’Œä¸åŒèƒ½åŠ›çº§åˆ«ç³»ç»Ÿä¹‹é—´çš„æ¶ˆæ¯ æå‡æ€§èƒ½ï¼šå½“å­˜åœ¨ä¸€å¯¹å¤šè°ƒç”¨æ˜¯ï¼Œå¯ä»¥å‘ä¸€æ¡æ¶ˆæ¯ç»™æ¶ˆæ¯ç³»ç»Ÿï¼Œè®©æ¶ˆæ¯ç³»ç»Ÿé€šçŸ¥ç›¸å…³ç³»ç»Ÿ è“„æµå‹æµ‹ï¼šå¯ä»¥å †ç§¯ä¸€å®šçš„æ¶ˆæ¯é‡æ¥å‹æµ‹ ","date":"2021-01-07","objectID":"/2021/01/rocketmq/:1:0","tags":["docker","rocketmq"],"title":"dockerå®‰è£…éƒ¨ç½²Rocketmq","uri":"/2021/01/rocketmq/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"å®‰è£…RocketMQ å®˜æ–¹åœ°å€ # git clone https://github.com/apache/rocketmq-docker.git # cd rocketmq-docker/ # ls CONTRIBUTING.md image-build LICENSE NOTICE product README.md stage.sh templates # cd image-build/ # ls build-image.sh Dockerfile-alpine Dockerfile-centos scripts update.sh ","date":"2021-01-07","objectID":"/2021/01/rocketmq/:2:0","tags":["docker","rocketmq"],"title":"dockerå®‰è£…éƒ¨ç½²Rocketmq","uri":"/2021/01/rocketmq/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"åˆ›å»ºRocketMQé•œåƒ sh build-image.sh RMQ-VERSION BASE-IMAGE RMQ-VERSION BASE-IMAGEæ”¯æŒcentosï¼Œalpineä¸¤ç§æ–¹å¼ æˆ‘ä»¬ä½¿ç”¨ sh build-image.sh 4.7.1 alpine æ„å»ºæ—¶é—´æœ‰ç‚¹é•¿ï¼Œéœ€è¦è€å¿ƒç­‰å¾…ã€‚ å½“æ„å»ºå®Œæˆä¹‹åä¼šæç¤º Successfully built 128108c2e50d Successfully tagged apacherocketmq/rocketmq:4.7.1-alpine é‚£ä¹ˆæˆ‘ä»¬å°±èƒ½æŸ¥è¯¢åˆ°é•œåƒ # docker images |grep mq apacherocketmq/rocketmq 4.7.1-alpine 128108c2e50d 4 9 seconds ago 145MB ","date":"2021-01-07","objectID":"/2021/01/rocketmq/:2:1","tags":["docker","rocketmq"],"title":"dockerå®‰è£…éƒ¨ç½²Rocketmq","uri":"/2021/01/rocketmq/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"ç”Ÿæˆé…ç½® # cd .. # ls CONTRIBUTING.md image-build LICENSE NOTICE product README.md stage.sh templates # sh stage.sh 4.7.1 (è¿™é‡Œçš„4.7.1å¯¹åº”ä¹‹å‰çš„é•œåƒç‰ˆæœ¬) Stage version = 4.7.1 mkdir /root/rocketmq/rocketmq-docker/stages/4.7.1 staged templates into folder /root/rocketmq/rocketmq-docker/stages/4.7.1 # ls CONTRIBUTING.md image-build LICENSE NOTICE product README.md stages stage.sh templates ç”Ÿæˆäº†stagesç›®å½•ï¼Œé‡Œé¢å­˜æ”¾é…ç½®æ¨¡æ¿æ–‡ä»¶ # cd stages/ # ls 4.7.1 # cd 4.7.1/ # ls templates # cd templates/ # ls data kubernetes play-docker-compose.sh play-docker.sh play-kubernetes.sh ssl docker-compose play-consumer.sh play-docker-dledger.sh play-docker-tls.sh play-producer.sh 1ã€å•æœº ./play-docker.sh alpine 2ã€docker-compose ./play-docker-compose.sh 3ã€kubernetesé›†ç¾¤ ./play-kubernetes.sh 4ã€Cluster of Dledger storage(RocketMQéœ€è¦4.4.0ç‰ˆæœ¬ä»¥ä¸Š) ./play-docker-dledger.sh 5ã€TLS ./play-docker-tls.sh ./play-producer.sh ./play-consumer.sh æˆ‘è¿™é‡Œé€‰æ‹©çš„æ˜¯å•æœºéƒ¨ç½²ï¼Œå¯ä»¥çœ‹åˆ°ç”Ÿæˆäº†ä¸¤ä¸ªå®¹å™¨ # docker ps |grep mq 5b557ea1e6be apacherocketmq/rocketmq:4.7.1-alpine \"sh mqbroker\" 25 seconds ago Up 24 seconds 0.0.0.0:10909-\u003e10909/tcp, 9876/tcp, 0.0.0.0:10911-10912-\u003e10911-10912/tcp rmqbroker 8b1318aee5d6 apacherocketmq/rocketmq:4.7.1-alpine \"sh mqnamesrv\" 26 seconds ago Up 25 seconds 10909/tcp, 0.0.0.0:9876-\u003e9876/tcp, 10911-10912/tcp rmqnamesrv éªŒè¯RocketMQå¯åŠ¨æˆåŠŸ 1ã€ä½¿ç”¨å‘½ä»¤ docker ps|grep rmqbroker æ‰¾åˆ°RocketMQ brokerçš„å®¹å™¨id 2ã€ä½¿ç”¨å‘½ä»¤ docker exec -it 5b557ea1e6be ./mqadmin clusterList -n {nameserver_ip}:9876 éªŒè¯RocketMQ brokerå·¥ä½œæ­£å¸¸ # docker exec -it 5b557ea1e6be ./mqadmin clusterList -n {nameserver_ip}:9876 RocketMQLog:WARN No appenders could be found for logger (io.netty.util.internal.PlatformDependent0). RocketMQLog:WARN Please initialize the logger system properly. #Cluster Name #Broker Name #BID #Addr #Version #InTPS(LOAD) #OutTPS(LOAD) #PCWait(ms) #Hour #SPACE DefaultCluster 5b557ea1e6be 0 172.17.0.8:10911 V4_7_1 0.00(0,0ms) 0.00(0,0ms) 0 447225.46 -1.0000 ","date":"2021-01-07","objectID":"/2021/01/rocketmq/:2:2","tags":["docker","rocketmq"],"title":"dockerå®‰è£…éƒ¨ç½²Rocketmq","uri":"/2021/01/rocketmq/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"å‡çº§ cd image-build ./update.sh ","date":"2021-01-07","objectID":"/2021/01/rocketmq/:2:3","tags":["docker","rocketmq"],"title":"dockerå®‰è£…éƒ¨ç½²Rocketmq","uri":"/2021/01/rocketmq/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"å®‰è£…GUI # docker pull apacherocketmq/rocketmq-console:2.0.0 # docker run -e \"JAVA_OPTS=-Drocketmq.namesrv.addr=192.168.150.70:9876 -Dcom.rocketmq.sendMessageWithVIPChannel=false\" -p 6881:8080 -t apacherocketmq/rocketmq-console:2.0.0 ","date":"2021-01-07","objectID":"/2021/01/rocketmq/:3:0","tags":["docker","rocketmq"],"title":"dockerå®‰è£…éƒ¨ç½²Rocketmq","uri":"/2021/01/rocketmq/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"golang clientä½¿ç”¨é—®é¢˜ ç”±äºä½¿ç”¨çš„dockeræœåŠ¡å¯åŠ¨ï¼Œbrokerçš„åœ°å€æ˜¯å†…ç½‘åœ°å€ï¼Œéœ€è¦å°†åœ°å€ä¿®æ”¹ä¸ºå¤–ç½‘åœ°å€ # docker ps |grep mq 8abb966542a3 apacherocketmq/rocketmq-console:2.0.0 \"sh -c 'java $JAVA...\" 17 hours ago Up 17 hours 0.0.0.0:6881-\u003e8080/tcp dazzling_tesla 5b557ea1e6be apacherocketmq/rocketmq:4.7.1-alpine \"sh mqbroker\" 18 hours ago Up 18 hours 0.0.0.0:10909-\u003e10909/tcp, 9876/tcp, 0.0.0.0:10911-10912-\u003e10911-10912/tcp rmqbroker 8b1318aee5d6 apacherocketmq/rocketmq:4.7.1-alpine \"sh mqnamesrv\" 18 hours ago Up 18 hours 10909/tcp, 0.0.0.0:9876-\u003e9876/tcp, 10911-10912/tcp rmqnamesrv # docker exec -it 5b557ea1e6be bash // è¿›å…¥åˆ°å®¹å™¨å†…éƒ¨ä¿®æ”¹é…ç½® # vi ../confbroker.conf åœ¨æ–‡ä»¶ä¸­æ·»åŠ  brokerIP1=xxx.xxx.xxx.xxx ç„¶åé‡å¯broker, docker restart 5b557ea1e6be ==è¿™é‡Œéœ€è¦å»ä¿®æ”¹å¯åŠ¨è„šæœ¬ ./play-docker.sh é‡Œçš„start_namesrv_broker() å‡½æ•°ä¸­çš„dockerå¯åŠ¨å‘½ä»¤ï¼Œåœ¨mybrokeråé¢æ·»åŠ -c ../conf/broker.conf== # Start Broker docker run -d -v `pwd`/data/broker/logs:/home/rocketmq/logs -v `pwd`/data/broker/store:/home/rocketmq/store --name rmqbroker --link rmqnamesrv:namesrv -e \"NAMESRV_ADDR=namesrv:9876\" -p 10909:10909 -p 10911:10911 -p 10912:10912 apacherocketmq/rocketmq:4.7.1${TAG_SUFFIX} sh mqbroker -c ../conf/broker.conf è¿™æ ·æŸ¥çœ‹clusterä¼šå‘ç°Addresså˜æˆå¤–ç½‘åœ°å€ã€‚ ","date":"2021-01-07","objectID":"/2021/01/rocketmq/:3:1","tags":["docker","rocketmq"],"title":"dockerå®‰è£…éƒ¨ç½²Rocketmq","uri":"/2021/01/rocketmq/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"client-go Topic package main import ( \"context\" \"fmt\" \"github.com/apache/rocketmq-client-go/v2/admin\" \"github.com/apache/rocketmq-client-go/v2/primitive\" ) func main() { topic := \"Develop\" nameSrvAddr := []string{\"192.168.150.70:9876\"} brokerAddr := \"192.168.150.70:10911\" testAdmin, err := admin.NewAdmin(admin.WithResolver(primitive.NewPassthroughResolver(nameSrvAddr))) if err != nil { panic(err) } // åˆ›å»ºtopic err = testAdmin.CreateTopic( context.Background(), admin.WithTopicCreate(topic), admin.WithBrokerAddrCreate(brokerAddr)) if err != nil { fmt.Println(\"Create topic error:\", err) } // åˆ é™¤topic err = testAdmin.DeleteTopic( context.Background(), admin.WithTopicDelete(topic), //admin.WithBrokerAddrDelete(brokerAddr), //admin.WithNameSrvAddr(nameSrvAddr), ) err = testAdmin.Close() if err != nil { fmt.Println(\"Shutdown admin error:\", err) } } ","date":"2021-01-07","objectID":"/2021/01/rocketmq/:3:2","tags":["docker","rocketmq"],"title":"dockerå®‰è£…éƒ¨ç½²Rocketmq","uri":"/2021/01/rocketmq/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"client-go ç”Ÿäº§è€… package main import ( \"context\" \"fmt\" \"github.com/apache/rocketmq-client-go/v2\" \"github.com/apache/rocketmq-client-go/v2/primitive\" \"github.com/apache/rocketmq-client-go/v2/producer\" \"strconv\" ) func main() { addr,err := primitive.NewNamesrvAddr(\"192.168.150.70:9876\") if err != nil { panic(err) } topic := \"Develop\" p,err := rocketmq.NewProducer( producer.WithGroupName(\"my_service\"), producer.WithNameServer(addr), producer.WithCreateTopicKey(topic), producer.WithRetry(1)) if err != nil { panic(err) } err = p.Start() if err != nil { panic(err) } // å‘é€å¼‚æ­¥æ¶ˆæ¯ res,err := p.SendSync(context.Background(),primitive.NewMessage(topic,[]byte(\"send sync message\"))) if err != nil { fmt.Printf(\"send sync message error:%s\\n\",err) } else { fmt.Printf(\"send sync message success. result=%s\\n\",res.String()) } // å‘é€æ¶ˆæ¯åå›è°ƒ err = p.SendAsync(context.Background(), func(ctx context.Context, result *primitive.SendResult, err error) { if err != nil { fmt.Printf(\"receive message error:%v\\n\",err) } else { fmt.Printf(\"send message success. result=%s\\n\",result.String()) } },primitive.NewMessage(topic,[]byte(\"send async message\"))) if err != nil { fmt.Printf(\"send async message error:%s\\n\",err) } // æ‰¹é‡å‘é€æ¶ˆæ¯ var msgs []*primitive.Message for i := 0; i \u003c 5; i++ { msgs = append(msgs, primitive.NewMessage(topic,[]byte(\"batch send message. num:\"+strconv.Itoa(i)))) } res,err = p.SendSync(context.Background(),msgs...) if err != nil { fmt.Printf(\"batch send sync message error:%s\\n\",err) } else { fmt.Printf(\"batch send sync message success. result=%s\\n\",res.String()) } // å‘é€å»¶è¿Ÿæ¶ˆæ¯ msg := primitive.NewMessage(topic,[]byte(\"delay send message\")) msg.WithDelayTimeLevel(3) res,err = p.SendSync(context.Background(),msg) if err != nil { fmt.Printf(\"delay send sync message error:%s\\n\",err) } else { fmt.Printf(\"delay send sync message success. result=%s\\n\",res.String()) } // å‘é€å¸¦æœ‰tagçš„æ¶ˆæ¯ msg1 := primitive.NewMessage(topic,[]byte(\"send tag message\")) msg1.WithTag(\"tagA\") res,err = p.SendSync(context.Background(),msg1) if err != nil { fmt.Printf(\"send tag sync message error:%s\\n\",err) } else { fmt.Printf(\"send tag sync message success. result=%s\\n\",res.String()) } err = p.Shutdown() if err != nil { panic(err) } } ","date":"2021-01-07","objectID":"/2021/01/rocketmq/:3:3","tags":["docker","rocketmq"],"title":"dockerå®‰è£…éƒ¨ç½²Rocketmq","uri":"/2021/01/rocketmq/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"client-go æ¶ˆè´¹è€… // åœ¨v2.1.0-rc5.0ä¸æ”¯æŒï¼Œä¼šåœ¨ä¸‹ä¸€ä¸ªç‰ˆæœ¬ä¸­æ”¯æŒ func PullConsumer() { topic := \"Develop\" // æ¶ˆè´¹è€…ä¸»åŠ¨æ‹‰å–æ¶ˆæ¯ // not c1,err := rocketmq.NewPullConsumer( consumer.WithGroupName(\"my_service\"), consumer.WithNsResolver(primitive.NewPassthroughResolver([]string{\"192.168.150.70:9876\"}))) if err != nil { panic(err) } err = c1.Start() if err != nil { fmt.Println(err) os.Exit(-1) } queue := primitive.MessageQueue{ Topic: topic, BrokerName: \"broker-a\", // ä½¿ç”¨brokerçš„åç§° QueueId: 0, } err = c1.Shutdown() if err != nil { fmt.Println(\"Shutdown Pull Consumer error: \",err) } offset := int64(0) for { resp,err := c1.PullFrom(context.Background(),queue,offset,10) if err != nil { if err == rocketmq.ErrRequestTimeout { fmt.Printf(\"timeout\\n\") time.Sleep(time.Second) continue } fmt.Printf(\"unexpected error: %v\\n\",err) return } if resp.Status == primitive.PullFound { fmt.Printf(\"pull message success. nextOffset: %d\\n\",resp.NextBeginOffset) for _, ext := range resp.GetMessageExts() { fmt.Printf(\"pull msg: %s\\n\",ext) } } offset = resp.NextBeginOffset } } func PushConsumer() { topic := \"Develop\" // æ¶ˆæ¯ä¸»åŠ¨æ¨é€ç»™æ¶ˆè´¹è€… c2,err := rocketmq.NewPushConsumer( consumer.WithGroupName(\"my_service\"), consumer.WithNsResolver(primitive.NewPassthroughResolver([]string{\"192.168.150.70:9876\"})), consumer.WithConsumeFromWhere(consumer.ConsumeFromFirstOffset), // é€‰æ‹©æ¶ˆè´¹æ—¶é—´(é¦–æ¬¡/å½“å‰/æ ¹æ®æ—¶é—´) consumer.WithConsumerModel(consumer.BroadCasting)) // æ¶ˆè´¹æ¨¡å¼(é›†ç¾¤æ¶ˆè´¹:æ¶ˆè´¹å®Œå…¶ä»–äººä¸èƒ½å†è¯»å–/å¹¿æ’­æ¶ˆè´¹ï¼šæ‰€æœ‰äººéƒ½èƒ½è¯») if err != nil { panic(err) } err = c2.Subscribe( topic,consumer.MessageSelector{ Type: consumer.TAG, Expression: \"*\", // å¯ä»¥ TagA || TagB }, func(ctx context.Context, msgs ...*primitive.MessageExt) (consumer.ConsumeResult, error) { orderlyCtx,_ := primitive.GetOrderlyCtx(ctx) fmt.Printf(\"orderly context: %v\\n\",orderlyCtx) for i := range msgs { fmt.Printf(\"Subscribe callback: %v\\n\",msgs[i]) } return consumer.ConsumeSuccess,nil }) if err != nil { fmt.Printf(\"Subscribe error:%s\\n\",err) } err = c2.Start() if err != nil { fmt.Println(err) os.Exit(-1) } time.Sleep(time.Minute) err = c2.Shutdown() if err != nil { fmt.Println(\"Shutdown Consumer error: \",err) } } ","date":"2021-01-07","objectID":"/2021/01/rocketmq/:3:4","tags":["docker","rocketmq"],"title":"dockerå®‰è£…éƒ¨ç½²Rocketmq","uri":"/2021/01/rocketmq/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"ä¸€ ","date":"2020-12-15","objectID":"/2020/12/%E6%99%BA%E5%8A%9B%E9%A2%98/:1:0","tags":["æ™ºåŠ›"],"title":"6é“æœ‰è¶£çš„æ™ºåŠ›é¢˜","uri":"/2020/12/%E6%99%BA%E5%8A%9B%E9%A2%98/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"æœ‰20ç“¶è¯ä¸¸ï¼Œå…¶ä¸­19ç“¶è£…æœ‰1å…‹/ç²’çš„è¯ä¸¸ï¼Œä½™ä¸‹ä¸€ç“¶è£…æœ‰1.1å…‹/ç²’çš„è¯ä¸¸ã€‚ç»™ä½ ä¸€å°ç§°é‡ç²¾å‡†çš„å¤©å¹³ï¼Œæ€ä¹ˆæ‰¾å‡ºè¾ƒé‡çš„é‚£ç“¶è¯ä¸¸ï¼Ÿå¤©å¹³åªèƒ½ä½¿ç”¨ä¸€æ¬¡ã€‚ åˆæ¬¡çœ‹åˆ°è¿™é¢˜ï¼Œå¦‚æœä¸é™åˆ¶æ¬¡æ•°ï¼Œé‚£ä¹ˆå¯ä»¥äºŒåˆ†æ³•ï¼Œå¤©å¹³ä¸¤è¾¹10ä¸ªæ¯”è¾ƒï¼Œç›´åˆ°æ‰¾åˆ°è¾ƒé‡çš„ä¸ºæ­¢ã€‚ ä½†æ˜¯ï¼Œç°åœ¨é™åˆ¶åªèƒ½ä½¿ç”¨ä¸€æ¬¡å¤©å¹³ã€‚ æ€ä¹ˆåŠå‘¢ï¼Ÿ å‡è®¾åªæœ‰ä¸¤ç“¶è¯ä¸¸ï¼Œä¸€ç“¶è¾ƒé‡ï¼Œä»ä¸¤ç“¶ä¸­å„å–ä¸€ç²’ï¼Œç§°é‡ä¸º2.1å…‹ï¼Œæˆ‘ä»¬æ— æ³•å¾—çŸ¥æ˜¯ä»å“ªä¸€ç“¶å¤šå‡ºçš„0.1å…‹ã€‚ æˆ‘ä»¬éœ€è¦å°†å› å­ä¸å¹³è¡¡ï¼Œå¦‚æœä»1å·è¯ç“¶å–å‡º1ç²’ï¼Œä»2å·è¯ç“¶å–å‡º2ç²’ï¼Œå¦‚æœç®—å‡ºé‡é‡æ˜¯3.1å…‹ï¼Œé‚£ä¹ˆ1å·ç“¶è¾ƒé‡ï¼Œå¦‚æœç®—å‡ºé‡é‡ä¸º3.2å…‹ï¼Œé‚£ä¹ˆ2å·ç“¶è¾ƒé‡ã€‚ æˆ‘ä»¬å°†è¿™ä¸ªç»“è®ºæ¨å¹¿ä¸€ä¸‹ï¼Œä»1å·è¯ç“¶å–å‡º1ç²’ï¼Œä»2å·è¯ç“¶å–å‡º2ç²’ï¼Œä»¥æ­¤ç±»æ¨ï¼Œå¦‚æœæ¯ç²’è¯ä¸¸å‡é‡1å…‹ï¼Œé‚£ä¹ˆå¾—åˆ°æ€»é‡é‡ä¸ºï¼ˆ1+2+3+â€¦+20=21*20/2=210ï¼‰, å› æ­¤ï¼Œå¦‚æœç§°é‡ä¸º210.9å…‹ï¼Œé‚£ä¹ˆè¾ƒé‡çš„é‚£ç“¶æ¥è‡ªäº9å·ç“¶ã€‚ ","date":"2020-12-15","objectID":"/2020/12/%E6%99%BA%E5%8A%9B%E9%A2%98/:2:0","tags":["æ™ºåŠ›"],"title":"6é“æœ‰è¶£çš„æ™ºåŠ›é¢˜","uri":"/2020/12/%E6%99%BA%E5%8A%9B%E9%A2%98/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"äºŒ ","date":"2020-12-15","objectID":"/2020/12/%E6%99%BA%E5%8A%9B%E9%A2%98/:3:0","tags":["æ™ºåŠ›"],"title":"6é“æœ‰è¶£çš„æ™ºåŠ›é¢˜","uri":"/2020/12/%E6%99%BA%E5%8A%9B%E9%A2%98/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"æœ‰ä¸ª8*8çš„æ£‹ç›˜ï¼Œå…¶ä¸­å¯¹è§’çš„è§’è½æœ‰ä¸¤ä¸ªæ–¹å—è¢«åˆ‡æ‰äº†ã€‚ç»™å®š31å—å¤šç±³è¯ºéª¨ç‰Œï¼Œä¸€å—éª¨ç‰Œæ°å¥½å¯ä»¥è¦†ç›–ä¸¤ä¸ªæ ¼å­ã€‚ç”¨31å—éª¨ç‰Œèƒ½å¦ç›–ä½æ•´ä¸ªæ£‹ç›˜å‘¢ï¼Ÿ ä¹ä¸€çœ‹ï¼Œæ£‹ç›˜88=64ï¼Œå¤šç±³è¯º312=62ï¼Œåˆšå¥½èƒ½ç›–ä½ã€‚ã€‚å…¶å®æ˜¯é”™è§‰ å‡è®¾æ£‹ç›˜æœ‰32ä¸ªé»‘æ ¼å’Œ32ä¸ªç™½æ ¼äº¤å‰æ’åˆ—ï¼Œåˆ‡æ‰å¯¹è§’çš„æ–¹æ ¼æ˜¯åŒç§é¢œè‰²çš„ï¼Œæ­¤æ—¶åªå‰©30ä¸ªé»‘æ ¼å’Œ32ä¸ªç™½æ ¼ï¼ˆæˆ–32ä¸ªé»‘æ ¼å’Œ30ä¸ªç™½æ ¼ï¼‰ï¼Œ è€Œä¸€å—å¤šç±³è¯ºéª¨ç‰Œå¿…é¡»è¦è¦†ç›–ä¸€ä¸ªç™½æ ¼å’Œä¸€ä¸ªé»‘æ ¼ï¼Œ31å—å¤šç±³è¯ºéª¨ç‰Œè¦è¦†ç›–31ä¸ªç™½æ ¼å’Œ31ä¸ªé»‘æ ¼ã€‚ ","date":"2020-12-15","objectID":"/2020/12/%E6%99%BA%E5%8A%9B%E9%A2%98/:4:0","tags":["æ™ºåŠ›"],"title":"6é“æœ‰è¶£çš„æ™ºåŠ›é¢˜","uri":"/2020/12/%E6%99%BA%E5%8A%9B%E9%A2%98/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"ä¸‰ ","date":"2020-12-15","objectID":"/2020/12/%E6%99%BA%E5%8A%9B%E9%A2%98/:5:0","tags":["æ™ºåŠ›"],"title":"6é“æœ‰è¶£çš„æ™ºåŠ›é¢˜","uri":"/2020/12/%E6%99%BA%E5%8A%9B%E9%A2%98/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"æœ‰ä¸¤ä¸ªæ°´å£¶ï¼Œå®¹é‡ä¸º5å‡å’Œ3å‡ï¼Œè‹¥æ°´é‡ä¸é™é‡ï¼Œæ€ä¹ˆç”¨è¿™ä¸¤ä¸ªæ°´å£¶å¾—åˆ°4å‡çš„æ°´ï¼Ÿæ³¨ï¼šæ°´å£¶ä¸è§„åˆ™å½¢çŠ¶ï¼Œæ— æ³•ç²¾ç¡®è£…æ»¡åŠå£¶æ°´ã€‚ 5å‡ 3å‡ æ³¨é‡Š 5 0 è£…æ»¡5å‡çš„å£¶ 2 3 ç”¨5å‡çš„å£¶è£…æ»¡3å‡çš„å£¶ 0 2 å°†5å‡å£¶ä¸­çš„2å‡æ°´å€’å…¥3å‡å£¶ä¸­ 5 2 è£…æ»¡5å‡å£¶ 4 3 ç”¨5å‡å£¶è£…æ»¡3å‡å£¶ 5å‡ 3å‡ æ³¨é‡Š 0 3 è£…æ»¡3å‡å£¶ 3 3 å°†3å‡å£¶å€’å…¥5å‡å£¶ä¸­ï¼ŒåŒæ—¶è£…æ»¡3å‡å£¶ 5 1 å°†3å‡å£¶å€’å…¥5å‡å£¶ä¸­ 1 0 å°†3å‡å£¶ä¸­çš„1å‡æ°´å€’å…¥5å‡å£¶ä¸­ 1 3 è£…æ»¡3å‡å£¶ 4 0 å°†3å‡å£¶å€’å…¥5å‡å£¶ä¸­ ","date":"2020-12-15","objectID":"/2020/12/%E6%99%BA%E5%8A%9B%E9%A2%98/:6:0","tags":["æ™ºåŠ›"],"title":"6é“æœ‰è¶£çš„æ™ºåŠ›é¢˜","uri":"/2020/12/%E6%99%BA%E5%8A%9B%E9%A2%98/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"å›› ","date":"2020-12-15","objectID":"/2020/12/%E6%99%BA%E5%8A%9B%E9%A2%98/:7:0","tags":["æ™ºåŠ›"],"title":"6é“æœ‰è¶£çš„æ™ºåŠ›é¢˜","uri":"/2020/12/%E6%99%BA%E5%8A%9B%E9%A2%98/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"åœ¨å²›ä¸Šä½ç€ä¸€ç¾¤äººï¼Œæœ‰ä¸€å¤©æ¥äº†ä¸€ä¸ªæ¸¸å®¢ï¼Œå®šäº†å¥‡æ€ªçš„è§„çŸ©ï¼šæ‰€æœ‰çš„è“çœ¼ç›å¿…é¡»å°½å¿«ç¦»å¼€å²›ã€‚ æ¯ä¸ªäººéƒ½èƒ½çœ‹åˆ°åˆ«äººçœ¼ç›çš„é¢œè‰²ï¼Œä½†ä¸çŸ¥é“è‡ªå·±çœ¼ç›çš„é¢œè‰²ï¼ˆåˆ«äººä¸èƒ½å‘ŠçŸ¥ï¼‰ï¼Œ æ­¤å¤–ä»–ä»¬ä¸çŸ¥é“æœ‰å¤šå°‘ä¸ªè“çœ¼ç›ï¼ŒåªçŸ¥é“è‡³å°‘æœ‰ä¸€ä¸ªè“çœ¼ç›ï¼Œæ¯ä¸ªäººéƒ½æ˜¯èªæ˜çš„ï¼Œé‚£ä¹ˆè“çœ¼ç›è¦èŠ±å‡ å¤©æ‰èƒ½ç¦»å¼€è¿™ä¸ªå²›å‘¢ï¼Ÿ å‡è®¾æœ‰cä¸ªè“çœ¼ç›ï¼Œä¸”c\u003e0 1ã€c=1ï¼šåªæœ‰ä¸€ä¸ªè“çœ¼ç› è“çœ¼ç›çš„äººè§‚å¯Ÿä¹‹åå‘ç°æ²¡æœ‰è“çœ¼ç›ï¼Œé‚£ä¹ˆä¸€å®šèƒ½æ¨å¯¼å‡ºè‡ªå·±æ˜¯è“çœ¼ç›ï¼Œå› æ­¤ä»–ä¼šå½“å¤©ç¦»å¼€ 2ã€c=2ï¼šä¸¤ä¸ªè“çœ¼ç› ä¸¤ä¸ªè“çœ¼ç›çœ‹åˆ°å¯¹æ–¹ï¼Œä¸ç¡®å®šc=1æˆ–2ï¼Œä½†æ˜¯ç”±äºä¸Šç§æƒ…å†µï¼Œä»–ä»¬çŸ¥é“c=1æ—¶ï¼Œè“çœ¼ç›å½“å¤©ä¼šç¦»å¼€ï¼Œå¦‚æœç¬¬äºŒå¤©å‘ç°å¯¹æ–¹æ²¡æœ‰ç¦»å¼€ï¼Œé‚£ä¹ˆä¸€å®šèƒ½æ¨å¯¼å‡ºè‡ªå·±ä¹Ÿæ˜¯è“çœ¼ç›ï¼Œäºæ˜¯ï¼Œä¸¤ä¸ªè“çœ¼ç›ä¼šåœ¨ç¬¬äºŒå¤©ç¦»å¼€ 3ã€c\u003e2 å¦‚æœc=3ï¼Œè¿™ä¸‰ä¸ªäººä¼šæ„è¯†åˆ°æœ‰2-3ä¸ªäººæ˜¯è“çœ¼ç›ï¼Œå¦‚æœ2äººè“çœ¼ç›ï¼Œä¼šåœ¨ç¬¬äºŒå¤©å…¨éƒ¨ç¦»å¼€ï¼Œå› æ­¤ï¼Œå¦‚æœç¬¬äºŒå¤©å¦å¤–ä¸¤ä¸ªäººéƒ½åœ¨å²›ä¸Šï¼Œæ¯ä¸ªäººéƒ½èƒ½æ¨å¯¼å‡ºè‡ªå·±æ˜¯è“çœ¼ç›ï¼Œäºæ˜¯ä¼šåœ¨ç¬¬ä¸‰å¤©ç¦»å¼€ã€‚ å½“é€æ­¥æé«˜cæ—¶ï¼Œå‘ç°è¿™ä¸ªé€»è¾‘æ˜¯é€‚ç”¨çš„ã€‚ å¦‚æœæœ‰cäººè“çœ¼ç›ï¼Œåˆ™æ‰€æœ‰çš„è“çœ¼ç›è¦ç”¨cå¤©ç¦»å¼€è¿™ä¸ªå²› ","date":"2020-12-15","objectID":"/2020/12/%E6%99%BA%E5%8A%9B%E9%A2%98/:8:0","tags":["æ™ºåŠ›"],"title":"6é“æœ‰è¶£çš„æ™ºåŠ›é¢˜","uri":"/2020/12/%E6%99%BA%E5%8A%9B%E9%A2%98/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"äº” ","date":"2020-12-15","objectID":"/2020/12/%E6%99%BA%E5%8A%9B%E9%A2%98/:9:0","tags":["æ™ºåŠ›"],"title":"6é“æœ‰è¶£çš„æ™ºåŠ›é¢˜","uri":"/2020/12/%E6%99%BA%E5%8A%9B%E9%A2%98/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"æœ‰ä¸ªå»ºç­‘é«˜100ç±³ã€‚è‹¥ä»ç¬¬Nå±‚æˆ–æ›´é«˜çš„æ¥¼å±‚æ‰”é¸¡è›‹ï¼Œé¸¡è›‹ä¼šç ´ï¼Œè‹¥ä»Nå±‚ä»¥ä¸‹çš„æ¥¼å±‚æ‰”ä¸‹æ¥ä¸ä¼šç ´ã€‚ æ°å¥½ä½ æœ‰ä¸¤ä¸ªé¸¡è›‹ï¼Œæ±‚å‡ºNï¼Œå¹¶è¦æ±‚æœ€å·®æƒ…å†µä¸‹æ‰”é¸¡è›‹æ¬¡æ•°æœ€å°‘ã€‚ æˆ‘ä»¬å‘ç°ï¼Œæ— è®ºæˆ‘ä»¬æ€ä¹ˆæ‰”é¸¡è›‹ï¼Œç¬¬äºŒä¸ªé¸¡è›‹éƒ½å¿…é¡»åœ¨ç ´æ‰çš„é‚£ä¸€å±‚å’Œæ²¡æœ‰ç ´æ‰çš„é‚£ä¸€å±‚é€å±‚ç´¯åŠ ã€‚ ä¾‹å¦‚ï¼Œé¸¡è›‹1åœ¨5å±‚æ²¡ç ´ï¼Œ10å±‚æ²¡ç ´ï¼Œ15å±‚ç ´äº†ï¼Œé‚£ä¹ˆé¸¡è›‹2å¿…é¡»ä»11,12,13,14å°è¯• å…·ä½“åšæ³• å‡è®¾æ­¥é•¿ä¸º10 é¸¡è›‹1ä»10å±‚æ‰”ä¸‹ï¼Œå¦‚æœç ´æ‰äº†ï¼Œæœ€å¤šéœ€è¦æ‰”10æ¬¡ é¸¡è›‹1ä»100å±‚æ‰”ä¸‹æ‰ç ´æ‰ï¼Œæœ€å¤šéœ€è¦æ‰”19æ¬¡ã€‚ é‚£ä¹ˆæˆ‘ä»¬çš„ç›®çš„å°±æ˜¯æ±‚è¿™ä¸ªæ­¥é•¿ï¼Œä½¿å¾—æœ€å¥½æƒ…å†µå’Œæœ€å·®æƒ…å†µç±»ä¼¼ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œé¸¡è›‹1æ¯æ‰”ä¸€æ¬¡ï¼Œå°±è¦å‡å°‘é¸¡è›‹2æ‰”çš„æ¬¡æ•°ã€‚ ä¾‹å¦‚ï¼Œé¸¡è›‹1ä»20å±‚æ‰”ï¼Œç„¶åä»30å±‚æ‰”ï¼Œé¸¡è›‹2å¯èƒ½è¦æ‰”9æ¬¡ï¼Œ è‹¥é¸¡è›‹1å†æ‰”ä¸€æ¬¡ï¼Œæˆ‘ä»¬è¦è®©é¸¡è›‹2æ‰”çš„æ¬¡æ•°å‡å°‘ï¼Œä¹Ÿå°±æ˜¯è¯´é¸¡è›‹1è¦ä»39å±‚å¼€å§‹æ‰”ã€‚ å› æ­¤ x + ï¼ˆx-1ï¼‰ + ï¼ˆx-2ï¼‰ +â€¦ + 1 = x(x+1)/2=100 -\u003e x=14 ","date":"2020-12-15","objectID":"/2020/12/%E6%99%BA%E5%8A%9B%E9%A2%98/:10:0","tags":["æ™ºåŠ›"],"title":"6é“æœ‰è¶£çš„æ™ºåŠ›é¢˜","uri":"/2020/12/%E6%99%BA%E5%8A%9B%E9%A2%98/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"å…­ ","date":"2020-12-15","objectID":"/2020/12/%E6%99%BA%E5%8A%9B%E9%A2%98/:11:0","tags":["æ™ºåŠ›"],"title":"6é“æœ‰è¶£çš„æ™ºåŠ›é¢˜","uri":"/2020/12/%E6%99%BA%E5%8A%9B%E9%A2%98/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"èµ°å»Šä¸Šæœ‰100ä¸ªå…³ä¸Šçš„å‚¨ç‰©æŸœã€‚ ç¬¬ä¸€è½®ï¼Œå°†100æŸœå­å…¨éƒ¨æ‰“å¼€ï¼› ç¬¬äºŒè½®ï¼Œæ¯æ•°ä¸¤ä¸ªæŸœå­å…³ä¸Šä¸€ä¸ªï¼› ç¬¬ä¸‰è½®ï¼Œæ¯éš”ä¸¤ä¸ªæŸœå­åˆ‡æ¢æŸœå­çŠ¶æ€ï¼ˆå°±æ˜¯å°†å…³ä¸Šçš„æŸœå­æ‰“å¼€ï¼Œæ‰“å¼€çš„æŸœå­å…³ä¸Šï¼‰ï¼› ç…§æ­¤è§„å¾‹ï¼Œé‡å¤100æ¬¡ï¼Œå½“ç»“æŸæ—¶ï¼Œæœ‰å¤šå°‘ä¸ªæŸœå­æ˜¯æ‰“å¼€çš„ï¼Ÿ æŸœå­nä¼šåœ¨æ¯éš”å› å­å¯¹åº”çš„é‚£ä¸€è½®åˆ‡æ¢çŠ¶æ€ï¼Œä¾‹å¦‚15çš„å› å­æœ‰1,3,5,15,å› å­ä¸ªæ•°ä¸ºå¶æ•°ï¼Œæ‰€ä»¥æŸœå­15æ˜¯å…³ç€çš„ é‚£ä¹ˆä»€ä¹ˆæ ·çš„æ•´æ•°å› å­çš„ä¸ªæ•°æ˜¯å¥‡æ•°ï¼Ÿ æˆ‘ä»¬å¯ä»¥å°†å› å­é…å¯¹ï¼Œ15çš„å› å­æœ‰(1,15),(3,5)ã€‚ é‚£ä¹ˆ36çš„å› å­æœ‰(1,36),(2,18),(3,12),(4,9),(6,6),æ³¨æ„(6,6)å…¶å®æ˜¯ä¸€ä¸ªå› å­,36æœ‰å¥‡æ•°ä¸ªå› å­ ç»“è®º:å¦‚æœæ˜¯å®Œå…¨å¹³æ–¹æ•°ä¼šæœ‰å¥‡æ•°ä¸ªå› å­ï¼Œ100ä»¥å†…çš„å®Œå…¨å¹³æ–¹æ•°æœ‰ 1,4,9,16,25,36,49,64,81,100.å…±10ä¸ª ","date":"2020-12-15","objectID":"/2020/12/%E6%99%BA%E5%8A%9B%E9%A2%98/:12:0","tags":["æ™ºåŠ›"],"title":"6é“æœ‰è¶£çš„æ™ºåŠ›é¢˜","uri":"/2020/12/%E6%99%BA%E5%8A%9B%E9%A2%98/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"å®‰è£…ææ–™ raspberry pi 4b 4G *1 128G ä¸‰æ˜ŸTFå¡ *1 microæ¥å£è½¬HDMIè½¬æ¥çº¿ *1 ç”µæºé€‚é…å™¨ 5V 3A *1 ","date":"2020-11-27","objectID":"/2020/11/install_os/:1:0","tags":["raspberry"],"title":"æ ‘è“æ´¾å®‰è£…ubuntuç³»ç»Ÿ","uri":"/2020/11/install_os/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"å®‰è£…ç³»ç»Ÿ ","date":"2020-11-27","objectID":"/2020/11/install_os/:2:0","tags":["raspberry"],"title":"æ ‘è“æ´¾å®‰è£…ubuntuç³»ç»Ÿ","uri":"/2020/11/install_os/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"1ã€ä¸‹è½½ åœ¨windowsä¸Šä¸‹è½½ raspberry pi imager ç”¨æ¥å®‰è£…ç³»ç»Ÿ ç”±äºæˆ‘ä»¬å·²ç»åœ¨ å·²ç»ä¸‹è½½å¥½äº† OSï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥çƒ§å½•ç³»ç»Ÿã€‚ ","date":"2020-11-27","objectID":"/2020/11/install_os/:2:1","tags":["raspberry"],"title":"æ ‘è“æ´¾å®‰è£…ubuntuç³»ç»Ÿ","uri":"/2020/11/install_os/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"2ã€è¿›å…¥ç³»ç»Ÿ è¾“å…¥è´¦å·å¯†ç ï¼Œé»˜è®¤ubuntuï¼šubuntuï¼Œéœ€è¦é‡æ–°è®¾ç½®å¯†ç ã€‚ æ­¤æ—¶éœ€è¦è¿æ¥ç½‘çº¿ã€æ˜¾ç¤ºå™¨ã€é”®ç›˜ã€‚ æ›´æ–°è½¯ä»¶æºï¼Œç”±äºæ ‘è“æ´¾ï¼Œä½¿ç”¨ubuntu-portsï¼Œç„¶åæ›´æ–° # cp /etc/apt/sources.list /etc/apt/sources.list.bak # ç„¶åæ›¿æ¢è½¯ä»¶æº # apt update å®‰è£…è½¯ä»¶ # apt install net-tools wireless-tools wpasupplicant udhcpc æŸ¥çœ‹ç½‘å¡ # iwconfig lo no wireless extensions. eth0 no wireless extensions. wlan0 no wireless extensions. å¯åŠ¨ç½‘å¡ # ifconfig wlan0 up # ifconfig æ­¤æ—¶å°±èƒ½çœ‹åˆ°ç½‘å¡ä¿¡æ¯äº†ã€‚ é…ç½®wifiä¿¡æ¯ # vi wpa_supplicant.conf country=GB ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev update_config=1 # wpa_passphrase wifiåç§° wifiå¯†ç  \u003e\u003e wpa_supplicant.conf æ­¤æ—¶å†å¯åŠ¨wpa_cliåå°wpa_supplicant # wpa_supplicant -iwlan0 -c wpa_supplicant.conf -B æŸ¥çœ‹wifiè¿æ¥çŠ¶æ€ # wpa_cli -iwlan0 status æ‰«æå¯ç”¨wifi # wpa_cli -i wlan0 scan æŸ¥çœ‹æ‰«æç»“æœ # wpa_cli -i wlan0 scan_results æ–°å¢wifiç¼–ç  # wpa_cli -iwlan0 add_network é…ç½®wifiåç§° # wpa_cli -iwlan0 set network ç¼–ç  ssid \"wifiåç§°\" é…ç½®wifiå¯†ç  # wpa_cli -iwlan0 set network ç¼–ç  psk \"wifiå¯†ç \" æŸ¥çœ‹wifiåˆ—è¡¨ # wpa_cli -iwlan0 list_network é€‰æ‹©wifi # wpa_cli -iwlan0 select_network ä½¿ç”¨wifi # wpa_cli -iwlan0 enable_network æ–­å¼€wifi # wpa_cli -iwlan0 disconnect é‡è¿wifi # wpa_cli -iwlan0 reconnect åœæ­¢ä½¿ç”¨wifi # wpa_cli -iwlan0 disable_network ç¼–ç  ä¿å­˜wifi # wpa_cli -iwlan0 save_config æ­¤æ—¶wifiå·²ç»è¿æ¥æˆåŠŸï¼Œä½†æ˜¯è¿˜æ²¡æœ‰åˆ†é…ipåœ°å€ udhcpc -iwlan0 -q æ­¤æ—¶æˆåŠŸè¿æ¥wifiã€‚ ","date":"2020-11-27","objectID":"/2020/11/install_os/:2:2","tags":["raspberry"],"title":"æ ‘è“æ´¾å®‰è£…ubuntuç³»ç»Ÿ","uri":"/2020/11/install_os/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"æ·»åŠ DNS # vi /etc/resolv.conf nameserver 114.114.114.114 ","date":"2020-11-27","objectID":"/2020/11/install_os/:2:3","tags":["raspberry"],"title":"æ ‘è“æ´¾å®‰è£…ubuntuç³»ç»Ÿ","uri":"/2020/11/install_os/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"ä¸‹è½½å®‰è£…docker dockerå®˜ç½‘ 1ã€å¸è½½æ—§ç‰ˆæœ¬ # apt-get remove docker docker-engine docker.io containerd runc 2ã€æ·»åŠ repository # apt-get update # apt-get install \\ apt-transport-https \\ ca-certificates \\ curl \\ gnupg-agent \\ software-properties-common # curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - # apt-key fingerprint 0EBFCD88 # add-apt-repository \\ \"deb [arch=armhf] https://download.docker.com/linux/ubuntu \\ $(lsb_release -cs) \\ stable\" 3ã€å®‰è£…docker # apt-get update # apt-get install docker-ce docker-ce-cli containerd.io ç¬¬ä¸‰æ­¥ä¸€ç›´æç¤º Unable to locate package docker-ce-cli é‚£å°±åªèƒ½ä½¿ç”¨è„šæœ¬çš„æ–¹å¼å®‰è£… # curl -sSL https://get.docker.com | sh # docker version Client: Version: 18.01.0-ce API version: 1.35 Go version: go1.9.2 Git commit: 03596f5 Built: Wed Jan 10 20:05:35 2018 OS/Arch: linux/arm64 Experimental: false Orchestrator: swarm Server: Engine: Version: 18.01.0-ce API version: 1.35 (minimum version 1.12) Go version: go1.9.2 Git commit: 03596f5 Built: Wed Jan 10 20:03:37 2018 OS/Arch: linux/arm64 Experimental: false æ‰§è¡Œhello-world # docker run hello-world Unable to find image 'hello-world:latest' locally latest: Pulling from library/hello-world 256ab8fe8778: Already exists Digest: sha256:e7c70bb24b462baa86c102610182e3efcb12a04854e8c582838d92970a09f323 Status: Downloaded newer image for hello-world:latest Hello from Docker! This message shows that your installation appears to be working correctly. To generate this message, Docker took the following steps: 1. The Docker client contacted the Docker daemon. 2. The Docker daemon pulled the \"hello-world\" image from the Docker Hub. (arm64v8) 3. The Docker daemon created a new container from that image which runs the executable that produces the output you are currently reading. 4. The Docker daemon streamed that output to the Docker client, which sent it to your terminal. To try something more ambitious, you can run an Ubuntu container with: $ docker run -it ubuntu bash Share images, automate workflows, and more with a free Docker ID: https://hub.docker.com/ For more examples and ideas, visit: https://docs.docker.com/get-started/ æ·»åŠ é•œåƒæº # cat /etc/docker/daemon.json { \"registry-mirrors\": [\"https://c2Zra3lhZDYK.mirror.aliyuncs.com\"] } # systemctl daemon-reload # systemctl restart docker ","date":"2020-11-27","objectID":"/2020/11/install_os/:3:0","tags":["raspberry"],"title":"æ ‘è“æ´¾å®‰è£…ubuntuç³»ç»Ÿ","uri":"/2020/11/install_os/"},{"categories":["æœˆéœœå¤©çš„å°ç¬”è®°"],"content":"ç®€ä»‹ å…ˆæ¥çœ‹ä¸€ä¸‹ json.Unmarshal çš„æ³¨é‡Š å¤§æ„æ˜¯ json è§£æçš„æ—¶å€™ä¼šè°ƒç”¨ Unmarshaler çš„æ¥å£ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è‡ªå®šä¹‰è§£ææ•°æ®äº†ã€‚ å…ˆçœ‹ä¸€ä¸ªä¾‹å­ package main import ( \"encoding/json\" \"fmt\" \"time\" ) const textJson = `{\"name\":\"xiaoming\",\"duration\":\"5s\"}` func main() { var o Object json.Unmarshal([]byte(textJson),\u0026o) fmt.Printf(\"%+v\\n\",o) } type Object struct { Name string Time time.Duration } func (o *Object) UnmarshalJSON(data []byte) error { tmp := struct { Name string `json:\"name\"` Duration string `json:\"duration\"` }{} err := json.Unmarshal(data,\u0026tmp) if err != nil { return err } dur,err := time.ParseDuration(tmp.Duration) if err != nil { return err } o.Name = tmp.Name o.Time = dur return nil } ä½ å¯èƒ½è§‰å¾—æ‰“å°çš„æ•°æ®å’ŒtextJsonæ²¡ä»€ä¹ˆåŒºåˆ«ã€‚ ä½†æ˜¯å®é™…ä¸Šæ‰“å°çš„o.Timeæ˜¯ä¸ªæ—¶é—´ç±»å‹çš„æ•°æ®äº†ï¼Œä»stringè½¬åˆ°time.Durationç±»å‹ï¼Œè¿™ä¸ªå¯ä»¥å¾ˆè½»æ¾çš„è½¬æ¢ã€‚ ä½†æ˜¯è¿™é‡Œè¿˜ä¼šæœ‰ä¸€ä¸ªå‘ï¼Œæ¥çœ‹å¦ä¸€ä¸ªä¾‹å­ package main import ( \"encoding/json\" \"fmt\" \"time\" ) var testJSON = `{\"num\":5,\"duration\":\"5s\"}` type Nested struct { Dur time.Duration `json:\"duration\"` } func (n *Nested) UnmarshalJSON(data []byte) error { *n = Nested{} tmp := struct { Dur string `json:\"duration\"` }{} fmt.Printf(\"parsing nested json %s \\n\", string(data)) if err := json.Unmarshal(data, \u0026tmp); err != nil { fmt.Printf(\"failed to parse nested: %v\", err) return err } tmpDur, err := time.ParseDuration(tmp.Dur) if err != nil { fmt.Printf(\"failed to parse duration: %v\", err) return err } (*n).Dur = tmpDur return nil } type Object struct { Nested Num int `json:\"num\"` } //uncommenting this method still doesnt help. //tmp is parsed with the completed json at Nested //which doesnt take care of Num field, so Num is zero value. func (o *Object) UnmarshalJSON(data []byte) error { *o = Object{} tmp := struct { Nested Num int `json:\"num\"` }{} fmt.Printf(\"parsing object json %s \\n\", string(data)) if err := json.Unmarshal(data, \u0026tmp); err != nil { fmt.Printf(\"failed to parse object: %v\", err) return err } fmt.Printf(\"tmp object: %+v \\n\", tmp) (*o).Num = tmp.Num (*o).Nested = tmp.Nested return nil } func main() { obj := Object{} if err := json.Unmarshal([]byte(testJSON), \u0026obj); err != nil { fmt.Printf(\"failed to parse result: %v\", err) return } fmt.Printf(\"result: %+v \\n\", obj) } æœ€ç»ˆè¾“å‡ºçš„ç»“æœæ˜¯ parsing object json {\"num\":5,\"duration\":\"5s\"} parsing nested json {\"num\":5,\"duration\":\"5s\"} tmp object: {Nested:{Dur:5s} Num:0} result: {Nested:{Dur:5s} Num:0} è¿™é‡Œä½ å¯èƒ½è¦ç–‘é—®äº†ï¼Œä¸ºä»€ä¹ˆæ•°æ®ä¸¢å¤±äº†ï¼Œnumä»5å˜æˆäº†0ï¼Ÿ é‚£ä¹ˆä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Ÿ ç”¨ä¸€ä¸ªç®€å•çš„ä¾‹å­è¯´æ˜ä¸€ä¸‹ package main import \"fmt\" type Funer interface{ Name()string PrintName() } type A struct { } func (a *A) Name() string { return \"a\" } func (a *A) PrintName() { fmt.Println(a.Name()) } type B struct { A } func (b *B) Name() string { return \"b\" } func getBer() Funer { return \u0026B{} } func main() { b := getBer() b.PrintName() } è¿™æ˜¯ä¸€ä¸ªç±»ä¼¼ç»§æ‰¿çš„å®ç°ï¼Œå®ƒæœ€ç»ˆä¼šæ‰“å° a ã€‚ è¿™æ˜¯å› ä¸ºgolangæ²¡æœ‰ç»§æ‰¿æ–¹æ³•ï¼Œå®ƒåªä¼šè°ƒç”¨è‡ªå·±çš„æŒ‡é’ˆçš„æ•°æ®ï¼Œå¦‚æœæ˜¯C/C++ï¼Œå®ƒä¼šå®ç°å¤šæ€ï¼Œæ‰“å° b ã€‚ è¿™æ ·å°±ä¼šå¯¼è‡´ json æ•°æ®çš„æ¥å£è°ƒç”¨æ˜¯ä»å¤–éƒ¨åˆ°å†…éƒ¨çš„æ¥å£è°ƒç”¨ï¼Œè°çš„æŒ‡é’ˆæ–¹æ³•å°±å®ç°è°çš„æŒ‡é’ˆæ–¹æ³•ã€‚ é‚£ä¹ˆä¸Šé¢é‚£ç§æƒ…å†µè¯æ˜è§£å†³å‘¢ï¼Ÿ package main import ( \"encoding/json\" \"fmt\" \"time\" ) var testJSON = `{\"num\":5,\"duration\":\"5s\"}` type Nested struct { Dur time.Duration `json:\"duration\"` } func (obj *Object) UnmarshalJSON(data []byte) error { tmp := struct { Dur string `json:\"duration\"` Num int `json:\"num\"` }{} if err := json.Unmarshal(data, \u0026tmp); err != nil { return err } dur, err := time.ParseDuration(tmp.Dur) if err != nil { return err } obj.Dur = dur obj.Num = tmp.Num return nil } type Object struct { Nested Num int `json:\"num\"` } var _ json.Unmarshaler = (*Object)(nil) func main() { obj := Object{} _ = json.Unmarshal([]byte(testJSON), \u0026obj) fmt.Printf(\"result: %+v \\n\", obj) } åœ¨å†…éƒ¨ä¸ä½¿ç”¨ç»§æ‰¿ï¼Œé€šè¿‡çš„ç»“æ„æ¥è§£ææ•°æ®å°±å¯ä»¥äº†ã€‚ ","date":"2020-11-25","objectID":"/2020/11/json_unmarshal/:1:0","tags":["json","golang"],"title":"å¦‚ä½•è‡ªå®šä¹‰è®©jsonè§£æå‡ºè‡ªå®šä¹‰å€¼","uri":"/2020/11/json_unmarshal/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"å‰è¨€ åœ¨å¼€å§‹ç›‘æ§ä½ çš„æœåŠ¡ä¹‹å‰ï¼Œä½ éœ€è¦é€šè¿‡æ·»åŠ prometheuså®¢æˆ·ç«¯æ¥æ·»åŠ ç›‘æ§ã€‚ å¯ä»¥æ‰¾ ç¬¬ä¸‰æ–¹exporter ç›‘æ§ä½ çš„æœåŠ¡ï¼Œä¹Ÿå¯ä»¥è‡ªå·±ç¼–å†™exporterã€‚ ç›®å‰å·²ç»æœ‰å¾ˆå¤šä¸åŒçš„è¯­è¨€ç¼–å†™çš„å®¢æˆ·ç«¯åº“ï¼ŒåŒ…æ‹¬å®˜æ–¹æä¾›çš„Goï¼ŒJavaï¼ŒPythonï¼ŒRubyã€‚ å·²æœ‰å®¢æˆ·ç«¯åº“ åœ¨äº†è§£ç¼–å†™exporterä¹‹å‰ï¼Œå¯ä»¥å…ˆ5åˆ†é’Ÿå­¦ä¼šæ­å»ºprometheus ","date":"2020-11-20","objectID":"/2020/11/exporter/:1:0","tags":["prometheus"],"title":"Golang exporterçš„ä½¿ç”¨æ–¹æ³•","uri":"/2020/11/exporter/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"ç®€å•çš„exporteræœåŠ¡ å…ˆå†™ä¸€ä¸ªç®€å•çš„httpæœåŠ¡ï¼Œåœ¨9095ç«¯å£å¯åŠ¨äº†ä¸€ä¸ªèƒ½å¤Ÿä¸ºprometheusæä¾›ç›‘æ§æŒ‡æ ‡çš„HTTPæœåŠ¡ã€‚ä½ å¯ä»¥åœ¨ http://localhost:9095/metrics çœ‹åˆ°è¿™äº›æŒ‡æ ‡ã€‚ package main import ( \"github.com/prometheus/client_golang/prometheus/promhttp\" \"net/http\" ) func main() { http.HandleFunc(\"/\", func(w http.ResponseWriter, r *http.Request) { w.Write([]byte(\"hello world\")) }) http.Handle(\"/metrics\",promhttp.Handler()) http.ListenAndServe(\":9095\",nil) } è™½ç„¶å¶å°”ä¼šæ‰‹åŠ¨è®¿é—®/metricsé¡µé¢æŸ¥çœ‹æŒ‡æ ‡æ•°æ®ï¼Œä½†æ˜¯å°†æŒ‡æ ‡æ•°æ®å¯¼å…¥prometheusæ‰æ–¹ä¾¿ã€‚ global:scrape_interval:15s# é»˜è®¤æŠ“å–é—´éš”ï¼Œ15så‘ç›®æ ‡æŠ“å–ä¸€æ¬¡æ•°æ®external_labels:monitor:'prometheus-monitor'# æŠ“å–å¯¹è±¡scrape_configs:- job_name:'exporter'# åç§°ï¼Œä¼šåœ¨æ¯ä¸€æ¡metricsæ·»åŠ æ ‡ç­¾{job_name:\"prometheus\"}scrape_interval:5s# æŠ“å–æ—¶é—´static_configs:# æŠ“å–å¯¹è±¡- targets:['localhost:9095'] é‚£ä¹ˆåœ¨ http://localhost:9090/ æµè§ˆå™¨è¾“å…¥ PromQL è¡¨è¾¾å¼ go_info,å°±ä¼šçœ‹åˆ°å¦‚å›¾çš„ç»“æœ ","date":"2020-11-20","objectID":"/2020/11/exporter/:2:0","tags":["prometheus"],"title":"Golang exporterçš„ä½¿ç”¨æ–¹æ³•","uri":"/2020/11/exporter/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"ç›‘æ§æŒ‡æ ‡ ","date":"2020-11-20","objectID":"/2020/11/exporter/:3:0","tags":["prometheus"],"title":"Golang exporterçš„ä½¿ç”¨æ–¹æ³•","uri":"/2020/11/exporter/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"Counter(è®¡æ•°å™¨ç±»å‹) Counterè®°å½•çš„æ˜¯äº‹ä»¶çš„æ•°é‡æˆ–å¤§å°ï¼Œåªå¢ä¸å‡ï¼Œé™¤éå‘ç”Ÿé‡ç½®ã€‚ Counterä¸»è¦æœ‰ä¸¤ä¸ªæ–¹æ³• # å°†counteråŠ 1 Inc() # å¢åŠ æŒ‡å®šå€¼ï¼Œå¦‚æœ\u003c0ä¼španic Add(float64) package main import ( \"github.com/prometheus/client_golang/prometheus\" \"github.com/prometheus/client_golang/prometheus/promauto\" \"github.com/prometheus/client_golang/prometheus/promhttp\" \"net/http\" \"time\" ) var ( failures = prometheus.NewCounterVec(prometheus.CounterOpts{ Name: \"hq_failture_total\", Help: \"failure counts\", },[]string{\"device\"}) // å¯ä»¥ä½¿ç”¨promautoè‡ªåŠ¨æ³¨å†Œ success = promauto.NewCounterVec(prometheus.CounterOpts{ Name: \"hq_failture_total\", Help: \"failure counts\", },[]string{\"device\"}) ) func init() { prometheus.MustRegister(failures) } func main() { go func() { failures.WithLabelValues(\"/dev/sda\").Add(3.2) time.Sleep(time.Second) failures.WithLabelValues(\"/dev/sda\").Inc() time.Sleep(time.Second) failures.WithLabelValues(\"/dev/sdb\").Inc() time.Sleep(time.Second) failures.WithLabelValues(\"/dev/sdb\").Add(1.5) }() http.HandleFunc(\"/\", func(w http.ResponseWriter, r *http.Request) { w.Write([]byte(\"hello world\")) }) http.Handle(\"/metrics\",promhttp.Handler()) http.ListenAndServe(\":9095\",nil) } ","date":"2020-11-20","objectID":"/2020/11/exporter/:3:1","tags":["prometheus"],"title":"Golang exporterçš„ä½¿ç”¨æ–¹æ³•","uri":"/2020/11/exporter/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"Gauge(ä»ªè¡¨ç›˜ç±»å‹) Gaugeæ˜¯å¯å¢å¯å‡çš„æŒ‡æ ‡ç±»ï¼Œæ›´å…³æ³¨äºæ•°å€¼æœ¬èº«ã€‚ Gaugeä¸»è¦æœ‰å‡ ç§æ–¹æ³• # è®¾ç½®ä»»æ„å€¼ Set(float64) # åŠ 1 Inc() # å‡1 Dec() # åŠ ä»»æ„æ•°ï¼Œå¦‚æœæ˜¯è´Ÿæ•°ï¼Œé‚£ä¹ˆå°±ä¼šå‡å» Add(float64) # å’Œå½“å‰å€¼çš„å·®å€¼ Sub(float64) # è®¾ç½®å€¼ä¸ºå½“å‰æ—¶é—´æˆ³ SetToCurrentTime() package main import ( \"github.com/prometheus/client_golang/prometheus\" \"github.com/prometheus/client_golang/prometheus/promhttp\" \"net/http\" \"time\" ) var ( failures = prometheus.NewGaugeVec(prometheus.GaugeOpts{ Name: \"hq_failture_total\", Help: \"failure counts\", },[]string{\"device\"}) ) func init() { prometheus.MustRegister(failures) } func main() { go func() { failures.WithLabelValues(\"/dev/sda\").Add(5) failures.WithLabelValues(\"/dev/sdb\").Set(10) time.Sleep(time.Second * 5) failures.WithLabelValues(\"/dev/sda\").Inc() failures.WithLabelValues(\"/dev/sdb\").Add(3) time.Sleep(time.Second * 5) failures.WithLabelValues(\"/dev/sda\").Dec() failures.WithLabelValues(\"/dev/sdb\").SetToCurrentTime() time.Sleep(time.Second* 5) failures.WithLabelValues(\"/dev/sda\").Sub(1) failures.WithLabelValues(\"/dev/sdb\").Dec() time.Sleep(time.Second* 5) time.Sleep(time.Second) }() http.HandleFunc(\"/\", func(w http.ResponseWriter, r *http.Request) { w.Write([]byte(\"hello world\")) }) http.Handle(\"/metrics\",promhttp.Handler()) http.ListenAndServe(\":9095\",nil) } ","date":"2020-11-20","objectID":"/2020/11/exporter/:3:2","tags":["prometheus"],"title":"Golang exporterçš„ä½¿ç”¨æ–¹æ³•","uri":"/2020/11/exporter/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"Summary(æ‘˜è¦ç±»å‹) è¡¨ç¤ºä¸€æ®µæ—¶é—´æ•°æ®é‡‡æ ·ç»“æœï¼Œç”±_count,_sumæ„æˆ Summaryåªæœ‰ä¸€ç§æ–¹æ³• Observe(float64) ä½ å¯ä»¥è®¿é—® /metrics å¯ä»¥çœ‹åˆ°hq_failture_total_sumå’Œhq_failture_total_count hq_failture_total_sumä»£è¡¨è§‚å¯Ÿå€¼çš„æ€»å’Œ hq_failture_total_countä»£è¡¨è§‚å¯Ÿåˆ°çš„æ¡æ•° package main import ( \"github.com/prometheus/client_golang/prometheus\" \"github.com/prometheus/client_golang/prometheus/promhttp\" \"net/http\" \"time\" ) var ( failures = prometheus.NewSummaryVec(prometheus.SummaryOpts{ Name: \"hq_failture_total\", Help: \"failure counts\", },[]string{\"device\"}) ) func init() { prometheus.MustRegister(failures) } func main() { var count float64 go func() { t := time.NewTicker(time.Second) for { count++ failures.WithLabelValues(\"/dev/sdc\").Observe(count) \u003c-t.C } }() http.HandleFunc(\"/\", func(w http.ResponseWriter, r *http.Request) { w.Write([]byte(\"hello world\")) }) http.Handle(\"/metrics\",promhttp.Handler()) http.ListenAndServe(\":9095\",nil) } ","date":"2020-11-20","objectID":"/2020/11/exporter/:3:3","tags":["prometheus"],"title":"Golang exporterçš„ä½¿ç”¨æ–¹æ³•","uri":"/2020/11/exporter/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"Histogram(ç›´æ–¹å›¾ç±»å‹) summaryå¯ä»¥æä¾›å¹³å‡å»¶è¿Ÿæ•°æ®ï¼Œä½†æ˜¯å¦‚æœä½ æƒ³è¦åˆ†ä½æ•°å‘¢ï¼Ÿ é‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨Histogramåˆ†ä½æ•°. Histogramåªæœ‰ä¸€ç§æ–¹æ³• Observe(float64) ä½ å¯ä»¥è®¿é—® /metrics å¯ä»¥çœ‹åˆ°hq_failture_total_sumå’Œhq_failture_total_countã€hq_failture_total_bucket package main import ( \"github.com/prometheus/client_golang/prometheus\" \"github.com/prometheus/client_golang/prometheus/promhttp\" \"math/rand\" \"net/http\" \"time\" ) var ( failures = prometheus.NewHistogramVec(prometheus.HistogramOpts{ Name: \"hq_failture_total\", Help: \"failure counts\", },[]string{\"device\"}) ) func init() { prometheus.MustRegister(failures) } func main() { go func() { t := time.NewTicker(time.Second) for { failures.WithLabelValues(\"/dev/sdc\").Observe(rand.Float64()) \u003c-t.C } }() http.HandleFunc(\"/\", func(w http.ResponseWriter, r *http.Request) { w.Write([]byte(\"hello world\")) }) http.Handle(\"/metrics\",promhttp.Handler()) http.ListenAndServe(\":9095\",nil) } é‚£ä¹ˆä»€ä¹ˆæ˜¯bucket(æ¡¶)ï¼Ÿæ¡¶è®°å½•å°äºç›‘æ§æŒ‡æ ‡çš„æ•°é‡ é»˜è®¤çš„bucketsèŒƒå›´ä¸º{0.005ï¼Œ0.01ï¼Œ0.025ï¼Œ0.05ï¼Œ0.075ï¼Œ0.1ï¼Œ0.25ï¼Œ0.5ï¼Œ0.75ï¼Œ1ï¼Œ2.5ï¼Œ5ï¼Œ7.5ï¼Œ10} PromQLå‡½æ•°histogram_quantileå¯ä»¥ç”¨æ¥ç»Ÿè®¡æ¡¶ä¸­çš„åˆ†ä½æ•°ã€‚ä¾‹å¦‚ï¼Œ0.95åˆ†ä½æ•°çš„è¡¨è¾¾å¼ä¸º histogram_quantile(0.95,rate(hq_failture_total_bucket[1m])) ","date":"2020-11-20","objectID":"/2020/11/exporter/:3:4","tags":["prometheus"],"title":"Golang exporterçš„ä½¿ç”¨æ–¹æ³•","uri":"/2020/11/exporter/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"å¦‚ä½•ç»™æŒ‡æ ‡å‘½åï¼Ÿ Prometheus æŒ‡æ ‡éœ€è¦ä»¥å­—æ¯å¼€å¤´ï¼Œåé¢å¯ä»¥è·Ÿç€ä»»æ„æ•°é‡çš„å­—æ¯ï¼Œæ•°å­—ï¼Œä¸‹åˆ’çº¿ã€‚ å‘½åçš„æ•´ä½“ç»“æ„æ˜¯ library_name_unit_suffix è™½ç„¶ [a-zA-Z_:][a-zA-Z0-9_:]* æ˜¯Prometheusä¸­æœ‰æ•ˆçš„å‘½åè§„åˆ™çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œä½†ä½ è¦é¿å…æ˜¯æœ‰æŸäº›æœ‰æ•ˆå€¼ã€‚ ä½ ä¸åº”è¯¥åœ¨æµ‹æ§æŒ‡æ ‡ä½¿ç”¨å†’å·ï¼Œå› ä¸ºå®ƒæ˜¯ä¸ºè®°å½•è§„åˆ™ä¸­ä½¿ç”¨è€Œä¿ç•™çš„ã€‚ä»¥ä¸‹åˆ’çº¿å¼€å¤´çš„åç§°æ˜¯ä¸ºprometheuså†…éƒ¨ä½¿ç”¨è€Œä¿ç•™çš„ã€‚ _total,_count,_sumå’Œ_bucketè¿™äº›åç¼€æ˜¯ç•™ç»™counterï¼Œsummaryå’ŒhistogramæŒ‡æ ‡ä½¿ç”¨çš„ã€‚ é™¤äº†åœ¨counterç±»å‹çš„æŒ‡æ ‡ä¸Šå§‹ç»ˆå…·æœ‰_totalåç¼€å¤–ï¼Œä¸è¦å°†å…¶ä»–åç¼€æ”¾åœ¨æŒ‡æ ‡åç§°çš„æœ«å°¾ã€‚ ","date":"2020-11-20","objectID":"/2020/11/exporter/:4:0","tags":["prometheus"],"title":"Golang exporterçš„ä½¿ç”¨æ–¹æ³•","uri":"/2020/11/exporter/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"ç®€ä»‹ prometheusæ˜¯ä¸€ä¸ªå¼€æºçš„ç³»ç»Ÿç›‘æ§å’Œè­¦æŠ¥å·¥å…·åŒ…ï¼Œæœ€åˆç”±SoundCloudå¼€å‘ã€‚è‡ª2012å¹´å§‹ï¼Œè®¸å¤šå…¬å¸å’Œç»„ç»‡å·²ç»é‡‡ç”¨äº†prometheusï¼Œè¯¥é¡¹ç›®æ‹¥æœ‰æ´»è·ƒçš„å¼€å‘äººå‘˜å’Œç”¨æˆ·ç¤¾åŒºã€‚ å®ƒç°åœ¨æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¼€æºé¡¹ç›®ï¼Œç‹¬ç«‹äºä»»ä½•å…¬å¸è¿›è¡Œç»´æŠ¤ã€‚ç€é‡äºæ­¤ï¼Œprometheusåœ¨2016å¹´åŠ å…¥CNCFï¼Œæ˜¯ç»§kubernetesä¹‹åç¬¬äºŒä¸ªæ‰˜ç®¡çš„é¡¹ç›®ã€‚ å®˜ç½‘åœ°å€ï¼š Prometheus githubåœ°å€ï¼š github æ¶æ„å›¾ ","date":"2020-11-19","objectID":"/2020/11/prometheus/:1:0","tags":["prometheus"],"title":"5åˆ†é’Ÿå­¦ä¼šæ­å»ºPrometheus","uri":"/2020/11/prometheus/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"ä¸‹è½½ä¸å®‰è£… å®‰è£…æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œå¦‚æœä½ æ˜¯windowsç”¨æˆ·ï¼Œé‚£ä¹ˆåªéœ€è¦åœ¨æœ¬åœ°èµ·ä¸ªäºŒè¿›åˆ¶æœåŠ¡å°±å¯ä»¥ã€‚å¦‚æœä½ æ˜¯linuxç”¨æˆ·ï¼Œå¯ä»¥é€šè¿‡dockerç­‰æ›´åŠ çµæ´»æ–¹å¼éƒ¨ç½²ã€‚ ","date":"2020-11-19","objectID":"/2020/11/prometheus/:2:0","tags":["prometheus"],"title":"5åˆ†é’Ÿå­¦ä¼šæ­å»ºPrometheus","uri":"/2020/11/prometheus/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"äºŒè¿›åˆ¶ äºŒè¿›åˆ¶ä¸‹è½½åœ°å€ tar xvfz prometheus-*.tar.gz cd prometheus-* ./prometheus --config.file=prometheus.yml å½“ç„¶ä½ å¯ä»¥ä¸‹è½½æœ€æ–°çš„æºç è¿›è¡Œç¼–è¯‘è·å–æœ€æ–°çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ mkdir -p $GOPATH/src/github.com/prometheus cd $GOPATH/src/github.com/prometheus git clone https://github.com/prometheus/prometheus.git cd prometheus make build ./prometheus -config.file=your_config.yml ","date":"2020-11-19","objectID":"/2020/11/prometheus/:2:1","tags":["prometheus"],"title":"5åˆ†é’Ÿå­¦ä¼šæ­å»ºPrometheus","uri":"/2020/11/prometheus/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"docker # ä½¿ç”¨ /opt/prometheus/prometheus.yml çš„é…ç½® docker run --name prometheus -d -p 127.0.0.1:9090:9090 -v /opt/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus ","date":"2020-11-19","objectID":"/2020/11/prometheus/:2:2","tags":["prometheus"],"title":"5åˆ†é’Ÿå­¦ä¼šæ­å»ºPrometheus","uri":"/2020/11/prometheus/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"helm helm repo add prometheus-community https://prometheus-community.github.io/helm-charts helm repo add stable https://charts.helm.sh/stable helm repo update # Helm 3 $ helm install [RELEASE_NAME] prometheus-community/prometheus # Helm 2 $ helm install --name [RELEASE_NAME] prometheus-community/prometheus ","date":"2020-11-19","objectID":"/2020/11/prometheus/:2:3","tags":["prometheus"],"title":"5åˆ†é’Ÿå­¦ä¼šæ­å»ºPrometheus","uri":"/2020/11/prometheus/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"é…ç½®æ–‡ä»¶ prometheuså·²ç»èƒ½å¤Ÿèµ·æ¥äº†ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦å¯¹æœåŠ¡åšä¸€äº›ä¸ªæ€§åŒ–çš„é…ç½®ï¼Œè®©prometheusèƒ½å¤Ÿè·å–åˆ°æ•°æ®ã€‚ global:scrape_interval:15s# é»˜è®¤æŠ“å–é—´éš”ï¼Œ15så‘ç›®æ ‡æŠ“å–ä¸€æ¬¡æ•°æ®external_labels:monitor:'prometheus-monitor'# æŠ“å–å¯¹è±¡scrape_configs:- job_name:'prometheus'# åç§°ï¼Œä¼šåœ¨æ¯ä¸€æ¡metricsæ·»åŠ æ ‡ç­¾{job_name:\"prometheus\"}scrape_interval:5s# æŠ“å–æ—¶é—´static_configs:# æŠ“å–å¯¹è±¡- targets:['localhost:9090'] é‡å¯å®Œæ¯•åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸¤ä¸ªç•Œé¢ã€‚ ","date":"2020-11-19","objectID":"/2020/11/prometheus/:2:4","tags":["prometheus"],"title":"5åˆ†é’Ÿå­¦ä¼šæ­å»ºPrometheus","uri":"/2020/11/prometheus/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"å®‰è£…exporter å¦‚ä½•è·å–æ•°æ®æºï¼Ÿä»ä¸‹é¢çš„é“¾æ¥ä½ å¯ä»¥æŒ‘é€‰ä¸€äº›å®˜æ–¹æˆ–éå®˜æ–¹çš„exporteræ¥ç›‘æ§ä½ çš„æœåŠ¡ã€‚ exporters and integrations ä¾‹å¦‚ï¼šNode Exporter æš´éœ²äº†å¦‚linuxç­‰UNIXç³»ç»Ÿçš„å†…æ ¸å’Œæœºå™¨çº§åˆ«çš„æŒ‡æ ‡(windowsç”¨æˆ·åº”ç”¨wmi_exporter)ã€‚å®ƒæä¾›äº†å¾ˆå¤šæ ‡å‡†çš„æŒ‡æ ‡å¦‚CPUã€å†…å­˜ã€ç£ç›˜ç©ºé—´ã€ç¡¬ç›˜I/Oå’Œç½‘ç»œå¸¦å®½ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜æä¾›äº†ä»è´Ÿè½½ç‡å¹³å‡å€¼åˆ°ä¸»æ¿æ¸©åº¦ç­‰å¾ˆå¤šå†…æ ¸æš´éœ²çš„é—®é¢˜ã€‚ ä¸‹è½½è¿è¡Œä¹‹åï¼Œæˆ‘ä»¬éœ€è¦æ›´æ–°prometheus.ymlï¼Œç„¶å é‡å¯ prometheusåŠ è½½æ–°çš„é…ç½® global:scrape_interval:15s# é»˜è®¤æŠ“å–é—´éš”ï¼Œ15så‘ç›®æ ‡æŠ“å–ä¸€æ¬¡æ•°æ®external_labels:monitor:'codelab-monitor'# æŠ“å–å¯¹è±¡scrape_configs:- job_name:'prometheus'# åç§°ï¼Œä¼šåœ¨æ¯ä¸€æ¡metricsæ·»åŠ æ ‡ç­¾{job_name:\"prometheus\"}scrape_interval:5s# æŠ“å–æ—¶é—´static_configs:# æŠ“å–å¯¹è±¡- targets:['localhost:9090']- job_name:'node'scrape_interval:5sstatic_configs:- targets:['localhost:9100'] ","date":"2020-11-19","objectID":"/2020/11/prometheus/:3:0","tags":["prometheus"],"title":"5åˆ†é’Ÿå­¦ä¼šæ­å»ºPrometheus","uri":"/2020/11/prometheus/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"å‘Šè­¦é€šçŸ¥ å¦‚æœä½ éœ€è¦è®¾å®šç‰¹å®šçš„è§„åˆ™ï¼Œä¾‹å¦‚cpu/å†…å­˜è¶…è¿‡äº†è®¾å®šå€¼ï¼Œéœ€è¦å°†å‘Šè­¦æ•°æ®å‘é€åˆ°ä½ çš„é‚®ä»¶ã€å¾®ä¿¡ã€é’‰é’‰ç­‰ï¼Œé‚£ä¹ˆä½ å°±éœ€è¦Alertmanagerã€‚ å‘Šè­¦åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ã€‚é¦–å…ˆéœ€è¦åœ¨prometheusä¸­æ·»åŠ å‘Šè­¦è§„åˆ™ï¼Œå®šä¹‰å‘Šè­¦äº§ç”Ÿçš„é€»è¾‘ï¼Œå…¶æ¬¡Altermanagerå°†è§¦å‘çš„è­¦æŠ¥è½¬åŒ–ä¸ºé€šçŸ¥ï¼Œä¾‹å¦‚é‚®ä»¶ï¼Œå‘¼å«å’ŒèŠå¤©æ¶ˆæ¯ã€‚ global:scrape_interval:15s# é»˜è®¤æŠ“å–é—´éš”ï¼Œ15så‘ç›®æ ‡æŠ“å–ä¸€æ¬¡æ•°æ®evaluation_interval:10sexternal_labels:monitor:'codelab-monitor'# è§„åˆ™æ–‡ä»¶rule_files:- rules.ymlalerting:alertmanagers:- static_configs:- targets:- localhost:9093# æŠ“å–å¯¹è±¡scrape_configs:- job_name:'prometheus'# åç§°ï¼Œä¼šåœ¨æ¯ä¸€æ¡metricsæ·»åŠ æ ‡ç­¾{job_name:\"prometheus\"}scrape_interval:5s# æŠ“å–æ—¶é—´static_configs:# æŠ“å–å¯¹è±¡- targets:['localhost:9090']- job_name:'node'scrape_interval:5sstatic_configs:- targets:['localhost:9100'] # è§„åˆ™æ–‡ä»¶rules.ymlgroups:- name:examplerules:- alert:InstanceDownexpr:up == 0for:1m æŒ‰ç…§ evaluation_interval çš„é…ç½®ï¼ŒInstanceDownå‘Šè­¦æ¯10så°†è¢«æ‰§è¡Œ1æ¬¡ã€‚å¦‚æœæŒç»­1mæ”¶åˆ°æ•°æ®ï¼Œé‚£ä¹ˆè¿™ä¸ªå‘Šè­¦å°±ä¼šè¢«è§¦å‘ã€‚åœ¨è¾¾åˆ°è®¾å®šçš„æ—¶é—´é•¿åº¦å‰ï¼Œè¿™ä¸ªå‘Šè­¦å¤„äº pending çŠ¶æ€ï¼Œåœ¨ Alerts é¡µé¢å¯ä»¥å•å‡»è­¦å‘ŠæŸ¥çœ‹åŒ…æ‹¬å®ƒçš„æ ‡ç­¾åœ¨å†…çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚ æ³¨ï¼šé€šå¸¸å»ºè®®è‡³å°‘5minä»¥å‡å°‘å™ªå£°ä»è€Œå‡è½»å›ºæœ‰ç›‘æ§çš„å„ç§æƒ…å†µã€‚ æ—¢ç„¶æœ‰ä¸€ä¸ªè¢«è§¦å‘çš„å‘Šè­¦ï¼Œéœ€è¦ Alertmanager é’ˆå¯¹å®ƒåšä¸€äº›äº‹ã€‚ ","date":"2020-11-19","objectID":"/2020/11/prometheus/:4:0","tags":["prometheus"],"title":"5åˆ†é’Ÿå­¦ä¼šæ­å»ºPrometheus","uri":"/2020/11/prometheus/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"Alertmanager å¦‚ä½•ç®¡ç†å‘Šè­¦é€šçŸ¥ï¼Ÿ æ¯”å¦‚æˆ‘åªæƒ³å·¥ä½œæ—¶é—´æ”¶åˆ°å‘Šè­¦ï¼Œé‚£ä¹ˆå¯ä»¥è®¾ç½®å‘Šè­¦äº‹ä»¶ä¸º09:00-21:00ã€‚ æ¯”å¦‚æˆ‘æŸä¸ªæœåŠ¡ä¸æƒ³æ”¶åˆ°é€šçŸ¥ï¼Œé‚£ä¹ˆå¯ä»¥æš‚æ—¶å…³é—­é€šçŸ¥ã€‚ ä¸‹è½½åœ°å€ ç°åœ¨éœ€è¦ä¸º Alertmanager åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ã€‚è¿™é‡Œæœ‰å¾ˆå¤šä¸­æ–¹å¼è®©Alertmanager é€šçŸ¥åˆ°ä½ ã€‚è¿™é‡Œä½¿ç”¨SMTPã€‚ global:smtp_smarthost:'localhost:25'smtp_from:'youraddress@example.org'route:receiver:example-emailreceivers:- name:'example-email'email_configs:- to:'youraddress@example.org' å¯åŠ¨Alertmanagerï¼Œç°åœ¨å¯ä»¥åœ¨æµè§ˆå™¨è¾“å…¥ http://localhost:9093 æ¥è®¿é—® Alertmanagerï¼Œåœ¨è¿™ä¸ªé¡µé¢ä½ å°†çœ‹åˆ°è§¦å‘çš„å‘Šè­¦ï¼Œå¦‚æœæ‰€æœ‰çš„é…ç½®æ­£ç¡®å¹¶æ­£å¸¸å¯åŠ¨ï¼Œä¸€ä¸¤åˆ†é’Ÿåå°±ä¼šæ”¶åˆ°é‚®ä»¶å‘Šè­¦é€šçŸ¥ã€‚ ","date":"2020-11-19","objectID":"/2020/11/prometheus/:5:0","tags":["prometheus"],"title":"5åˆ†é’Ÿå­¦ä¼šæ­å»ºPrometheus","uri":"/2020/11/prometheus/"},{"categories":["æœˆéœœå¤©çš„å°æ•™ç¨‹"],"content":"æ€»ç»“ è¿™ä¸ªprometheusç”±exporterã€prometheus serverã€Alertmanageræ„æˆã€‚ exporteræ”¶é›†æ•°æ®ï¼Œprometheus server æ‹‰å–exporteræ•°æ®ï¼Œç„¶åæ ¹æ®å‘Šè­¦è§„åˆ™ï¼Œå°†å‘Šè­¦æ¨é€åˆ°Alertmanagerå¤„ç†ã€‚ ä¸­é—´è¿˜è¡ç”Ÿäº†è®¸å¤šå…¶ä»–ç»„ä»¶ï¼Œä¾‹å¦‚pushgateway(å®¢æˆ·ç«¯å°†æ•°æ®pushåˆ°pushgatewayï¼Œç”±prometheuså®šæœŸæ‹‰å–)ï¼Œgrafanaå›¾æ ‡é¡µé¢ç­‰ã€‚ ","date":"2020-11-19","objectID":"/2020/11/prometheus/:6:0","tags":["prometheus"],"title":"5åˆ†é’Ÿå­¦ä¼šæ­å»ºPrometheus","uri":"/2020/11/prometheus/"},{"categories":null,"content":" å¸Œæœ›æˆä¸ºä¸€ä¸ªæœ‰è¶£å‘³å„¿çš„äººã€‚ A golang developer ","date":"2020-11-19","objectID":"/about/:0:0","tags":null,"title":"About me","uri":"/about/"}]